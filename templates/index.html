<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Region {{ region }} ‚Äî HVAC Win-the-Winter Command Center</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    tailwind.config = {
        theme: { extend: { colors: {
            wm: { 
                blue: '#0053e2', 
                'blue-dark': '#001f5c',
                'blue-light': '#e6f0ff',
                spark: '#ffc220', 
                green: '#2a8703',
                red: '#ea1100',
                orange: '#f47920'
            }
        }}}
    }
</script>
<style>
  body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
  
  /* KPI Cards */
  .kpi-card { 
    background: white; border-radius: 16px; padding: 20px; 
    border: 1px solid #e5e7eb; transition: all 0.3s ease;
    cursor: pointer; position: relative; overflow: hidden;
  }
  .kpi-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
    background: linear-gradient(90deg, #0053e2, #7c3aed); opacity: 0; transition: opacity 0.3s;
  }
  .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,83,226,0.15); }
  .kpi-card:hover::before { opacity: 1; }
  
  /* Tab Navigation */
  .tab-nav { display: flex; gap: 4px; background: #f3f4f6; padding: 6px; border-radius: 14px; }
  .tab-btn { 
    padding: 10px 20px; font-size: 13px; font-weight: 600; border: none; 
    background: transparent; color: #6b7280; border-radius: 10px; 
    cursor: pointer; transition: all 0.2s; white-space: nowrap;
    display: flex; align-items: center; gap: 6px;
  }
  .tab-btn:hover { background: white; color: #0053e2; }
  .tab-btn.active { background: white; color: #0053e2; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
  .tab-btn .badge { 
    background: #03e2; color: white; font-size: 10px; 
    padding: 2px 8px; border-radius: 10px; font-weight: 700;
  }
  .tab-btn.active .badge { background: #ffc220; color: #001f5c; }
  
  /* Filter Dropdowns */
  .filter-select {
    border: 2px solid #e5e7eb; border-radius: 10px; padding: 10px 14px;
    font-size: 13px; font-weight: 500; outline: none; transition: all 0.2s;
    background: white; min-width: 160px;
  }
  .filter-select:focus { border-color: #0053e2; box-shadow: 0 0 0 4px rgba(0,83,226,0.1); }
  .filter-select:hover { border-color: #0053e2; }
  
  /* Tables */
  .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .data-table th { 
    padding: 14px 16px; text-align: left; background: #f8fafc; 
    border-bottom: 2px solid #e5e7eb; font-weight: 600; color: #475569;
    position: sticky; top: 0; z-index: 10;
  }
  .data-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; }
  .data-table tbody tr { transition: all 0.15s; cursor: pointer; }
  .data-table tbody tr:hover { background: #eff6ff; }
  
  /* Search Box */
  .search-box {
    border: 2px solid #e5e7eb; border-radius: 12px; padding: 10px 14px 10px 40px;
    font-size: 14px; outline: none; transition: all 0.2s; width: 280px;
  }
  .search-box:focus { border-color: #0053e2; box-shadow: 0 0 0 4px rgba(0,83,226,0.1); }
  
  /* Charts */
  .chart-card { background: white; border-radius: 16px; padding: 24px; border: 1px solid #e5e7eb; }
  
  /* Status Pills */
  .pill { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .pill-green { background: #dcfce7; color: #166534; }
  .pill-red { background: #fee2e2; color: #991b1b; }
  .pill-yellow { background: #fef9c3; color: #854d0e; }
  .pill-blue { background: #dbeafe; color: #1e40af; }
  
  /* Live Indicator */
  .live-dot {
    width: 8px; height: 8px; background: #2a8703; border-radius: 50%;
    display: inline-block; margin-right: 6px;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
  
  /* Banner Toggle */
  .banner-btn {
    padding: 8px 16px; font-size: 12px; font-weight: 600;
    border: 2px solid #e5e7eb; background: white; cursor: pointer;
    transition: all 0.2s;
  }
  .banner-btn:first-child { border-radius: 10px 0 0 10px; }
  .banner-btn:last-child { border-radius: 0 10px 10px 0; }
  .banner-btn:not(:first-child) { border-left: none; }
  .banner-btn.active { background: #0053e2; color: white; border-color: #0053e2; }
  .banner-btn:hover:not(.active) { background: #f8fafc; border-color: #0053e2; }
  
  /* Gradient Header */
  .hero-gradient {
    background: linear-gradient(135deg, #001f5c 0%, #0053e2 50%, #3b82f6 100%);
  }
  
  /* Animations */
  .fade-in { animation: fadeIn 0.4s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  .slide-up { animation: slideUp 0.3s ease-out; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  
  /* Scroll shadows */
  .scroll-shadow {
    background: linear-gradient(to bottom, white, white),
                linear-gradient(to bottom, white, white),
                linear-gradient(to bottom, rgba(0,0,0,0.05), transparent),
                linear-gradient(to top, rgba(0,0,0,0.05), transparent);
    background-position: top, bottom, top, bottom;
    background-repeat: no-repeat;
    background-size: 100% 40px, 100% 40px, 100% 14px, 100% 14px;
    background-attachment: local, local, scroll, scroll;
  }
</style>
</head>
<body class="bg-gray-50 min-h-screen">

<!-- Register Chart.js plugins -->
<script>Chart.register(ChartDataLabels); Chart.defaults.plugins.datalabels = { display: false };</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- DATA LOADING -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// Global data stores
let STORES = [];
let WOS = [];
let WTW_DATA = [];
let WTW_ORG = {};
let KPI_DATA = {};
let LEAK_SUMMARY = [];
let YOY = {};

const GENERATED = '{{ generated }}';
let currentTab = 'exec';
let activeBanner = 'all';
let activeFilters = { sr: '', fm: '', rm: '', fsm: '', ops: '' };

// Load data from API endpoints
async function loadData() {
    console.log('Loading data...');
    try {
        const [stores, wos, wtw, org, kpi, leaks, yoy] = await Promise.all([
            fetch('/api/stores').then(r => r.ok ? r.json() : []),
            fetch('/api/work-orders').then(r => r.ok ? r.json() : []),
            fetch('/data/wtw_data.json').then(r => r.ok ? r.json() : []).catch(() => []),
            fetch('/data/wtw_org.json').then(r => r.ok ? r.json() : {}).catch(() => ({})),
            fetch('/data/kpi_data.json').then(r => r.ok ? r.json() : {}).catch(() => ({})),
            fetch('/data/leak_summary.json').then(r => r.ok ? r.json() : []).catch(() => []),
            fetch('/data/yoy.json').then(r => r.ok ? r.json() : {}).catch(() => ({}))
        ]);
        
        STORES = stores || [];
        WOS = wos || [];
        WTW_DATA = Array.isArray(wtw) ? wtw : [];
        WTW_ORG = org || {};
        KPI_DATA = kpi || {};
        LEAK_SUMMARY = Array.isArray(leaks) ? leaks : [];
        YOY = yoy || {};
        
        console.log(`Loaded: ${STORES.length} stores, ${WOS.length} WOs, Org keys: ${Object.keys(WTW_ORG).length}`);
        
        initDashboard();
    } catch (err) {
        console.error('Data load error:', err);
        // Try loading from embedded data
        loadEmbeddedData();
    }
}

function loadEmbeddedData() {
    // Fallback: try to get data from page
    STORES = window.EMBEDDED_STORES || [];
    WOS = window.EMBEDDED_WOS || [];
    initDashboard();
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', loadData);
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- HERO HEADER -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="hero-gradient text-white">
    <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <!-- Title Section -->
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-3xl">‚ùÑÔ∏è</span>
                    <h1 class="text-2xl lg:text-3xl font-bold">Region {{ region }} ‚Äî HVAC Win-the-Winter</h1>
                </div>
                <p class="text-blue-200 flex items-center gap-2">
                    <span class="live-dot"></span>
                    <span>Command Center ‚Ä¢ FY26 ‚Ä¢ Updated {{ generated }}</span>
                </p>
            </div>
            
            <!-- Quick Stats -->
            <div class="flex flex-wrap gap-6">
                <div class="text-center">
                    <p class="text-3xl font-bold" id="heroStoreCount">--</p>
                    <p class="text-xs text-blue-200">Total Stores</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl font-bold text-wm-spark" id="heroTntAvg">--%</p>
                    <p class="text-xs text-blue-200">Avg TnT</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl font-bold" id="heroWoCount">--</p>
                    <p class="text-xs text-blue-200">Open WOs</p>
                </div>
                <div class="text-center">
                    <p class="text-3xl font-bold text-green-300" id="heroWtwPct">--%</p>
                    <p class="text-xs text-blue-200">WTW Complete</p>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB NAVIGATION -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-6 py-3">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <!-- Tabs -->
            <nav class="tab-nav overflow-x-auto" role="tablist">
                <button class="tab-btn active" onclick="switchTab('exec')" data-tab="exec">
                    üìä Executive
                </button>
                <button class="tab-btn" onclick="switchTab('team')" data-tab="team">
                    üë• Team <span class="badge" id="teamBadge">5</span>
                </button>
                <button class="tab-btn" onclick="switchTab('stores')" data-tab="stores">
                    üè™ Stores <span class="badge" id="storesBadge">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('wos')" data-tab="wos">
                    üìã Work Orders <span class="badge" id="wosBadge">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('wtw')" data-tab="wtw">
                    ‚ùÑÔ∏è Win-the-Winter
                </button>
                <button class="tab-btn" onclick="switchTab('leaks')" data-tab="leaks">
                    üíß Leaks
                </button>
            </nav>
            
            <!-- Banner Toggle -->
            <div class="flex items-center gap-4">
                <div class="flex">
                    <button class="banner-btn active" onclick="setBanner('all')" id="bn-all">All</button>
                    <button class="banner-btn" onclick="setBanner('walmart')" id="bn-walmart">Walmart</button>
                    <button class="banner-btn" onclick="setBanner('nhm')" id="bn-nhm">NHM</button>
                    <button class="banner-btn" onclick="setBanner('sams')" id="bn-sams">Sam's</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- FILTERS BAR -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="bg-white border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex flex-col lg:flex-row lg:items-center gap-4">
            <!-- Search -->
            <div class="relative">
                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">üîç</span>
                <input type="text" id="globalSearch" placeholder="Search stores, people, WOs..." 
                       class="search-box" oninput="handleSearch(this.value)">
            </div>
            
            <!-- Filter Dropdowns -->
            <div class="flex flex-wrap gap-3">
                <select id="fSr" class="filter-select" onchange="applyFilters()">
                    <option value="">All Sr. Directors</option>
                </select>
                <select id="fFm" class="filter-select" onchange="applyFilters()">
                    <option value="">All FM Directors</option>
                </select>
                <select id="fRm" class="filter-select" onchange="applyFilters()">
                    <option value="">All Regional Managers</option>
                </select>
                <select id="fFsm" class="filter-select" onchange="applyFilters()">
                    <option value="">All FS Managers</option>
                </select>
            </div>
            
            <!-- Clear Filters -->
            <button onclick="clearFilters()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-wm-blue hover:bg-blue-50 rounded-lg transition">
                ‚úï Clear Filters
            </button>
            
            <!-- Filter Label -->
            <span id="filterLabel" class="text-sm text-gray-500 ml-auto">Showing all data</span>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB CONTENT: EXECUTIVE -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="exec-content" class="fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">

    <!-- KPI Cards Row -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8" id="kpiCards">
        <!-- Dynamically populated -->
    </div>
    
    <!-- Key Findings -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-6 mb-8">
        <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl">üß†</span>
            <h2 class="text-lg font-bold text-gray-800">Key Findings & Analysis</h2>
        </div>
        <div id="keyFindings" class="text-sm text-gray-700 space-y-2">
            <p>‚Ä¢ Loading insights...</p>
        </div>
    </div>
    
    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="chart-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800">üìä TnT Distribution</h3>
                <button onclick="exportChart('tntChart')" class="text-xs text-gray-500 hover:text-wm-blue">üì• Export</button>
            </div>
            <div style="height:280px"><canvas id="tntChart"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800">‚ùÑÔ∏è WTW Completion by Phase</h3>
                <button onclick="exportChart('wtwChart')" class="text-xs text-gray-500 hover:text-wm-blue">üì• Export</button>
            </div>
            <div style="height:280px"><canvas id="wtwChart"></canvas></div>
        </div>
    </div>
    
    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="chart-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800">üéØ Sr. Director Performance</h3>
            </div>
            <div style="height:320px"><canvas id="srCompareChart"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-800">üí∞ Top 10 Loss Contributors</h3>
            </div>
            <div style="height:320px"><canvas id="lossChart"></canvas></div>
        </div>
    </div>
    
    <!-- Risk & Wins -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-red-50 border border-red-200 rounded-2xl p-6">
            <h3 class="font-bold text-red-800 mb-4 flex items-center gap-2">‚ö†Ô∏è Risk Areas</h3>
            <div id="riskAreas" class="text-sm text-red-700 space-y-2"></div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-2xl p-6">
            <h3 class="font-bold text-green-800 mb-4 flex items-center gap-2">üèÜ Wins & Achievements</h3>
            <div id="winAreas" class="text-sm text-green-700 space-y-2"></div>
        </div>
    </div>
    
</main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB CONTENT: TEAM -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="team-content" class="hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <!-- Sr. Directors Grid -->
    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">üëî Senior Directors</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10" id="srDirectorCards">
        <!-- Dynamically populated -->
    </div>
    
    <!-- FM Directors Table -->
    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">üìã FM Directors</h2>
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden mb-10">
        <div class="overflow-x-auto max-h-96 scroll-shadow">
            <table class="data-table" id="fmDirectorsTable">
                <thead>
                    <tr>
                        <th>FM Director</th>
                        <th>Sr. Director</th>
                        <th>Regional Managers</th>
                        <th>Stores</th>
                        <th>Avg TnT</th>
                        <th>Open WOs</th>
                    </tr>
                </thead>
                <tbody id="fmDirectorsBody"></tbody>
            </table>
        </div>
    </div>
    
    <!-- Regional Managers Table -->
    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">üë• Regional Managers</h2>
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto max-h-96 scroll-shadow">
            <table class="data-table" id="rmTable">
                <thead>
                    <tr>
                        <th>Regional Manager</th>
                        <th>FM Director</th>
                        <th>FS Managers</th>
                        <th>Stores</th>
                        <th>Avg TnT</th>
                    </tr>
                </thead>
                <tbody id="rmBody"></tbody>
            </table>
        </div>
    </div>
    
</main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB CONTENT: STORES -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="stores-content" class="hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="font-bold text-gray-800">üè™ Store Performance</h2>
            <span id="storeCountLabel" class="text-sm text-gray-500">0 stores</span>
        </div>
        <div class="overflow-x-auto max-h-[600px] scroll-shadow">
            <table class="data-table" id="storesTable">
                <thead>
                    <tr>
                        <th>Store #</th>
                        <th>City</th>
                        <th>State</th>
                        <th>Banner</th>
                        <th>TnT Ref</th>
                        <th>TnT HVAC</th>
                        <th>FM Director</th>
                        <th>Regional Manager</th>
                        <th>Open WOs</th>
                        <th>Loss $</th>
                    </tr>
                </thead>
                <tbody id="storesBody"></tbody>
            </table>
        </div>
    </div>
    
</main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB CONTENT: WORK ORDERS -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="wos-content" class="hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="font-bold text-gray-800">üìã Work Orders</h2>
            <span id="woCountLabel" class="text-sm text-gray-500">0 work orders</span>
        </div>
        <div class="overflow-x-auto max-h-[600px] scroll-shadow">
            <table class="data-table" id="wosTable">
                <thead>
                    <tr>
                        <th>WO #</th>
                        <th>Store</th>
                        <th>Status</th>
                        <th>Phase</th>
                        <th>Provider</th>
                        <th>Problem Type</th>
                        <th>Created</th>
                        <th>NTE</th>
                    </tr>
                </thead>
                <tbody id="wosBody"></tbody>
            </table>
        </div>
    </div>
    
</main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB CONTENT: WIN THE WINTER -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="wtw-content" class="hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <!-- WTW KPIs -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="wtwKpis">
        <!-- Dynamically populated -->
    </div>
    
    <!-- WTW Phase Progress -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="chart-card">
            <h3 class="font-semibold text-gray-800 mb-4">Phase 1</h3>
            <div style="height:200px"><canvas id="phase1Chart"></canvas></div>
        </div>
        <div class="chart-card">
            <h3 class="font-semibold text-gray-800 mb-4">Phase 2</h3>
            <div style="height:200px"><canvas id="phase2Chart"></canvas></div>
        </div>
        <div class="chart-card">
            <h3 class="font-semibold text-gray-800 mb-4">Phase 3</h3>
            <div style="height:200px"><canvas id="phase3Chart"></canvas></div>
        </div>
    </div>
    
    <!-- WTW Stores Table -->
    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto max-h-[500px] scroll-shadow">
            <table class="data-table" id="wtwTable">
                <thead>
                    <tr>
                        <th>Store</th>
                        <th>Phase</th>
                        <th>Status</th>
                        <th>FM Director</th>
                        <th>Regional Manager</th>
                        <th>Completion %</th>
                    </tr>
                </thead>
                <tbody id="wtwBody"></tbody>
            </table>
        </div>
    </div>
    
</main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB CONTENT: LEAKS -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="leaks-content" class="hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="leakKpis">
        <!-- Dynamically populated -->
    </div>
    
    <div class="chart-card mb-8">
        <h3 class="font-semibold text-gray-800 mb-4">üíß Leak Trends</h3>
        <div style="height:300px"><canvas id="leakChart"></canvas></div>
    </div>
    
</main>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- FOOTER -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<footer class="bg-gray-800 text-gray-400 py-6 mt-12">
    <div class="max-w-7xl mx-auto px-6 text-center text-sm">
        <p>HVAC Win-the-Winter Command Center ‚Ä¢ Region {{ region }} ‚Ä¢ Generated {{ generated }}</p>
        <p class="mt-1">Data sources: Crystal MDM, ServiceChannel, ISP</p>
    </div>
</footer>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- DASHBOARD LOGIC -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITY FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function avg(arr) { return arr.length ? arr.reduce((a,b) => a + b, 0) / arr.length : 0; }
function sum(arr) { return arr.reduce((a,b) => a + b, 0); }
function fmt(n, d=1) { return n != null ? Number(n).toFixed(d) : '--'; }
function fmtCurrency(n) { return n != null ? '$' + Number(n).toLocaleString() : '--'; }
function esc(s) { return s == null ? '' : String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function switchTab(tab) {
    currentTab = tab;
    
    // Hide all content
    document.querySelectorAll('[id$="-content"]').forEach(el => el.classList.add('hidden'));
    
    // Show selected
    const content = document.getElementById(tab + '-content');
    if (content) {
        content.classList.remove('hidden');
        content.classList.add('fade-in');
    }
    
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
    });
    
    // Render tab-specific content
    if (tab === 'team') renderTeamTab();
    if (tab === 'stores') renderStoresTab();
    if (tab === 'wos') renderWosTab();
    if (tab === 'wtw') renderWtwTab();
    if (tab === 'leaks') renderLeaksTab();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BANNER TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const RETAIL = new Set(['WM Supercenter','Neighborhood Market',"Sam's Club",'Wal-Mart','Grocery']);
const WM_BANNERS = new Set(['WM Supercenter','Wal-Mart','Grocery']);
const NHM_BANNERS = new Set(['Neighborhood Market']);
const SC_BANNERS = new Set(["Sam's Club"]);

function getActiveBanners() {
    if (activeBanner === 'walmart') return WM_BANNERS;
    if (activeBanner === 'nhm') return NHM_BANNERS;
    if (activeBanner === 'sams') return SC_BANNERS;
    return RETAIL;
}

function setBanner(mode) {
    activeBanner = mode;
    ['all','walmart','nhm','sams'].forEach(b => {
        const btn = document.getElementById('bn-' + b);
        if (btn) btn.classList.toggle('active', b === mode);
    });
    applyFilters();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initFilters() {
    const org = WTW_ORG.srToFm || {};
    const srSelect = document.getElementById('fSr');
    
    // Populate Sr. Directors
    if (srSelect) {
        srSelect.innerHTML = '<option value="">All Sr. Directors</option>';
        Object.keys(org).filter(k => k !== 'Unassigned' && k !== 'FM-SR-DIR').forEach(sr => {
            srSelect.innerHTML += `<option value="${esc(sr)}">${esc(sr)}</option>`;
        });
    }
    
    updateCascadingFilters();
}

function updateCascadingFilters() {
    const org = WTW_ORG;
    const sr = document.getElementById('fSr')?.value || '';
    const fm = document.getElementById('fFm')?.value || '';
    const rm = document.getElementById('fRm')?.value || '';
    
    // FM Directors based on Sr selection
    const fmSelect = document.getElementById('fFm');
    if (fmSelect) {
        const fmList = sr ? (org.srToFm?.[sr] || []) : Object.values(org.srToFm || {}).flat();
        fmSelect.innerHTML = '<option value="">All FM Directors</option>';
        [...new Set(fmList)].filter(f => f !== 'Unassigned' && f !== 'FM-DIR').sort().forEach(f => {
            fmSelect.innerHTML += `<option value="${esc(f)}">${esc(f)}</option>`;
        });
    }
    
    // Regional Managers based on FM selection
    const rmSelect = document.getElementById('fRm');
    if (rmSelect) {
        let rmList = [];
        if (fm) {
            rmList = org.fmToReg?.[fm] || [];
        } else {
            rmList = Object.values(org.fmToReg || {}).flat();
        }
        rmSelect.innerHTML = '<option value="">All Regional Managers</option>';
        [...new Set(rmList)].filter(r => r !== 'Unassigned' && !r.includes('-RM')).sort().forEach(r => {
            rmSelect.innerHTML += `<option value="${esc(r)}">${esc(r)}</option>`;
        });
    }
    
    // FS Managers based on RM selection
    const fsmSelect = document.getElementById('fFsm');
    if (fsmSelect) {
        let fsmList = [];
        if (rm) {
            fsmList = org.regToFs?.[rm] || [];
        } else {
            fsmList = Object.values(org.regToFs || {}).flat();
        }
        fsmSelect.innerHTML = '<option value="">All FS Managers</option>';
        [...new Set(fsmList)].filter(f => f !== 'Unassigned' && !f.includes('-FS')).sort().forEach(f => {
            fsmSelect.innerHTML += `<option value="${esc(f)}">${esc(f)}</option>`;
        });
    }
}

function applyFilters() {
    activeFilters = {
        sr: document.getElementById('fSr')?.value || '',
        fm: document.getElementById('fFm')?.value || '',
        rm: document.getElementById('fRm')?.value || '',
        fsm: document.getElementById('fFsm')?.value || ''
    };
    
    updateCascadingFilters();
    updateFilterLabel();
    renderCurrentTab();
}

function clearFilters() {
    ['fSr','fFm','fRm','fFsm'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    document.getElementById('globalSearch').value = '';
    activeFilters = { sr: '', fm: '', rm: '', fsm: '' };
    activeBanner = 'all';
    setBanner('all');
    applyFilters();
}

function updateFilterLabel() {
    const parts = [];
    if (activeFilters.sr) parts.push(activeFilters.sr);
    if (activeFilters.fm) parts.push(activeFilters.fm);
    if (activeFilters.rm) parts.push(activeFilters.rm);
    if (activeFilters.fsm) parts.push(activeFilters.fsm);
    
    const label = document.getElementById('filterLabel');
    if (label) {
        label.textContent = parts.length ? `Filtered: ${parts.join(' ‚Üí ')}` : 'Showing all data';
    }
}

function getFilteredStores() {
    let stores = STORES.filter(s => getActiveBanners().has(s.banner_desc));
    
    if (activeFilters.sr) {
        stores = stores.filter(s => s.fm_sr_director_name === activeFilters.sr);
    }
    if (activeFilters.fm) {
        stores = stores.filter(s => s.fm_director_name === activeFilters.fm);
    }
    if (activeFilters.rm) {
        stores = stores.filter(s => s.fm_regional_manager_name === activeFilters.rm);
    }
    if (activeFilters.fsm) {
        stores = stores.filter(s => s.fs_manager_name === activeFilters.fsm);
    }
    
    return stores;
}

function handleSearch(query) {
    // Simple search - could be enhanced
    console.log('Searching:', query);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderCurrentTab() {
    switch(currentTab) {
        case 'exec': renderExecTab(); break;
        case 'team': renderTeamTab(); break;
        case 'stores': renderStoresTab(); break;
        case 'wos': renderWosTab(); break;
        case 'wtw': renderWtwTab(); break;
        case 'leaks': renderLeaksTab(); break;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXECUTIVE TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let charts = {};

function renderExecTab() {
    const stores = getFilteredStores();
    const wos = WOS;
    
    // Update hero stats
    document.getElementById('heroStoreCount').textContent = stores.length;
    document.getElementById('heroTntAvg').textContent = fmt(avg(stores.map(s => parseFloat(s.twt_ref) || 0))) + '%';
    document.getElementById('heroWoCount').textContent = wos.length;
    
    // Calculate WTW completion
    const wtwComplete = wos.filter(w => w.status_name === 'Completed').length;
    const wtwPct = wos.length ? ((wtwComplete / wos.length) * 100) : 0;
    document.getElementById('heroWtwPct').textContent = fmt(wtwPct, 0) + '%';
    
    // Update badges
    document.getElementById('storesBadge').textContent = stores.length;
    document.getElementById('wosBadge').textContent = wos.length;
    
    // KPI Cards
    renderKpiCards(stores, wos);
    
    // Key Findings
    renderKeyFindings(stores, wos);
    
    // Charts
    renderTntDistChart(stores);
    renderWtwPhaseChart(wos);
    renderSrCompareChart(stores);
    renderLossChart(stores);
    
    // Risks & Wins
    renderRisksWins(stores, wos);
}

function renderKpiCards(stores, wos) {
    const container = document.getElementById('kpiCards');
    if (!container) return;
    
    const tntAvg = avg(stores.map(s => parseFloat(s.twt_ref) || 0));
    const hvacAvg = avg(stores.map(s => parseFloat(s.twt_hvac) || 0));
    const totalLoss = sum(stores.map(s => parseFloat(s.total_loss) || 0));
    const openWos = wos.filter(w => w.status_name !== 'Completed').length;
    const agedWos = wos.filter(w => {
        const created = new Date(w.created_date);
        const days = (Date.now() - created) / (1000*60*60*24);
        return days > 30 && w.status_name !== 'Completed';
    }).length;
    const completedWos = wos.filter(w => w.status_name === 'Completed').length;
    
    container.innerHTML = `
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">Avg TnT Ref</p>
            <p class="text-2xl font-bold" style="color: ${tntAvg >= 90 ? '#2a8703' : tntAvg >= 85 ? '#f47920' : '#ea1100'}">${fmt(tntAvg)}%</p>
            <p class="text-xs text-gray-400 mt-1">Target: 92%</p>
        </div>
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">Avg TnT HVAC</p>
            <p class="text-2xl font-bold" style="color: ${hvacAvg >= 90 ? '#2a8703' : hvacAvg >= 85 ? '#f47920' : '#ea1100'}">${fmt(hvacAvg)}%</p>
            <p class="text-xs text-gray-400 mt-1">Target: 90%</p>
        </div>
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">Total Loss</p>
            <p class="text-2xl font-bold text-red-600">${fmtCurrency(totalLoss)}</p>
            <p class="text-xs text-gray-400 mt-1">${stores.length} stores</p>
        </div>
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">Open WOs</p>
            <p class="text-2xl font-bold text-orange-500">${openWos}</p>
            <p class="text-xs text-gray-400 mt-1">${agedWos} aged (30+ days)</p>
        </div>
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">Completed WOs</p>
            <p class="text-2xl font-bold text-green-600">${completedWos}</p>
            <p class="text-xs text-gray-400 mt-1">${wos.length ? Math.round((completedWos/wos.length)*100) : 0}% complete</p>
        </div>
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">Stores</p>
            <p class="text-2xl font-bold text-wm-blue">${stores.length}</p>
            <p class="text-xs text-gray-400 mt-1">In current filter</p>
        </div>
    `;
}

function renderKeyFindings(stores, wos) {
    const container = document.getElementById('keyFindings');
    if (!container) return;
    
    const tntAvg = avg(stores.map(s => parseFloat(s.twt_ref) || 0));
    const lowTnt = stores.filter(s => (parseFloat(s.twt_ref) || 100) < 85).length;
    const completedPct = wos.length ? (wos.filter(w => w.status_name === 'Completed').length / wos.length * 100) : 0;
    
    container.innerHTML = `
        <p>‚Ä¢ <strong>Average TnT Refrigeration:</strong> ${fmt(tntAvg)}% across ${stores.length} stores</p>
        <p>‚Ä¢ <strong>WTW Progress:</strong> ${fmt(completedPct, 0)}% of work orders completed</p>
        <p>‚Ä¢ <strong>At-Risk Stores:</strong> ${lowTnt} stores below 85% TnT threshold require attention</p>
        <p>‚Ä¢ <strong>Open Work Orders:</strong> ${wos.filter(w => w.status_name !== 'Completed').length} WOs pending completion</p>
    `;
}

function renderTntDistChart(stores) {
    const ctx = document.getElementById('tntChart');
    if (!ctx) return;
    
    // Bucket stores by TnT
    const buckets = { '<80%': 0, '80-85%': 0, '85-90%': 0, '90-95%': 0, '95-100%': 0 };
    stores.forEach(s => {
        const tnt = parseFloat(s.twt_ref) || 0;
        if (tnt < 80) buckets['<80%']++;
        else if (tnt < 85) buckets['80-85%']++;
        else if (tnt < 90) buckets['85-90%']++;
        else if (tnt < 95) buckets['90-95%']++;
        else buckets['95-100%']++;
    });
    
    if (charts.tntChart) charts.tntChart.destroy();
    charts.tntChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(buckets),
            datasets: [{
                label: 'Stores',
                data: Object.values(buckets),
                backgroundColor: ['#ea1100', '#f47920', '#ffc220', '#86efac', '#2a8703']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, datalabels: { display: true, anchor: 'end', align: 'top', font: { weight: 'bold' } } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function renderWtwPhaseChart(wos) {
    const ctx = document.getElementById('wtwChart');
    if (!ctx) return;
    
    const phases = { PH1: { total: 0, done: 0 }, PH2: { total: 0, done: 0 }, PH3: { total: 0, done: 0 } };
    wos.forEach(w => {
        const phase = w.phase || 'PH1';
        if (phases[phase]) {
            phases[phase].total++;
            if (w.status_name === 'Completed') phases[phase].done++;
        }
    });
    
    if (charts.wtwChart) charts.wtwChart.destroy();
    charts.wtwChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Phase 1', 'Phase 2', 'Phase 3'],
            datasets: [
                { label: 'Completed', data: [phases.PH1.done, phases.PH2.done, phases.PH3.done], backgroundColor: '#2a8703' },
                { label: 'Remaining', data: [phases.PH1.total - phases.PH1.done, phases.PH2.total - phases.PH2.done, phases.PH3.total - phases.PH3.done], backgroundColor: '#e5e7eb' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
        }
    });
}

function renderSrCompareChart(stores) {
    const ctx = document.getElementById('srCompareChart');
    if (!ctx) return;
    
    // Group by Sr Director
    const srData = {};
    stores.forEach(s => {
        const sr = s.fm_sr_director_name || 'Unknown';
        if (!srData[sr]) srData[sr] = [];
        srData[sr].push(s);
    });
    
    const labels = Object.keys(srData).filter(k => k !== 'Unknown' && k !== 'Unassigned').slice(0, 5);
    const tntData = labels.map(sr => avg(srData[sr].map(s => parseFloat(s.twt_ref) || 0)));
    const hvacData = labels.map(sr => avg(srData[sr].map(s => parseFloat(s.twt_hvac) || 0)));
    
    if (charts.srCompareChart) charts.srCompareChart.destroy();
    charts.srCompareChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'TnT Ref', data: tntData, backgroundColor: '#0053e2' },
                { label: 'TnT HVAC', data: hvacData, backgroundColor: '#7c3aed' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { position: 'bottom' } },
            scales: { x: { beginAtZero: true, max: 100 } }
        }
    });
}

function renderLossChart(stores) {
    const ctx = document.getElementById('lossChart');
    if (!ctx) return;
    
    const sorted = [...stores].sort((a,b) => (parseFloat(b.total_loss)||0) - (parseFloat(a.total_loss)||0)).slice(0, 10);
    
    if (charts.lossChart) charts.lossChart.destroy();
    charts.lossChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sorted.map(s => '#' + s.store_number),
            datasets: [{
                label: 'Loss $',
                data: sorted.map(s => parseFloat(s.total_loss) || 0),
                backgroundColor: '#ea1100'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { display: false } }
        }
    });
}

function renderRisksWins(stores, wos) {
    const riskContainer = document.getElementById('riskAreas');
    const winContainer = document.getElementById('winAreas');
    
    const lowTnt = stores.filter(s => (parseFloat(s.twt_ref) || 100) < 85);
    const agedWos = wos.filter(w => {
        const days = (Date.now() - new Date(w.created_date)) / (1000*60*60*24);
        return days > 30 && w.status_name !== 'Completed';
    });
    const highLoss = stores.filter(s => (parseFloat(s.total_loss) || 0) > 10000);
    
    if (riskContainer) {
        riskContainer.innerHTML = `
            <p>‚Ä¢ ${lowTnt.length} stores below 85% TnT threshold</p>
            <p>‚Ä¢ ${agedWos.length} work orders aged 30+ days</p>
            <p>‚Ä¢ ${highLoss.length} stores with >$10K loss</p>
        `;
    }
    
    const goodTnt = stores.filter(s => (parseFloat(s.twt_ref) || 0) >= 95);
    const completedWos = wos.filter(w => w.status_name === 'Completed');
    
    if (winContainer) {
        winContainer.innerHTML = `
            <p>‚Ä¢ ${goodTnt.length} stores at 95%+ TnT (excellent)</p>
            <p>‚Ä¢ ${completedWos.length} WTW work orders completed</p>
            <p>‚Ä¢ Team maintaining strong performance</p>
        `;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEAM TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderTeamTab() {
    renderSrDirectorCards();
    renderFmDirectorsTable();
    renderRmTable();
}

function renderSrDirectorCards() {
    const container = document.getElementById('srDirectorCards');
    if (!container) return;
    
    const org = WTW_ORG.srToFm || {};
    const stores = STORES;
    
    let html = '';
    Object.keys(org).filter(k => k !== 'Unassigned' && k !== 'FM-SR-DIR').forEach(sr => {
        const fmList = org[sr] || [];
        const srStores = stores.filter(s => s.fm_sr_director_name === sr);
        const avgTnt = avg(srStores.map(s => parseFloat(s.twt_ref) || 0));
        const isCurrent = sr === 'B.A. Glass';
        
        html += `
            <div class="kpi-card ${isCurrent ? 'ring-2 ring-wm-spark' : ''}" onclick="document.getElementById('fSr').value='${esc(sr)}';applyFilters();">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-2xl">üëî</span>
                    ${isCurrent ? '<span class="pill pill-yellow">YOUR TEAM</span>' : ''}
                </div>
                <h3 class="font-bold text-gray-800 mb-1">${esc(sr)}</h3>
                <p class="text-xs text-gray-500 mb-3">${fmList.length} FM Directors ‚Ä¢ ${srStores.length} Stores</p>
                <div class="flex items-center justify-between">
                    <span class="text-lg font-bold ${avgTnt >= 90 ? 'text-green-600' : avgTnt >= 85 ? 'text-orange-500' : 'text-red-600'}">${fmt(avgTnt)}%</span>
                    <span class="text-xs text-gray-400">Avg TnT</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p class="text-gray-500">No Sr. Directors loaded</p>';
    document.getElementById('teamBadge').textContent = Object.keys(org).filter(k => k !== 'Unassigned' && k !== 'FM-SR-DIR').length;
}

function renderFmDirectorsTable() {
    const container = document.getElementById('fmDirectorsBody');
    if (!container) return;
    
    const org = WTW_ORG;
    const stores = STORES;
    
    let html = '';
    Object.entries(org.srToFm || {}).filter(([sr]) => sr !== 'Unassigned' && sr !== 'FM-SR-DIR').forEach(([sr, fmList]) => {
        fmList.forEach(fm => {
            const rmList = org.fmToReg?.[fm] || [];
            const fmStores = stores.filter(s => s.fm_director_name === fm);
            const avgTnt = avg(fmStores.map(s => parseFloat(s.twt_ref) || 0));
            const openWos = WOS.filter(w => fmStores.some(s => s.store_number == w.store_nbr) && w.status_name !== 'Completed').length;
            
            html += `
                <tr onclick="document.getElementById('fFm').value='${esc(fm)}';applyFilters();">
                    <td class="font-medium">${esc(fm)}</td>
                    <td>${esc(sr)}</td>
                    <td>${rmList.filter(r => !r.includes('-RM')).length}</td>
                    <td>${fmStores.length}</td>
                    <td><span class="pill ${avgTnt >= 90 ? 'pill-green' : avgTnt >= 85 ? 'pill-yellow' : 'pill-red'}">${fmt(avgTnt)}%</span></td>
                    <td>${openWos}</td>
                </tr>
            `;
        });
    });
    
    container.innerHTML = html || '<tr><td colspan="6" class="text-center text-gray-500 py-8">No FM Directors loaded</td></tr>';
}

function renderRmTable() {
    const container = document.getElementById('rmBody');
    if (!container) return;
    
    const org = WTW_ORG;
    const stores = STORES;
    
    let html = '';
    Object.entries(org.fmToReg || {}).forEach(([fm, rmList]) => {
        rmList.filter(rm => !rm.includes('-RM')).forEach(rm => {
            const fsmList = org.regToFs?.[rm] || [];
            const rmStores = stores.filter(s => s.fm_regional_manager_name === rm);
            const avgTnt = avg(rmStores.map(s => parseFloat(s.twt_ref) || 0));
            
            html += `
                <tr onclick="document.getElementById('fRm').value='${esc(rm)}';applyFilters();">
                    <td class="font-medium">${esc(rm)}</td>
                    <td>${esc(fm)}</td>
                    <td>${fsmList.filter(f => !f.includes('-FS')).length}</td>
                    <td>${rmStores.length}</td>
                    <td><span class="pill ${avgTnt >= 90 ? 'pill-green' : avgTnt >= 85 ? 'pill-yellow' : 'pill-red'}">${fmt(avgTnt)}%</span></td>
                </tr>
            `;
        });
    });
    
    container.innerHTML = html || '<tr><td colspan="5" class="text-center text-gray-500 py-8">No Regional Managers loaded</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORES TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderStoresTab() {
    const container = document.getElementById('storesBody');
    const countLabel = document.getElementById('storeCountLabel');
    if (!container) return;
    
    const stores = getFilteredStores();
    if (countLabel) countLabel.textContent = `${stores.length} stores`;
    
    let html = '';
    stores.slice(0, 200).forEach(s => {
        const tnt = parseFloat(s.twt_ref) || 0;
        const hvac = parseFloat(s.twt_hvac) || 0;
        const loss = parseFloat(s.total_loss) || 0;
        const woCount = WOS.filter(w => w.store_nbr == s.store_number).length;
        
        html += `
            <tr>
                <td class="font-medium">#${s.store_number}</td>
                <td>${esc(s.city_name)}</td>
                <td>${esc(s.state_cd)}</td>
                <td><span class="pill pill-blue">${esc(s.banner_desc?.substring(0,15))}</span></td>
                <td><span class="pill ${tnt >= 90 ? 'pill-green' : tnt >= 85 ? 'pill-yellow' : 'pill-red'}">${fmt(tnt)}%</span></td>
                <td><span class="pill ${hvac >= 90 ? 'pill-green' : hvac >= 85 ? 'pill-yellow' : 'pill-red'}">${fmt(hvac)}%</span></td>
                <td>${esc(s.fm_director_name)}</td>
                <td>${esc(s.fm_regional_manager_name)}</td>
                <td>${woCount}</td>
                <td class="${loss > 5000 ? 'text-red-600 font-medium' : ''}">${fmtCurrency(loss)}</td>
            </tr>
        `;
    });
    
    container.innerHTML = html || '<tr><td colspan="10" class="text-center text-gray-500 py-8">No stores match current filters</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORK ORDERS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderWosTab() {
    const container = document.getElementById('wosBody');
    const countLabel = document.getElementById('woCountLabel');
    if (!container) return;
    
    const wos = WOS;
    if (countLabel) countLabel.textContent = `${wos.length} work orders`;
    
    let html = '';
    wos.slice(0, 200).forEach(w => {
        const status = w.status_name || 'Unknown';
        const isComplete = status === 'Completed';
        const phase = w.phase || 'PH1';
        
        html += `
            <tr>
                <td class="font-medium">${esc(w.workorder_nbr)}</td>
                <td>#${w.store_nbr}</td>
                <td><span class="pill ${isComplete ? 'pill-green' : 'pill-yellow'}">${esc(status)}</span></td>
                <td><span class="pill pill-blue">${esc(phase)}</span></td>
                <td>${esc(w.provider_name)}</td>
                <td>${esc(w.problem_type_desc)}</td>
                <td>${w.created_date?.substring(0,10) || '--'}</td>
                <td>${fmtCurrency(w.not_to_exceed_amt)}</td>
            </tr>
        `;
    });
    
    container.innerHTML = html || '<tr><td colspan="8" class="text-center text-gray-500 py-8">No work orders found</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIN THE WINTER TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderWtwTab() {
    // Render WTW specific content
    const container = document.getElementById('wtwBody');
    if (!container) return;
    
    container.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">Loading WTW data...</td></tr>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEAKS TAB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderLeaksTab() {
    const container = document.getElementById('leakKpis');
    if (!container) return;
    
    container.innerHTML = `
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">Total Leaks</p>
            <p class="text-2xl font-bold text-red-600">${LEAK_SUMMARY.length || '--'}</p>
        </div>
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">Open Leak WOs</p>
            <p class="text-2xl font-bold text-orange-500">--</p>
        </div>
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">High Charge Assets</p>
            <p class="text-2xl font-bold text-purple-600">--</p>
        </div>
        <div class="kpi-card">
            <p class="text-xs font-medium text-gray-500 mb-1">EPA Inspections</p>
            <p class="text-2xl font-bold text-blue-600">--</p>
        </div>
    `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIALIZE DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initDashboard() {
    console.log('Initializing dashboard...');
    initFilters();
    renderExecTab();
}
</script>

</body>
</html>