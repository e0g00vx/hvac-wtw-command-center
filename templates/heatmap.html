<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Region 15B Heat Maps</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .map-container { height: 550px; width: 100%; border-radius: 12px; }
        .tab-btn { transition: all 0.2s; }
        .tab-btn.active { background: linear-gradient(135deg, #0053e2, #0ea5e9); color: white; }
        .tab-btn:not(.active) { background: #f1f5f9; color: #475569; }
        .tab-btn:not(.active):hover { background: #e2e8f0; }
        .filter-select { border: 2px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; font-size: 14px; min-width: 180px; }
        .filter-select:focus { border-color: #0053e2; outline: none; }
        .stat-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; }
        .loading { display: flex; align-items: center; justify-content: center; height: 400px; color: #666; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-[#004c91] to-[#0053e2] text-white py-5 px-4 shadow-lg">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <span class="text-3xl">‚ùÑÔ∏è</span> Region 15B Command Center
                </h1>
                <p class="text-blue-200 text-sm mt-1">FM Director: Franky Gonzalez | Sr. Director: B.A. Glass | FY26</p>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-blue-200">Stores Loaded:</span>
                <span class="bg-white/20 px-3 py-1 rounded-lg text-sm font-medium" id="totalStores">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-4 pt-6">
        <div class="flex gap-2 mb-6">
            <button onclick="switchTab('heatmap')" id="tab-heatmap" class="tab-btn active px-6 py-3 rounded-xl font-semibold text-sm flex items-center gap-2">
                <span>üó∫Ô∏è</span> Heat Map
            </button>
            <button onclick="switchTab('rtu')" id="tab-rtu" class="tab-btn px-6 py-3 rounded-xl font-semibold text-sm flex items-center gap-2">
                <span>üö®</span> RTU/AHU Broken
            </button>
        </div>
    </div>

    <!-- HEAT MAP TAB -->
    <div id="heatmap-content" class="max-w-7xl mx-auto px-4 pb-8">
        <!-- Filters -->
        <div class="bg-white rounded-xl shadow p-4 mb-4">
            <div class="flex flex-wrap items-center gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">FM Director</label>
                    <select id="filterDirector" onchange="renderHeatMap()" class="filter-select">
                        <option value="">All Directors</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">FS Regional</label>
                    <select id="filterRegional" onchange="renderHeatMap()" class="filter-select">
                        <option value="">All Regionals</option>
                    </select>
                </div>
                <div class="ml-auto flex items-center gap-4">
                    <span class="text-sm text-gray-500">Showing: <strong id="storeCount">0</strong> stores</span>
                    <button onclick="resetFilters()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition">üîÑ Reset</button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="stat-card text-center"><p class="text-3xl font-bold text-emerald-600" id="statExcellent">0</p><p class="text-xs text-gray-500 mt-1">‚úÖ Excellent (95%+)</p></div>
            <div class="stat-card text-center"><p class="text-3xl font-bold text-amber-500" id="statGood">0</p><p class="text-xs text-gray-500 mt-1">üü° Good (85-95%)</p></div>
            <div class="stat-card text-center"><p class="text-3xl font-bold text-orange-500" id="statWarning">0</p><p class="text-xs text-gray-500 mt-1">üü† Warning (75-85%)</p></div>
            <div class="stat-card text-center"><p class="text-3xl font-bold text-red-500" id="statCritical">0</p><p class="text-xs text-gray-500 mt-1">üî¥ Critical (<75%)</p></div>
        </div>

        <!-- Map -->
        <div class="bg-white rounded-xl shadow-lg p-4">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-gray-800">Store TnT Performance</h2>
                <div class="flex gap-4 text-xs">
                    <span class="flex items-center gap-1"><span class="legend-dot" style="background:#10b981"></span> 95%+</span>
                    <span class="flex items-center gap-1"><span class="legend-dot" style="background:#f59e0b"></span> 85-95%</span>
                    <span class="flex items-center gap-1"><span class="legend-dot" style="background:#f97316"></span> 75-85%</span>
                    <span class="flex items-center gap-1"><span class="legend-dot" style="background:#ef4444"></span> <75%</span>
                </div>
            </div>
            <div id="heatmapMap" class="map-container"></div>
        </div>
    </div>

    <!-- RTU/AHU BROKEN TAB -->
    <div id="rtu-content" class="hidden max-w-7xl mx-auto px-4 pb-8">
        <!-- Filters -->
        <div class="bg-white rounded-xl shadow p-4 mb-4">
            <div class="flex flex-wrap items-center gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">FM Director</label>
                    <select id="rtuFilterDirector" onchange="renderRtuMap()" class="filter-select">
                        <option value="">All Directors</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">FS Regional</label>
                    <select id="rtuFilterRegional" onchange="renderRtuMap()" class="filter-select">
                        <option value="">All Regionals</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Issue Type</label>
                    <select id="rtuFilterIssue" onchange="renderRtuMap()" class="filter-select">
                        <option value="all">All Issues</option>
                        <option value="comm">Comm Loss Only</option>
                        <option value="alarm">Alarms Only</option>
                    </select>
                </div>
                <div class="ml-auto flex items-center gap-4">
                    <span class="text-sm text-gray-500">Units with issues: <strong id="rtuIssueCount" class="text-red-600">0</strong></span>
                    <button onclick="resetRtuFilters()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition">üîÑ Reset</button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
            <div class="stat-card text-center border-l-4 border-red-500"><p class="text-3xl font-bold text-red-600" id="rtuCommLoss">0</p><p class="text-xs text-gray-500 mt-1">üìµ Comm Loss</p></div>
            <div class="stat-card text-center border-l-4 border-orange-500"><p class="text-3xl font-bold text-orange-600" id="rtuAlarms">0</p><p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è Active Alarms</p></div>
            <div class="stat-card text-center border-l-4 border-amber-500"><p class="text-3xl font-bold text-amber-600" id="rtuOffline">0</p><p class="text-xs text-gray-500 mt-1">üî¥ Total Broken</p></div>
            <div class="stat-card text-center border-l-4 border-emerald-500"><p class="text-3xl font-bold text-emerald-600" id="rtuOnline">0</p><p class="text-xs text-gray-500 mt-1">‚úÖ Online Units</p></div>
        </div>

        <!-- Map -->
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-gray-800">üö® RTU/AHU with Comm Loss & Alarms</h2>
                <div class="flex gap-4 text-xs">
                    <span class="flex items-center gap-1"><span class="legend-dot" style="background:#ef4444"></span> Comm Loss</span>
                    <span class="flex items-center gap-1"><span class="legend-dot" style="background:#f97316"></span> Alarms</span>
                    <span class="flex items-center gap-1"><span class="legend-dot" style="background:#fbbf24"></span> Multiple</span>
                </div>
            </div>
            <div id="rtuMap" class="map-container"></div>
        </div>

        <!-- Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="p-4 bg-gradient-to-r from-red-50 to-orange-50 border-b"><h3 class="font-bold text-gray-800">üìù Units Requiring Attention</h3></div>
            <div class="overflow-x-auto max-h-80">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-gray-600 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold">Store</th>
                            <th class="px-4 py-3 text-left font-semibold">Unit</th>
                            <th class="px-4 py-3 text-left font-semibold">Type</th>
                            <th class="px-4 py-3 text-left font-semibold">Issue</th>
                            <th class="px-4 py-3 text-left font-semibold">Director</th>
                        </tr>
                    </thead>
                    <tbody id="rtuTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    // ============================================================
    // LOAD REAL DATA FROM DBLISH
    // ============================================================
    let STORES = [];
    let TERM_UNITS = {};
    let heatmapMap = null;
    let rtuMap = null;

    // Texas city coordinates for mapping
    const CITY_COORDS = {
        'HOUSTON': [29.76, -95.37], 'DALLAS': [32.78, -96.80], 'AUSTIN': [30.27, -97.74],
        'SAN ANTONIO': [29.42, -98.49], 'FORT WORTH': [32.75, -97.33], 'EL PASO': [31.76, -106.49],
        'ARLINGTON': [32.73, -97.11], 'PLANO': [33.02, -96.70], 'CORPUS CHRISTI': [27.80, -97.40],
        'LUBBOCK': [33.58, -101.85], 'LAREDO': [27.51, -99.51], 'IRVING': [32.81, -96.95],
        'AMARILLO': [35.22, -101.83], 'MCKINNEY': [33.20, -96.62], 'FRISCO': [33.15, -96.82],
        'WACO': [31.55, -97.15], 'MIDLAND': [31.99, -102.08], 'ODESSA': [31.85, -102.37],
        'BEAUMONT': [30.08, -94.13], 'ABILENE': [32.45, -99.73], 'TYLER': [32.35, -95.30],
        'ROUND ROCK': [30.51, -97.68], 'SUGAR LAND': [29.62, -95.64], 'MCALLEN': [26.20, -98.23],
        'KILLEEN': [31.12, -97.73], 'COLLEGE STATION': [30.63, -96.33], 'DENTON': [33.21, -97.13],
        'BROWNSVILLE': [25.90, -97.50], 'PASADENA': [29.69, -95.21], 'MESQUITE': [32.77, -96.60],
        'CARROLLTON': [32.95, -96.89], 'GRAND PRAIRIE': [32.75, -96.99], 'LONGVIEW': [32.50, -94.74]
    };

    function getCoords(city) {
        const c = (city || '').toUpperCase().trim();
        for (const [name, coords] of Object.entries(CITY_COORDS)) {
            if (c.includes(name)) return [coords[0] + (Math.random()-0.5)*0.1, coords[1] + (Math.random()-0.5)*0.1];
        }
        // Random Texas location
        return [30 + Math.random()*5, -99 + Math.random()*8];
    }

    // Decode dictionary-encoded data
    function decode(packed) {
        if (Array.isArray(packed)) return packed;
        const {c: cols, d: dicts, r: rows} = packed;
        return rows.map(row => {
            const obj = {};
            cols.forEach((k, i) => { obj[k] = (dicts && dicts[k]) ? dicts[k][row[i]] : row[i]; });
            return obj;
        });
    }

    // Load data on page load
    async function loadData() {
        try {
            console.log('üì¶ Loading data from dblish...');
            
            // Load stores
            const storesRes = await fetch('/data/stores.json');
            const storesData = await storesRes.json();
            STORES = decode(storesData);
            console.log('‚úÖ Stores loaded:', STORES.length);
            
            // Load terminal units
            const unitsRes = await fetch('/data/term_units.json');
            TERM_UNITS = await unitsRes.json();
            console.log('‚úÖ Terminal units loaded:', Object.keys(TERM_UNITS).length, 'stores');
            
            document.getElementById('totalStores').textContent = STORES.length + ' stores';
            
            // Populate filters with REAL directors/regionals from data
            populateFilters();
            
            // Initialize maps
            initHeatMap();
            
        } catch (err) {
            console.error('‚ùå Error loading data:', err);
            document.getElementById('totalStores').textContent = 'Error loading';
        }
    }

    function populateFilters() {
        // Get unique directors and regionals from REAL data
        const directors = [...new Set(STORES.map(s => s.dir).filter(Boolean))].sort();
        const regionals = [...new Set(STORES.map(s => s.rm).filter(Boolean))].sort();
        
        console.log('üë§ Directors found:', directors.length);
        console.log('üë• Regionals found:', regionals.length);
        
        // Heat map filters
        const dirSelect = document.getElementById('filterDirector');
        const regSelect = document.getElementById('filterRegional');
        directors.forEach(d => dirSelect.innerHTML += `<option value="${d}">${d}</option>`);
        regionals.forEach(r => regSelect.innerHTML += `<option value="${r}">${r}</option>`);
        
        // RTU filters
        const rtuDirSelect = document.getElementById('rtuFilterDirector');
        const rtuRegSelect = document.getElementById('rtuFilterRegional');
        directors.forEach(d => rtuDirSelect.innerHTML += `<option value="${d}">${d}</option>`);
        regionals.forEach(r => rtuRegSelect.innerHTML += `<option value="${r}">${r}</option>`);
    }

    // ============================================================
    // TAB SWITCHING
    // ============================================================
    function switchTab(tab) {
        document.getElementById('heatmap-content').classList.toggle('hidden', tab !== 'heatmap');
        document.getElementById('rtu-content').classList.toggle('hidden', tab !== 'rtu');
        document.getElementById('tab-heatmap').classList.toggle('active', tab === 'heatmap');
        document.getElementById('tab-rtu').classList.toggle('active', tab === 'rtu');
        
        if (tab === 'heatmap') setTimeout(() => { if(heatmapMap) heatmapMap.invalidateSize(); renderHeatMap(); }, 100);
        if (tab === 'rtu') setTimeout(() => { initRtuMap(); }, 100);
    }

    // ============================================================
    // HEAT MAP - Uses REAL store data
    // ============================================================
    function initHeatMap() {
        if (heatmapMap) return;
        heatmapMap = L.map('heatmapMap').setView([31.0, -99.5], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM', maxZoom: 18 }).addTo(heatmapMap);
        renderHeatMap();
    }

    function renderHeatMap() {
        if (!heatmapMap || STORES.length === 0) return;
        
        // Clear markers
        heatmapMap.eachLayer(layer => { if (layer instanceof L.CircleMarker) heatmapMap.removeLayer(layer); });
        
        // Get filters
        const dirFilter = document.getElementById('filterDirector').value;
        const regFilter = document.getElementById('filterRegional').value;
        
        // Filter stores
        let filtered = STORES.filter(s => {
            if (dirFilter && s.dir !== dirFilter) return false;
            if (regFilter && s.rm !== regFilter) return false;
            return true;
        });
        
        let excellent = 0, good = 0, warning = 0, critical = 0;
        
        filtered.forEach(s => {
            const [lat, lng] = getCoords(s.city);
            const tnt = parseFloat(s.tnt) || 0;
            const storeNum = s.sn || '?';
            const city = s.city || '';
            const director = s.dir || 'N/A';
            const regional = s.rm || 'N/A';
            
            let color, status;
            if (tnt >= 95) { color = '#10b981'; status = 'Excellent'; excellent++; }
            else if (tnt >= 85) { color = '#f59e0b'; status = 'Good'; good++; }
            else if (tnt >= 75) { color = '#f97316'; status = 'Warning'; warning++; }
            else { color = '#ef4444'; status = 'Critical'; critical++; }
            
            L.circleMarker([lat, lng], { radius: 10, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9 })
                .bindPopup(`
                    <div style="font-family:system-ui;min-width:200px">
                        <div style="font-weight:bold;font-size:14px">Store #${storeNum}</div>
                        <div style="color:#666;font-size:12px;margin:4px 0">${city}</div>
                        <div style="background:#f3f4f6;padding:10px;border-radius:8px;text-align:center;margin:8px 0">
                            <div style="font-size:20px;font-weight:bold;color:${color}">${tnt.toFixed(1)}%</div>
                            <div style="font-size:11px;color:#666">TnT - ${status}</div>
                        </div>
                        <div style="font-size:11px;color:#666;border-top:1px solid #eee;padding-top:6px">
                            <div><strong>Director:</strong> ${director}</div>
                            <div><strong>Regional:</strong> ${regional}</div>
                        </div>
                    </div>
                `)
                .bindTooltip(`#${storeNum}: ${tnt.toFixed(1)}%`)
                .addTo(heatmapMap);
        });
        
        document.getElementById('statExcellent').textContent = excellent;
        document.getElementById('statGood').textContent = good;
        document.getElementById('statWarning').textContent = warning;
        document.getElementById('statCritical').textContent = critical;
        document.getElementById('storeCount').textContent = filtered.length;
        
        if (filtered.length > 0) {
            const bounds = filtered.map(s => getCoords(s.city));
            heatmapMap.fitBounds(bounds, { padding: [30, 30] });
        }
    }

    function resetFilters() {
        document.getElementById('filterDirector').value = '';
        document.getElementById('filterRegional').value = '';
        renderHeatMap();
    }

    // ============================================================
    // RTU/AHU BROKEN MAP - Uses REAL terminal unit data
    // ============================================================
    function initRtuMap() {
        if (!rtuMap) {
            rtuMap = L.map('rtuMap').setView([31.0, -99.5], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM', maxZoom: 18 }).addTo(rtuMap);
        }
        renderRtuMap();
    }

    function renderRtuMap() {
        if (!rtuMap) return;
        
        // Clear markers
        rtuMap.eachLayer(layer => { if (layer instanceof L.CircleMarker) rtuMap.removeLayer(layer); });
        
        const dirFilter = document.getElementById('rtuFilterDirector').value;
        const regFilter = document.getElementById('rtuFilterRegional').value;
        const issueFilter = document.getElementById('rtuFilterIssue').value;
        
        let commLoss = 0, alarms = 0, totalOnline = 0;
        const storeIssues = {};
        const tableData = [];
        
        // Process each store's units
        Object.keys(TERM_UNITS).forEach(storeNum => {
            const store = STORES.find(s => s.sn == storeNum);
            if (!store) return;
            
            // Apply filters
            if (dirFilter && store.dir !== dirFilter) return;
            if (regFilter && store.rm !== regFilter) return;
            
            const units = TERM_UNITS[storeNum] || [];
            let storeComm = 0, storeAlarm = 0;
            
            units.forEach(u => {
                const hasComm = u.lo > 0; // Comm loss/offline
                const hasAlarm = u.al > 0 || u.hf > 0; // Alarms or high failure
                
                if (issueFilter === 'comm' && !hasComm) return;
                if (issueFilter === 'alarm' && !hasAlarm) return;
                
                if (hasComm) { commLoss++; storeComm++; }
                if (hasAlarm) { alarms++; storeAlarm++; }
                if (!hasComm && !hasAlarm) { totalOnline++; }
                
                if (hasComm || hasAlarm) {
                    tableData.push({
                        store: storeNum,
                        city: store.city || '',
                        unit: u.un || 'Unit',
                        type: (u.ut || u.cl || '').toLowerCase().includes('rooftop') ? 'RTU' : 'AHU',
                        issue: hasComm ? 'comm' : 'alarm',
                        director: store.dir || 'N/A'
                    });
                }
            });
            
            if (storeComm > 0 || storeAlarm > 0) {
                storeIssues[storeNum] = { comm: storeComm, alarm: storeAlarm, store };
            }
        });
        
        // Add markers for stores with issues
        Object.values(storeIssues).forEach(({ comm, alarm, store }) => {
            const [lat, lng] = getCoords(store.city);
            
            let color = '#fbbf24'; // multiple
            if (comm > 0 && alarm === 0) color = '#ef4444'; // comm only
            else if (alarm > 0 && comm === 0) color = '#f97316'; // alarm only
            
            L.circleMarker([lat, lng], { radius: 12, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9 })
                .bindPopup(`
                    <div style="font-family:system-ui;min-width:200px">
                        <div style="font-weight:bold;font-size:14px">Store #${store.sn}</div>
                        <div style="color:#666;font-size:12px;margin:4px 0">${store.city || ''}</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0">
                            <div style="background:#fee2e2;padding:8px;border-radius:6px;text-align:center">
                                <div style="font-weight:bold;color:#dc2626">${comm}</div>
                                <div style="font-size:10px;color:#666">Comm Loss</div>
                            </div>
                            <div style="background:#ffedd5;padding:8px;border-radius:6px;text-align:center">
                                <div style="font-weight:bold;color:#ea580c">${alarm}</div>
                                <div style="font-size:10px;color:#666">Alarms</div>
                            </div>
                        </div>
                        <div style="font-size:11px;color:#666"><strong>Director:</strong> ${store.dir || 'N/A'}</div>
                    </div>
                `)
                .addTo(rtuMap);
        });
        
        // Update stats
        document.getElementById('rtuCommLoss').textContent = commLoss;
        document.getElementById('rtuAlarms').textContent = alarms;
        document.getElementById('rtuOffline').textContent = commLoss + alarms;
        document.getElementById('rtuOnline').textContent = totalOnline;
        document.getElementById('rtuIssueCount').textContent = tableData.length;
        
        // Update table
        document.getElementById('rtuTableBody').innerHTML = tableData.slice(0, 50).map(r => `
            <tr class="border-b border-gray-100 hover:bg-red-50">
                <td class="px-4 py-2 font-semibold">#${r.store} <span class="text-gray-400 text-xs">${r.city}</span></td>
                <td class="px-4 py-2">${r.unit}</td>
                <td class="px-4 py-2"><span class="px-2 py-1 rounded text-xs font-medium ${r.type==='RTU'?'bg-blue-100 text-blue-700':'bg-purple-100 text-purple-700'}">${r.type}</span></td>
                <td class="px-4 py-2"><span class="px-2 py-1 rounded text-xs font-medium ${r.issue==='comm'?'bg-red-100 text-red-700':'bg-orange-100 text-orange-700'}">${r.issue==='comm'?'üìµ Comm Loss':'‚ö†Ô∏è Alarm'}</span></td>
                <td class="px-4 py-2 text-sm text-gray-600">${r.director}</td>
            </tr>
        `).join('') || '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">No issues found</td></tr>';
        
        // Fit bounds
        const bounds = Object.values(storeIssues).map(({store}) => getCoords(store.city));
        if (bounds.length > 0) rtuMap.fitBounds(bounds, { padding: [30, 30] });
    }

    function resetRtuFilters() {
        document.getElementById('rtuFilterDirector').value = '';
        document.getElementById('rtuFilterRegional').value = '';
        document.getElementById('rtuFilterIssue').value = 'all';
        renderRtuMap();
    }

    // Start loading data
    document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>