<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Region 15B — HVAC Win-the-Winter Command Center | Franky Gonzalez</title>
    <meta http-equiv="refresh" content="300">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { colors: {
                /* ═══ FRANKY'S LIGHT ELEGANT PALETTE ═══ */
                franky: {
                    /* Primary: Soft Sky Blue */
                    sky: '#e0f2fe', skymed: '#7dd3fc', skydark: '#0ea5e9',
                    /* Secondary: Soft Lavender Purple */
                    lavender: '#f3e8ff', lavenderdark: '#a855f7',
                    /* Accent: Soft Mint Green */
                    mint: '#d1fae5', mintdark: '#10b981',
                    /* Warm: Soft Peach/Coral */
                    peach: '#ffedd5', peachdark: '#f97316',
                    /* Rose: Soft Pink */
                    rose: '#ffe4e6', rosedark: '#f43f5e',
                    /* Neutral */
                    cream: '#fefce8', sand: '#fef3c7'
                },
                walmart: { blue: '#0ea5e9', yellow: '#fbbf24', dark: '#0284c7', light: '#f0f9ff' }
            }}}
        }
    </script>
    <style>
        body { background: linear-gradient(180deg, #f0f9ff 0%, #ffffff 100%); }
        .kpi-card { 
            transition: all 0.3s ease; 
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
        }
        .kpi-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border-color: #7dd3fc;
        }
        .table-row:hover { background-color: #f0f9ff; }
        .tab-active { border-bottom-color: #0ea5e9; color: #0ea5e9; }
        
        /* Elegant Header */
        .wow-header {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 50%, #14b8a6 100%);
            position: relative;
            overflow: hidden;
        }
        .wow-header::before {
            content: '';
            position: absolute;
            top: -50%; right: -10%;
            width: 60%; height: 200%;
            background: radial-gradient(ellipse, rgba(255,255,255,0.15) 0%, transparent 70%);
        }
        
        /* Live Pulse */
        .live-dot {
            width: 12px; height: 12px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.6); }
            50% { box-shadow: 0 0 0 12px rgba(16, 185, 129, 0); }
        }
        
        /* Elegant Cards */
        .glass-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.05);
        }
        
        /* Heat Maps */
        #storeHealthMap, #ahuRtuMap {
            height: 500px;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        /* Tab Navigation */
        nav[role="tablist"] { scrollbar-width: thin; }
        nav[role="tablist"]::-webkit-scrollbar { height: 4px; }
        nav[role="tablist"]::-webkit-scrollbar-thumb { background: #7dd3fc; border-radius: 4px; }
        .tab-scroll-wrapper { position: relative; }
        .tab-scroll-wrapper::after {
            content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 40px;
            background: linear-gradient(to right, transparent, white);
            pointer-events: none;
        }
        @media (max-width: 640px) {
            nav[role="tablist"] button { padding: 0.75rem 0.5rem; font-size: 0.75rem; }
        }
        
        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #0ea5e9 0%, #10b981 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Status Pills */
        .pill-success { background: #d1fae5; color: #059669; }
        .pill-warning { background: #fef3c7; color: #d97706; }
        .pill-danger { background: #fee2e2; color: #dc2626; }
        .pill-info { background: #e0f2fe; color: #0284c7; }
    </style>
<script>
// Decode dictionary-encoded data back to array of objects
function decodeDictData(packed) {
  if (Array.isArray(packed)) return packed; // already decoded
  const {c: cols, d: dicts, r: rows} = packed;
  return rows.map(row => {
    const obj = {};
    cols.forEach((k, i) => {
      obj[k] = (dicts[k] != null) ? dicts[k][row[i]] : row[i];
    });
    return obj;
  });
}
// Lazy-load data files (split for fast GitHub Pages delivery)
document.addEventListener('DOMContentLoaded', async function() {
  const t0 = performance.now();
  await Promise.all([
  fetch('data/stores.json').then(r=>r.json()).then(d=>{window.STORES=STORES=decodeDictData(d);}),
  fetch('data/wos.json').then(r=>r.json()).then(d=>{window.WOS=WOS=decodeDictData(d);}),
  fetch('data/leaks.json').then(r=>r.json()).then(d=>{window.LEAKS=LEAKS=decodeDictData(d);}),
  fetch('data/hc_assets.json').then(r=>r.json()).then(d=>{window.HC_ASSETS=HC_ASSETS=d;}),
  fetch('data/terminal_hvac.json').then(r=>r.json()).then(d=>{window.TERMINAL_HVAC=TERMINAL_HVAC=d;}),
  fetch('data/store_emissions.json').then(r=>r.json()).then(d=>{window.STORE_EMISSIONS=STORE_EMISSIONS=d;}),
  fetch('data/ref_emissions.json').then(r=>r.json()).then(d=>{window.REF_EMISSIONS=REF_EMISSIONS=d;}),
  fetch('data/term_units.json').then(r=>r.json()).then(d=>{window.TERM_UNITS=TERM_UNITS=d;}),
  fetch('data/term_detail.json').then(r=>r.json()).then(d=>{window.TERM_DETAIL=TERM_DETAIL=decodeDictData(d);}),
  fetch('data/wtw_data.json').then(r=>r.json()).then(d=>{window.WTW_DATA=WTW_DATA=decodeDictData(d);}),
  fetch('data/wtw_org.json').then(r=>r.json()).then(d=>{window.WTW_ORG=WTW_ORG=d;}),
  fetch('data/yoy.json').then(r=>r.json()).then(d=>{window.YOY=YOY=d;}),
  fetch('data/ref_terminal.json').then(r=>r.json()).then(d=>{window.REF_TERMINAL=REF_TERMINAL=d;}),
  fetch('data/nps_fs.json').then(r=>r.json()).then(d=>{window.NPS_FS=NPS_FS=d;}),
  fetch('data/nps_ops.json').then(r=>r.json()).then(d=>{window.NPS_OPS=NPS_OPS=d;}),
  fetch('data/nps_region.json').then(r=>r.json()).then(d=>{window.NPS_REGION=NPS_REGION=d;}),
  fetch('data/leak_summary.json').then(r=>r.json()).then(d=>{window.LEAK_SUMMARY=LEAK_SUMMARY=d;}),
  fetch('data/refrig_projects.json').then(r=>r.json()).then(d=>{window.REFRIG_PROJECTS=REFRIG_PROJECTS=d;}),
  fetch('data/active_projects.json').then(r=>r.json()).then(d=>{window.ACTIVE_PROJECTS=ACTIVE_PROJECTS=decodeDictData(d);}),
  fetch('data/kpi_data.json').then(r=>r.json()).then(d=>{window.KPI_DATA=KPI_DATA=d;})
  ]);
  console.log(`Data loaded in ${(performance.now()-t0).toFixed(0)}ms`);
  // Re-trigger init if dashboard already loaded
  if (typeof initDashboard === 'function') initDashboard();
  if (typeof populateOverviewTab === 'function') populateOverviewTab();
});
</script>
</head>
<body class="bg-gray-50 min-h-screen">
<script>Chart.register(ChartDataLabels); Chart.defaults.plugins.datalabels = { display: false };</script>
<script>
    var STORES = []; // loaded from data/stores.json
    var WOS = []; // loaded from data/wos.json
    var LEAKS = []; // loaded from data/leaks.json
    var HC_ASSETS = []; // loaded from data/hc_assets.json
    const GENERATED = '2026-02-19 16:26';
    var TERMINAL_HVAC = {}; // loaded from data/terminal_hvac.json
    var STORE_EMISSIONS = {}; // loaded from data/store_emissions.json
    var REF_EMISSIONS = {}; // loaded from data/ref_emissions.json
    var TERM_UNITS = {}; // loaded from data/term_units.json
    var TERM_DETAIL = []; // loaded from data/term_detail.json
    var WTW_DATA = []; // loaded from data/wtw_data.json
    var WTW_ORG = {}; // loaded from data/wtw_org.json
    var YOY = {}; // loaded from data/yoy.json
    var REF_TERMINAL = []; // loaded from data/ref_terminal.json
    var NPS_FS = []; // loaded from data/nps_fs.json
    var NPS_OPS = []; // loaded from data/nps_ops.json
    var NPS_REGION = []; // loaded from data/nps_region.json
    var LEAK_SUMMARY = []; // loaded from data/leak_summary.json
    var REFRIG_PROJECTS = []; // loaded from data/refrig_projects.json
    var KPI_DATA = []; // loaded from data/kpi_data.json

    // Banner sets & global toggle (must be before exec_js / leak_js)
    const RETAIL = new Set(['WM Supercenter','Neighborhood Market',"Sam's Club",'Wal-Mart','Grocery']);
    const WM_BANNERS = new Set(['WM Supercenter','Wal-Mart','Grocery']);
    const NHM_BANNERS = new Set(['Neighborhood Market']);
    const SC_BANNERS = new Set(["Sam's Club"]);
    let currentTab = 'exec';
    let activeBanner = 'all';
    function getActiveBanners() {
        if (activeBanner === 'walmart') return WM_BANNERS;
        if (activeBanner === 'nhm') return NHM_BANNERS;
        if (activeBanner === 'sams') return SC_BANNERS;
        return RETAIL;
    }
    function setBanner(mode) {
        activeBanner = mode;
        const btnOrder = ['all','walmart','nhm','sams'];
        btnOrder.forEach((b, i) => {
            const btn = document.getElementById('bn-' + b);
            if (!btn) return;
            const isFirst = i === 0;
            const isLast = i === btnOrder.length - 1;
            const rounded = isFirst ? ' rounded-l-md' : isLast ? ' rounded-r-md' : '';
            if (b === mode) {
                btn.className = 'py-1.5 text-xs font-semibold border border-gray-300 bg-[#0ea5e9] text-white text-center' + rounded;
            } else {
                btn.className = 'py-1.5 text-xs font-semibold border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-center' + rounded;
            }
        });
        if (typeof initExecFilters === 'function') { initExecFilters(); applyExecFilters(); }
        if (typeof applyFilters === 'function' && (currentTab === 'tnt')) applyFilters();
        if (typeof wtwApplyFilter === 'function' && currentTab === 'wtw') wtwApplyFilter();
        if (typeof renderLeakTab === 'function' && currentTab === 'leak') renderLeakTab();
        if (typeof renderHvacTab === 'function' && currentTab === 'hvac') renderHvacTab();
        if (typeof renderNpsTab === 'function' && currentTab === 'nps') renderNpsTab();
        if (typeof renderGoalsTab === 'function' && currentTab === 'goals') renderGoalsTab();
        if (typeof renderProjectsTab === 'function' && currentTab === 'projects') renderProjectsTab();
        if (typeof renderKpiTab === 'function' && currentTab === 'kpi') renderKpiTab();
    }
    function avg(arr) { return arr.length ? arr.reduce((a,b) => a + b, 0) / arr.length : 0; }
</script>

<script>
// ══════════════════════════════════════════════════════════════
// Shared Utilities
// ══════════════════════════════════════════════════════════════

// HTML escaper — prevents XSS in innerHTML templates
function esc(s) {
    if (s == null) return '';
    var d = document.createElement('div');
    d.textContent = String(s);
    return d.innerHTML;
}

// ══════════════════════════════════════════════════════════════
// Fiscal Year Utilities (Walmart: Feb 1 → Jan 31)
// FY26 = Feb 1 2025 → Jan 31 2026
//
// TEMPLATE RULES:
//   1. activeFy defaults to null (All Time) — never filter on load
//   2. All getters (getWosFy, getLeaksFy) pass through raw data when activeFy=null
//   3. Every function guards against missing/empty data arrays
//   4. initFyPicker() MUST only be called from initDashboard() AFTER data loads
//   5. WTW_DATA is NOT filtered by FY (it's inherently single-FY)
// ══════════════════════════════════════════════════════════════

// ── Date → FY conversion ──
function dateToFy(dateStr) {
    if (!dateStr || typeof dateStr !== 'string') return null;
    var parts = dateStr.split('-');
    if (parts.length < 2) return null;
    var yr = parseInt(parts[0]), mo = parseInt(parts[1]);
    if (isNaN(yr) || isNaN(mo)) return null;
    return mo >= 2 ? yr - 2000 + 1 : yr - 2000;
}

function fyLabel(fyNum) { return fyNum ? 'FY' + fyNum : 'All Time'; }

function fyStartDate(fyNum) { return (2000 + fyNum - 1) + '-02-01'; }
function fyEndDate(fyNum)   { return (2000 + fyNum) + '-01-31'; }

function fyMonthIndex(dateStr) {
    if (!dateStr) return -1;
    var mo = parseInt(dateStr.split('-')[1]);
    if (isNaN(mo)) return -1;
    return mo >= 2 ? mo - 2 : 10;
}

var FY_MONTH_NAMES = ['Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan'];

function isInFy(dateStr, fyNum) {
    if (!dateStr || fyNum == null) return true; // no filter = pass through
    return dateToFy(dateStr) === fyNum;
}

// ── Global FY State ──
var activeFy = null;      // null = all time (SAFE default)
var availableFys = [];    // populated by initFyPicker

function currentFyNum() {
    var now = new Date();
    var yr = now.getFullYear(), mo = now.getMonth() + 1;
    return mo >= 2 ? yr - 2000 + 1 : yr - 2000;
}

function detectAvailableFys() {
    var fys = new Set();
    // Guard: only scan if data arrays exist and have items
    if (typeof WOS !== 'undefined' && Array.isArray(WOS)) {
        WOS.forEach(function(w) { var f = dateToFy(w.cd); if (f) fys.add(f); });
    }
    if (typeof LEAKS !== 'undefined' && Array.isArray(LEAKS)) {
        LEAKS.forEach(function(l) { var f = dateToFy(l.cd); if (f) fys.add(f); });
    }
    if (typeof WTW_DATA !== 'undefined' && Array.isArray(WTW_DATA)) {
        WTW_DATA.forEach(function(d) {
            if (d.sch) { var f = dateToFy(d.sch + '-01'); if (f) fys.add(f); }
        });
    }
    availableFys = Array.from(fys).sort().reverse();
}

function initFyPicker() {
    detectAvailableFys();
    activeFy = null; // ALWAYS start with All Time

    var sel = document.getElementById('fyPicker');
    if (!sel) return;
    sel.innerHTML = '<option value="" selected>All Time</option>' +
        availableFys.map(function(f) {
            var label = fyLabel(f) + ' (Feb ' + (2000 + f - 1) + ' \u2013 Jan ' + (2000 + f) + ')';
            return '<option value="' + f + '">' + label + '</option>';
        }).join('');
    var lbl = document.getElementById('fyActiveLabel');
    if (lbl) lbl.textContent = 'All Time';
}

function setFiscalYear(val) {
    activeFy = val ? parseInt(val) : null;
    var lbl = document.getElementById('fyActiveLabel');
    if (lbl) {
        lbl.textContent = activeFy
            ? fyLabel(activeFy) + ' (Feb ' + (2000 + activeFy - 1) + ' \u2013 Jan ' + (2000 + activeFy) + ')'
            : 'All Time';
    }
    var hdr = document.getElementById('headerFyLabel');
    if (hdr) hdr.textContent = activeFy ? fyLabel(activeFy) : 'FY' + currentFyNum();
    refreshCurrentTab();
}

function refreshCurrentTab() {
    if (currentTab === 'exec' && typeof applyExecFilters === 'function') applyExecFilters();
    if (currentTab === 'tnt' && typeof applyFilters === 'function') applyFilters();
    if (currentTab === 'wtw' && typeof wtwApplyFilter === 'function') wtwApplyFilter();
    if (currentTab === 'leak' && typeof renderLeakTab === 'function') renderLeakTab();
    if (currentTab === 'hvac' && typeof renderHvacTab === 'function') renderHvacTab();
    if (currentTab === 'nps' && typeof renderNpsTab === 'function') renderNpsTab();
    if (currentTab === 'goals' && typeof renderGoalsTab === 'function') renderGoalsTab();
    if (currentTab === 'projects' && typeof renderProjectsTab === 'function') renderProjectsTab();
}

// ── FY-filtered data getters ──
// Rule: when activeFy is null, return the FULL raw array (no filtering)
function getWosFy() {
    if (!activeFy) return WOS;
    return WOS.filter(function(w) { return isInFy(w.cd, activeFy); });
}

function getLeaksFy() {
    if (!activeFy) return LEAKS;
    return LEAKS.filter(function(l) { return isInFy(l.cd, activeFy); });
}

// NOTE: WTW_DATA is NOT filtered by FY — it's inherently single-FY program data.
// This getter exists for YoY summary building only.
function getWtwFy() {
    if (!activeFy) return WTW_DATA;
    return WTW_DATA.filter(function(d) {
        return d.sch ? isInFy(d.sch + '-01', activeFy) : true;
    });
}

// ── FY Summary Stats (for YoY comparison) ──
function buildFySummary() {
    var summary = {};
    if (!availableFys.length) return summary;
    availableFys.forEach(function(fy) {
        var wos = WOS.filter(function(w) { return isInFy(w.cd, fy); });
        var leaks = LEAKS.filter(function(l) { return isInFy(l.cd, fy); });
        var wosDone = wos.filter(function(w) { return w.st === 'COMPLETED' || w.st === 'Completed'; }).length;
        var leaksDone = leaks.filter(function(l) { return l.st === 'Completed'; }).length;
        var totalNte = wos.reduce(function(a, w) { return a + (w.nte || 0); }, 0);
        var leakNte = leaks.reduce(function(a, l) { return a + (l.nte || 0); }, 0);
        var totalLoss = 0;
        var storeNums = new Set(wos.map(function(w) { return w.sn; }));
        STORES.forEach(function(s) {
            if (storeNums.has(s.sn)) totalLoss += (s.loss || 0);
        });
        summary[fy] = {
            fy: fy, label: fyLabel(fy),
            period: 'Feb ' + (2000 + fy - 1) + ' \u2013 Jan ' + (2000 + fy),
            wos: wos.length, wosDone: wosDone,
            wosPct: wos.length ? Math.round(100 * wosDone / wos.length) : 0,
            leaks: leaks.length, leaksDone: leaksDone,
            leaksPct: leaks.length ? Math.round(100 * leaksDone / leaks.length) : 0,
            nte: Math.round(totalNte), leakNte: Math.round(leakNte),
            loss: Math.round(totalLoss),
        };
    });
    return summary;
}

// ── Monthly breakdown for a FY ──
function buildFyMonthly(fy) {
    var months = new Array(12).fill(null).map(function(_, i) {
        return { idx: i, label: FY_MONTH_NAMES[i], wos: 0, wosDone: 0, leaks: 0, leaksDone: 0, nte: 0 };
    });
    WOS.filter(function(w) { return isInFy(w.cd, fy); }).forEach(function(w) {
        var mi = fyMonthIndex(w.cd);
        if (mi >= 0 && mi < 12) {
            months[mi].wos++;
            if (w.st === 'COMPLETED' || w.st === 'Completed') months[mi].wosDone++;
            months[mi].nte += (w.nte || 0);
        }
    });
    LEAKS.filter(function(l) { return isInFy(l.cd, fy); }).forEach(function(l) {
        var mi = fyMonthIndex(l.cd);
        if (mi >= 0 && mi < 12) {
            months[mi].leaks++;
            if (l.st === 'Completed') months[mi].leaksDone++;
        }
    });
    return months;
}

// ══════════════════════════════════════════════════════════════
// Composite Ranking Algorithm
// Combines: TnT Ref, HVAC, Dewpoint, Rack, PM Score, Loss, WTW
// Each metric is normalized to 0-100, then weighted.
// Higher composite = better performance.
// ══════════════════════════════════════════════════════════════
function compositeScore(row) {
    var W = (typeof GOALS !== 'undefined' && GOALS.composite_rank) || {
        tnt_weight: 0.25, hvac_weight: 0.15, dewpoint_weight: 0.15,
        rack_weight: 0.15, pm_weight: 0.10, loss_weight: 0.10, wtw_weight: 0.10,
        dewpoint_target: 52, loss_normalization: 500000
    };
    var score = 0, totalWeight = 0;

    // TnT Ref (0-100%, higher = better)
    if (row.tnt != null) { score += (row.tnt) * W.tnt_weight; totalWeight += W.tnt_weight; }
    // HVAC (0-100%, higher = better)
    if (row.hvac != null) { score += (row.hvac) * W.hvac_weight; totalWeight += W.hvac_weight; }
    // Dewpoint (lower = better, invert: score = max(0, 100 - penalty))
    if (row.dp != null) {
        var dpScore = Math.max(0, 100 - Math.max(0, row.dp - W.dewpoint_target) * 5);
        score += dpScore * W.dewpoint_weight; totalWeight += W.dewpoint_weight;
    }
    // Rack (0-100%, higher = better)
    if (row.rack != null) { score += (row.rack) * W.rack_weight; totalWeight += W.rack_weight; }
    // PM Score (0-100%, higher = better)
    if (row.pm != null) { score += (row.pm) * W.pm_weight; totalWeight += W.pm_weight; }
    // Loss (lower = better, invert: score = max(0, 100 - (loss / norm * 100)))
    if (row.loss != null) {
        var lossScore = Math.max(0, 100 - (row.loss / W.loss_normalization) * 100);
        score += lossScore * W.loss_weight; totalWeight += W.loss_weight;
    }
    // WTW % (0-100%, higher = better)
    if (row.wtwPct != null) { score += (row.wtwPct) * W.wtw_weight; totalWeight += W.wtw_weight; }

    // Normalize: if not all metrics available, scale up proportionally
    if (totalWeight <= 0) return null;
    return score / totalWeight;
}

function compositeColor(v) {
    if (v == null) return 'text-gray-400';
    if (v >= 90) return 'text-green-600';
    if (v >= 80) return 'text-yellow-600';
    if (v >= 70) return 'text-orange-600';
    return 'text-red-600 font-bold';
}

function compositeGrade(v) {
    if (v == null) return '--';
    if (v >= 95) return 'A+';
    if (v >= 90) return 'A';
    if (v >= 85) return 'A-';
    if (v >= 80) return 'B+';
    if (v >= 75) return 'B';
    if (v >= 70) return 'B-';
    if (v >= 65) return 'C+';
    if (v >= 60) return 'C';
    return 'D';
}
</script>

<script>
// ══════════════════════════════════════════════════════════════
// Dashboard Export Utilities
// Supports: CSV (tables), PNG (charts), text (insights)
// ══════════════════════════════════════════════════════════════

function _exportTimestamp() {
    var d = new Date();
    return d.getFullYear() + '-' +
        String(d.getMonth() + 1).padStart(2, '0') + '-' +
        String(d.getDate()).padStart(2, '0') + '_' +
        String(d.getHours()).padStart(2, '0') +
        String(d.getMinutes()).padStart(2, '0');
}

function _downloadFile(filename, content, mimeType) {
    var blob = new Blob([content], { type: mimeType });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function _downloadCanvas(filename, canvas) {
    var a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// ── CSV Export from HTML table ──
function exportTableCSV(tableEl, filename) {
    if (!tableEl) return;
    var rows = [];
    // Headers
    var thead = tableEl.querySelector('thead');
    if (thead) {
        var headerRow = [];
        thead.querySelectorAll('th').forEach(function(th) {
            headerRow.push('"' + (th.textContent || '').trim().replace(/"/g, '""') + '"');
        });
        rows.push(headerRow.join(','));
    }
    // Body rows
    var tbody = tableEl.querySelector('tbody') || tableEl;
    tbody.querySelectorAll('tr').forEach(function(tr) {
        if (tr.closest('thead')) return;
        var cells = [];
        tr.querySelectorAll('td, th').forEach(function(td) {
            var text = (td.textContent || '').trim().replace(/"/g, '""');
            cells.push('"' + text + '"');
        });
        if (cells.length > 0) rows.push(cells.join(','));
    });
    if (rows.length === 0) { _exportToast('No data to export'); return; }
    var fn = (filename || 'export') + '_' + _exportTimestamp() + '.csv';
    _downloadFile(fn, '\uFEFF' + rows.join('\n'), 'text/csv;charset=utf-8');
    _exportToast('Exported ' + (rows.length - 1) + ' rows → ' + fn);
}

// ── CSV Export from data array ──
function exportDataCSV(data, columns, filename) {
    if (!data || !data.length) { _exportToast('No data to export'); return; }
    var rows = [];
    // Header
    rows.push(columns.map(function(c) { return '"' + (c.label || c.key) + '"'; }).join(','));
    // Data
    data.forEach(function(row) {
        var cells = columns.map(function(c) {
            var v = row[c.key];
            if (v == null) return '""';
            var s = String(c.fmt ? c.fmt(v) : v).replace(/"/g, '""');
            return '"' + s + '"';
        });
        rows.push(cells.join(','));
    });
    var fn = (filename || 'export') + '_' + _exportTimestamp() + '.csv';
    _downloadFile(fn, '\uFEFF' + rows.join('\n'), 'text/csv;charset=utf-8');
    _exportToast('Exported ' + data.length + ' rows → ' + fn);
}

// ── Chart PNG Export ──
function exportChartPNG(chartId, filename) {
    var canvas = document.getElementById(chartId);
    if (!canvas) { _exportToast('Chart not found'); return; }
    var fn = (filename || chartId) + '_' + _exportTimestamp() + '.png';
    _downloadCanvas(fn, canvas);
    _exportToast('Chart saved → ' + fn);
}

// ── Export any section (auto-detect content) ──
function exportSection(sectionEl, filename) {
    if (!sectionEl) return;
    // Check for table first
    var table = sectionEl.querySelector('table');
    if (table && table.querySelector('tbody tr')) {
        exportTableCSV(table, filename);
        return;
    }
    // Check for chart canvas
    var canvas = sectionEl.querySelector('canvas');
    if (canvas) {
        exportChartPNG(canvas.id, filename);
        return;
    }
    // Fallback: export text content
    var text = (sectionEl.textContent || '').trim();
    if (text) {
        var fn = (filename || 'export') + '_' + _exportTimestamp() + '.txt';
        _downloadFile(fn, text, 'text/plain;charset=utf-8');
        _exportToast('Text saved → ' + fn);
    }
}

// ── Toast notification ──
function _exportToast(msg) {
    var existing = document.getElementById('exportToast');
    if (existing) existing.remove();
    var toast = document.createElement('div');
    toast.id = 'exportToast';
    toast.className = 'fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg z-[999] text-sm flex items-center gap-2 transition-opacity duration-300';
    toast.innerHTML = '<span>\u2705</span> ' + msg;
    document.body.appendChild(toast);
    setTimeout(function() { toast.style.opacity = '0'; }, 2500);
    setTimeout(function() { toast.remove(); }, 3000);
}

// ── Export button factory ──
function makeExportBtn(onclick, title) {
    return '<button onclick="' + onclick + '" title="' + (title || 'Export') +
        '" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200" aria-label="' +
        (title || 'Export') + '">&#x1F4E5;</button>';
}

// ── Export all tables & charts in the current tab ──
function exportAllCurrentTab() {
    var tabEl = document.getElementById(currentTab + '-content');
    if (!tabEl) { _exportToast('No active tab found'); return; }
    var tabName = currentTab;
    var exported = 0;

    // Export all visible tables
    tabEl.querySelectorAll('table').forEach(function(table) {
        var tbody = table.querySelector('tbody');
        if (!tbody || tbody.children.length === 0) return;
        // Derive name from closest heading
        var section = table.closest('.bg-white, .rounded-lg');
        var heading = section ? (section.querySelector('h2, h3') || {}) : {};
        var name = (heading.textContent || 'table').trim().replace(/[^a-zA-Z0-9]+/g, '_').substring(0, 40).toLowerCase();
        exportTableCSV(table, tabName + '_' + name);
        exported++;
    });

    // Export all visible charts
    tabEl.querySelectorAll('canvas').forEach(function(canvas) {
        if (!canvas.id) return;
        // Only export if chart has data (chartInst exists)
        if (typeof chartInst !== 'undefined' && chartInst[canvas.id]) {
            exportChartPNG(canvas.id, tabName + '_' + canvas.id);
            exported++;
        } else {
            // Try Chart.js registry
            var ci = Chart.getChart(canvas);
            if (ci) {
                exportChartPNG(canvas.id, tabName + '_' + canvas.id);
                exported++;
            }
        }
    });

    if (exported === 0) {
        _exportToast('No exportable content found in this tab');
    } else {
        _exportToast('Exported ' + exported + ' item' + (exported !== 1 ? 's' : '') + ' from ' + tabName.toUpperCase() + ' tab');
    }
}
// ── Auto-inject bottom export buttons into every box ──
function _injectBottomExportButtons() {
    document.querySelectorAll('.bg-white.rounded-lg, .bg-white.rounded-xl').forEach(function(box) {
        // Find the header export button in this box
        var headerBtn = box.querySelector('button[onclick*="export"]:not(.export-bottom button)');
        if (!headerBtn) return;
        // Skip if already has a bottom export
        if (box.querySelector('.export-bottom')) {
            headerBtn.remove();
            return;
        }
        var wrapper = document.createElement('div');
        wrapper.className = 'export-bottom flex justify-end mt-3 pt-2 border-t border-gray-100';
        var btn = document.createElement('button');
        btn.setAttribute('onclick', headerBtn.getAttribute('onclick'));
        btn.setAttribute('title', headerBtn.getAttribute('title') || 'Export');
        btn.setAttribute('aria-label', headerBtn.getAttribute('aria-label') || 'Export');
        btn.className = 'px-3 py-1.5 text-xs font-medium text-[#0ea5e9] hover:bg-blue-50 rounded-md transition border border-blue-200 hover:border-[#0ea5e9] inline-flex items-center gap-1';
        btn.innerHTML = '&#x1F4E5; Export';
        wrapper.appendChild(btn);
        box.appendChild(wrapper);
        // Remove the header button
        headerBtn.remove();
    });
}
document.addEventListener('DOMContentLoaded', function() {
    // Inject after initial render
    setTimeout(_injectBottomExportButtons, 500);
});
</script>

<!-- ════════════════════════════════════════════════════════════════════════════════════════════ -->
<!-- FRANKY'S WOW HEADER -->
<!-- ════════════════════════════════════════════════════════════════════════════════════════════ -->
<header class="wow-header text-white shadow-xl">
    <div class="max-w-7xl mx-auto px-4 py-6 relative z-10">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4">
            <!-- Title Section -->
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-2xl bg-white/20 backdrop-blur flex items-center justify-center text-4xl shadow-lg">❄️</div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Region 15B Command Center</h1>
                    <p class="text-cyan-100 text-sm mt-1">
                        <span class="inline-flex items-center gap-2 bg-white/20 px-3 py-1 rounded-full text-xs font-medium">
                            👤 FM Director: <strong class="text-yellow-300">Franky Gonzalez</strong>
                        </span>
                        <span class="inline-flex items-center gap-2 bg-white/20 px-3 py-1 rounded-full text-xs font-medium ml-2">
                            🏆 Sr. Director: <strong class="text-emerald-300">B.A. Glass</strong>
                        </span>
                    </p>
                </div>
            </div>
            <!-- Stats + FY Picker -->
            <div class="flex items-center gap-6">
                <div class="text-center hidden md:block">
                    <p class="text-4xl font-bold text-white drop-shadow" id="heroStores">--</p>
                    <p class="text-xs text-cyan-200 font-medium">STORES</p>
                </div>
                <div class="text-center hidden md:block">
                    <p class="text-4xl font-bold text-emerald-300 drop-shadow" id="heroTnT">--%</p>
                    <p class="text-xs text-cyan-200 font-medium">AVG TnT</p>
                </div>
                <div class="text-center hidden md:block">
                    <p class="text-4xl font-bold text-yellow-300 drop-shadow" id="heroWTW">--</p>
                    <p class="text-xs text-cyan-200 font-medium">WTW PHASE</p>
                </div>
                <div class="bg-white/20 backdrop-blur rounded-xl p-3">
                    <label for="fyPicker" class="text-xs text-cyan-200 block mb-1 text-center">Fiscal Year</label>
                    <select id="fyPicker" onchange="setFiscalYear(this.value)" class="bg-white text-gray-800 border-0 rounded-lg px-4 py-2 text-sm font-semibold shadow-lg cursor-pointer" style="min-width:140px">
                        <option value="">All Time</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- ═══ LIVE REFRESH BAR ═══ -->
<div class="bg-gradient-to-r from-emerald-50 via-white to-sky-50 border-b border-gray-200 px-4 py-3 shadow-sm">
    <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-4">
            <div class="live-dot"></div>
            <span class="text-emerald-600 font-bold text-sm">LIVE DATA</span>
            <div class="flex items-center gap-2">
                <span class="text-gray-500 text-sm">Auto-refresh:</span>
                <span id="countdownText" class="text-sky-600 font-mono font-bold text-lg">5:00</span>
            </div>
            <div class="w-40 h-2 bg-gray-200 rounded-full overflow-hidden">
                <div id="countdownBar" class="h-full bg-gradient-to-r from-emerald-400 to-sky-400 transition-all" style="width:100%"></div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-gray-500 text-sm">Last updated: <span id="lastUpdated" class="text-gray-700 font-medium">--</span></span>
            <button onclick="location.reload()" class="px-5 py-2.5 bg-gradient-to-r from-sky-500 to-cyan-500 hover:from-sky-600 hover:to-cyan-600 text-white font-bold text-sm rounded-xl shadow-lg shadow-sky-500/30 transition-all hover:scale-105">
                🔄 Refresh Now
            </button>
        </div>
    </div>
</div>

<!-- Banner Toggle + Tab Navigation -->
<div class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-2">
        <div class="tab-scroll-wrapper flex-1 min-w-0">
        <nav class="flex space-x-2 sm:space-x-4 overflow-x-auto pb-0 w-full lg:w-auto -mb-px" role="tablist" aria-label="Dashboard Tabs" style="-webkit-overflow-scrolling:touch">
            <button onclick="switchTab('exec')" id="tab-exec" role="tab" aria-selected="true" aria-controls="exec-content"
                class="border-b-3 border-sky-500 text-sky-600 py-4 px-2 text-sm font-semibold whitespace-nowrap">📋 Executive</button>
            <button onclick="switchTab('storemap')" id="tab-storemap" role="tab" aria-selected="false" aria-controls="storemap-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">🗺️ Heat Map</button>
            <button onclick="switchTab('ahumap')" id="tab-ahumap" role="tab" aria-selected="false" aria-controls="ahumap-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">🚨 RTU/AHU Broken</button>
            <button onclick="switchTab('tnt')" id="tab-tnt" role="tab" aria-selected="false" aria-controls="tnt-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">📊 TnT</button>
            <button onclick="switchTab('wtw')" id="tab-wtw" role="tab" aria-selected="false" aria-controls="wtw-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">❄️ WTW</button>
            <button onclick="switchTab('leak')" id="tab-leak" role="tab" aria-selected="false" aria-controls="leak-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">💧 Leaks</button>
            <button onclick="switchTab('hvac')" id="tab-hvac" role="tab" aria-selected="false" aria-controls="hvac-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">❄️ HVAC</button>
            <button onclick="switchTab('mm')" id="tab-mm" role="tab" aria-selected="false" aria-controls="mm-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">📱 MM</button>
            <button onclick="switchTab('nps')" id="tab-nps" role="tab" aria-selected="false" aria-controls="nps-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">⭐ NPS</button>
            <button onclick="switchTab('goals')" id="tab-goals" role="tab" aria-selected="false" aria-controls="goals-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">🎯 Goals</button>
            <button onclick="switchTab('projects')" id="tab-projects" role="tab" aria-selected="false" aria-controls="projects-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">🏗️ Projects</button>
            <button onclick="switchTab('kpi')" id="tab-kpi" role="tab" aria-selected="false" aria-controls="kpi-content"
                class="border-b-3 border-transparent text-gray-500 hover:text-sky-600 py-4 px-2 text-sm font-medium whitespace-nowrap">📊 KPIs</button>
        </nav>
        </div>
        <!-- Banner Toggle -->
        <div class="grid grid-cols-4 w-full sm:w-[420px] py-2 flex-shrink-0" id="bannerToggle" role="group" aria-label="Store banner filter">
            <button onclick="setBanner('all')" id="bn-all"
                class="py-2 text-xs font-semibold rounded-l-xl border border-gray-200 bg-gradient-to-r from-sky-500 to-cyan-500 text-white text-center shadow">All</button>
            <button onclick="setBanner('walmart')" id="bn-walmart"
                class="py-1.5 text-xs font-semibold border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-center">Walmart</button>
            <button onclick="setBanner('nhm')" id="bn-nhm"
                class="py-1.5 text-xs font-semibold border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-center">NHM</button>
            <button onclick="setBanner('sams')" id="bn-sams"
                class="py-1.5 text-xs font-semibold rounded-r-md border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 text-center">Sam's Club</button>
        </div>
        </div>
    </div>
</div>

<!-- Executive Insights Tab -->
<div id="exec-content">
<main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Executive Header -->
    <div class="bg-gradient-to-r from-walmart-dark to-walmart-blue rounded-lg shadow-lg p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">&#x1F4CB; Executive Summary &mdash; HVAC/R &amp; Win the Winter <span id="execFyLabel">FY26</span></h1>
                <p class="text-blue-200 mt-1">High-level view for leadership &middot; Data as of <span id="execTs"></span> &middot; <span id="execPeriod" class="font-semibold text-white"></span></p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-center"><p class="text-3xl font-bold" id="execStoreCount">--</p><p class="text-xs text-blue-200">Retail Stores</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="execWoCount">--</p><p class="text-xs text-blue-200">WTW Work Orders</p></div>
                <button onclick="toggleYoy('exec')" id="yoyToggleExec" class="ml-4 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-semibold flex items-center gap-1.5 transition" title="Toggle Year-over-Year view">
                    &#x1F4C5; <span>YoY</span>
                </button>

            </div>
        </div>
    </div>

    <!-- Exec Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
                <h3 class="text-sm font-medium text-gray-700">&#x1F50D; Filter View</h3>
                <span class="text-xs text-gray-400" id="execFilterLabel">Showing all retail stores</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <input type="text" id="exNameSearch" placeholder="Search by name..." autocomplete="off"
                        oninput="nameSearch('ex', this.value)"
                        class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-48 focus:ring-2 focus:ring-[#0ea5e9] focus:border-[#0ea5e9] pl-8">
                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs">&#x1F50D;</span>
                    <div id="exNameResults" class="hidden absolute z-50 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
                <button onclick="clearExecFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-md">
                    &#x2715; Clear Filters
                </button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ops Region</label>
                <select id="exOps" onchange="applyExecFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Ops Regions</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sr. Director</label>
                <select id="exSr" onchange="applyExecFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Sr. Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FM Director</label>
                <select id="exDir" onchange="applyExecFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Regional Manager</label>
                <select id="exRm" onchange="applyExecFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Managers</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FS Manager</label>
                <select id="exFsm" onchange="applyExecFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All FS Managers</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Top-line AI Analysis -->
    <div class="bg-white rounded-lg shadow border-l-4 border-walmart-blue p-5 mb-6">
        <div class="flex justify-between items-center mb-3"><h2 class="text-lg font-bold text-gray-800">&#x1F9E0; Key Findings &amp; Analysis</h2><button onclick="exportSection(this.closest('.bg-white'),'exec_key_findings')" title="Export" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
        <div id="execKeyFindings" class="text-sm text-gray-700 space-y-3"></div>
    </div>

    <!-- Scorecard Row -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6" id="execScoreCards"></div>

    <!-- Charts Row 1: TnT Distribution + WTW Completion -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4CA; Refrigeration TnT Distribution</h3><button onclick="exportChartPNG('execTntDist','exec_tnt_distribution')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">How many stores fall in each performance bracket</p>
            <div style="height:280px"><canvas id="execTntDist"></canvas></div>
            <div id="tntDrillPanel" class="hidden mt-3 border-t border-gray-200 pt-3">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-sm font-semibold text-gray-700">&#x1F50D; <span id="tntDrillTitle"></span></h4>
                    <button onclick="document.getElementById('tntDrillPanel').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-sm">&times; Close</button>
                </div>
                <div class="overflow-x-auto" style="max-height:260px;overflow-y:auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50 sticky top-0"><tr>
                            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500">Store</th>
                            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500">City</th>
                            <th class="px-2 py-1 text-left text-xs font-medium text-gray-500">RM</th>
                            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">TnT</th>
                            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">30d</th>
                            <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">HVAC</th>
                            <th class="px-2 py-1 text-right text-xs font-medium text-gray-500">Loss</th>
                        </tr></thead>
                        <tbody id="tntDrillBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x2744; WTW Completion by Phase</h3><button onclick="exportChartPNG('execWtwPhase','exec_wtw_phase')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Work order progress across all 3 phases</p>
            <div style="height:280px"><canvas id="execWtwPhase"></canvas></div>
        </div>
    </div>

    <!-- Charts Row 2: Sr Director Heatmap + Loss Pareto -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F3AF; Sr. Director Performance Comparison</h3><button onclick="exportChartPNG('execSrCompare','exec_sr_comparison')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">TnT Ref, HVAC, Dewpoint, and PM Score side by side</p>
            <div style="height:320px"><canvas id="execSrCompare"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4B0; Top 10 Loss Contributors</h3><button onclick="exportChartPNG('execLossPareto','exec_top10_loss')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-1">Stores driving the most dollar loss across the fleet</p>
            <div class="bg-blue-50 border border-blue-200 rounded-md px-3 py-2 mb-3">
                <p class="text-xs text-blue-800"><strong>&#x2139;&#xFE0F; How this is calculated:</strong>
                    Loss dollars represent the <strong>total_loss</strong> field from ServiceChannel's
                    <em>store_tabular_view</em> in Crystal MDM. This is a <strong>rolling cumulative figure</strong>
                    reflecting refrigerant-related product loss per store (not time-bounded to a single fiscal year).
                    It includes spoilage, shrink, and temperature-related losses tied to refrigeration &amp; HVAC
                    system performance. Data is refreshed each time the dashboard is rebuilt.
                    <span class="font-semibold">Last refreshed: <span id="lossRefreshTs"></span></span>
                </p>
            </div>
            <div style="height:300px"><canvas id="execLossPareto"></canvas></div>
        </div>
    </div>

    <!-- Risk & Wins -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Risks -->
        <div class="bg-red-50 border border-red-200 rounded-lg p-5">
            <h3 class="text-base font-bold text-red-800 mb-3">&#x26A0; Risk Areas &amp; Concerns</h3>
            <div id="execRisks" class="text-sm text-red-700 space-y-2"></div>
        </div>
        <!-- Wins -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-5">
            <h3 class="text-base font-bold text-green-800 mb-3">&#x2705; Wins &amp; Bright Spots</h3>
            <div id="execWins" class="text-sm text-green-700 space-y-2"></div>
        </div>
    </div>

    <!-- Regional Ranking Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200">
            <div class="flex justify-between items-center">
            <div><h2 class="text-lg font-semibold text-gray-800">&#x1F3C6; Sr. Director Scorecard</h2>
            <p class="text-xs text-gray-500">Ranked by composite score (TnT 25% + HVAC 15% + Dewpoint 15% + Rack 15% + PM 10% + Loss 10% + WTW 10%) &middot; Click to drill into TnT tab</p></div>
            <button onclick="exportTableCSV(document.getElementById('execRankBody').closest('table'),'exec_scorecard')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"><tr>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500">Rank</th>
                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500">Sr. Director</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">Stores</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">TnT Ref</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">HVAC</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">Dewpoint</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">Rack</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">PM Score</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 bg-blue-50">Composite</th>
                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500">Loss ($)</th>
                    <th class="px-3 py-3 text-center text-xs font-medium text-gray-500">WTW %</th>
                </tr></thead>
                <tbody id="execRankBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <!-- Recommendations -->
    <div class="bg-walmart-light border border-blue-200 rounded-lg p-5 mb-6">
        <div class="flex justify-between items-center mb-3"><h3 class="text-base font-bold text-walmart-dark">&#x1F4A1; Recommendations for Leadership</h3><button onclick="exportSection(this.closest('.bg-white,.p-5'),'.exec_recommendations')" title="Export" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
        <div id="execRecommendations" class="text-sm text-gray-700 space-y-2"></div>
    </div>

    <!-- YoY Section (toggled) -->
    <div id="yoyExecWrap" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-base font-bold text-walmart-dark mb-4">&#x1F4C5; Fiscal Year-over-Year Comparison (Feb–Jan)</h3>
            <p class="text-xs text-gray-500 mb-4">All metrics aligned to Walmart fiscal year (Feb 1 – Jan 31)</p>

            <!-- FY Summary Table -->
            <div id="fyCompTable" class="mb-6"></div>

            <!-- Monthly Overlay Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">Monthly Work Orders (FY Overlay)</h4>
                    <div style="height:280px"><canvas id="fyCompWos"></canvas></div>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">Monthly Leak WOs (FY Overlay)</h4>
                    <div style="height:280px"><canvas id="fyCompLeaks"></canvas></div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">Monthly NTE Spend (FY Overlay)</h4>
                    <div style="height:280px"><canvas id="fyCompNte"></canvas></div>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">WO Completion Rate (FY Overlay)</h4>
                    <div style="height:280px"><canvas id="fyCompDone"></canvas></div>
                </div>
            </div>

            <!-- WTW Monthly & Phase Charts (built from actual WOS data) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">WTW Work Orders by Month (FY Overlay)</h4>
                    <div style="height:280px"><canvas id="yoyExecWtwMonthly"></canvas></div>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">WTW Completion by Phase</h4>
                    <div style="height:280px"><canvas id="yoyExecWtwPhase"></canvas></div>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-sm font-semibold text-gray-600 mb-2">WTW Program Completion by Fiscal Year</h4>
                <div style="height:220px"><canvas id="yoyExecWtw"></canvas></div>
            </div>
        </div>
    </div>
    <div class="flex justify-center py-4"><button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="px-4 py-2 bg-[#0ea5e9] hover:bg-[#004c91] text-white text-sm font-semibold rounded-lg flex items-center gap-2 shadow transition">&#x2B06; Back to Top</button></div>
</main>
</div>

<!-- Filters -->
<div id="tnt-content" class="hidden">
<main class="max-w-7xl mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-medium text-gray-700">Filters</h3>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <input type="text" id="fNameSearch" placeholder="Search by name..." autocomplete="off"
                        oninput="nameSearch('f', this.value)"
                        class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-48 focus:ring-2 focus:ring-[#0ea5e9] focus:border-[#0ea5e9] pl-8">
                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs">&#x1F50D;</span>
                    <div id="fNameResults" class="hidden absolute z-50 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
                <button onclick="toggleYoy('tnt')" id="yoyToggleTnt" class="px-3 py-1 bg-gray-100 hover:bg-[#0ea5e9] hover:text-white text-gray-600 text-sm rounded-md font-semibold transition flex items-center gap-1">
                    &#x1F4C5; YoY
                </button>

                <button onclick="clearAllFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-md">
                    &#x2715; Clear All Filters
                </button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ops Region</label>
                <select id="fOps" onchange="applyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Ops Regions</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sr. Director</label>
                <select id="fSr" onchange="applyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Sr. Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FM Director</label>
                <select id="fDir" onchange="applyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Regional Manager</label>
                <select id="fRm" onchange="applyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Managers</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FS Manager</label>
                <select id="fFsm" onchange="applyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All FS Managers</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Market</label>
                <select id="fMkt" onchange="applyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Markets</option>
                </select>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-walmart-blue">
            <p class="text-sm text-gray-500 uppercase tracking-wide">Current TnT Ref</p>
            <p class="text-3xl font-bold text-walmart-blue" id="kpiTnT">--</p>
            <p class="text-xs text-gray-400">Refrigeration</p>
        </div>
        <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-blue-400">
            <p class="text-sm text-gray-500 uppercase tracking-wide">7-Day Avg</p>
            <p class="text-3xl font-bold text-sky-600" id="kpi7d">--</p>
            <p class="text-xs text-gray-400">Refrigeration</p>
        </div>
        <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
            <p class="text-sm text-gray-500 uppercase tracking-wide">30-Day Avg</p>
            <p class="text-3xl font-bold text-green-600" id="kpi30d">--</p>
            <p class="text-xs text-gray-400">Refrigeration</p>
        </div>
        <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
            <p class="text-sm text-gray-500 uppercase tracking-wide">90-Day Avg</p>
            <p class="text-3xl font-bold text-purple-600" id="kpi90d">--</p>
            <p class="text-xs text-gray-400">Refrigeration</p>
        </div>
        <div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 border-walmart-yellow">
            <p class="text-sm text-gray-500 uppercase tracking-wide">HVAC</p>
            <p class="text-3xl font-bold text-yellow-600" id="kpiHvac">--</p>
            <p class="text-xs text-gray-400">HVAC Systems</p>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <p class="text-4xl font-bold text-gray-800" id="statStores">--</p>
            <p class="text-sm text-gray-500">Total Stores</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <p class="text-4xl font-bold text-red-600" id="statLoss">--</p>
            <p class="text-sm text-gray-500">Total Loss ($)</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <p class="text-4xl font-bold text-red-600" id="statOOT">--</p>
            <p class="text-sm text-gray-500">Cases Out of Target</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
            <p class="text-4xl font-bold text-gray-800" id="statManagers">--</p>
            <p class="text-sm text-gray-500">Regional Managers</p>
        </div>
    </div>

    <!-- WM vs NHM vs Sam's Split -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-blue-50 border-2 border-walmart-blue rounded-lg p-4">
            <h3 class="text-lg font-bold text-walmart-blue mb-3">&#x1F3EA; Walmart Stores</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div><p class="text-2xl font-bold text-walmart-blue" id="wmCount">--</p><p class="text-xs text-gray-500">Stores</p></div>
                <div><p class="text-2xl font-bold" id="wmTnT">--</p><p class="text-xs text-gray-500">30-Day TnT</p></div>
                <div><p class="text-2xl font-bold" id="wmPass">--</p><p class="text-xs text-gray-500">&#x2265;90% Pass</p></div>
            </div>
        </div>
        <div class="bg-amber-50 border-2 border-amber-600 rounded-lg p-4">
            <h3 class="text-lg font-bold text-amber-700 mb-3">&#x1F3E0; Neighborhood Market</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div><p class="text-2xl font-bold text-amber-700" id="nhmCount">--</p><p class="text-xs text-gray-500">Stores</p></div>
                <div><p class="text-2xl font-bold" id="nhmTnT">--</p><p class="text-xs text-gray-500">30-Day TnT</p></div>
                <div><p class="text-2xl font-bold" id="nhmPass">--</p><p class="text-xs text-gray-500">&#x2265;90% Pass</p></div>
            </div>
        </div>
        <div class="bg-teal-50 border-2 border-teal-600 rounded-lg p-4">
            <h3 class="text-lg font-bold text-teal-700 mb-3">&#x1F6D2; Sam's Club Stores</h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div><p class="text-2xl font-bold text-teal-700" id="scCount">--</p><p class="text-xs text-gray-500">Stores</p></div>
                <div><p class="text-2xl font-bold" id="scTnT">--</p><p class="text-xs text-gray-500">30-Day TnT</p></div>
                <div><p class="text-2xl font-bold" id="scPass">--</p><p class="text-xs text-gray-500">&#x2265;87% Pass</p></div>
            </div>
        </div>
    </div>

    <!-- Top 5 + Bottom 5 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top 5 -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-4 py-3 border-b border-green-200 bg-green-50 rounded-t-lg flex justify-between items-center"><h2 class="text-lg font-semibold text-green-800">&#x1F3C6; Top 5 Stores (TnT)</h2><button onclick="exportTableCSV(document.getElementById('top5Body').closest('table'),'tnt_top5')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-green-600 hover:text-green-800 hover:bg-green-100 rounded transition">&#x1F4E5;</button></div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-green-50 sticky top-0"><tr>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-600">Store</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-600">RM</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">TnT</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">30d</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">Loss</th>
                    </tr></thead>
                    <tbody id="top5Body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
        <!-- Bottom 5 -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-4 py-3 border-b border-red-200 bg-red-50 rounded-t-lg flex justify-between items-center"><h2 class="text-lg font-semibold text-red-800">&#x1F6A8; Bottom 5 Stores (TnT)</h2><button onclick="exportTableCSV(document.getElementById('bottom5Body').closest('table'),'tnt_bottom5')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-red-600 hover:text-red-800 hover:bg-red-100 rounded transition">&#x1F4E5;</button></div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-red-50 sticky top-0"><tr>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-600">Store</th>
                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-600">RM</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">TnT</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">30d</th>
                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-600">Loss</th>
                    </tr></thead>
                    <tbody id="bottom5Body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Breakdown Chart -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold text-gray-800" id="breakdownTitle">Performance by Sr. Director</h2><button onclick="exportChartPNG('breakdownChart','tnt_breakdown')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
        <div style="height:320px"><canvas id="breakdownChart"></canvas></div>
    </div>

    <!-- Manager Performance Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200">
            <div class="flex flex-wrap justify-between items-center gap-3">
                <div class="flex items-center gap-2"><h2 class="text-lg font-semibold text-gray-800">Manager Performance</h2><button onclick="exportTableCSV(document.getElementById('mgrTableBody').closest('table'),'tnt_manager_performance')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
                <div class="flex items-center gap-3">
                    <span id="mgrSliceLabel" class="hidden text-xs font-semibold text-walmart-blue bg-blue-50 border border-blue-200 rounded-full px-3 py-1">
                        &#x1F50D; <span id="mgrSliceName"></span>
                        <button onclick="mgrSlice=null;applyFilters()" class="ml-1 text-gray-400 hover:text-red-500">&times;</button>
                    </span>
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-medium text-gray-500">Group By:</label>
                        <select id="mgrGroupBy" onchange="mgrSlice=null;renderMgrTable();renderKPIs();renderSplit();renderBottom10();renderBreakdown();renderInsights()" class="border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                            <option value="sr">Sr. Director</option>
                            <option value="dir">FM Director</option>
                            <option value="rm" selected>Regional Manager</option>
                            <option value="fsm">FS Manager</option>
                        </select>
                    </div>
                    <input type="text" id="tableSearch" placeholder="Search..." oninput="renderMgrTable()"
                        class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-walmart-blue focus:border-walmart-blue w-48">
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('nm')">Name &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('cnt')">Stores</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('tnt')">TnT Ref</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('tnt30')">30-Day</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('hvac')">HVAC</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('dp')">Dewpoint</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('rack')">Rack</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 bg-blue-50 cursor-pointer" onclick="sortTable('comp')">Composite &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('loss')">Loss $</th>
                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortTable('wos')">WTW WOs</th>
                    </tr>
                </thead>
                <tbody id="mgrTableBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <!-- Store/Manager Detail Panel (appears on slicer click) -->
    <div id="mgrStorePanel" class="hidden mb-6">
        <div class="bg-white rounded-lg shadow-lg border-2 border-[#0ea5e9] overflow-hidden">
            <div class="bg-[#0ea5e9] text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-base font-bold">&#x1F3EA; Stores &amp; Managers — <span id="mgrStorePanelTitle"></span></h3>
                <div class="flex items-center gap-3">
                    <button onclick="exportTableCSV(document.getElementById('mgrStoreBody').closest('table'),'tnt_stores_detail')" title="Export CSV" class="text-white/80 hover:text-white text-xs px-2 py-1 bg-white/20 hover:bg-white/30 rounded transition">&#x1F4E5; Export</button>
                    <span id="mgrStoreCount" class="text-sm bg-white/20 rounded-full px-3 py-1"></span>
                    <input type="text" id="mgrStoreSearch" placeholder="Search stores..." oninput="renderMgrStoreList()"
                        class="border-0 rounded-md px-3 py-1 text-sm text-gray-800 w-48 focus:ring-2 focus:ring-white">
                    <button onclick="document.getElementById('mgrStorePanel').classList.add('hidden')" class="text-white hover:text-gray-200 text-xl">&times;</button>
                </div>
            </div>
            <div class="overflow-x-auto" style="max-height:500px; overflow-y:auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('sn')">Store #</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('nm')">Store Name</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('rm')">Regional Mgr</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('fsm')">FS Manager</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('rgn')">Region</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('sub')">Sub-Region</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Market</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('tnt')">TnT Ref</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('hvac')">HVAC</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('dp')">Dewpoint</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('rack')">Rack</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortMgrStores('wos')">WTW WOs</th>
                        </tr>
                    </thead>
                    <tbody id="mgrStoreBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Insights -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h3 class="text-lg font-semibold text-blue-800 mb-2">&#x1F4CA; Insights &amp; Analysis</h3>
        <div id="insightsContent" class="text-sm text-blue-700 space-y-2"></div>
    </div>

    <!-- Store Detail (hidden until click) -->
    <div id="storeDetail" class="hidden mb-6">
        <div class="bg-white rounded-lg shadow-lg border-2 border-walmart-blue overflow-hidden">
            <div class="bg-walmart-blue text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-lg font-bold">&#x1F3EA; Store <span id="detailStoreNum"></span> - Detailed View</h3>
                <button onclick="document.getElementById('storeDetail').classList.add('hidden')" class="text-white hover:text-gray-200 text-xl">&times;</button>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4" id="detailInfo"></div>
                <h4 class="font-semibold text-gray-700 mb-2">Time in Target Performance</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-2 mb-4" id="detailTnT"></div>
                <!-- Ref Terminal Cases for this store -->
                <div id="detailRefTerminal" class="mb-4"></div>
                <h4 class="font-semibold text-gray-700 mb-2">Win-the-Winter Work Orders</h4>
                <div class="overflow-x-auto" style="max-height:250px;overflow-y:auto" id="detailWOs"></div>
            </div>
        </div>
    </div>

    <!-- Terminal Cases Org Ranking (Slicer) -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6" id="refTermRankingSection">
        <div class="px-4 py-3 border-b border-red-200 bg-gradient-to-r from-red-50 to-orange-50">
            <div class="flex flex-wrap justify-between items-center gap-3">
                <h2 class="text-lg font-semibold text-red-800">&#x1F3C6; Terminal Cases — Leadership Ranking</h2>
                <button onclick="resetRefTermRanking()" class="px-3 py-1 text-xs font-semibold rounded-md border border-gray-300 bg-white text-gray-600 hover:bg-gray-50">Reset All</button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Click a name to filter — cascades like a slicer across all levels and the store table below</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-0 divide-x divide-gray-200">
            <!-- Sr Director -->
            <div class="p-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Sr Director</h3>
                <div id="refTermRankSr" class="space-y-1 max-h-[280px] overflow-y-auto text-sm"></div>
            </div>
            <!-- FM Director -->
            <div class="p-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">FM Director</h3>
                <div id="refTermRankDir" class="space-y-1 max-h-[280px] overflow-y-auto text-sm"></div>
            </div>
            <!-- Regional Manager -->
            <div class="p-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Regional Manager</h3>
                <div id="refTermRankRm" class="space-y-1 max-h-[280px] overflow-y-auto text-sm"></div>
            </div>
            <!-- FS Manager -->
            <div class="p-3">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">FS Manager</h3>
                <div id="refTermRankFsm" class="space-y-1 max-h-[280px] overflow-y-auto text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Refrigeration Terminal Cases Section -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-red-200 bg-red-50">
            <div class="flex flex-wrap justify-between items-center gap-3">
                <h2 class="text-lg font-semibold text-red-800">&#x1F6A8; Refrigeration Terminal Cases</h2>
                <button onclick="exportTableCSV(document.getElementById('refTermTableBody').closest('table'),'tnt_terminal_cases')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-red-600 hover:text-red-800 hover:bg-red-100 rounded transition">&#x1F4E5;</button>
                <div class="flex items-center gap-3">
                    <div id="refTermKpis" class="flex gap-4 text-sm"></div>
                    <input type="text" id="refTermSearch" placeholder="Search store/case..." oninput="renderRefTermTable()"
                        class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:ring-walmart-blue focus:border-walmart-blue w-48">
                </div>
            </div>
        </div>
        <!-- Store-level summary table -->
        <div class="overflow-x-auto" style="max-height:420px;overflow-y:auto">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortRefTerm('sn')">Store</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortRefTerm('cnt')">Cases</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortRefTerm('mt')">MT</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortRefTerm('lt')">LT</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortRefTerm('pt')">Avg % Terminal</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortRefTerm('cd')">Consec Days</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortRefTerm('wo')">Open WOs</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">RM</th>
                    </tr>
                </thead>
                <tbody id="refTermTableBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <!-- Case Detail Modal (hidden until store click) -->
    <div id="refTermDetail" class="hidden mb-6">
        <div class="bg-white rounded-lg shadow-lg border-2 border-red-400 overflow-hidden">
            <div class="bg-red-600 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-lg font-bold">&#x2744;&#xFE0F; Store <span id="refTermDetailStore"></span> — Terminal Cases</h3>
                <button onclick="document.getElementById('refTermDetail').classList.add('hidden')" class="text-white hover:text-gray-200 text-xl">&times;</button>
            </div>
            <div class="p-4">
                <div id="refTermDetailKpis" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>
                <div class="overflow-x-auto" style="max-height:400px;overflow-y:auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Case</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Sensor</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">Class</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Setpoint</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Med Temp 72h</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">% Terminal 24h</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Consec Days</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Days (30d)</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">Open WO</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Controller</th>
                            </tr>
                        </thead>
                        <tbody id="refTermDetailBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- YoY Section (toggled) -->
    <div id="yoyTntWrap" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-base font-bold text-walmart-dark mb-4">&#x1F4C5; Year-over-Year — Monthly WO Volume</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">WTW Work Orders by Month (FY overlay)</h4>
                    <div style="height:280px"><canvas id="yoyTntHvac"></canvas></div>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">WTW WOs — All Categories (FY overlay)</h4>
                    <div style="height:280px"><canvas id="yoyTntRef"></canvas></div>
                </div>
            </div>
            <div class="mt-6">
                <h4 class="text-sm font-semibold text-gray-600 mb-2">Monthly NTE Spend ($)</h4>
                <div style="height:250px"><canvas id="yoyTntNte"></canvas></div>
            </div>
        </div>
    </div>
    <div class="flex justify-center py-4"><button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="px-4 py-2 bg-[#0ea5e9] hover:bg-[#004c91] text-white text-sm font-semibold rounded-lg flex items-center gap-2 shadow transition">&#x2B06; Back to Top</button></div>
</main>
</div>

<!-- Refrigeration Project Modal -->
<div id="refrigProjectModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-label="Refrigeration project details">
    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[85vh] overflow-y-auto p-6 relative">
        <button onclick="document.getElementById('refrigProjectModal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 text-2xl leading-none" aria-label="Close">&#x2715;</button>
        <div id="refrigProjectContent"></div>
    </div>
</div>

<!-- Win the Winter Tab -->
<div id="wtw-content" class="hidden">
<main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
        <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center gap-1">
                <span class="text-xs font-semibold text-[#004c91]">Ops Region:</span>
                <select id="wtwOps" onchange="wtwApplyFilter()" class="border border-gray-200 rounded-md px-2 py-1.5 text-xs min-w-[100px]">
                    <option value="">All Ops Regions</option>
                </select>
            </div>
            <div class="flex items-center gap-1">
                <span class="text-xs font-semibold text-[#004c91]">BU:</span>
                <select id="wtwBu" onchange="wtwApplyFilter()" class="border border-gray-200 rounded-md px-2 py-1.5 text-xs min-w-[140px]">
                    <option value="">All BUs (Fleet)</option>
                </select>
            </div>
            <div class="flex items-center gap-1">
                <span class="text-xs font-semibold text-[#004c91]">FM Director:</span>
                <select id="wtwFmd" onchange="wtwApplyFilter()" class="border border-gray-200 rounded-md px-2 py-1.5 text-xs min-w-[140px]">
                    <option value="">All FM Directors</option>
                </select>
            </div>
            <div class="flex items-center gap-1">
                <span class="text-xs font-semibold text-[#004c91]">FM Regional:</span>
                <select id="wtwFmr" onchange="wtwApplyFilter()" class="border border-gray-200 rounded-md px-2 py-1.5 text-xs min-w-[140px]">
                    <option value="">All FM Regionals</option>
                </select>
            </div>
            <div class="flex items-center gap-1">
                <span class="text-xs font-semibold text-[#004c91]">FS Manager:</span>
                <select id="wtwFsm" onchange="wtwApplyFilter()" class="border border-gray-200 rounded-md px-2 py-1.5 text-xs min-w-[140px]">
                    <option value="">All FS Managers</option>
                </select>
            </div>
            <div class="relative">
                <input type="text" id="wtwNameSearch" placeholder="Search by name..." autocomplete="off"
                    oninput="nameSearch('wtw', this.value)"
                    class="border border-gray-200 rounded-md px-3 py-1.5 text-xs w-44 focus:ring-2 focus:ring-[#0ea5e9] focus:border-[#0ea5e9] pl-7">
                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">&#x1F50D;</span>
                <div id="wtwNameResults" class="hidden absolute z-50 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
            </div>
            <button onclick="wtwReset()" class="ml-auto px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs font-semibold rounded-md">Reset</button>
        </div>
        <div class="flex items-center gap-2 mt-3 pt-3 border-t border-gray-200 justify-center">
            <div class="flex items-center gap-1">
                <span class="text-xs font-semibold text-[#004c91]">Phase:</span>
                <select id="wtwPhase" onchange="wtwApplyFilter()" class="border border-gray-200 rounded-md px-2 py-1.5 text-xs min-w-[80px]">
                    <option value="">All</option>
                    <option value="PH1">Phase 1</option>
                    <option value="PH2">Phase 2</option>
                    <option value="PH3">Phase 3</option>
                </select>
            </div>
            <div class="w-px h-6 bg-gray-200 mx-2"></div>
            <button onclick="wtwShowSub('overview')" id="wtwSubOverview" class="px-4 py-1.5 text-xs font-semibold rounded-md bg-gradient-to-r from-[#0ea5e9] to-[#0ea5e9] text-white">Overview</button>
            <button onclick="wtwShowSub('inprogress')" id="wtwSubInprogress" class="px-4 py-1.5 text-xs font-semibold rounded-md border border-gray-200 text-gray-600 hover:border-[#0ea5e9] hover:text-[#0ea5e9]">In-Progress (<span id="wtwIpCount">0</span>)</button>
            <button onclick="wtwShowSub('ready')" id="wtwSubReady" class="px-4 py-1.5 text-xs font-semibold rounded-md border border-gray-200 text-gray-600 hover:border-[#0ea5e9] hover:text-[#0ea5e9]">Ready (<span id="wtwReadyCount">0</span>)</button>
            <div class="w-px h-6 bg-gray-200 mx-1"></div>
            <button onclick="toggleYoy('wtw')" id="yoyToggleWtw" class="px-3 py-1.5 text-xs font-semibold rounded-md bg-gray-100 hover:bg-[#0ea5e9] hover:text-white text-gray-600 transition flex items-center gap-1" title="Toggle Year-over-Year view">
                &#x1F4C5; YoY
            </button>

        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-4 gap-3 mb-4">
        <div class="bg-white rounded-lg shadow p-3 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-[#0ea5e9] to-[#0091ea]"></div>
            <div class="text-sm">&#x1F4CB;</div>
            <div class="text-2xl font-bold text-[#0ea5e9]" id="wtwKpiTotal">0</div>
            <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider">Total Work Orders</div>
        </div>
        <div class="bg-white rounded-lg shadow p-3 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-[#76c043] to-[#8bc34a]"></div>
            <div class="text-sm">&#x2705;</div>
            <div class="text-2xl font-bold text-[#76c043]" id="wtwKpiDone">0</div>
            <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider">Completed</div>
            <div class="text-[9px] text-gray-400 mt-0.5 bg-gray-50 inline-block px-2 py-0.5 rounded-full" id="wtwKpiDonePct">0% of total</div>
        </div>
        <div class="bg-white rounded-lg shadow p-3 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-[#fbbf24] to-[#ffca28]"></div>
            <div class="text-sm">&#x1F504;</div>
            <div class="text-2xl font-bold text-[#d4a017]" id="wtwKpiIp">0</div>
            <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider">In Progress</div>
            <div class="text-[9px] text-gray-400 mt-0.5 bg-gray-50 inline-block px-2 py-0.5 rounded-full" id="wtwKpiIpPct">0% remaining</div>
        </div>
        <div class="bg-white rounded-lg shadow p-3 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-[#e57373] to-[#ef5350]"></div>
            <div class="text-sm">&#x1F4C4;</div>
            <div class="text-2xl font-bold text-[#e57373]" id="wtwKpiOpen">0</div>
            <div class="text-[10px] font-semibold text-gray-500 uppercase tracking-wider">Open</div>
            <div class="text-[9px] text-gray-400 mt-0.5 bg-gray-50 inline-block px-2 py-0.5 rounded-full" id="wtwKpiOpenPct">0% pending</div>
        </div>
    </div>

    <!-- OVERVIEW Sub-tab -->
    <div id="wtwOverview">
        <!-- BU Progress Table -->
        <div class="bg-white rounded-lg shadow p-5 mb-5">
            <div class="flex justify-between items-center"><h3 class="text-lg font-semibold text-[#004c91] pb-3 mb-4 border-b-2 border-gray-200">&#x1F31F; Fleet Progress by Sr Director (BU)</h3><button onclick="exportTableCSV(document.getElementById('wtwBuBody').closest('table'),'wtw_fleet_progress')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gradient-to-r from-[#0ea5e9] to-[#0ea5e9] text-white">
                        <th class="px-3 py-3 text-left rounded-tl-lg">BU</th>
                        <th class="px-3 py-3 text-left">Sr Director</th>
                        <th class="px-3 py-3 text-center">Total</th>
                        <th class="px-3 py-3 text-center">Completed</th>
                        <th class="px-3 py-3 text-center">In Progress</th>
                        <th class="px-3 py-3 text-center">Open</th>
                        <th class="px-3 py-3 text-center rounded-tr-lg">% Complete</th>
                    </tr>
                </thead>
                <tbody id="wtwBuBody"></tbody>
            </table>
        </div>

        <!-- Chart + PM Improvement -->
        <div class="flex gap-5 mb-5" style="align-items:stretch">
            <div class="bg-white rounded-lg shadow p-5 flex-[3]">
                <div style="height:350px"><canvas id="wtwOverviewChart"></canvas></div>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex-1 flex flex-col justify-center items-center min-w-[220px]">
                <div class="text-center">
                    <div class="text-sm text-gray-500 mb-2">Avg Time to Complete</div>
                    <div class="text-xs text-gray-400 mb-1">Completed WOs Only</div>
                    <div class="text-5xl font-bold text-[#0ea5e9]" id="wtwAvgImp">--</div>
                    <div class="text-sm text-gray-500">avg duration</div>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="text-xs text-gray-400">Total</div>
                        <div class="text-2xl font-bold text-[#2a8703]" id="wtwImpCount">0</div>
                        <div class="text-xs text-gray-400">WOs completed</div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="text-lg font-bold text-[#0ea5e9]" id="wtwMissingScores">0%</div>
                        <div class="text-[11px] text-gray-400">completion rate</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Store Summary -->
        <div class="bg-white rounded-lg shadow p-5">
            <div class="flex justify-between items-center"><h3 class="text-lg font-semibold text-[#004c91] pb-3 mb-4 border-b-2 border-gray-200">&#x1F4CA; Store Summary</h3><button onclick="exportTableCSV(document.getElementById('wtwStoreSumBody').closest('table'),'wtw_store_summary')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <div class="flex items-center gap-4 mb-3 flex-wrap">
                <div class="flex items-center gap-1">
                    <span class="text-xs font-semibold text-[#004c91]">Status:</span>
                    <select id="wtwStoreSumStatus" onchange="wtwRenderStoreSummary()" class="border border-gray-200 rounded-md px-2 py-1 text-xs">
                        <option value="">All</option>
                        <option value="COMPLETED">Completed</option>
                        <option value="IN PROGRESS">In Progress</option>
                        <option value="OPEN">Open</option>
                    </select>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-xs font-semibold text-[#004c91]">Store #:</span>
                    <input id="wtwStoreSearch" type="text" placeholder="Search store..." oninput="wtwRenderStoreSummary()" class="border border-gray-200 rounded-md px-2 py-1 text-xs w-24" />
                </div>
                <span id="wtwStoreSumCount" class="text-[11px] text-gray-500 font-semibold"></span>
                <span class="text-[11px] text-gray-400">Click headers to sort • Click row to slice</span>
                <span id="wtwSlicerBadge" class="hidden ml-auto px-3 py-1 bg-[#0ea5e9] text-white text-xs font-bold rounded-full cursor-pointer shadow hover:bg-[#004299] transition" onclick="wtwToggleStoreSlicer(null)"></span>
            </div>
            <div style="max-height:500px;overflow-y:auto">
                <table class="w-full text-xs border-collapse" id="wtwStoreSumTable">
                    <thead class="sticky top-0 z-10">
                        <tr class="bg-[#0ea5e9] text-white cursor-pointer select-none">
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortStoreSummary('store')">Store <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortStoreSummary('status')">Status <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortStoreSummary('phase')">Phase <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortStoreSummary('hours')">Hours <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortStoreSummary('recent_pm')">Recent PM <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortStoreSummary('improvement')" title="PM score change vs 30 days ago">30d Δ <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortStoreSummary('store_rate')" title="Store-level leak rate">Store Leak Rate <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortStoreSummary('asset_lr')" title="Average asset leak rate">Avg Asset LR <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="wtwStoreSumBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- IN-PROGRESS Sub-tab -->
    <div id="wtwInprogress" class="hidden">
        <div class="bg-white rounded-lg shadow p-5">
            <div class="flex justify-between items-center"><h3 class="text-lg font-semibold text-[#004c91] pb-3 mb-4 border-b-2 border-gray-200">In-Progress Work Orders</h3><button onclick="exportTableCSV(document.getElementById('wtwIpBody').closest('table'),'wtw_in_progress')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <div class="text-[11px] text-gray-400 mb-3">Click column headers to sort</div>
            <div style="max-height:700px;overflow-y:auto">
                <table class="w-full text-xs border-collapse">
                    <thead class="sticky top-0 z-10">
                        <tr class="bg-[#0ea5e9] text-white cursor-pointer select-none">
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortIp('phase')" style="width:80px">Phase <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortIp('store')" style="width:70px">Store <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortIp('wo_num')" style="width:100px">WO # <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortIp('extended')" style="width:140px">Status <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortIp('hours')" style="width:70px">Hours <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortIp('scheduled')" style="width:100px">Scheduled <span class="sort-icon"></span></th>
                            <th class="px-2 py-2.5 text-center" onclick="wtwSortIp('pm_score')" style="width:80px">PM Score <span class="sort-icon"></span></th>
                        </tr>
                    </thead>
                    <tbody id="wtwIpBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- YoY Section (toggled, not a sub-tab) -->
    <div id="yoyWtwWrap" class="hidden">
        <div class="bg-white rounded-lg shadow p-5 mb-5">
            <h3 class="text-lg font-semibold text-[#004c91] pb-3 mb-4 border-b-2 border-gray-200">&#x1F4C5; Win the Winter — Year-over-Year Comparison</h3>
            <div style="height:320px"><canvas id="yoyWtwBar"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-5 mb-5">
            <h3 class="text-lg font-semibold text-[#004c91] pb-3 mb-4 border-b-2 border-gray-200">Fiscal Year Summary</h3>
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gradient-to-r from-[#0ea5e9] to-[#0ea5e9] text-white">
                        <th class="px-4 py-3 text-center rounded-tl-lg">Fiscal Year</th>
                        <th class="px-4 py-3 text-center">Total WOs</th>
                        <th class="px-4 py-3 text-center">Completed</th>
                        <th class="px-4 py-3 text-center">Completion Rate</th>
                        <th class="px-4 py-3 text-center rounded-tr-lg">vs Prior Year</th>
                    </tr>
                </thead>
                <tbody id="yoyWtwTable"></tbody>
            </table>
        </div>
    </div>

    <!-- READY Sub-tab -->
    <div id="wtwReady" class="hidden">
        <div class="bg-white rounded-lg shadow p-5 mb-5">
            <div class="flex justify-between items-center"><h3 class="text-lg font-semibold text-[#004c91] pb-3 mb-4 border-b-2 border-gray-200">&#x2705; Ready to Complete — Stores with PM Score &ge; 90%</h3><button onclick="exportTableCSV(document.getElementById('wtwReadyBody')?.closest('table'),'wtw_ready_to_complete')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-sm text-gray-500 mb-4">These in-progress work orders have achieved the target PM Score threshold and may be ready for completion.</p>
            <div class="bg-[#76c043] text-white p-5 rounded-lg mb-5 flex justify-around items-center">
                <div class="text-center">
                    <div class="text-sm opacity-90">Ready to Complete</div>
                    <div class="text-5xl font-bold" id="wtwReadyBig">0</div>
                    <div class="text-xs opacity-80">stores with PM Score &ge; 90%</div>
                </div>
                <div class="w-px h-20 bg-white/30"></div>
                <div class="text-center">
                    <div class="text-sm opacity-90">If Completed, Would Be</div>
                    <div class="flex gap-8 justify-center mt-2">
                        <div>
                            <div class="text-4xl font-bold" id="wtwProjCompleted">0</div>
                            <div class="text-[11px] opacity-80">total completed</div>
                        </div>
                        <div>
                            <div class="text-4xl font-bold" id="wtwProjPct">0%</div>
                            <div class="text-[11px] opacity-80">complete</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Ready by FM Director -->
            <div style="height:300px"><canvas id="wtwReadyChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-[#004c91]">Store Details</h3>
                <button onclick="wtwExportReady()" class="bg-[#0ea5e9] text-white border-none px-4 py-2 rounded text-sm flex items-center gap-2 hover:bg-[#004c91] cursor-pointer">
                    <span>&#x1F4E5;</span> Export to CSV
                </button>
            </div>
            <div style="max-height:500px;overflow-y:auto">
                <table class="w-full text-xs border-collapse">
                    <thead class="sticky top-0 z-10">
                        <tr class="bg-[#76c043] text-white cursor-pointer select-none">
                            <th class="px-2 py-2.5">FM Director</th>
                            <th class="px-2 py-2.5">Phase</th>
                            <th class="px-2 py-2.5">Store</th>
                            <th class="px-2 py-2.5">WO #</th>
                            <th class="px-2 py-2.5">Status</th>
                            <th class="px-2 py-2.5">PM Score</th>
                            <th class="px-2 py-2.5">Scheduled</th>
                        </tr>
                    </thead>
                    <tbody id="wtwReadyBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="flex justify-center py-4"><button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="px-4 py-2 bg-[#0ea5e9] hover:bg-[#004c91] text-white text-sm font-semibold rounded-lg flex items-center gap-2 shadow transition">&#x2B06; Back to Top</button></div>
</main>
</div>

<!-- Leak Summary Tab -->
<div id="leak-content" class="hidden">
<main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Leak Header -->
    <div class="bg-gradient-to-r from-red-600 to-orange-500 rounded-lg shadow-lg p-6 mb-4 text-white">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">&#x1F4A7; Refrigerant Leak Summary</h1>
                <p class="text-red-100">Leak Repairs, EPA Inspections &amp; Refrigerant Handling</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-3xl font-bold" id="leakTotal">0</p>
                    <p class="text-sm text-red-100">Total Leak Work Orders</p>
                </div>
                <button onclick="toggleYoy('leak')" id="yoyToggleLeak" class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-semibold flex items-center gap-1.5 transition" title="Toggle Year-over-Year view">
                    &#x1F4C5; <span>YoY</span>
                </button>

            </div>
        </div>
    </div>

    <!-- Leak Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2">
                <h3 class="text-sm font-medium text-gray-700">&#x1F50D; Filter View</h3>
                <span class="text-xs text-gray-400" id="leakFilterLabel">Showing all leak work orders</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <input type="text" id="lkNameSearch" placeholder="Search by name..." autocomplete="off"
                        oninput="nameSearch('lk', this.value)"
                        class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-48 focus:ring-2 focus:ring-[#0ea5e9] focus:border-[#0ea5e9] pl-8">
                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs">&#x1F50D;</span>
                    <div id="lkNameResults" class="hidden absolute z-50 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
                <button onclick="clearLeakFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-md">
                    &#x2715; Clear Filters
                </button>
            </div>
        </div>
        <!-- Management Hierarchy Filters -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ops Region</label>
                <select id="lkOps" onchange="applyLeakHierarchyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Ops Regions</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sr. Director</label>
                <select id="lkSr" onchange="applyLeakHierarchyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Sr. Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FM Director</label>
                <select id="lkDir" onchange="applyLeakHierarchyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Regional Manager</label>
                <select id="lkRm" onchange="applyLeakHierarchyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Managers</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FS Manager</label>
                <select id="lkFsm" onchange="applyLeakHierarchyFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All FS Managers</option>
                </select>
            </div>
        </div>
        <!-- Data Filters -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Leak Type</label>
                <select id="lkType" onchange="renderLeakTab()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Types</option>
                    <option value="Leak Repair">Leak Repair</option>
                    <option value="EPA Inspection">EPA Inspection</option>
                    <option value="Refrigerant Handling">Refrigerant Handling</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                <select id="lkYear" onchange="renderLeakTab()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Years</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="lkStatus" onchange="renderLeakTab()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Status</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                <select id="lkPriority" onchange="renderLeakTab()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-walmart-blue focus:border-walmart-blue">
                    <option value="">All Priorities</option>
                </select>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
            <p class="text-sm text-gray-500 uppercase">Leak Repairs</p>
            <p class="text-2xl font-bold text-red-600" id="lkRepairs">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-orange-500">
            <p class="text-sm text-gray-500 uppercase">EPA Inspections</p>
            <p class="text-2xl font-bold text-orange-600" id="lkEpa">0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
            <p class="text-sm text-gray-500 uppercase">Completion Rate</p>
            <p class="text-2xl font-bold text-green-600" id="lkCompRate">0%</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
            <p class="text-sm text-gray-500 uppercase">Total NTE</p>
            <p class="text-2xl font-bold text-sky-600" id="lkNte">$0</p>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
            <p class="text-sm text-gray-500 uppercase">Stores Affected</p>
            <p class="text-2xl font-bold text-purple-600" id="lkStores">0</p>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <!-- Tableau Leak Summary (Asset-Level from Tableau Report) -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
            <div>
                <div class="flex justify-between items-center"><h2 class="text-lg font-semibold text-gray-800">&#x1F4CA; Leak Summary Report <span class="text-xs font-normal text-gray-400">(Tableau)</span></h2><button onclick="exportTableCSV(document.getElementById('lsTableBody')?.closest('table'),'leak_summary')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
                <p class="text-xs text-gray-500">Asset-level leak rates from Tableau Refrigerant Leak Report — cross-referenced with ServiceChannel</p>
            </div>
            <div class="flex gap-2 items-center">
                <select id="lsColorFilter" onchange="renderLeakSummary()" class="text-sm border rounded px-2 py-1">
                    <option value="">All Colors</option>
                    <option value="Red">&#x1F534; Red (High)</option>
                    <option value="Orange">&#x1F7E0; Orange</option>
                    <option value="Yellow">&#x1F7E1; Yellow</option>
                    <option value="Green">&#x1F7E2; Green</option>
                </select>
                <select id="lsTypeFilter" onchange="renderLeakSummary()" class="text-sm border rounded px-2 py-1">
                    <option value="">All Types</option>
                    <option value="WMT">WMT</option>
                    <option value="SAMS">SAMS</option>
                    <option value="DC">DC</option>
                </select>
                <input type="text" id="lsSearch" placeholder="Store # or Tag..." oninput="renderLeakSummary()"
                    class="text-sm border rounded px-2 py-1 w-40" aria-label="Search leak summary">
                <span class="text-xs text-gray-500" id="lsCount"></span>
            </div>
        </div>
        <!-- Leak Summary KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 p-4 bg-gray-50 border-b">
            <div class="text-center">
                <p class="text-2xl font-bold text-red-600" id="lsRedCount">0</p>
                <p class="text-xs text-gray-500">&#x1F534; Red Assets</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-orange-500" id="lsOrangeCount">0</p>
                <p class="text-xs text-gray-500">&#x1F7E0; Orange Assets</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-yellow-600" id="lsYellowCount">0</p>
                <p class="text-xs text-gray-500">&#x1F7E1; Yellow Assets</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-green-600" id="lsGreenCount">0</p>
                <p class="text-xs text-gray-500">&#x1F7E2; Green Assets</p>
            </div>
            <div class="text-center">
                <p class="text-2xl font-bold text-[#0ea5e9]" id="lsTotalEvents">0</p>
                <p class="text-xs text-gray-500">Total Leak Events</p>
            </div>
        </div>
        <!-- Leak Summary Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4">
            <div>
                <h4 class="text-sm font-semibold text-gray-600 mb-2">Asset Leak Rate Distribution</h4>
                <div style="height:260px"><canvas id="lsRateDistChart"></canvas></div>
            </div>
            <div>
                <h4 class="text-sm font-semibold text-gray-600 mb-2">Leak Events by Store Type</h4>
                <div style="height:260px"><canvas id="lsTypeChart"></canvas></div>
            </div>
        </div>
        <!-- Leak Summary Table -->
        <div class="overflow-x-auto" style="max-height:400px;overflow-y:auto">
            <table class="min-w-full text-sm">
                <thead class="bg-red-50 sticky top-0"><tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortLeakSummary('sn')">Store &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Tag ID</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Type</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">FS Sub Market</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortLeakSummary('charge')">Charge (lbs) &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortLeakSummary('added')">Added (lbs) &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortLeakSummary('leak_rate')">Leak Rate &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">Color</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortLeakSummary('events')">Events &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortLeakSummary('store_rate')">Store Rate &#x25B2;&#x25BC;</th>
                </tr></thead>
                <tbody id="lsTableBody" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
    </div>

    <!-- BQ Leak WO Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-sm font-semibold text-gray-700">&#x1F4C8; Monthly Trend</h3><button onclick="exportChartPNG('leakTrendChart','leak_monthly_trend')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <div style="height:280px"><canvas id="leakTrendChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-sm font-semibold text-gray-700">&#x26A0;&#xFE0F; Assets Over 400 lbs Added Since 1/1/2026</h3><button onclick="exportChartPNG('leakHighChargeChart','leak_high_charge')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <div style="height:280px"><canvas id="leakHighChargeChart"></canvas></div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-sm font-semibold text-gray-700">&#x1F3E2; Top 10 Providers by Refrigerant WO Count</h3><button onclick="exportChartPNG('leakProviderChart','leak_top_providers')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <div style="height:280px"><canvas id="leakProviderChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-sm font-semibold text-gray-700">&#x26A0;&#xFE0F; Top 10 Stores by Leak WOs</h3><button onclick="exportChartPNG('leakStoreChart','leak_top_stores')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <div style="height:280px"><canvas id="leakStoreChart"></canvas></div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-semibold text-gray-700">&#x1F4B0; NTE Spend by Quarter — Year over Year</h3>
                <div class="flex gap-1 items-center" id="nteYearToggles"></div>
            </div>
            <div style="height:260px"><canvas id="leakNteChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">&#x1F30D; Leak Rate % vs Emissions (MTCO2e)</h3>
            <p class="text-xs text-gray-400 mb-2">Emissions = lbs leaked &times; GWP &divide; 2204.6</p>
            <div style="height:280px"><canvas id="leakEmissionsChart"></canvas></div>
        </div>
    </div>

    <!-- Emissions Detail Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">&#x2697;&#xFE0F; Emissions by Refrigerant Type</h3>
            <p class="text-xs text-gray-400 mb-2">MTCO2e contribution by refrigerant — higher GWP = greater impact per lb leaked</p>
            <div style="height:300px"><canvas id="refEmissionsChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">&#x1F4CA; Leak Rate vs Emissions Scatter</h3>
            <p class="text-xs text-gray-400 mb-2">Each dot = store &middot; Some stores leak more but emit less (lower GWP refrigerant)</p>
            <div style="height:300px"><canvas id="leakEmScatter"></canvas></div>
        </div>
    </div>

    <!-- Emissions KPI Cards -->
    <div class="bg-gradient-to-r from-emerald-700 to-emerald-500 rounded-lg shadow-lg p-4 mb-6 text-white">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-lg font-bold">&#x1F30D; Fleet Emissions Summary</h2>
                <p class="text-emerald-100 text-xs">Emissions = lbs &times; GWP &divide; 2204.6 &middot; GWP matched from BQ asset data</p>
            </div>
            <div class="flex gap-6">
                <div class="text-center"><p class="text-2xl font-bold" id="emTotalMt">--</p><p class="text-xs text-emerald-100">Total MTCO2e</p></div>
                <div class="text-center"><p class="text-2xl font-bold" id="emTotalLbs">--</p><p class="text-xs text-emerald-100">Total Lbs Leaked</p></div>
                <div class="text-center"><p class="text-2xl font-bold" id="emStoreCount">--</p><p class="text-xs text-emerald-100">Stores</p></div>
            </div>
        </div>
    </div>

    <!-- High-Charge Asset Table (>400 lbs added) -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
            <div>
                <h2 class="text-lg font-semibold text-gray-800">&#x26A0;&#xFE0F; Assets Over 400 lbs Added Since 1/1/2026</h2>
                <p class="text-xs text-gray-500">Assets with 400+ lbs of refrigerant added since January 1, 2026 — filters with hierarchy dropdowns</p>
            </div>
            <div class="flex gap-2 items-center">
                <input type="text" id="hcSearch" placeholder="Store #, tag, FSM..." oninput="renderHCTable()"
                    class="text-sm border rounded px-2 py-1 w-48" aria-label="Search high-charge assets">
                <span class="text-xs text-gray-500" id="hcShowing"></span>
            </div>
        </div>
        <div class="overflow-x-auto" style="max-height:400px;overflow-y:auto">
            <table class="min-w-full text-sm">
                <thead class="bg-red-50 sticky top-0"><tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHCTable('sn')">Store &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHCTable('tag')">Tag ID &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Type</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">FS Manager</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHCTable('charge')">Charge (lbs) &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHCTable('added')">Amt Added (lbs) &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHCTable('leak_rate')">Leak Rate &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">Color</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHCTable('events')">Events &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHCTable('store_rate')">Store Rate &#x25B2;&#x25BC;</th>
                </tr></thead>
                <tbody id="hcTableBody" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
    </div>

    <!-- Leak WO Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-800">Leak Work Orders</h2>
            <div class="flex gap-2 items-center">
                <input type="text" id="leakSearch" placeholder="Store # or tracking..." oninput="renderLeakTable()"
                    class="text-sm border rounded px-2 py-1 w-48" aria-label="Search leak work orders">
                <span class="text-xs text-gray-500" id="leakShowing"></span>
            </div>
        </div>
        <div class="overflow-x-auto" style="max-height:500px;overflow-y:auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50 sticky top-0"><tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Tracking #</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Store</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Type</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Priority</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Provider</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">NTE</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Created</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Completed</th>
                </tr></thead>
                <tbody id="leakTableBody" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
    </div>

    <!-- YoY Section (toggled) -->
    <div id="yoyLeakWrap" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-base font-bold text-walmart-dark mb-4">&#x1F4C5; Year-over-Year — Leak Work Orders</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">Monthly Leak WOs (FY overlay)</h4>
                    <div style="height:300px"><canvas id="yoyLeakMonthly"></canvas></div>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-gray-600 mb-2">Leak Completion Rate by FY</h4>
                    <div style="height:300px"><canvas id="yoyLeakCompletion"></canvas></div>
                </div>
            </div>
        </div>
    </div>
    <div class="flex justify-center py-4"><button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="px-4 py-2 bg-[#0ea5e9] hover:bg-[#004c91] text-white text-sm font-semibold rounded-lg flex items-center gap-2 shadow transition">&#x2B06; Back to Top</button></div>
</main>
</div>

<!-- HVAC Tab -->
<div id="hvac-content" class="hidden">
<main class="max-w-7xl mx-auto px-4 py-6">
    <!-- HVAC Header -->
    <div class="bg-gradient-to-r from-cyan-700 to-cyan-500 rounded-lg shadow-lg p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">&#x2744;&#xFE0F; HVAC Performance Dashboard</h1>
                <p class="text-cyan-100 mt-1">AHU Dewpoint, HVAC TnT, Alerts &amp; Work Orders</p>
            </div>
            <div class="flex gap-6">
                <div class="text-center"><p class="text-3xl font-bold" id="hvacStoreCount">--</p><p class="text-xs text-cyan-100">Stores w/ HVAC Data</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="hvacAvgTnt">--</p><p class="text-xs text-cyan-100">Avg HVAC TnT</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="hvacAvgDp">--</p><p class="text-xs text-cyan-100">Avg Dewpoint</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="hvacAvgZoneTemp">--</p><p class="text-xs text-cyan-100">Avg Zone Temp</p></div>
                <button onclick="toggleYoy('hvac')" id="yoyToggleHvac" class="px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-semibold flex items-center gap-1.5 transition" title="Toggle Year-over-Year view">
                    &#x1F4C5; <span>YoY</span>
                </button>

            </div>
        </div>
    </div>

    <!-- HVAC Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-medium text-gray-700">&#x1F50D; Filter</h3>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <input type="text" id="hvNameSearch" placeholder="Search by name..." autocomplete="off"
                    oninput="nameSearch('hv', this.value)"
                        class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-56 focus:ring-2 focus:ring-[#0ea5e9] focus:border-[#0ea5e9] pl-8">
                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs">&#x1F50D;</span>
                    <div id="hvNameResults" class="hidden absolute z-50 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
                <button onclick="clearHvacFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-md">&#x2715; Clear</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ops Region</label>
                <select id="hvOps" onchange="applyHvacFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Ops Regions</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sr. Director</label>
                <select id="hvSr" onchange="applyHvacFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Sr. Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FM Director</label>
                <select id="hvDir" onchange="applyHvacFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Regional Manager</label>
                <select id="hvRm" onchange="applyHvacFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Managers</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FS Manager</label>
                <select id="hvFsm" onchange="applyHvacFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All FS Managers</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Avg Zone Temp</label>
                <select id="hvTemp" onchange="applyHvacFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Temps</option>
                    <option value="cold">&le;60&deg;F (Cold)</option>
                    <option value="cool">61-68&deg;F (Cool)</option>
                    <option value="target">69-73&deg;F (Target)</option>
                    <option value="warm">74-78&deg;F (Warm)</option>
                    <option value="hot">&ge;79&deg;F (Hot)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6" id="hvacKpiCards"></div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4CA; HVAC TnT Distribution</h3><button onclick="exportChartPNG('hvacTntDist','hvac_tnt_distribution')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Stores by HVAC Time-in-Target bracket</p>
            <div style="height:280px"><canvas id="hvacTntDist"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F321;&#xFE0F; Dewpoint Distribution</h3><button onclick="exportChartPNG('hvacDpDist','hvac_dewpoint_distribution')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Store dewpoint readings (&le;52&deg;F is target)</p>
            <div style="height:280px"><canvas id="hvacDpDist"></canvas></div>
        </div>
    </div>

    <!-- HVAC Distribution Store Drill-down (appears on chart click) -->
    <div id="hvacDistStorePanel" class="hidden mb-6">
        <div class="bg-white rounded-lg shadow-lg border-2 border-cyan-600 overflow-hidden">
            <div class="bg-cyan-700 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-base font-bold">&#x1F3EA; <span id="hvacDistTitle"></span></h3>
                <div class="flex items-center gap-3">
                    <span id="hvacDistCount" class="text-sm bg-white/20 rounded-full px-3 py-1"></span>
                    <input type="text" id="hvacDistSearch" placeholder="Search stores..." oninput="renderHvacDistStores()"
                        class="border-0 rounded-md px-3 py-1 text-sm text-gray-800 w-48 focus:ring-2 focus:ring-white">
                    <button onclick="clearHvacDistSlice()" class="text-white hover:text-gray-200 text-xl">&times;</button>
                </div>
            </div>
            <div class="overflow-x-auto" style="max-height:500px; overflow-y:auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacDistStores('sn')">Store #</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacDistStores('nm')">Store Name</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">City</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacDistStores('rm')">Regional Mgr</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Region</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Sub-Region</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacDistStores('hvac')">HVAC TnT</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacDistStores('dp')">Dewpoint</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacDistStores('ha72')">72hr Alerts</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacDistStores('hwo')">HVAC WOs</th>
                        </tr>
                    </thead>
                    <tbody id="hvacDistBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->

    <!-- Store HVAC Unit Detail (appears when clicking a store row) -->
    <div id="hvacStoreUnitPanel" class="hidden mb-6">
        <div class="bg-white rounded-lg shadow-lg border-2 border-cyan-600 overflow-hidden">
            <div class="bg-cyan-800 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-base font-bold">&#x1F3ED; Store <span id="hvacUnitStoreNum"></span> &mdash; HVAC Units</h3>
                <div class="flex items-center gap-3">
                    <span id="hvacUnitSummary" class="text-sm bg-white/20 rounded-full px-3 py-1"></span>
                    <select id="hvacUnitTypeFilter" onchange="renderHvacStoreUnits()" class="border-0 rounded-md px-2 py-1 text-sm text-gray-800">
                        <option value="">All Unit Types</option>
                        <option value="rooftop unit">RTU</option>
                        <option value="air handler">AHU</option>
                        <option value="unit heater">Unit Heater</option>
                        <option value="VAV">VAV</option>
                    </select>
                    <button onclick="closeHvacStoreUnits()" class="text-white hover:text-gray-200 text-xl">&times;</button>
                </div>
            </div>
            <div class="p-4">
                <!-- Unit type summary badges -->
                <div id="hvacUnitBadges" class="flex flex-wrap gap-2 mb-4"></div>
                <!-- Avg temp display -->
                <div id="hvacUnitTempBar" class="mb-4"></div>
                <!-- Units table -->
                <div class="overflow-x-auto" style="max-height:400px; overflow-y:auto">
                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                        <thead class="bg-gray-50 sticky top-0"><tr>
                            <th class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer" onclick="sortHvacStoreUnits('un')">Unit</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer" onclick="sortHvacStoreUnits('ut')">Type</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500 cursor-pointer" onclick="sortHvacStoreUnits('zt')">Zone Temp</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500 cursor-pointer" onclick="sortHvacStoreUnits('zd')">Zone DP</th>
                            <th class="px-3 py-2 text-right font-medium text-gray-500 cursor-pointer" onclick="sortHvacStoreUnits('tnt')">TnT %</th>
                            <th class="px-3 py-2 text-center font-medium text-gray-500 cursor-pointer" onclick="sortHvacStoreUnits('al')">Alerts</th>
                            <th class="px-3 py-2 text-center font-medium text-gray-500">High DP</th>
                            <th class="px-3 py-2 text-center font-medium text-gray-500">High Temp</th>
                            <th class="px-3 py-2 text-center font-medium text-gray-500">Low Temp</th>
                            <th class="px-3 py-2 text-center font-medium text-gray-500">Lockout</th>
                            <th class="px-3 py-2 text-center font-medium text-gray-500">Heat Fail</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Reason</th>
                        </tr></thead>
                        <tbody id="hvacStoreUnitBody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-500 mt-2" id="hvacUnitCount"></p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F3AF; HVAC TnT by Sr. Director</h3><button onclick="exportChartPNG('hvacSrChart','hvac_sr_director')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Average HVAC TnT per leadership group</p>
            <div style="height:320px"><canvas id="hvacSrChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x26A0; 72hr HVAC Alerts by Region</h3><button onclick="exportChartPNG('hvacAlertChart','hvac_alerts')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Stores with active HVAC alerts in last 72 hours</p>
            <div style="height:320px"><canvas id="hvacAlertChart"></canvas></div>
        </div>
    </div>

    <!-- 72hr Alert Region Drill-down (appears on chart click) -->
    <div id="hvacAlertStorePanel" class="hidden mb-6">
        <div class="bg-white rounded-lg shadow-lg border-2 border-red-600 overflow-hidden">
            <div class="bg-red-700 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-base font-bold">&#x26A0;&#xFE0F; <span id="hvacAlertTitle"></span></h3>
                <div class="flex items-center gap-3">
                    <span id="hvacAlertCount" class="text-sm bg-white/20 rounded-full px-3 py-1"></span>
                    <input type="text" id="hvacAlertSearch" placeholder="Search stores..." oninput="renderHvacAlertStores()"
                        class="border-0 rounded-md px-3 py-1 text-sm text-gray-800 w-48 focus:ring-2 focus:ring-white">
                    <button onclick="clearHvacAlertSlice()" class="text-white hover:text-gray-200 text-xl">&times;</button>
                </div>
            </div>
            <div class="overflow-x-auto" style="max-height:500px; overflow-y:auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacAlertStores('sn')">Store #</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacAlertStores('nm')">Store Name</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">City</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacAlertStores('rm')">Regional Mgr</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Region</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacAlertStores('hvac')">HVAC TnT</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacAlertStores('dp')">Dewpoint</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacAlertStores('ha72')">72hr Alerts</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacAlertStores('hwo')">HVAC WOs</th>
                        </tr>
                    </thead>
                    <tbody id="hvacAlertBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- HVAC WO Summary -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F6E0; HVAC vs Ref Work Orders</h3><button onclick="exportChartPNG('hvacWoChart','hvac_vs_ref_wos')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">WO counts by type across filtered stores</p>
            <div style="height:280px"><canvas id="hvacWoChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4A8; AHU Dewpoint vs Store Dewpoint</h3><button onclick="exportChartPNG('hvacScatter','hvac_scatter')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Scatter: each dot is a store</p>
            <div style="height:280px"><canvas id="hvacScatter"></canvas></div>
        </div>
    </div>

    <!-- Terminal HVAC Units Section -->
    <div class="bg-gradient-to-r from-red-700 to-red-500 rounded-lg shadow-lg p-4 mb-6 text-white">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-lg font-bold">&#x1F6A8; Terminal HVAC Units</h2>
                <p class="text-red-100 text-xs">Units stuck in terminal state by reason &amp; duration &middot; Source: Tableau</p>
            </div>
            <div class="flex gap-6">
                <div class="text-center"><p class="text-2xl font-bold" id="termTotalUnits">--</p><p class="text-xs text-red-100">Terminal Units</p></div>
                <div class="text-center"><p class="text-2xl font-bold" id="termTotalOccur">--</p><p class="text-xs text-red-100">Total Alerts</p></div>
                <div class="text-center"><p class="text-2xl font-bold" id="termGt3Units">--</p><p class="text-xs text-red-100">Units w/ Alerts</p></div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4CA; Terminal Units by Reason</h3><button onclick="exportChartPNG('termReasonChart','hvac_terminal_by_reason')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Distinct HVAC units in terminal state, grouped by reason</p>
            <div style="height:280px"><canvas id="termReasonChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x23F3; Alert Severity Distribution</h3><button onclick="exportChartPNG('termDaysChart','hvac_terminal_alerts')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Terminal units by alert count bucket</p>
            <div style="height:280px"><canvas id="termDaysChart"></canvas></div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <div>
                <div class="flex justify-between items-center"><h3 class="text-base font-semibold text-gray-800">&#x1F6A8; Terminal Units with Alarms &mdash; Unit &amp; Store Detail</h3><button onclick="exportTableCSV(document.getElementById('termDetailBody')?.closest('table'),'hvac_terminal_detail')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
                <p class="text-xs text-gray-500">7,686 terminal units &middot; Filter by reason &middot; Click rows for store detail</p>
            </div>
            <div class="flex gap-2 items-center">
                <select id="termReasonFilter" onchange="renderTermDetailTable()" class="border border-gray-300 rounded-md px-2 py-1 text-sm">
                    <option value="">All Reasons</option>
                    <option value="ZONE TEMP">Zone Temp</option>
                    <option value="COMM LOSS">Comm Loss</option>
                    <option value="DEWPOINT">Dewpoint</option>
                </select>
                <label class="flex items-center gap-1 text-sm text-gray-600">
                    <input type="checkbox" id="termAlarmsOnly" onchange="renderTermDetailTable()" checked>
                    Alarms only
                </label>
                <input type="text" id="termSearch" placeholder="Store # ..." oninput="renderTermDetailTable()"
                    class="border border-gray-300 rounded-md px-2 py-1 text-sm w-28">
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-1">
                <div style="height:320px"><canvas id="termStackedChart"></canvas></div>
            </div>
            <div class="lg:col-span-2">
                <div class="overflow-x-auto" style="max-height:320px;overflow-y:auto">
                    <table class="min-w-full divide-y divide-gray-200 text-xs">
                        <thead class="bg-gray-50 sticky top-0"><tr>
                            <th class="px-2 py-1 text-left font-medium text-gray-500">Store</th>
                            <th class="px-2 py-1 text-left font-medium text-gray-500">Mod Label</th>
                            <th class="px-2 py-1 text-left font-medium text-gray-500">Unit</th>
                            <th class="px-2 py-1 text-left font-medium text-gray-500">Reason</th>
                            <th class="px-2 py-1 text-center font-medium text-gray-500">Alerts</th>
                            <th class="px-2 py-1 text-center font-medium text-gray-500">HVAC TnT</th>
                            <th class="px-2 py-1 text-center font-medium text-gray-500">Zone Temp</th>
                            <th class="px-2 py-1 text-center font-medium text-gray-500">Zone DP</th>
                        </tr></thead>
                        <tbody id="termDetailBody" class="bg-white divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <p class="text-xs text-gray-500 mt-1" id="termDetailCount"></p>
            </div>
        </div>
    </div>

    <!-- Terminal HVAC Detail Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">&#x1F4CB; Terminal HVAC Detail</h2>
            <p class="text-xs text-gray-500">All reason × duration combinations from Tableau</p>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50"><tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Duration</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Reason</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Occurrences</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Unique Units</th>
            </tr></thead>
            <tbody id="termTableBody" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
    </div>

    <!-- Bottom-10 Stores Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">&#x1F6A8; Worst HVAC Performers</h2>
            <p class="text-xs text-gray-500">Bottom stores by HVAC TnT &middot; Click column headers to sort</p>
        </div>
        <div class="overflow-x-auto" style="max-height:500px;overflow-y:auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0"><tr>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacTable('sn')"># &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Store</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">City</th>
                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">RM</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacTable('hvac')">HVAC TnT &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacTable('dp')">Dewpoint &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacTable('adp')">AHU DP &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacTable('avgzt')">Avg Temp &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 cursor-pointer" onclick="sortHvacTable('hwo')">HVAC WOs &#x25B2;&#x25BC;</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">Ref WOs</th>
                    <th class="px-3 py-2 text-center text-xs font-medium text-gray-500">72hr Alerts</th>
                    <th class="px-3 py-2 text-right text-xs font-medium text-gray-500">Loss ($)</th>
                </tr></thead>
                <tbody id="hvacTableBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
        <div class="px-4 py-2 bg-gray-50 text-xs text-gray-500"><span id="hvacTableShowing"></span></div>
    </div>

    <!-- YoY Section (toggled) -->
    <div id="yoyHvacWrap" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-base font-bold text-walmart-dark mb-4">&#x1F4C5; Year-over-Year — Avg HVAC Time in Target</h3>
            <div style="height:300px"><canvas id="yoyHvacTnt"></canvas></div>
            <p class="text-xs text-gray-400 mt-2">Monthly average HVAC time in target (%) across all stores. FY comparison limited to last 3 years.</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-base font-bold text-walmart-dark mb-4">&#x1F4C5; Year-over-Year — Avg Dewpoint</h3>
            <div style="height:300px"><canvas id="yoyHvacDp"></canvas></div>
            <p class="text-xs text-gray-400 mt-2">Monthly average AHU dewpoint (°F) across all stores. Lower is generally better in winter months.</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-base font-bold text-walmart-dark mb-4">&#x1F4C5; Year-over-Year — Avg Alerts per Store</h3>
            <div style="height:300px"><canvas id="yoyHvacAlerts"></canvas></div>
            <p class="text-xs text-gray-400 mt-2">Monthly average high-dewpoint alerts per store. Trending down indicates improving performance.</p>
        </div>
    </div>
    <div class="flex justify-center py-4"><button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="px-4 py-2 bg-[#0ea5e9] hover:bg-[#004c91] text-white text-sm font-semibold rounded-lg flex items-center gap-2 shadow transition">&#x2B06; Back to Top</button></div>
</main>
</div>

<!-- NPS Tab -->
<div id="nps-content" class="hidden">
<main class="max-w-7xl mx-auto px-4 py-6">
    <!-- NPS Header -->
    <div class="bg-gradient-to-r from-green-700 to-green-500 rounded-lg shadow-lg p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">&#x2B50; NPS &mdash; Net Promoter Score</h1>
                <p class="text-green-100 mt-1">FM/Ops Survey Satisfaction &middot; Source: Tableau</p>
            </div>
            <div class="flex gap-6">
                <div class="text-center"><p class="text-3xl font-bold" id="npsOverallScore">--</p><p class="text-xs text-green-100">Overall NPS</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="npsTotalResponses">--</p><p class="text-xs text-green-100">Total Responses</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="npsTotalStores">--</p><p class="text-xs text-green-100">Total Stores</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="npsAvgParticipation">--</p><p class="text-xs text-green-100">Avg Participation</p></div>
            </div>
        </div>
    </div>

    <!-- NPS Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-medium text-gray-700">&#x1F50D; Filter</h3>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <input type="text" id="npsNameSearch" placeholder="Search by name..." autocomplete="off"
                        oninput="nameSearch('nps', this.value)"
                        class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-48 focus:ring-2 focus:ring-[#0ea5e9] focus:border-[#0ea5e9] pl-8">
                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs">&#x1F50D;</span>
                    <div id="npsNameResults" class="hidden absolute z-50 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
                <button onclick="clearNpsFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-md">&#x2715; Clear</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-3">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sr. Director</label>
                <select id="npsFilterSr" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Sr. Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FM Director</label>
                <select id="npsFilterDir" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Regional Manager</label>
                <select id="npsFilterRm" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Regional Mgrs</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FS Manager</label>
                <select id="npsFilterFsm" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All FS Managers</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Market</label>
                <select id="npsFilterMkt" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Markets</option>
                </select>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ops Region</label>
                <select id="npsFilterOps" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Ops Regions</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ops Regional</label>
                <select id="npsFilterRegional" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Regionals</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Market Manager</label>
                <select id="npsFilterManager" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Managers</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">NPS Score Range</label>
                <select id="npsFilterScore" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Scores</option>
                    <option value="90">&ge;90 (Excellent)</option>
                    <option value="80">80-89 (Good)</option>
                    <option value="70">70-79 (Moderate)</option>
                    <option value="60">60-69 (Needs Work)</option>
                    <option value="0">&lt;60 (Critical)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Participation Rate</label>
                <select id="npsFilterPart" onchange="applyNpsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="">All Rates</option>
                    <option value="50">&ge;50%</option>
                    <option value="30">30-49%</option>
                    <option value="20">20-29%</option>
                    <option value="0">&lt;20%</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Missing Markets Alert -->
    <div id="npsMissingMarketsAlert" class="hidden mb-6">
        <div class="bg-amber-50 border border-amber-300 rounded-lg p-4">
            <div class="flex items-start gap-3">
                <span class="text-xl flex-shrink-0">&#x26A0;&#xFE0F;</span>
                <div class="flex-1">
                    <h3 class="text-sm font-bold text-amber-800 mb-1">Missing NPS Survey Data</h3>
                    <p class="text-sm text-amber-700" id="npsMissingSummary"></p>
                    <details class="mt-2">
                        <summary class="text-xs text-amber-600 cursor-pointer hover:text-amber-800 font-medium">Show affected stores</summary>
                        <div id="npsMissingDetail" class="mt-2 text-xs text-amber-700 max-h-48 overflow-y-auto"></div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <!-- Sr Director KPI Cards -->
    <h2 class="text-lg font-bold text-gray-800 mb-3">&#x1F4CB; NPS by FS Sr. Director</h2>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6" id="npsSrCards"></div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4CA; NPS by Ops Regional</h3><button onclick="exportChartPNG('npsRegionalChart','nps_by_regional')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Region-level NPS scores (click bars to drill down)</p>
            <div style="height:350px"><canvas id="npsRegionalChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F30D; NPS Score by Region (Map Buckets)</h3><button onclick="exportChartPNG('npsRegionBucketChart','nps_region_buckets')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Regions by NPS score bracket &mdash; Q1 2026</p>
            <div style="height:350px"><canvas id="npsRegionBucketChart"></canvas></div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4C8; NPS Distribution</h3><button onclick="exportChartPNG('npsDistChart','nps_distribution')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Market-level NPS score distribution (click bars to see markets)</p>
            <div style="height:280px"><canvas id="npsDistChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F3AF; Participation Rate Distribution</h3><button onclick="exportChartPNG('npsParticipationChart','nps_participation')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Survey response rates across markets (click bars to see markets)</p>
            <div style="height:280px"><canvas id="npsParticipationChart"></canvas></div>
        </div>
    </div>

    <!-- Distribution Drill-down Panel (appears on chart click) -->
    <div id="npsDistDrillPanel" class="hidden mb-6">
        <div class="bg-white rounded-lg shadow-lg border-2 border-[#0ea5e9] overflow-hidden">
            <div class="bg-[#0ea5e9] text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-base font-bold">&#x1F3EA; <span id="npsDistDrillTitle"></span></h3>
                <div class="flex items-center gap-3">
                    <span id="npsDistDrillCount" class="text-sm bg-white/20 rounded-full px-3 py-1"></span>
                    <input type="text" id="npsDistDrillSearch" placeholder="Search..." oninput="renderNpsDistDrill()"
                        class="border-0 rounded-md px-3 py-1 text-sm text-gray-800 w-48 focus:ring-2 focus:ring-white">
                    <button onclick="clearNpsDistDrill()" class="text-white hover:text-gray-200 text-xl">&times;</button>
                </div>
            </div>
            <div class="overflow-x-auto" style="max-height:500px; overflow-y:auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsDistDrill('market')">Market</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsDistDrill('manager')">Market Manager</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsDistDrill('regional')">Ops Regional</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsDistDrill('market_nps')">NPS Score</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsDistDrill('volume')">Responses</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsDistDrill('stores')">Stores</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsDistDrill('response_rate')">Response %</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsDistDrill('region_participation')">Region Part.</th>
                        </tr>
                    </thead>
                    <tbody id="npsDistDrillBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ops Market Drill-down Panel -->
    <div id="npsMarketPanel" class="hidden mb-6">
        <div class="bg-white rounded-lg shadow-lg border-2 border-green-600 overflow-hidden">
            <div class="bg-green-700 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="text-base font-bold">&#x1F3EA; Markets &mdash; <span id="npsMarketPanelTitle"></span></h3>
                <div class="flex items-center gap-3">
                    <span id="npsMarketCount" class="text-sm bg-white/20 rounded-full px-3 py-1"></span>
                    <input type="text" id="npsMarketSearch" placeholder="Search..." oninput="renderNpsMarketList()"
                        class="border-0 rounded-md px-3 py-1 text-sm text-gray-800 w-48 focus:ring-2 focus:ring-white">
                    <button onclick="clearNpsMarketSlice()" class="text-white hover:text-gray-200 text-xl">&times;</button>
                </div>
            </div>
            <div class="overflow-x-auto" style="max-height:500px; overflow-y:auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsMarkets('market')">Market</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsMarkets('manager')">Market Manager</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsMarkets('market_nps')">NPS Score</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsMarkets('volume')">Responses</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsMarkets('stores')">Stores</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsMarkets('response_rate')">Response %</th>
                        </tr>
                    </thead>
                    <tbody id="npsMarketBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Full Ops Market Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
            <div>
                <div class="flex justify-between items-center"><h2 class="text-lg font-semibold text-gray-800">&#x1F4CB; All Markets &mdash; NPS Detail</h2><button onclick="exportTableCSV(document.getElementById('npsTableBody')?.closest('table'),'nps_markets_detail')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
                <p class="text-xs text-gray-500">Click column headers to sort &middot; Click rows for details</p>
            </div>
            <input type="text" id="npsTableSearch" placeholder="Search markets/managers..." oninput="renderNpsTable()"
                class="border border-gray-300 rounded-md px-3 py-2 text-sm w-64">
        </div>
        <div class="overflow-x-auto" style="max-height:600px;overflow-y:auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('market')">Market &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('manager')">Market Manager &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('regional')">Ops Regional &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('region_nps')">Region NPS &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('market_nps')">Market NPS &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('volume')">Responses &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('stores')">Stores &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('region_participation')">Region Part. &#x25B2;&#x25BC;</th>
                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 cursor-pointer" onclick="sortNpsTable('response_rate')">Response % &#x25B2;&#x25BC;</th>
                    </tr>
                </thead>
                <tbody id="npsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
        <div class="px-4 py-2 bg-gray-50 text-xs text-gray-500"><span id="npsTableShowing"></span></div>
    </div>

    <!-- Insights -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <h3 class="text-lg font-semibold text-green-800 mb-2">&#x1F4CA; NPS Insights &amp; Analysis</h3>
        <div id="npsInsights" class="text-sm text-green-700 space-y-2"></div>
    </div>

    <div class="flex justify-center py-4"><button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="px-4 py-2 bg-[#0ea5e9] hover:bg-[#004c91] text-white text-sm font-semibold rounded-lg flex items-center gap-2 shadow transition">&#x2B06; Back to Top</button></div>
</main>
</div>

<!-- Goals Tab -->
<div id="goals-content" class="hidden">
<main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Goals Header -->
    <div class="bg-gradient-to-r from-[#004c91] to-[#0ea5e9] rounded-lg shadow-lg p-6 mb-6 text-white">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">&#x1F3AF; Goals &amp; Targets &mdash; FY24 &rarr; FY27</h1>
                <p class="text-blue-200 mt-1">Health &amp; Resilience Scoring &middot; Product Loss Targets &middot; Mock View</p>
            </div>
            <div class="flex gap-6">
                <div class="text-center"><p class="text-3xl font-bold" id="goalsCurrLoss">--</p><p class="text-xs text-blue-200">FY26 YTD Loss</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="goalsCurrTnt">--</p><p class="text-xs text-blue-200">Avg TnT</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="goalsCurrDp">--</p><p class="text-xs text-blue-200">Avg Dewpoint</p></div>
                <div class="text-center"><p class="text-3xl font-bold" id="goalsCurrHvac">--</p><p class="text-xs text-blue-200">Avg HVAC TnT</p></div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-sm font-medium text-gray-700">Filters</h3>
            <div class="flex items-center gap-2">
                <div class="relative">
                    <input type="text" id="gNameSearch" placeholder="Search by name..." autocomplete="off"
                        oninput="nameSearch('g', this.value)"
                        class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-48 focus:ring-2 focus:ring-[#0ea5e9] focus:border-[#0ea5e9] pl-8">
                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs">&#x1F50D;</span>
                    <div id="gNameResults" class="hidden absolute z-50 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
                <button onclick="clearGoalsFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-md">&#x2715; Clear Filters</button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Ops Region</label>
                <select id="gOps" onchange="applyGoalsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-[#0ea5e9] focus:border-[#0ea5e9]"><option value="">All Ops Regions</option></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sr. Director</label>
                <select id="gSr" onchange="applyGoalsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-[#0ea5e9] focus:border-[#0ea5e9]"><option value="">All Sr. Directors</option></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FM Director</label>
                <select id="gDir" onchange="applyGoalsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-[#0ea5e9] focus:border-[#0ea5e9]"><option value="">All Directors</option></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Regional Manager</label>
                <select id="gRm" onchange="applyGoalsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-[#0ea5e9] focus:border-[#0ea5e9]"><option value="">All Managers</option></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">FS Manager</label>
                <select id="gFsm" onchange="applyGoalsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-[#0ea5e9] focus:border-[#0ea5e9]"><option value="">All FS Managers</option></select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Market</label>
                <select id="gMkt" onchange="applyGoalsFilters()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-[#0ea5e9] focus:border-[#0ea5e9]"><option value="">All Markets</option></select>
            </div>
        </div>
        <p class="text-xs text-gray-400 mt-2" id="goalsFilterLabel"></p>
    </div>

    <!-- Health & Resilience Scoring -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center mb-1"><h2 class="text-lg font-bold text-gray-800">&#x1F3E5; Health &amp; Resilience Health Scoring</h2><button onclick="exportSection(this.closest('.bg-white'),'goals_health_scoring')" title="Export" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
        <p class="text-xs text-gray-500 mb-4">Composite score weighted across three pillars &middot; TnT tolerance: 52&deg; (+5&deg;)</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Rack Health -->
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold text-gray-700">&#x1F527; Rack Health (Rack Scorecard)</h3>
                    <span class="text-xs font-bold text-white bg-[#0ea5e9] rounded-full px-2 py-0.5">40%</span>
                </div>
                <div class="relative pt-1">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>Current</span><span id="goalsRackPct">--</span>
                    </div>
                    <div class="overflow-hidden h-4 text-xs flex rounded-full bg-gray-200">
                        <div id="goalsRackBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-[#0ea5e9] rounded-full transition-all" style="width:0%"></div>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Target: &ge;85% average rack score</p>
            </div>
            <!-- Time in Target -->
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold text-gray-700">&#x1F321;&#xFE0F; Time in Target (Ref)</h3>
                    <span class="text-xs font-bold text-white bg-[#0ea5e9] rounded-full px-2 py-0.5">30%</span>
                </div>
                <div class="relative pt-1">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>Current</span><span id="goalsTntPct">--</span>
                    </div>
                    <div class="overflow-hidden h-4 text-xs flex rounded-full bg-gray-200">
                        <div id="goalsTntBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-[#2a8703] rounded-full transition-all" style="width:0%"></div>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Target: &ge;90% time in target &middot; 52&deg; (+5&deg;)</p>
            </div>
            <!-- Dewpoint TnT -->
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-semibold text-gray-700">&#x1F4A7; Dewpoint TnT (AHUs)</h3>
                    <span class="text-xs font-bold text-white bg-[#0ea5e9] rounded-full px-2 py-0.5">30%</span>
                </div>
                <div class="relative pt-1">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>Current</span><span id="goalsDpPct">--</span>
                    </div>
                    <div class="overflow-hidden h-4 text-xs flex rounded-full bg-gray-200">
                        <div id="goalsDpBar" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-[#fbbf24] rounded-full transition-all" style="width:0%"></div>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2">Target: &ge;90% HVAC TnT &middot; AHU dewpoint &le;52&deg;</p>
            </div>
        </div>
        <!-- Composite Score -->
        <div class="mt-4 bg-gray-50 rounded-lg p-4 flex items-center gap-6">
            <div>
                <p class="text-sm font-semibold text-gray-700">Composite Health Score</p>
                <p class="text-xs text-gray-500">= (Rack &times; 0.40) + (TnT &times; 0.30) + (Dewpoint TnT &times; 0.30)</p>
            </div>
            <div class="ml-auto text-center">
                <p class="text-4xl font-bold" id="goalsComposite">--</p>
                <p class="text-xs text-gray-500">Current Score</p>
            </div>
            <div class="text-center">
                <p class="text-4xl font-bold text-[#2a8703]">90.0</p>
                <p class="text-xs text-gray-500">FY27 Target</p>
            </div>
        </div>
    </div>

    <!-- Product Loss Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4C9; Total Product Loss &mdash; FY Trend</h3><button onclick="exportChartPNG('goalsLossChart','goals_loss_trend')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Actual vs Target &middot; FY24 &rarr; FY27 Goal</p>
            <div style="height:320px"><canvas id="goalsLossChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4C9; Markdown Loss &mdash; FY Trend</h3><button onclick="exportChartPNG('goalsMarkdownChart','goals_markdown_trend')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Actual vs Target &middot; FY24 &rarr; FY27 Goal</p>
            <div style="height:320px"><canvas id="goalsMarkdownChart"></canvas></div>
        </div>
    </div>

    <!-- SUP / Per-Store Chart -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F3EA; Loss Per Store (SUP) &mdash; FY Trend</h3><button onclick="exportChartPNG('goalsSupChart','goals_sup_trend')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Average loss per retail store &middot; FY27 SUP Goal: $149k</p>
            <div style="height:320px"><canvas id="goalsSupChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4CA; YoY Improvement Rate</h3><button onclick="exportChartPNG('goalsYoyChart','goals_yoy_improvement')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500 mb-3">Percent reduction in total loss year-over-year</p>
            <div style="height:320px"><canvas id="goalsYoyChart"></canvas></div>
        </div>
    </div>

    <!-- Goals Summary Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden mb-6">
        <div class="px-4 py-3 border-b border-gray-200">
            <div class="flex justify-between items-center"><h2 class="text-lg font-semibold text-gray-800">&#x1F4CB; Goals Summary &mdash; All Fiscal Years</h2><button onclick="exportTableCSV(document.getElementById('goalsSummaryBody')?.closest('table'),'goals_summary')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
            <p class="text-xs text-gray-500">FY26 actuals are YTD &middot; Projected full-year marked with *</p>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500">Metric</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500">FY24 Actual</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500">FY25 Actual</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500">FY26 YTD</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500">FY26 Projected*</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-[#0ea5e9] font-bold">FY27 Goal</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500">FY26&rarr;27 Gap</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500">Status</th>
                    </tr>
                </thead>
                <tbody id="goalsSummaryBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <!-- Health Score Distribution -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex justify-between items-center mb-2"><h3 class="text-base font-semibold text-gray-800">&#x1F4CA; Store Health Score Distribution (FY26 Current)</h3><button onclick="exportChartPNG('goalsHealthDistChart','goals_health_distribution')" title="Export Chart" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button></div>
        <p class="text-xs text-gray-500 mb-3">How many stores fall in each health score bracket</p>
        <div style="height:280px"><canvas id="goalsHealthDistChart"></canvas></div>
    </div>

    <!-- Insights -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h3 class="text-lg font-semibold text-[#004c91] mb-2">&#x1F4CA; Goals Insights &amp; Gap Analysis</h3>
        <div id="goalsInsights" class="text-sm text-[#004c91] space-y-2"></div>
    </div>

    <div class="flex justify-center py-4"><button onclick="window.scrollTo({top:0,behavior:'smooth'})" class="px-4 py-2 bg-[#0ea5e9] hover:bg-[#004c91] text-white text-sm font-semibold rounded-lg flex items-center gap-2 shadow transition">&#x2B06; Back to Top</button></div>
</main>
</div>

<!-- ═══════════ Active Projects Tab ═══════════ -->
<div id="projects-content" class="hidden">
    <div class="max-w-7xl mx-auto px-4 py-6 space-y-6">

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-4">
            <div class="flex flex-wrap gap-3 items-end mb-3">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Sr. Director</label>
                    <select id="pjSr" onchange="applyProjectFilters()" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Sr. Directors</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">FM Director</label>
                    <select id="pjDir" onchange="applyProjectFilters()" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Directors</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Regional Manager</label>
                    <select id="pjRm" onchange="applyProjectFilters()" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Regional Mgrs</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">FS Manager</label>
                    <select id="pjFsm" onchange="applyProjectFilters()" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All FS Managers</option>
                    </select>
                </div>
                <div class="relative ml-auto">
                    <input type="text" id="pjNameSearch" placeholder="Search by name..." autocomplete="off"
                        oninput="nameSearch('pj', this.value)"
                        class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-48 focus:ring-2 focus:ring-[#0ea5e9] focus:border-[#0ea5e9] pl-8">
                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs">&#x1F50D;</span>
                    <div id="pjNameResults" class="hidden absolute z-50 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="flex flex-wrap gap-3 items-end">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Status</label>
                    <select id="pjStatus" onchange="applyProjectFilters()" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Statuses</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Project Type</label>
                    <select id="pjType" onchange="applyProjectFilters()" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">State</label>
                    <select id="pjState" onchange="applyProjectFilters()" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All States</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Fiscal Year</label>
                    <select id="pjFy" onchange="applyProjectFilters()" class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">All FYs</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Search</label>
                    <input type="text" id="pjSearch" oninput="applyProjectFilters()" placeholder="Store # or name..." class="text-sm border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 w-48">
                </div>
                <button onclick="clearProjectFilters()" class="text-xs text-[#0ea5e9] hover:underline pb-2">Clear</button>
                <span id="pjFilterLabel" class="text-xs text-gray-400 pb-2 ml-auto"></span>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="pjKpis"></div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-2">&#x1F4CA; Projects by Status</h3>
                <div style="height:280px"><canvas id="pjStatusChart"></canvas></div>
                <button onclick="exportChartPNG('pjStatusChart','projects_by_status')" title="Export Chart" class="hidden">export</button>
            </div>
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-2">&#x1F3D7;&#xFE0F; Projects by Type</h3>
                <div style="height:280px"><canvas id="pjTypeChart"></canvas></div>
                <button onclick="exportChartPNG('pjTypeChart','projects_by_type')" title="Export Chart" class="hidden">export</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-2">&#x1F4CD; Projects by State (Top 15)</h3>
                <div style="height:320px"><canvas id="pjStateChart"></canvas></div>
                <button onclick="exportChartPNG('pjStateChart','projects_by_state')" title="Export Chart" class="hidden">export</button>
            </div>
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="text-base font-semibold text-gray-800 mb-2">&#x23F3; Project Duration Distribution</h3>
                <div style="height:320px"><canvas id="pjDurationChart"></canvas></div>
                <button onclick="exportChartPNG('pjDurationChart','project_duration')" title="Export Chart" class="hidden">export</button>
            </div>
        </div>

        <!-- Budget Overview -->
        <div class="bg-white rounded-lg shadow p-5">
            <h3 class="text-base font-semibold text-gray-800 mb-2">&#x1F4B0; Budget Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="pjBudgetCards"></div>
        </div>

        <!-- Projects Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-200 flex flex-wrap justify-between items-center gap-3">
                <h2 class="text-lg font-semibold text-gray-800">&#x1F4CB; All Active Projects</h2>
                <div class="flex items-center gap-3 flex-wrap">
                    <div class="flex items-center gap-1.5">
                        <label class="text-xs font-medium text-gray-500">Type:</label>
                        <select id="pjTableType" onchange="applyProjectFilters()" class="text-xs border-gray-300 rounded-md px-2 py-1 focus:border-blue-500 focus:ring-blue-500">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <label class="text-xs font-medium text-gray-500">Status:</label>
                        <select id="pjTableStatus" onchange="applyProjectFilters()" class="text-xs border-gray-300 rounded-md px-2 py-1 focus:border-blue-500 focus:ring-blue-500">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-1.5">
                        <label class="text-xs font-medium text-gray-500">Category:</label>
                        <select id="pjTableCat" onchange="applyProjectFilters()" class="text-xs border-gray-300 rounded-md px-2 py-1 focus:border-blue-500 focus:ring-blue-500">
                            <option value="">All</option>
                        </select>
                    </div>
                    <input type="text" id="pjTableSearch" oninput="applyProjectFilters()" placeholder="Store # or name..." class="text-xs border-gray-300 rounded-md px-2 py-1 w-36 focus:border-blue-500 focus:ring-blue-500">
                    <span id="pjTableCount" class="text-xs text-gray-400"></span>
                    <button onclick="exportTableCSV(document.getElementById('pjTableBody')?.closest('table'),'active_projects')" title="Export CSV" class="px-2 py-1 text-xs font-medium text-gray-500 hover:text-[#0ea5e9] hover:bg-blue-50 rounded transition border border-transparent hover:border-blue-200">&#x1F4E5;</button>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                <table class="min-w-full text-xs">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th onclick="sortProjects('sn')" class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-gray-700">Store &#x2195;</th>
                            <th onclick="sortProjects('pt')" class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-gray-700">Type &#x2195;</th>
                            <th onclick="sortProjects('as')" class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-gray-700">Status &#x2195;</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Location</th>
                            <th onclick="sortProjects('cst')" class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-gray-700">Const. Start &#x2195;</th>
                            <th onclick="sortProjects('cco')" class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-gray-700">Const. Complete &#x2195;</th>
                            <th onclick="sortProjects('cer')" class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-gray-700">Ceremony &#x2195;</th>
                            <th onclick="sortProjects('pos')" class="px-3 py-2 text-left font-medium text-gray-500 cursor-pointer hover:text-gray-700">Possession &#x2195;</th>
                            <th onclick="sortProjects('dur')" class="px-3 py-2 text-right font-medium text-gray-500 cursor-pointer hover:text-gray-700">Duration &#x2195;</th>
                            <th onclick="sortProjects('wbud')" class="px-3 py-2 text-right font-medium text-gray-500 cursor-pointer hover:text-gray-700">Budget &#x2195;</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Contractor</th>
                            <th class="px-3 py-2 text-left font-medium text-gray-500">Phase</th>
                        </tr>
                    </thead>
                    <tbody id="pjTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
            <div id="pjTablePagination" class="px-5 py-3 border-t border-gray-200 flex justify-between items-center text-xs text-gray-500"></div>
        </div>

    </div>
</div>

<!-- KPI Centralized Tab -->
<div id="kpi-content" class="hidden">
<main class="max-w-7xl mx-auto px-4 py-6">
    <!-- KPI Header -->
    <div class="bg-gradient-to-r from-indigo-700 to-indigo-500 rounded-lg shadow-lg p-4 sm:p-6 mb-6 text-white">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold">&#x1F4CA; FS Centralized KPIs</h1>
                <p class="text-indigo-100 mt-1 text-xs sm:text-sm">Safety &middot; Service &middot; Productivity &middot; Finance &middot; Source: BigQuery</p>
            </div>
            <div class="grid grid-cols-2 sm:flex gap-4 sm:gap-6 w-full sm:w-auto">
                <div class="text-center"><p class="text-2xl sm:text-3xl font-bold" id="kpiOverallTrir">--</p><p class="text-xs text-indigo-100">Current TRIR</p></div>
                <div class="text-center"><p class="text-2xl sm:text-3xl font-bold" id="kpiOverallNps">--</p><p class="text-xs text-indigo-100">Avg NPS</p></div>
                <div class="text-center"><p class="text-2xl sm:text-3xl font-bold" id="kpiOverallTat">--</p><p class="text-xs text-indigo-100">Avg TiT %</p></div>
                <div class="text-center"><p class="text-2xl sm:text-3xl font-bold" id="kpiOverallSpend">--</p><p class="text-xs text-indigo-100">Total Spend</p></div>
            </div>
        </div>
    </div>

    <!-- Sub-tab navigation (mirrors Tableau tabs) -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b border-gray-200 px-4">
            <nav class="flex space-x-4 sm:space-x-6 overflow-x-auto -mb-px" role="tablist" aria-label="KPI Sub-tabs" style="-webkit-overflow-scrolling:touch">
                <button onclick="switchKpiSub('overview')" id="kpiSub-overview" role="tab" aria-selected="true"
                    class="border-b-2 border-[#0ea5e9] text-[#0ea5e9] py-3 px-1 text-sm font-medium whitespace-nowrap">&#x1F4CB; Centralized KPIs</button>
                <button onclick="switchKpiSub('safety')" id="kpiSub-safety" role="tab" aria-selected="false"
                    class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium whitespace-nowrap">&#x1F6E1;&#xFE0F; Safety Ranked</button>
                <button onclick="switchKpiSub('service')" id="kpiSub-service" role="tab" aria-selected="false"
                    class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium whitespace-nowrap">&#x1F91D; Service Ranked</button>
                <button onclick="switchKpiSub('productivity')" id="kpiSub-productivity" role="tab" aria-selected="false"
                    class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium whitespace-nowrap">&#x26A1; Productivity Ranked</button>
                <button onclick="switchKpiSub('finance')" id="kpiSub-finance" role="tab" aria-selected="false"
                    class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium whitespace-nowrap">&#x1F4B0; Finance Ranked</button>
            </nav>
        </div>

        <!-- KPI Filters -->
        <div class="px-4 py-3 border-b border-gray-100">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-medium text-gray-700">&#x1F50D; Filter</h3>
                <button onclick="clearKpiFilters()" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm rounded-md">&#x2715; Clear</button>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sr. Director</label>
                    <select id="kpiFilterSr" onchange="onKpiFilterChange('sr')" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">All Sr. Directors</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Director</label>
                    <select id="kpiFilterDir" onchange="onKpiFilterChange('dir')" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">All Directors</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                    <select id="kpiFilterRgn" onchange="onKpiFilterChange('rgn')" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">All Regions</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fiscal Year</label>
                    <select id="kpiFilterFy" onchange="onKpiFilterChange('fy')" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">All Years</option>
                        <option value="2026" selected>FY2026</option>
                        <option value="2025">FY2025</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quarter</label>
                    <select id="kpiFilterQtr" onchange="onKpiFilterChange('qtr')" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="">All Quarters</option>
                        <option value="1">Q1</option>
                        <option value="2">Q2</option>
                        <option value="3">Q3</option>
                        <option value="4">Q4</option>
                    </select>
                </div>
            </div>
            <div id="kpiFilterLabel" class="text-xs text-gray-500 mt-2"></div>
        </div>
    </div>

    <!-- ═══ Centralized KPIs Overview ═══ -->
    <div id="kpiSubContent-overview">
        <!-- Summary KPI cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="kpiOverviewCards"></div>

        <!-- TRIR Trend -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-base font-semibold text-gray-800 mb-4">TRIR Monthly Trend</h3>
            <div style="height:300px"><canvas id="kpiTrirTrendChart"></canvas></div>
        </div>

        <!-- Side-by-side: Safety vs NPS leaders -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-base font-semibold text-gray-800 mb-3">&#x1F3C6; Top 5 Safest (by TRIR)</h3>
                <div id="kpiTopSafety"></div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-base font-semibold text-gray-800 mb-3">&#x1F3C6; Top 5 Service (by NPS)</h3>
                <div id="kpiTopService"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-base font-semibold text-gray-800 mb-3">&#x1F3C6; Top 5 Productivity (by TiT)</h3>
                <div id="kpiTopProductivity"></div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-base font-semibold text-gray-800 mb-3">&#x1F4B0; Top 5 Finance (Spend Efficiency)</h3>
                <div id="kpiTopFinance"></div>
            </div>
        </div>
    </div>

    <!-- ═══ Safety Ranked ═══ -->
    <div id="kpiSubContent-safety" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base font-semibold text-gray-800">&#x1F6E1;&#xFE0F; Safety Ranked — TRIR by Leadership</h3>
                <select id="kpiSafetyGroupBy" onchange="onKpiSubGroupByChange('safety')" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-full sm:w-auto">
                    <option value="sr">By Sr. Director</option>
                    <option value="dir">By Director</option>
                    <option value="rgn">By Region</option>
                </select>
                </div>
            </div>
            <div style="height:350px"><canvas id="kpiSafetyBarChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base font-semibold text-gray-800">Safety Ranking Table</h3>
                <input type="text" id="kpiSafetySearch" oninput="renderKpiSafety()" placeholder="&#x1F50D; Search name..." class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-full sm:w-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto"><table class="min-w-full text-sm" id="kpiSafetyTable">
                <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left font-medium text-gray-600">Rank</th><th class="px-3 py-2 text-left font-medium text-gray-600">Name</th><th class="px-3 py-2 text-right font-medium text-gray-600">Hours</th><th class="px-3 py-2 text-right font-medium text-gray-600">Incidents</th><th class="px-3 py-2 text-right font-medium text-gray-600">TRIR</th></tr></thead>
                <tbody id="kpiSafetyTbody"></tbody>
            </table></div>
        </div>
    </div>

    <!-- ═══ Service Ranked ═══ -->
    <div id="kpiSubContent-service" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base font-semibold text-gray-800">&#x1F91D; Service Ranked — NPS by Leadership</h3>
                <select id="kpiServiceGroupBy" onchange="onKpiSubGroupByChange('service')" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-full sm:w-auto">
                    <option value="sr">By Sr. Director</option>
                    <option value="dir">By Director</option>
                    <option value="sub">By Sub-Region</option>
                </select>
            </div>
            <div style="height:350px"><canvas id="kpiServiceBarChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base font-semibold text-gray-800">Service Ranking Table</h3>
                <input type="text" id="kpiServiceSearch" oninput="renderKpiService()" placeholder="&#x1F50D; Search name..." class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-full sm:w-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto"><table class="min-w-full text-sm" id="kpiServiceTable">
                <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left font-medium text-gray-600">Rank</th><th class="px-3 py-2 text-left font-medium text-gray-600">Name</th><th class="px-3 py-2 text-right font-medium text-gray-600">Responses</th><th class="px-3 py-2 text-right font-medium text-gray-600">Avg NPS</th></tr></thead>
                <tbody id="kpiServiceTbody"></tbody>
            </table></div>
        </div>
    </div>

    <!-- ═══ Productivity Ranked ═══ -->
    <div id="kpiSubContent-productivity" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base font-semibold text-gray-800">&#x26A1; Productivity Ranked — Time-in-Target by Leadership</h3>
                <select id="kpiProdGroupBy" onchange="onKpiSubGroupByChange('productivity')" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-full sm:w-auto">
                    <option value="sr">By Sr. Director</option>
                    <option value="dir">By Director</option>
                    <option value="rm">By Regional Mgr</option>
                </select>
            </div>
            <div style="height:350px"><canvas id="kpiProdBarChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base font-semibold text-gray-800">Productivity Ranking Table</h3>
                <input type="text" id="kpiProdSearch" oninput="renderKpiProductivity()" placeholder="&#x1F50D; Search name..." class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-full sm:w-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto"><table class="min-w-full text-sm" id="kpiProdTable">
                <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left font-medium text-gray-600">Rank</th><th class="px-3 py-2 text-left font-medium text-gray-600">Name</th><th class="px-3 py-2 text-right font-medium text-gray-600">Stores</th><th class="px-3 py-2 text-right font-medium text-gray-600">7-Day TiT</th><th class="px-3 py-2 text-right font-medium text-gray-600">30-Day TiT</th><th class="px-3 py-2 text-right font-medium text-gray-600">Current TiT</th></tr></thead>
                <tbody id="kpiProdTbody"></tbody>
            </table></div>
        </div>
    </div>

    <!-- ═══ Finance Ranked ═══ -->
    <div id="kpiSubContent-finance" class="hidden">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-base font-semibold text-gray-800 mb-4">&#x1F4B0; Finance Ranked — Construction Project Spend</h3>
            <div style="height:350px"><canvas id="kpiFinanceBarChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base font-semibold text-gray-800">Project Financial Details</h3>
                <div class="flex gap-2 items-center w-full sm:w-auto">
                    <input type="text" id="kpiFinSearch" oninput="renderKpiFinance()" placeholder="&#x1F50D; Search..." class="border border-gray-300 rounded-md px-3 py-1.5 text-sm flex-1 sm:w-40 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <select id="kpiFinGroupBy" onchange="onKpiSubGroupByChange('finance')" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm">
                    <option value="gc">By GC Firm</option>
                    <option value="type">By Project Type</option>
                    <option value="year">By Year</option>
                </select>
            </div>
            <div class="overflow-x-auto"><table class="min-w-full text-sm" id="kpiFinanceTable">
                <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left font-medium text-gray-600">Rank</th><th class="px-3 py-2 text-left font-medium text-gray-600">Name</th><th class="px-3 py-2 text-right font-medium text-gray-600">Projects</th><th class="px-3 py-2 text-right font-medium text-gray-600">Budget</th><th class="px-3 py-2 text-right font-medium text-gray-600">Spend</th><th class="px-3 py-2 text-right font-medium text-gray-600">Spend %</th></tr></thead>
                <tbody id="kpiFinanceTbody"></tbody>
            </table></div>
        </div>
        <!-- GC Score Card -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-4">
                <h3 class="text-base font-semibold text-gray-800">&#x1F3C6; GC Scorecard</h3>
                <input type="text" id="kpiGcSearch" oninput="renderKpiFinance()" placeholder="&#x1F50D; Search GC..." class="border border-gray-300 rounded-md px-3 py-1.5 text-sm w-full sm:w-48 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="overflow-x-auto"><table class="min-w-full text-sm" id="kpiGcTable">
                <thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left font-medium text-gray-600">Rank</th><th class="px-3 py-2 text-left font-medium text-gray-600">GC Name</th><th class="px-3 py-2 text-right font-medium text-gray-600">Projects</th><th class="px-3 py-2 text-right font-medium text-gray-600">Spend</th><th class="px-3 py-2 text-right font-medium text-gray-600">Awarded</th><th class="px-3 py-2 text-right font-medium text-gray-600">Spend %</th><th class="px-3 py-2 text-right font-medium text-gray-600">Avg Days</th><th class="px-3 py-2 text-center font-medium text-gray-600">ISN Grade</th></tr></thead>
                <tbody id="kpiGcTbody"></tbody>
            </table></div>
        </div>
    </div>

</main>
</div>

<!-- placeholder - store detail is handled inline in tnt_tab -->

<script>
// ── Shared Name Search Utility (used across all tabs) ──
// Config per tab: { prefix, orgIds: [{key, filterId, label}], applyFn, clearFn }
var _nameSearchConfigs = {};

function registerNameSearch(prefix, config) {
    _nameSearchConfigs[prefix] = config;
}

function nameSearch(prefix, query) {
    var cfg = _nameSearchConfigs[prefix];
    if (!cfg) return;
    var panel = document.getElementById(prefix + 'NameResults');
    if (!panel) return;
    query = (query || '').trim().toLowerCase();
    if (query.length < 2) { panel.classList.add('hidden'); return; }

    var banners = typeof getActiveBanners === 'function' ? getActiveBanners() : null;
    var stores = STORES;
    if (banners) stores = stores.filter(function(s) { return banners.has(s.bn); });
    // Optional: filter to stores with relevant data
    if (cfg.storeFilter) stores = stores.filter(cfg.storeFilter);

    var matches = [];
    var seen = new Set();
    var roleColors = {
        'Sr. Director': 'bg-blue-100 text-blue-700',
        'FM Director': 'bg-purple-100 text-purple-700',
        'Regional Manager': 'bg-green-100 text-green-700',
        'FS Manager': 'bg-orange-100 text-orange-700',
    };

    cfg.orgIds.forEach(function(f) {
        stores.forEach(function(s) {
            var name = s[f.key];
            if (!name) return;
            var normalized = name.indexOf('Unassigned') === 0 ? 'Unassigned' : name;
            var uniqueKey = f.key + '|' + normalized;
            if (seen.has(uniqueKey)) return;
            if (normalized.toLowerCase().indexOf(query) >= 0) {
                seen.add(uniqueKey);
                matches.push({ name: normalized, field: f });
            }
        });
    });

    matches.sort(function(a, b) {
        var aStart = a.name.toLowerCase().indexOf(query) === 0 ? 0 : 1;
        var bStart = b.name.toLowerCase().indexOf(query) === 0 ? 0 : 1;
        if (aStart !== bStart) return aStart - bStart;
        return a.name.localeCompare(b.name);
    });

    if (matches.length === 0) {
        panel.innerHTML = '<div class="px-3 py-2 text-sm text-gray-400 italic">No matches found</div>';
        panel.classList.remove('hidden');
        return;
    }

    panel.innerHTML = matches.slice(0, 15).map(function(m) {
        var cls = roleColors[m.field.label] || 'bg-gray-100 text-gray-700';
        var idx = m.name.toLowerCase().indexOf(query);
        var hl = m.name.substring(0, idx) +
            '<span class="font-bold underline">' + m.name.substring(idx, idx + query.length) + '</span>' +
            m.name.substring(idx + query.length);
        var safeName = m.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return '<button type="button" class="w-full text-left px-3 py-2 hover:bg-blue-50 flex items-center justify-between gap-2 text-sm border-b border-gray-100 last:border-0" ' +
            'onclick="nameSelect(\'' + prefix + '\',\'' + m.field.filterId + '\',\'' + safeName + '\')">' +
            '<span>' + hl + '</span>' +
            '<span class="px-2 py-0.5 rounded-full text-xs font-medium ' + cls + '">' + m.field.label + '</span>' +
            '</button>';
    }).join('');
    panel.classList.remove('hidden');
}

function nameSelect(prefix, filterId, name) {
    var cfg = _nameSearchConfigs[prefix];
    if (!cfg) return;
    // Clear all org filters first
    cfg.orgIds.forEach(function(f) {
        var el = document.getElementById(f.filterId);
        if (el) el.value = '';
    });
    // Set the selected one
    var sel = document.getElementById(filterId);
    if (sel) {
        for (var i = 0; i < sel.options.length; i++) {
            if (sel.options[i].value === name) { sel.value = name; break; }
        }
    }
    // Update search box
    var searchBox = document.getElementById(prefix + 'NameSearch');
    if (searchBox) searchBox.value = name;
    // Hide results
    var panel = document.getElementById(prefix + 'NameResults');
    if (panel) panel.classList.add('hidden');
    // Apply filters
    if (cfg.applyFn && typeof window[cfg.applyFn] === 'function') window[cfg.applyFn]();
}

function nameSearchClear(prefix) {
    var searchBox = document.getElementById(prefix + 'NameSearch');
    if (searchBox) searchBox.value = '';
    var panel = document.getElementById(prefix + 'NameResults');
    if (panel) panel.classList.add('hidden');
}

// Close all search result panels when clicking outside
document.addEventListener('click', function(e) {
    Object.keys(_nameSearchConfigs).forEach(function(prefix) {
        var panel = document.getElementById(prefix + 'NameResults');
        var input = document.getElementById(prefix + 'NameSearch');
        if (panel && input && !panel.contains(e.target) && e.target !== input) {
            panel.classList.add('hidden');
        }
    });
});
</script>

<script>
// ── Executive Filters ──
function populateExecFilter(id, values) {
    var sel = document.getElementById(id);
    var cur = sel.value;
    var firstLabel = sel.options.length > 0 ? sel.options[0].text : 'All';
    var normalized = values.map(function(v) { return (v && v.indexOf('Unassigned') === 0) ? 'Unassigned' : v; });
    var opts = [...new Set(normalized)].filter(Boolean).sort();
    sel.innerHTML = '<option value="">' + firstLabel + '</option>' +
        opts.map(function(v) { return '<option value="' + v + '"' + (v === cur ? ' selected' : '') + '>' + v + '</option>'; }).join('');
    if (cur && !opts.includes(cur)) sel.value = '';
}

function getExecFiltered() {
    var ops = document.getElementById('exOps').value;
    var sr = document.getElementById('exSr').value;
    var dir = document.getElementById('exDir').value;
    var rm = document.getElementById('exRm').value;
    var fsm = document.getElementById('exFsm').value;
    return STORES.filter(function(s) {
        return getActiveBanners().has(s.bn) &&
            (!ops || s.ops === ops) &&
            _matchField(s.sr, sr) && _matchField(s.dir, dir) &&
            _matchField(s.rm, rm) && _matchField(s.fsm, fsm);
    });
}

function applyExecFilters() {
    var retail = getExecFiltered();
    populateExecFilter('exOps', retail.map(function(s) { return s.ops; }));
    populateExecFilter('exDir', retail.map(function(s) { return s.dir; }));
    populateExecFilter('exRm', retail.map(function(s) { return s.rm; }));
    populateExecFilter('exFsm', retail.map(function(s) { return s.fsm; }));
    var parts = [];
    if (document.getElementById('exOps').value) parts.push('Ops ' + document.getElementById('exOps').value);
    if (document.getElementById('exSr').value) parts.push(document.getElementById('exSr').value);
    if (document.getElementById('exDir').value) parts.push(document.getElementById('exDir').value);
    if (document.getElementById('exRm').value) parts.push(document.getElementById('exRm').value);
    if (document.getElementById('exFsm').value) parts.push(document.getElementById('exFsm').value);
    document.getElementById('execFilterLabel').textContent = parts.length
        ? 'Filtered: ' + parts.join(' \u203A ')
        : 'Showing all retail stores';
    renderExec();
}

function clearExecFilters() {
    ['exOps','exSr','exDir','exRm','exFsm'].forEach(function(id) { document.getElementById(id).value = ''; });
    nameSearchClear('ex');
    applyExecFilters();
}

registerNameSearch('ex', {
    orgIds: [
        { key: 'sr', filterId: 'exSr', label: 'Sr. Director' },
        { key: 'dir', filterId: 'exDir', label: 'FM Director' },
        { key: 'rm', filterId: 'exRm', label: 'Regional Manager' },
        { key: 'fsm', filterId: 'exFsm', label: 'FS Manager' },
    ],
    applyFn: 'applyExecFilters'
});

function initExecFilters() {
    var allRetail = STORES.filter(function(s) { return getActiveBanners().has(s.bn); });
    populateExecFilter('exOps', allRetail.map(function(s) { return s.ops; }));
    populateExecFilter('exSr', allRetail.map(function(s) { return s.sr; }));
    populateExecFilter('exDir', allRetail.map(function(s) { return s.dir; }));
    populateExecFilter('exRm', allRetail.map(function(s) { return s.rm; }));
    populateExecFilter('exFsm', allRetail.map(function(s) { return s.fsm; }));
}

function getExecGroupLevel() {
    if (document.getElementById('exRm').value) return { key: 'sn', label: 'Store', nameKey: 'nm' };
    if (document.getElementById('exDir').value) return { key: 'rm', label: 'Regional Manager' };
    if (document.getElementById('exSr').value) return { key: 'dir', label: 'FM Director' };
    return { key: 'sr', label: 'Sr. Director' };
}

// ── Executive Render (uses exec filters) ──
function renderExec() {
    var retail = getExecFiltered();
    var storeSns = new Set(retail.map(function(s) { return s.sn; }));
    var allWos = getWosFy().filter(function(w) { return storeSns.has(w.sn); });

    document.getElementById('execTs').textContent = GENERATED;
    // Update FY labels
    var fyLbl = activeFy ? fyLabel(activeFy) : 'FY' + currentFyNum();
    var fyPeriod = activeFy ? 'Feb ' + (2000 + activeFy - 1) + ' \u2013 Jan ' + (2000 + activeFy) : 'All Time';
    var elFy = document.getElementById('execFyLabel'); if (elFy) elFy.textContent = fyLbl;
    var elPd = document.getElementById('execPeriod'); if (elPd) elPd.textContent = fyPeriod;
    var elH = document.getElementById('headerFyLabel'); if (elH) elH.textContent = fyLbl;
    document.getElementById('execStoreCount').textContent = retail.length.toLocaleString();
    document.getElementById('execWoCount').textContent = allWos.length.toLocaleString();

    var tnts = retail.filter(function(x) { return x.tnt != null; }).map(function(x) { return x.tnt; });
    var t30 = retail.filter(function(x) { return x.tnt30 != null; }).map(function(x) { return x.tnt30; });
    var t90 = retail.filter(function(x) { return x.tnt90 != null; }).map(function(x) { return x.tnt90; });
    var hvacs = retail.filter(function(x) { return x.hvac != null; }).map(function(x) { return x.hvac; });
    var dps = retail.filter(function(x) { return x.dp != null; }).map(function(x) { return x.dp; });
    var totalLoss = retail.reduce(function(a, x) { return a + (x.loss || 0); }, 0);
    var totalOOT = retail.reduce(function(a, x) { return a + (x.oot || 0); }, 0);
    var woDone = allWos.filter(function(w) { return w.st === 'COMPLETED'; }).length;
    var woPct = allWos.length ? Math.round(100 * woDone / allWos.length) : 0;

    var avgTnT = avg(tnts), avgT30 = avg(t30), avgHvac = avg(hvacs), avgDp = avg(dps);
    var pass90 = tnts.filter(function(v) { return v >= 90; }).length;
    var passPct = tnts.length ? Math.round(100 * pass90 / tnts.length) : 0;
    var dpPass = dps.filter(function(v) { return v <= 52; }).length;
    var dpPct = dps.length ? Math.round(100 * dpPass / dps.length) : 0;
    var avg90 = avg(t90);
    var trendDir = avgT30 > avg90 ? 'up' : avgT30 < avg90 ? 'down' : 'flat';
    var trendIcon = trendDir === 'up' ? '\u25B2' : trendDir === 'down' ? '\u25BC' : '\u25CF';
    var trendCls = trendDir === 'up' ? 'text-green-600' : trendDir === 'down' ? 'text-red-600' : 'text-gray-500';
    var trendDelta = Math.abs(avgT30 - avg90).toFixed(1);

    // Scorecards
    var cards = [
        { label: 'TnT Ref (Current)', value: fmt(avgTnT) + '%', color: avgTnT >= 90 ? 'border-green-500' : avgTnT >= 80 ? 'border-yellow-500' : 'border-red-500', sub: passPct + '% of stores \u226590%' },
        { label: '30-Day Trend', value: fmt(avgT30) + '%', color: 'border-walmart-blue', sub: '<span class="' + trendCls + ' font-semibold">' + trendIcon + ' ' + trendDelta + 'pp</span> vs 90-day' },
        { label: 'HVAC Avg', value: fmt(avgHvac) + '%', color: avgHvac >= 90 ? 'border-green-500' : 'border-yellow-500', sub: hvacs.filter(function(v) { return v >= 90; }).length + '/' + hvacs.length + ' passing' },
        { label: 'Dewpoint', value: fmt(avgDp) + '\u00b0F', color: avgDp <= 52 ? 'border-green-500' : 'border-red-500', sub: dpPct + '% at/below 52\u00b0F' },
        { label: 'Total Loss', value: '$' + fmtK(Math.round(totalLoss)), color: 'border-red-500', sub: totalOOT.toLocaleString() + ' cases OOT' },
        { label: 'WTW Complete', value: woPct + '%', color: woPct >= 75 ? 'border-green-500' : woPct >= 50 ? 'border-yellow-500' : 'border-red-500', sub: woDone.toLocaleString() + '/' + allWos.length.toLocaleString() + ' WOs' },
    ];
    document.getElementById('execScoreCards').innerHTML = cards.map(function(c) {
        return '<div class="kpi-card bg-white rounded-lg shadow p-4 border-l-4 ' + c.color + '">' +
            '<p class="text-xs text-gray-500 uppercase tracking-wide">' + c.label + '</p>' +
            '<p class="text-2xl font-bold text-gray-800 mt-1">' + c.value + '</p>' +
            '<p class="text-xs text-gray-500 mt-1">' + c.sub + '</p></div>';
    }).join('');

    renderExecFindings(retail, allWos, avgTnT, avgT30, avg90, avgHvac, avgDp, passPct, dpPct, woPct, totalLoss);
    renderExecTntDist(tnts);
    renderExecWtwPhase(allWos);
    renderExecSrCompare(retail);
    renderExecLossPareto(retail);
    var tsEl = document.getElementById('lossRefreshTs');
    if (tsEl) tsEl.textContent = GENERATED || 'N/A';
    renderExecRisksWins(retail, allWos, avgTnT, avgDp, passPct, woPct);
    renderExecRankTable(retail, allWos);
    renderExecRecommendations(retail, allWos, avgTnT, avgDp, passPct, woPct, totalLoss);
}
</script>
<script>
// ── Executive sub-renderers (split for file size) ──
function renderExecFindings(retail, allWos, avgTnT, avgT30, avg90, avgHvac, avgDp, passPct, dpPct, woPct, totalLoss) {
    var tw = avgT30 > avg90 ? 'improving' : avgT30 < avg90 ? 'declining' : 'stable';
    var tc = tw === 'improving' ? 'text-green-700' : tw === 'declining' ? 'text-red-700' : '';
    var td = Math.abs(avgT30 - avg90).toFixed(1);
    var woR = allWos.filter(function(w) { return w.st !== 'COMPLETED'; }).length;
    var html = '<p><strong>Refrigeration Time-in-Target</strong> across ' + retail.length + ' stores sits at <strong class="' + (avgTnT >= 90 ? 'text-green-700' : 'text-red-700') + '">' + fmt(avgTnT) + '%</strong>. 30-day trend is <strong class="' + tc + '">' + tw + '</strong> (' + td + 'pp vs 90-day). ' + passPct + '% meeting \u226590% target.</p>';
    html += '<p><strong>HVAC</strong> averages <strong>' + fmt(avgHvac) + '%</strong>. Dewpoint: <strong>' + fmt(avgDp) + '\u00b0F</strong> \u2014 ' + dpPct + '% at/below 52\u00b0F.</p>';
    html += '<p><strong>Win-the-Winter</strong> is <strong>' + woPct + '%</strong> complete (' + woR.toLocaleString() + ' WOs remaining). Loss: <strong class="text-red-700">$' + Math.round(totalLoss).toLocaleString() + '</strong>.</p>';
    document.getElementById('execKeyFindings').innerHTML = html;
}

var tntBucketStores = {};

function getBucket(v) {
    if (v >= 95) return '\u226595%';
    if (v >= 90) return '90\u201394%';
    if (v >= 85) return '85\u201389%';
    if (v >= 80) return '80\u201384%';
    return '<80%';
}

function renderExecTntDist(tnts) {
    destroyC('execTntDist');
    var labels = ['\u226595%', '90\u201394%', '85\u201389%', '80\u201384%', '<80%'];
    var counts = [0, 0, 0, 0, 0];
    tntBucketStores = {};
    labels.forEach(function(l) { tntBucketStores[l] = []; });

    var retail = getExecFiltered();
    retail.forEach(function(s) {
        if (s.tnt == null) return;
        var bk = getBucket(s.tnt);
        tntBucketStores[bk].push(s);
        counts[labels.indexOf(bk)]++;
    });

    var canvas = document.getElementById('execTntDist');
    chartInst['execTntDist'] = new Chart(canvas, {
        type: 'bar',
        data: { labels: labels, datasets: [{ data: counts, backgroundColor: ['#16a34a','#22c55e','#eab308','#f97316','#dc2626'], borderRadius: 6 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { callbacks: { footer: function() { return 'Click to see stores'; } } } },
            scales: { y: { title: { display: true, text: '# Stores' } } },
            onClick: function(evt, elements) {
                if (!elements.length) return;
                var idx = elements[0].index;
                showTntDrill(labels[idx]);
            }
        }
    });
    document.getElementById('tntDrillPanel').classList.add('hidden');
}

function showTntDrill(bucket) {
    var stores = (tntBucketStores[bucket] || []).slice().sort(function(a, b) { return (a.tnt || 0) - (b.tnt || 0); });
    document.getElementById('tntDrillTitle').textContent = bucket + ' \u2014 ' + stores.length + ' stores';
    document.getElementById('tntDrillBody').innerHTML = stores.map(function(s) {
        var projBadge = (typeof REFRIG_PROJECTS !== 'undefined' && REFRIG_PROJECTS[s.sn]) ? ' <span class="cursor-pointer" onclick="event.stopPropagation();showRefrigProject(\'' + s.sn + '\')" title="Refrigeration project planned">&#x1F6A7;</span>' : '';
        return '<tr class="table-row cursor-pointer" onclick="switchTab(\'tnt\'); showStore(\'' + s.sn + '\')">' +
            '<td class="px-2 py-1 font-medium">' + s.sn + projBadge + '</td>' +
            '<td class="px-2 py-1 text-xs text-gray-600">' + (s.city || '') + ', ' + (s.state || '') + '</td>' +
            '<td class="px-2 py-1 text-xs text-gray-600">' + (s.rm || '--') + '</td>' +
            '<td class="px-2 py-1 text-center font-semibold ' + tntColor(s.tnt) + '">' + fmt(s.tnt) + '%</td>' +
            '<td class="px-2 py-1 text-center ' + tntColor(s.tnt30) + '">' + fmt(s.tnt30) + '%</td>' +
            '<td class="px-2 py-1 text-center ' + tntColor(s.hvac) + '">' + fmt(s.hvac) + '%</td>' +
            '<td class="px-2 py-1 text-right text-red-600">' + (s.loss ? '$' + Math.round(s.loss).toLocaleString() : '--') + '</td></tr>';
    }).join('');
    document.getElementById('tntDrillPanel').classList.remove('hidden');
}

function renderExecWtwPhase(allWos) {
    destroyC('execWtwPhase');
    var ph = ['PH1','PH2','PH3'];
    var done = ph.map(function(p) { return allWos.filter(function(w) { return w.ph === p && w.st === 'COMPLETED'; }).length; });
    var rem = ph.map(function(p) { return allWos.filter(function(w) { return w.ph === p && w.st !== 'COMPLETED'; }).length; });
    chartInst['execWtwPhase'] = new Chart(document.getElementById('execWtwPhase'), {
        type: 'bar',
        data: { labels: ['Phase 1','Phase 2','Phase 3'], datasets: [
            { label: 'Completed', data: done, backgroundColor: '#16a34a', borderRadius: 4 },
            { label: 'Remaining', data: rem, backgroundColor: '#d1d5db', borderRadius: 4 }
        ] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } },
            scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Work Orders' } } } }
    });
}

function renderExecSrCompare(retail) {
    destroyC('execSrCompare');
    var gl = getExecGroupLevel();
    var groups = {};
    retail.forEach(function(s) {
        var k = gl.nameKey ? (s[gl.key] + ' - ' + (s[gl.nameKey] || '')) : (s[gl.key] || 'Unassigned');
        if (!groups[k]) groups[k] = { tnts: [], hvacs: [], racks: [] };
        if (s.tnt != null) groups[k].tnts.push(s.tnt);
        if (s.hvac != null) groups[k].hvacs.push(s.hvac);
        if (s.rack != null) groups[k].racks.push(s.rack);
    });
    var labels = Object.keys(groups).sort();
    var short = labels.map(function(l) { return l.length > 18 ? l.substring(0,16) + '..' : l; });
    var titleEl = document.getElementById('execSrCompare').closest('.bg-white');
    if (titleEl) titleEl.querySelector('h3').innerHTML = '&#x1F3AF; ' + gl.label + ' Performance Comparison';
    chartInst['execSrCompare'] = new Chart(document.getElementById('execSrCompare'), {
        type: 'bar',
        data: { labels: short, datasets: [
            { label: 'TnT Ref', data: labels.map(function(l) { return +(avg(groups[l].tnts).toFixed(1)); }), backgroundColor: '#0ea5e9' },
            { label: 'HVAC', data: labels.map(function(l) { return +(avg(groups[l].hvacs).toFixed(1)); }), backgroundColor: '#fbbf24' },
            { label: 'Rack', data: labels.map(function(l) { return +(avg(groups[l].racks).toFixed(1)); }), backgroundColor: '#8b5cf6' },
        ] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: { callbacks: { title: function(ctx) { return labels[ctx[0].dataIndex]; } } },
                datalabels: {
                    display: true,
                    anchor: 'center',
                    align: 'center',
                    color: function(ctx) {
                        var bg = ctx.dataset.backgroundColor;
                        return bg === '#fbbf24' ? '#333' : '#fff';
                    },
                    font: { weight: 'bold', size: 11 },
                    formatter: function(v) { return v + '%'; }
                }
            },
            scales: { x: { min: 70, max: 100 } } }
    });
}

function renderExecLossPareto(retail) {
    destroyC('execLossPareto');
    var top = retail.filter(function(s) { return s.loss > 0; }).sort(function(a, b) { return b.loss - a.loss; }).slice(0, 10);
    chartInst['execLossPareto'] = new Chart(document.getElementById('execLossPareto'), {
        type: 'bar',
        data: { labels: top.map(function(s) { return '#' + s.sn; }),
            datasets: [{ label: 'Loss ($)', data: top.map(function(s) { return Math.round(s.loss); }), backgroundColor: '#dc2626', borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(ctx) { return '$' + ctx.raw.toLocaleString(); } } } },
            scales: { x: { ticks: { callback: function(v) { return '$' + fmtK(v); } } } } }
    });
}

function renderExecRisksWins(retail, allWos, avgTnT, avgDp, passPct, woPct) {
    var risks = [];
    if (avgTnT < 90) risks.push('<p>&#x1F534; TnT Ref (<strong>' + fmt(avgTnT) + '%</strong>) below 90% target.</p>');
    var b80 = retail.filter(function(s) { return s.tnt != null && s.tnt < 80; }).length;
    if (b80 > 0) risks.push('<p>&#x1F534; <strong>' + b80 + ' stores</strong> critically below 80% TnT.</p>');
    if (avgDp > 52) risks.push('<p>&#x1F7E0; Avg dewpoint <strong>' + fmt(avgDp) + '\u00b0F</strong> exceeds 52\u00b0F.</p>');
    var dpH = retail.filter(function(s) { return s.dp != null && s.dp > 60; }).length;
    if (dpH > 0) risks.push('<p>&#x1F7E0; <strong>' + dpH + '</strong> stores above 60\u00b0F dewpoint.</p>');
    if (woPct < 50) risks.push('<p>&#x1F534; WTW only <strong>' + woPct + '%</strong> complete.</p>');
    var stale = allWos.filter(function(w) { return w.st !== 'COMPLETED' && w.cd && daysSince(w.cd) > 60; }).length;
    if (stale > 0) risks.push('<p>&#x1F7E0; <strong>' + stale + '</strong> WOs are 60+ days old.</p>');
    if (!risks.length) risks.push('<p>&#x2705; No critical risks identified.</p>');
    document.getElementById('execRisks').innerHTML = risks.join('');

    var wins = [];
    if (passPct >= 70) wins.push('<p>&#x1F3C6; <strong>' + passPct + '%</strong> meeting \u226590% TnT.</p>');
    var a95 = retail.filter(function(s) { return s.tnt != null && s.tnt >= 95; }).length;
    if (a95 > 5) wins.push('<p>&#x2B50; <strong>' + a95 + ' stores</strong> at 95%+ TnT.</p>');
    if (woPct >= 60) wins.push('<p>&#x2744; WTW <strong>' + woPct + '%</strong> complete.</p>');
    var p1d = allWos.filter(function(w) { return w.ph === 'PH1' && w.st === 'COMPLETED'; }).length;
    var p1t = allWos.filter(function(w) { return w.ph === 'PH1'; }).length;
    if (p1t > 0 && p1d / p1t >= 0.8) wins.push('<p>&#x2705; Phase 1: <strong>' + Math.round(100*p1d/p1t) + '%</strong> done.</p>');
    var top = getExecTopPerformer(retail);
    if (top) wins.push('<p>&#x1F31F; Top: <strong>' + top.nm + '</strong> at ' + fmt(top.tnt) + '% TnT (' + top.cnt + ' stores).</p>');
    if (!wins.length) wins.push('<p>Opportunities for improvement across all metrics.</p>');
    document.getElementById('execWins').innerHTML = wins.join('');
}

function daysSince(ds) { return ds ? Math.floor((Date.now() - new Date(ds).getTime()) / 86400000) : 0; }

function getExecTopPerformer(retail) {
    var gl = getExecGroupLevel();
    var g = {};
    retail.forEach(function(s) {
        var k = s[gl.key] || 'Unassigned';
        if (!g[k]) g[k] = { nm: k, tnts: [], cnt: 0 };
        g[k].cnt++; if (s.tnt != null) g[k].tnts.push(s.tnt);
    });
    var r = Object.values(g).filter(function(x) { return x.tnts.length > 3; })
        .map(function(x) { return { nm: x.nm, tnt: avg(x.tnts), cnt: x.cnt }; })
        .sort(function(a, b) { return b.tnt - a.tnt; });
    return r[0] || null;
}

function renderExecRankTable(retail, allWos) {
    var gl = getExecGroupLevel();
    var headerDiv = document.getElementById('execRankBody').closest('table').parentElement.previousElementSibling;
    if (headerDiv) {
        headerDiv.querySelector('h2').innerHTML = '&#x1F3C6; ' + gl.label + ' Scorecard';
    }
    var thRow = document.getElementById('execRankBody').closest('table').querySelector('thead tr');
    if (thRow) thRow.children[1].textContent = gl.label;

    var groups = {};
    retail.forEach(function(s) {
        var k = s[gl.key] || 'Unassigned';
        // Consolidate all Unassigned variants into one group
        if (k.indexOf('Unassigned') === 0) k = 'Unassigned';
        if (!groups[k]) groups[k] = { nm: k, tnts:[], hvacs:[], dps:[], racks:[], pms:[], loss:0, cnt:0, sns: new Set(), _stores: [] };
        groups[k].cnt++; groups[k].sns.add(s.sn); groups[k]._stores.push(s);
        if (s.tnt != null) groups[k].tnts.push(s.tnt);
        if (s.hvac != null) groups[k].hvacs.push(s.hvac);
        if (s.dp != null) groups[k].dps.push(s.dp);
        if (s.rack != null) groups[k].racks.push(s.rack);
        if (s.pm != null) groups[k].pms.push(s.pm);
        groups[k].loss += (s.loss || 0);
    });
    Object.values(groups).forEach(function(g) {
        var gw = allWos.filter(function(w) { return g.sns.has(w.sn); });
        g.wtwPct = gw.length ? Math.round(100 * gw.filter(function(w) { return w.st === 'COMPLETED'; }).length / gw.length) : 0;
    });
    var rows = Object.values(groups).map(function(g) {
        var r = { nm: g.nm, cnt: g.cnt,
            tnt: g.tnts.length ? avg(g.tnts) : null, hvac: g.hvacs.length ? avg(g.hvacs) : null,
            dp: g.dps.length ? avg(g.dps) : null, rack: g.racks.length ? avg(g.racks) : null,
            pm: g.pms.length ? avg(g.pms) : null, loss: g.loss, wtwPct: g.wtwPct, _stores: g._stores };
        r.comp = compositeScore(r);
        return r;
    });
    rows.sort(function(a, b) {
        // Unassigned always at bottom
        if (a.nm === 'Unassigned' && b.nm !== 'Unassigned') return 1;
        if (b.nm === 'Unassigned' && a.nm !== 'Unassigned') return -1;
        return (b.comp || 0) - (a.comp || 0);
    });

    document.getElementById('execRankBody').innerHTML = rows.map(function(r, i) {
        var medal = r.nm === 'Unassigned' ? '—' : (i === 0 ? '&#x1F947;' : i === 1 ? '&#x1F948;' : i === 2 ? '&#x1F949;' : (i + 1));
        var esc = r.nm.replace(/'/g, "\\'");
        // Unassigned label with region/submarket info
        var nameLabel = r.nm;
        if (r.nm === 'Unassigned') {
            var regions = new Set(r._stores.map(function(s) { return s.rgn || s.ops || ''; }).filter(Boolean));
            var subs = new Set(r._stores.map(function(s) { return s.sub || s.mkt || ''; }).filter(Boolean));
            var rgnInfo = regions.size > 0 ? regions.size + ' rgn' : '';
            var subInfo = subs.size > 0 ? subs.size + ' mkt' : '';
            var extra = [rgnInfo, subInfo].filter(Boolean).join(', ');
            nameLabel = '\u26A0\uFE0F Unassigned' + (extra ? ' <span class="text-xs text-gray-400">(' + extra + ')</span>' : '');
        }
        return '<tr class="' + (i%2 ? 'bg-gray-50' : '') + ' table-row cursor-pointer" onclick="drillToSr(\'' + esc + '\')">' +
            '<td class="px-3 py-2 text-center font-bold">' + medal + '</td>' +
            '<td class="px-3 py-2 font-medium text-sm">' + nameLabel + '</td>' +
            '<td class="px-3 py-2 text-center">' + r.cnt + '</td>' +
            '<td class="px-3 py-2 text-center font-semibold ' + tntColor(r.tnt) + '">' + fmt(r.tnt) + '%</td>' +
            '<td class="px-3 py-2 text-center ' + tntColor(r.hvac) + '">' + fmt(r.hvac) + '%</td>' +
            '<td class="px-3 py-2 text-center ' + (r.dp != null && r.dp <= 52 ? 'text-green-600' : 'text-red-600') + '">' + (r.dp != null ? fmt(r.dp) + '\u00b0F' : '--') + '</td>' +
            '<td class="px-3 py-2 text-center ' + tntColor(r.rack) + '">' + (r.rack != null ? fmt(r.rack) + '%' : '--') + '</td>' +
            '<td class="px-3 py-2 text-center font-bold ' + tntColor(r.pm) + '">' + fmt(r.pm) + '%</td>' +
            '<td class="px-3 py-2 text-center font-bold bg-blue-50 ' + compositeColor(r.comp) + '">' + (r.comp != null ? fmt(r.comp) + ' <span class="text-xs font-normal text-gray-400">(' + compositeGrade(r.comp) + ')</span>' : '--') + '</td>' +
            '<td class="px-3 py-2 text-right text-red-600">$' + fmtK(Math.round(r.loss)) + '</td>' +
            '<td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs font-semibold ' + (r.wtwPct >= 75 ? 'bg-green-100 text-green-800' : r.wtwPct >= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800') + '">' + r.wtwPct + '%</span></td></tr>';
    }).join('');
}

function drillToSr(name) {
    document.getElementById('fSr').value = name;
    switchTab('tnt');
    applyFilters();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function renderExecRecommendations(retail, allWos, avgTnT, avgDp, passPct, woPct, totalLoss) {
    var recs = [], n = 1;
    var b80 = retail.filter(function(s) { return s.tnt != null && s.tnt < 80; }).length;
    if (avgTnT < 90) { recs.push('<p><strong>' + n + '. Prioritize TnT recovery:</strong> ' + b80 + ' stores below 80% are dragging the fleet avg down.</p>'); n++; }
    var dp55 = retail.filter(function(s) { return s.dp != null && s.dp > 55; }).length;
    if (avgDp > 52) { recs.push('<p><strong>' + n + '. Address dewpoint:</strong> ' + dp55 + ' stores above 55\u00b0F. Check seals, defrost, envelope.</p>'); n++; }
    var woO = allWos.filter(function(w) { return w.st !== 'COMPLETED'; }).length;
    if (woPct < 75) { recs.push('<p><strong>' + n + '. Accelerate WTW:</strong> ' + woO + ' WOs open. Consider surge staffing.</p>'); n++; }
    if (totalLoss > 100000) { recs.push('<p><strong>' + n + '. Loss mitigation:</strong> $' + Math.round(totalLoss).toLocaleString() + ' total. Top 10 stores have disproportionate share.</p>'); n++; }
    recs.push('<p><strong>' + n + '. Monitor:</strong> Auto-refreshes every 2hr. Use scorecard to drill into teams.</p>');
    document.getElementById('execRecommendations').innerHTML = recs.join('');
}
</script>

<script>
// ── Leak Summary Tab Logic ──
let leakCharts = {};
let leakInitialized = false;
let hcSortKey = 'current_charge';
let lsSortKey = 'leak_rate';
let lsSortAsc = false;
let hcSortAsc = false;
let hcChargeFilter = null; // { label, min, max } or null for all

// Lazy store lookup map (built after STORES loads)
var STORE_MAP = null;
function ensureStoreMap() {
    if (STORE_MAP !== null) return;
    STORE_MAP = {};
    STORES.forEach(s => {
        STORE_MAP[s.sn] = { sr: s.sr, dir: s.dir, rm: s.rm, fsm: s.fsm, bn: s.bn, ops: s.ops };
    });
}

function getLeakHierarchyStores() {
    const ops = document.getElementById('lkOps')?.value;
    const sr = document.getElementById('lkSr')?.value;
    const dir = document.getElementById('lkDir')?.value;
    const rm = document.getElementById('lkRm')?.value;
    const fsm = document.getElementById('lkFsm')?.value;
    const banners = getActiveBanners();
    // Always apply banner filter; also apply hierarchy if set
    let stores = STORES.filter(s => banners.has(s.bn));
    if (ops) stores = stores.filter(s => s.ops === ops);
    if (sr) stores = stores.filter(s => _matchField(s.sr, sr));
    if (dir) stores = stores.filter(s => _matchField(s.dir, dir));
    if (rm) stores = stores.filter(s => _matchField(s.rm, rm));
    if (fsm) stores = stores.filter(s => _matchField(s.fsm, fsm));
    if (!ops && !sr && !dir && !rm && !fsm && activeBanner === 'all') return null;
    return new Set(stores.map(s => s.sn));
}

function getFilteredLeaks() {
    let data = getLeaksFy();
    // Hierarchy filter
    const hierStores = getLeakHierarchyStores();
    if (hierStores) data = data.filter(l => hierStores.has(l.sn));
    // Data filters
    const lt = document.getElementById('lkType')?.value;
    const yr = document.getElementById('lkYear')?.value;
    const st = document.getElementById('lkStatus')?.value;
    const pr = document.getElementById('lkPriority')?.value;
    if (lt) data = data.filter(l => l.lt === lt);
    if (yr) data = data.filter(l => l.cd.startsWith(yr));
    if (st) data = data.filter(l => l.st.toUpperCase() === st.toUpperCase());
    if (pr) data = data.filter(l => l.pr === pr);
    return data;
}

function populateLeakFilters() {
    // Year filter — locked to 2026 (current reporting year)
    const yrSel = document.getElementById('lkYear');
    if (yrSel) {
        yrSel.innerHTML = '<option value="2026" selected>2026</option>';
    }
    // Status filter
    const statuses = [...new Set(LEAKS.map(l => l.st).filter(Boolean))].sort();
    const stSel = document.getElementById('lkStatus');
    if (stSel) {
        const cur = stSel.value;
        stSel.innerHTML = '<option value="">All Status</option>' +
            statuses.map(s => `<option value="${s}" ${s === cur ? 'selected' : ''}>${s}</option>`).join('');
    }
    // Priority filter
    const priorities = [...new Set(LEAKS.map(l => l.pr).filter(Boolean))].sort();
    const prSel = document.getElementById('lkPriority');
    if (prSel) {
        const cur = prSel.value;
        prSel.innerHTML = '<option value="">All Priorities</option>' +
            priorities.map(p => `<option value="${p}" ${p === cur ? 'selected' : ''}>${p}</option>`).join('');
    }
}

function populateLeakHierarchyFilter(id, values) {
    const sel = document.getElementById(id);
    if (!sel) return;
    const cur = sel.value;
    const firstLabel = sel.options.length > 0 ? sel.options[0].text : 'All';
    const normalized = values.map(v => (v && v.indexOf('Unassigned') === 0) ? 'Unassigned' : v);
    const opts = [...new Set(normalized)].filter(Boolean).sort();
    sel.innerHTML = `<option value="">${firstLabel}</option>` +
        opts.map(v => `<option value="${v}" ${v === cur ? 'selected' : ''}>${v}</option>`).join('');
    if (cur && !opts.includes(cur)) sel.value = '';
}

function applyLeakHierarchyFilters() {
    // Cascade: Ops -> Sr Dir -> Dir -> RM -> FSM
    const ops = document.getElementById('lkOps')?.value;
    let stores = STORES;
    if (ops) stores = stores.filter(s => s.ops === ops);
    populateLeakHierarchyFilter('lkSr', stores.map(s => s.sr));

    const sr = document.getElementById('lkSr')?.value;
    if (sr) stores = stores.filter(s => s.sr === sr);
    populateLeakHierarchyFilter('lkDir', stores.map(s => s.dir));

    const dir = document.getElementById('lkDir')?.value;
    if (dir) stores = stores.filter(s => s.dir === dir);
    populateLeakHierarchyFilter('lkRm', stores.map(s => s.rm));

    const rm = document.getElementById('lkRm')?.value;
    if (rm) stores = stores.filter(s => s.rm === rm);
    populateLeakHierarchyFilter('lkFsm', stores.map(s => s.fsm));

    renderLeakTab();
}

function initLeakHierarchyFilters() {
    populateLeakHierarchyFilter('lkOps', STORES.map(s => s.ops));
    populateLeakHierarchyFilter('lkSr', STORES.map(s => s.sr));
    populateLeakHierarchyFilter('lkDir', STORES.map(s => s.dir));
    populateLeakHierarchyFilter('lkRm', STORES.map(s => s.rm));
    populateLeakHierarchyFilter('lkFsm', STORES.map(s => s.fsm));
}

function clearLeakFilters() {
    ['lkOps', 'lkSr', 'lkDir', 'lkRm', 'lkFsm', 'lkType', 'lkYear', 'lkStatus', 'lkPriority'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    document.getElementById('leakSearch').value = '';
    nameSearchClear('lk');
    hcChargeFilter = null;
    initLeakHierarchyFilters();
    renderLeakTab();
}

registerNameSearch('lk', {
    orgIds: [
        { key: 'sr', filterId: 'lkSr', label: 'Sr. Director' },
        { key: 'dir', filterId: 'lkDir', label: 'FM Director' },
        { key: 'rm', filterId: 'lkRm', label: 'Regional Manager' },
        { key: 'fsm', filterId: 'lkFsm', label: 'FS Manager' },
    ],
    applyFn: 'applyLeakHierarchyFilters'
});

function renderLeakKPIs(data) {
    const repairs = data.filter(l => l.lt === 'Leak Repair').length;
    const epa = data.filter(l => l.lt === 'EPA Inspection').length;
    const completed = data.filter(l => l.st.toLowerCase().includes('completed')).length;
    const compRate = data.length ? ((completed / data.length) * 100).toFixed(1) : 0;
    const totalNte = data.reduce((s, l) => s + (l.nte || 0), 0);
    const stores = new Set(data.map(l => l.sn)).size;

    document.getElementById('leakTotal').textContent = data.length.toLocaleString();
    document.getElementById('lkRepairs').textContent = repairs.toLocaleString();
    document.getElementById('lkEpa').textContent = epa.toLocaleString();
    document.getElementById('lkCompRate').textContent = compRate + '%';
    document.getElementById('lkNte').textContent = '$' + (totalNte / 1e6).toFixed(1) + 'M';
    document.getElementById('lkStores').textContent = stores.toLocaleString();

    const filterParts = [];
    if (document.getElementById('lkSr')?.value) filterParts.push(document.getElementById('lkSr').value);
    if (document.getElementById('lkDir')?.value) filterParts.push(document.getElementById('lkDir').value);
    if (document.getElementById('lkRm')?.value) filterParts.push(document.getElementById('lkRm').value);
    if (document.getElementById('lkFsm')?.value) filterParts.push(document.getElementById('lkFsm').value);
    if (document.getElementById('lkType')?.value) filterParts.push(document.getElementById('lkType').value);
    if (document.getElementById('lkYear')?.value) filterParts.push(document.getElementById('lkYear').value);
    document.getElementById('leakFilterLabel').textContent =
        filterParts.length ? `Filtered: ${filterParts.join(' › ')} (${data.length.toLocaleString()} WOs)` :
        `Showing all leak work orders (${data.length.toLocaleString()})`;
}

function renderLeakTrendChart(data) {
    const monthly = {};
    data.forEach(l => {
        const m = l.cd.substring(0, 7);
        if (m) monthly[m] = (monthly[m] || 0) + 1;
    });
    const labels = Object.keys(monthly).sort().slice(-24);
    const vals = labels.map(m => monthly[m]);

    if (leakCharts.trend) leakCharts.trend.destroy();
    leakCharts.trend = new Chart(document.getElementById('leakTrendChart'), {
        type: 'line',
        data: {
            labels: labels.map(m => { const [y, mo] = m.split('-'); return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][+mo-1] + ' ' + y.slice(2); }),
            datasets: [{
                label: 'Leak WOs',
                data: vals,
                borderColor: '#ea1100',
                backgroundColor: 'rgba(234,17,0,0.1)',
                fill: true, tension: 0.3, pointRadius: 2
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
}

function getFilteredHCAssets() {
    // Derive from LEAK_SUMMARY: assets with 400+ lbs added since 01-01-2026
    let data = getFilteredLeakSummary();
    return data.filter(r => (r.added || 0) >= 400);
}

const HC_BUCKETS = [
    { label: '400-600 lbs', min: 400, max: 600 },
    { label: '600-1000 lbs', min: 600, max: 1000 },
    { label: '1000-1500 lbs', min: 1000, max: 1500 },
    { label: '1500-2000 lbs', min: 1500, max: 2000 },
    { label: '2000+ lbs', min: 2000, max: Infinity },
];

function renderLeakHighChargeChart(data) {
    const assets = getFilteredHCAssets();
    const vals = HC_BUCKETS.map(b =>
        assets.filter(a => a.added >= b.min && a.added < b.max).length
    );
    const baseColors = ['#fbbf24', '#f59e0b', '#ea580c', '#dc2626', '#991b1b'];
    // Highlight selected bucket
    // Convert hex to rgba for dimming non-selected bars
    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r},${g},${b},${alpha})`;
    }
    const bgColors = baseColors.map((c, i) => {
        if (hcChargeFilter && HC_BUCKETS[i].label === hcChargeFilter.label) return c;
        return hcChargeFilter ? hexToRgba(c, 0.25) : c;
    });
    const borderColors = baseColors.map((c, i) => {
        if (hcChargeFilter && HC_BUCKETS[i].label === hcChargeFilter.label) return '#000';
        return 'transparent';
    });

    if (leakCharts.highCharge) leakCharts.highCharge.destroy();
    leakCharts.highCharge = new Chart(document.getElementById('leakHighChargeChart'), {
        type: 'bar',
        data: {
            labels: HC_BUCKETS.map(b => b.label),
            datasets: [{
                label: 'Assets ≥400 lbs Added',
                data: vals,
                backgroundColor: bgColors,
                borderColor: borderColors,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            onClick: (evt, elements) => {
                if (!elements.length) { hcChargeFilter = null; }
                else {
                    const idx = elements[0].index;
                    const clicked = HC_BUCKETS[idx];
                    // Toggle: click same bar to deselect
                    if (hcChargeFilter && hcChargeFilter.label === clicked.label) {
                        hcChargeFilter = null;
                    } else {
                        hcChargeFilter = clicked;
                    }
                }
                renderLeakHighChargeChart(data);
                renderHCTable();
            },
            plugins: {
                legend: { display: false },
                tooltip: { callbacks: { afterLabel: () => 'Click to filter table below' } },
                datalabels: {
                    display: true, anchor: 'end', align: 'end',
                    color: '#333', font: { weight: 'bold', size: 11 },
                    formatter: v => v.toLocaleString()
                }
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Number of Assets' } },
                x: { title: { display: true, text: 'Click a bar to filter ↓' } }
            }
        }
    });
}

function sortHCTable(key) {
    if (hcSortKey === key) { hcSortAsc = !hcSortAsc; }
    else { hcSortKey = key; hcSortAsc = false; }
    renderHCTable();
}

function renderHCTable() {
    let assets = getFilteredHCAssets();
    // Apply charge range filter from chart click
    if (hcChargeFilter) {
        assets = assets.filter(a =>
            a.added >= hcChargeFilter.min && a.added < hcChargeFilter.max
        );
    }
    const search = (document.getElementById('hcSearch')?.value || '').toLowerCase();
    if (search) {
        assets = assets.filter(a =>
            String(a.sn).includes(search) ||
            (a.tag || '').toLowerCase().includes(search) ||
            (a.type || '').toLowerCase().includes(search) ||
            (a.fsm || '').toLowerCase().includes(search)
        );
    }
    // Sort
    assets = [...assets].sort((a, b) => {
        const av = a[hcSortKey] ?? 0, bv = b[hcSortKey] ?? 0;
        if (typeof av === 'string') return hcSortAsc ? av.localeCompare(bv) : bv.localeCompare(av);
        return hcSortAsc ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
    });
    const show = assets.slice(0, 200);
    const tbody = document.getElementById('hcTableBody');
    if (!tbody) return;

    const addedColor = c => {
        if (c >= 2000) return 'bg-red-100 text-red-800 font-bold';
        if (c >= 1000) return 'bg-orange-100 text-orange-800 font-semibold';
        if (c >= 600) return 'bg-yellow-100 text-yellow-800';
        return 'bg-amber-50 text-amber-800';
    };
    const colorDot = c => {
        const map = { Red: '#ea1100', Orange: '#f97316', Yellow: '#eab308', Green: '#2a8703' };
        return `<span class="inline-block w-2.5 h-2.5 rounded-full" style="background:${map[c]||'#999'}"></span> ${c||'-'}`;
    };

    tbody.innerHTML = show.map(a =>
        `<tr class="table-row hover:bg-red-50">
            <td class="px-3 py-2 font-semibold">${a.sn}</td>
            <td class="px-3 py-2 text-xs">${a.tag || '-'}</td>
            <td class="px-3 py-2 text-xs">${a.type || '-'}</td>
            <td class="px-3 py-2 text-xs">${a.fsm || '-'}</td>
            <td class="px-3 py-2 text-right">${a.charge != null ? a.charge.toLocaleString() + ' lbs' : '-'}</td>
            <td class="px-3 py-2 text-right"><span class="px-2 py-0.5 rounded text-xs ${addedColor(a.added)}">${a.added.toLocaleString()} lbs</span></td>
            <td class="px-3 py-2 text-right">${a.leak_rate != null ? (a.leak_rate * 100).toFixed(1) + '%' : '-'}</td>
            <td class="px-3 py-2 text-center text-xs">${colorDot(a.color)}</td>
            <td class="px-3 py-2 text-right font-semibold">${a.events || 0}</td>
            <td class="px-3 py-2 text-right">${a.store_rate != null ? (a.store_rate * 100).toFixed(1) + '%' : '-'}</td>
        </tr>`
    ).join('');

    const filterLabel = hcChargeFilter ? ` (${hcChargeFilter.label})` : '';
    document.getElementById('hcShowing').textContent =
        `Showing ${show.length} of ${assets.length.toLocaleString()} assets${filterLabel}`;
}

function renderLeakProviderChart(data) {
    const refOnly = data.filter(l => !l.prob || !l.prob.toLowerCase().includes('non refrigerant'));
    const provs = {};
    refOnly.forEach(l => { if (l.prov) provs[l.prov] = (provs[l.prov] || 0) + 1; });
    const sorted = Object.entries(provs).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const labels = sorted.map(([k]) => k.length > 25 ? k.slice(0, 22) + '...' : k);
    const vals = sorted.map(([, v]) => v);

    if (leakCharts.provider) leakCharts.provider.destroy();
    leakCharts.provider = new Chart(document.getElementById('leakProviderChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'WOs', data: vals, backgroundColor: '#0ea5e9' }] },
        options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: {
                legend: { display: false },
                datalabels: { display: true, anchor: 'end', align: 'end', color: '#333', font: { size: 10 } }
            },
            scales: { x: { beginAtZero: true } }
        }
    });
}

function renderLeakStoreChart(data) {
    const stores = {};
    data.forEach(l => { stores[l.sn] = (stores[l.sn] || 0) + 1; });
    const sorted = Object.entries(stores).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const labels = sorted.map(([k]) => 'Store ' + k);
    const vals = sorted.map(([, v]) => v);

    if (leakCharts.store) leakCharts.store.destroy();
    leakCharts.store = new Chart(document.getElementById('leakStoreChart'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Leak WOs', data: vals, backgroundColor: '#ea1100' }] },
        options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: {
                legend: { display: false },
                datalabels: { display: true, anchor: 'end', align: 'end', color: '#333', font: { size: 10 } }
            },
            scales: { x: { beginAtZero: true } }
        }
    });
}

let nteActiveYears = new Set();
const NTE_YEAR_COLORS = {
    '2026': '#0ea5e9', '2025': '#2a8703', '2024': '#ea1100',
    '2023': '#fbbf24', '2022': '#7c3aed', '2021': '#6b7280'
};

function populateNteYearToggles(data) {
    const years = [...new Set(data.map(l => l.cd?.substring(0, 4)).filter(Boolean))].sort().reverse();
    const container = document.getElementById('nteYearToggles');
    if (!container) return;
    const curYear = new Date().getFullYear().toString();
    // Default: show current year + previous year
    if (nteActiveYears.size === 0) {
        nteActiveYears.add(curYear);
        if (years.includes(String(+curYear - 1))) nteActiveYears.add(String(+curYear - 1));
    }
    container.innerHTML = years.slice(0, 5).map(y => {
        const active = nteActiveYears.has(y);
        const color = NTE_YEAR_COLORS[y] || '#6b7280';
        return `<button onclick="toggleNteYear('${y}')" class="px-2 py-0.5 rounded text-xs font-medium border transition ${
            active ? 'text-white' : 'bg-white text-gray-500 border-gray-300'
        }" style="${active ? 'background-color:' + color + ';border-color:' + color : ''}">${y}</button>`;
    }).join('');
}

function toggleNteYear(year) {
    if (nteActiveYears.has(year)) nteActiveYears.delete(year);
    else nteActiveYears.add(year);
    if (nteActiveYears.size === 0) nteActiveYears.add(year); // keep at least one
    const data = getFilteredLeaks();
    populateNteYearToggles(data);
    renderLeakNteChart(data);
}

function renderLeakNteChart(data) {
    const quarterLabels = ['Q1', 'Q2', 'Q3', 'Q4'];
    const years = [...nteActiveYears].sort();

    const datasets = years.map(year => {
        const yearData = data.filter(l => l.cd?.startsWith(year));
        const qVals = quarterLabels.map((_, qi) => {
            return yearData.reduce((sum, l) => {
                if (!l.cd) return sum;
                const m = parseInt(l.cd.split('-')[1]);
                const q = Math.ceil(m / 3) - 1;
                return q === qi ? sum + (l.nte || 0) : sum;
            }, 0);
        });
        const color = NTE_YEAR_COLORS[year] || '#6b7280';
        return {
            label: year,
            data: qVals.map(v => Math.round(v)),
            backgroundColor: color,
            borderColor: color,
            borderWidth: 1
        };
    });

    if (leakCharts.nte) leakCharts.nte.destroy();
    leakCharts.nte = new Chart(document.getElementById('leakNteChart'), {
        type: 'bar',
        data: { labels: quarterLabels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 11 } } },
                datalabels: {
                    display: datasets.length <= 3,
                    anchor: 'end', align: 'end', color: '#333', font: { size: 9 },
                    formatter: v => v > 0 ? '$' + (v / 1e6).toFixed(1) + 'M' : ''
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: v => '$' + (v / 1e6).toFixed(1) + 'M' }
                }
            }
        }
    });
}

function renderLeakEmissionsChart() {
    // Top-10 stores by emissions: side-by-side leak rate vs emissions
    const top = STORE_EMISSIONS.slice(0, 10);
    const labels = top.map(s => '#' + s.sn);

    if (leakCharts.emissions) leakCharts.emissions.destroy();
    leakCharts.emissions = new Chart(document.getElementById('leakEmissionsChart'), {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'Leak Rate %', data: top.map(s => s.lr), backgroundColor: '#0ea5e9', yAxisID: 'y' },
                { label: 'Emissions (MTCO2e)', data: top.map(s => s.em), backgroundColor: '#ea1100', yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'top' }, datalabels: { display: false } },
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: 'Leak Rate (%)' }, beginAtZero: true },
                y1: { type: 'linear', position: 'right', title: { display: true, text: 'MTCO2e' }, beginAtZero: true, grid: { drawOnChartArea: false } }
            }
        }
    });
}

function renderRefEmissionsChart() {
    const data = REF_EMISSIONS;
    const labels = data.map(d => d.ref.split(' ')[0]);
    const emVals = data.map(d => d.em);
    const lbVals = data.map(d => d.lbs);
    const colors = ['#ea1100','#ff8200','#fbbf24','#86bc25','#2a8703','#0ea5e9','#0284c7','#7c3aed','#9ca3af','#374151','#0891b2','#be185d','#78716c'];

    if (leakCharts.refEm) leakCharts.refEm.destroy();
    leakCharts.refEm = new Chart(document.getElementById('refEmissionsChart'), {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'Lbs Leaked', data: lbVals, backgroundColor: '#0ea5e980', yAxisID: 'y' },
                { label: 'MTCO2e', data: emVals, backgroundColor: '#ea110099', yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                datalabels: { display: false },
                tooltip: {
                    callbacks: {
                        afterBody: (items) => {
                            const idx = items[0].dataIndex;
                            return 'GWP: ' + data[idx].gwp + ' | Assets: ' + data[idx].ac;
                        }
                    }
                }
            },
            scales: {
                y: { position: 'left', title: { display: true, text: 'Lbs Leaked' }, beginAtZero: true },
                y1: { position: 'right', title: { display: true, text: 'MTCO2e' }, beginAtZero: true, grid: { drawOnChartArea: false } }
            }
        }
    });
}

function renderLeakEmScatter() {
    const points = STORE_EMISSIONS.filter(s => s.lr > 0 && s.em > 0).map(s => ({ x: s.lr, y: s.em, sn: s.sn }));

    if (leakCharts.emScatter) leakCharts.emScatter.destroy();
    leakCharts.emScatter = new Chart(document.getElementById('leakEmScatter'), {
        type: 'scatter',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => p.y > 2000 ? '#ea110080' : p.y > 500 ? '#ff820080' : '#2a870380'),
                pointRadius: 3
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: false }, datalabels: { display: false },
                tooltip: { callbacks: { label: ctx => `Store ${ctx.raw.sn}: ${ctx.raw.x.toFixed(1)}% leak rate, ${ctx.raw.y.toFixed(0)} MTCO2e` } }
            },
            scales: {
                x: { title: { display: true, text: 'Leak Rate (%)' } },
                y: { title: { display: true, text: 'Emissions (MTCO2e)' } }
            }
        }
    });
}

function renderEmissionsKPIs() {
    const totalMt = STORE_EMISSIONS.reduce((a, s) => a + s.em, 0);
    const totalLbs = STORE_EMISSIONS.reduce((a, s) => a + s.lbs, 0);
    document.getElementById('emTotalMt').textContent = Math.round(totalMt).toLocaleString();
    document.getElementById('emTotalLbs').textContent = Math.round(totalLbs).toLocaleString();
    document.getElementById('emStoreCount').textContent = STORE_EMISSIONS.length.toLocaleString();
}

function renderLeakTable() {
    const data = getFilteredLeaks();
    const search = (document.getElementById('leakSearch')?.value || '').toLowerCase();
    let filtered = data;
    if (search) {
        filtered = data.filter(l =>
            l.sn.includes(search) || l.t.includes(search) ||
            (l.prov || '').toLowerCase().includes(search)
        );
    }
    const show = filtered.slice(0, 200);
    const tbody = document.getElementById('leakTableBody');
    if (!tbody) return;

    const statusColor = s => {
        const u = (s || '').toLowerCase();
        if (u.includes('completed')) return 'bg-green-100 text-green-800';
        if (u.includes('progress')) return 'bg-blue-100 text-blue-800';
        if (u.includes('open')) return 'bg-yellow-100 text-yellow-800';
        return 'bg-gray-100 text-gray-800';
    };

    tbody.innerHTML = show.map(l =>
        `<tr class="table-row hover:bg-blue-50">
            <td class="px-3 py-2 font-mono text-xs">${l.t}</td>
            <td class="px-3 py-2 font-semibold">${l.sn}</td>
            <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs font-medium ${
                l.lt === 'Leak Repair' ? 'bg-red-100 text-red-800' :
                l.lt === 'EPA Inspection' ? 'bg-orange-100 text-orange-800' :
                'bg-blue-100 text-blue-800'
            }">${l.lt}</span></td>
            <td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs font-medium ${statusColor(l.st)}">${l.st}</span></td>
            <td class="px-3 py-2 text-xs">${l.pr}</td>
            <td class="px-3 py-2 text-xs">${(l.prov || '').slice(0, 30)}</td>
            <td class="px-3 py-2 text-right text-xs">${l.nte ? '$' + l.nte.toLocaleString() : '-'}</td>
            <td class="px-3 py-2 text-xs">${l.cd}</td>
            <td class="px-3 py-2 text-xs">${l.dd || '-'}</td>
        </tr>`
    ).join('');

    document.getElementById('leakShowing').textContent =
        `Showing ${show.length} of ${filtered.length.toLocaleString()}`;
}

function renderLeakTab() {
    ensureStoreMap();
    if (!leakInitialized) {
        initLeakHierarchyFilters();
        populateLeakFilters();
        leakInitialized = true;
    }
    const data = getFilteredLeaks();
    populateNteYearToggles(data);
    renderLeakKPIs(data);
    renderLeakTrendChart(data);
    renderLeakHighChargeChart(data);
    renderLeakProviderChart(data);
    renderLeakStoreChart(data);
    renderLeakNteChart(data);
    renderLeakEmissionsChart();
    renderRefEmissionsChart();
    renderLeakEmScatter();
    renderEmissionsKPIs();
    renderHCTable();
    renderLeakTable();
    renderLeakSummary();
}

// ═══ Tableau Leak Summary (Asset-Level) ═══
function getFilteredLeakSummary() {
    if (typeof LEAK_SUMMARY === 'undefined' || !Array.isArray(LEAK_SUMMARY)) return [];
    let data = LEAK_SUMMARY;
    // Apply hierarchy filters (Ops Region, Sr Director, FM Director, Regional, FS Manager)
    const hierStores = getLeakHierarchyStores();
    if (hierStores) data = data.filter(r => hierStores.has(String(r.sn)));
    const color = document.getElementById('lsColorFilter')?.value;
    const type = document.getElementById('lsTypeFilter')?.value;
    const search = (document.getElementById('lsSearch')?.value || '').trim().toLowerCase();
    if (color) data = data.filter(r => r.color === color);
    if (type) data = data.filter(r => r.type === type);
    if (search) data = data.filter(r => String(r.sn).includes(search) || (r.tag || '').toLowerCase().includes(search));
    return data;
}

function sortLeakSummary(key) {
    if (lsSortKey === key) { lsSortAsc = !lsSortAsc; } else { lsSortKey = key; lsSortAsc = false; }
    renderLeakSummary();
}

function renderLeakSummary() {
    const data = getFilteredLeakSummary();
    // KPIs
    const red = data.filter(r => r.color === 'Red').length;
    const orange = data.filter(r => r.color === 'Orange').length;
    const yellow = data.filter(r => r.color === 'Yellow').length;
    const green = data.filter(r => r.color === 'Green').length;
    const totalEvents = data.reduce((a, r) => a + (r.events || 0), 0);
    const el = id => document.getElementById(id);
    if (el('lsRedCount')) el('lsRedCount').textContent = red.toLocaleString();
    if (el('lsOrangeCount')) el('lsOrangeCount').textContent = orange.toLocaleString();
    if (el('lsYellowCount')) el('lsYellowCount').textContent = yellow.toLocaleString();
    if (el('lsGreenCount')) el('lsGreenCount').textContent = green.toLocaleString();
    if (el('lsTotalEvents')) el('lsTotalEvents').textContent = totalEvents.toLocaleString();
    if (el('lsCount')) el('lsCount').textContent = data.length.toLocaleString() + ' assets';

    // Rate distribution chart
    renderLsRateDistChart(data);
    // Type chart
    renderLsTypeChart(data);
    // Table
    renderLsTable(data);
}

function renderLsRateDistChart(data) {
    if (leakCharts['lsRateDistChart']) { leakCharts['lsRateDistChart'].destroy(); }
    const ctx = document.getElementById('lsRateDistChart');
    if (!ctx) return;
    const colorMap = { Red: '#ea1100', Orange: '#f97316', Yellow: '#eab308', Green: '#2a8703' };
    const colorOrder = ['Green', 'Yellow', 'Orange', 'Red'];
    const counts = {};
    colorOrder.forEach(c => { counts[c] = data.filter(r => r.color === c).length; });
    leakCharts['lsRateDistChart'] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: colorOrder,
            datasets: [{ data: colorOrder.map(c => counts[c]), backgroundColor: colorOrder.map(c => colorMap[c]) }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' },
                datalabels: { display: true, color: '#fff', font: { weight: 'bold', size: 13 },
                    formatter: (v, ctx) => v > 0 ? v.toLocaleString() : '' }
            }
        }
    });
}

function renderLsTypeChart(data) {
    if (leakCharts['lsTypeChart']) { leakCharts['lsTypeChart'].destroy(); }
    const ctx = document.getElementById('lsTypeChart');
    if (!ctx) return;
    const byType = {};
    data.forEach(r => {
        const t = r.type || 'Other';
        if (!byType[t]) byType[t] = { events: 0, assets: 0, added: 0 };
        byType[t].events += (r.events || 0);
        byType[t].assets++;
        byType[t].added += (r.added || 0);
    });
    const types = Object.keys(byType).sort();
    leakCharts['lsTypeChart'] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: types,
            datasets: [
                { label: 'Leak Events', data: types.map(t => byType[t].events), backgroundColor: '#0ea5e9' },
                { label: 'Assets', data: types.map(t => byType[t].assets), backgroundColor: '#fbbf24' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'top' },
                datalabels: { display: true, font: { weight: 'bold', size: 11 }, color: '#333',
                    formatter: v => v > 0 ? v.toLocaleString() : '' } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function renderLsTable(data) {
    const tbody = document.getElementById('lsTableBody');
    if (!tbody) return;
    // Sort
    const sorted = data.slice().sort((a, b) => {
        let va = a[lsSortKey], vb = b[lsSortKey];
        if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
        if (va < vb) return lsSortAsc ? -1 : 1;
        if (va > vb) return lsSortAsc ? 1 : -1;
        return 0;
    });
    // Limit to 200 rows for performance
    const show = sorted.slice(0, 200);
    const colorDot = { Red: '\u{1F534}', Orange: '\u{1F7E0}', Yellow: '\u{1F7E1}', Green: '\u{1F7E2}' };
    tbody.innerHTML = show.map((r, i) => {
        const bg = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        return `<tr class="${bg} hover:bg-blue-50">
            <td class="px-3 py-2 font-medium">${r.sn}</td>
            <td class="px-3 py-2 text-xs">${r.tag || ''}</td>
            <td class="px-3 py-2">${r.type}</td>
            <td class="px-3 py-2 text-xs">${r.fsm || ''}</td>
            <td class="px-3 py-2 text-right">${r.charge.toFixed(2)}</td>
            <td class="px-3 py-2 text-right font-semibold">${r.added.toFixed(2)}</td>
            <td class="px-3 py-2 text-right font-bold ${r.leak_rate > 1 ? 'text-red-600' : r.leak_rate > 0.5 ? 'text-orange-600' : 'text-green-600'}">${r.leak_rate.toFixed(3)}</td>
            <td class="px-3 py-2 text-center">${colorDot[r.color] || r.color}</td>
            <td class="px-3 py-2 text-right font-semibold">${r.events}</td>
            <td class="px-3 py-2 text-right">${r.store_rate.toFixed(4)}</td>
        </tr>`;
    }).join('');
    if (sorted.length > 200) {
        tbody.innerHTML += `<tr><td colspan="10" class="px-3 py-2 text-center text-gray-400 text-sm italic">Showing 200 of ${sorted.length.toLocaleString()} assets</td></tr>`;
    }
}
</script>
<script>
// ── HVAC Tab Logic ──
let hvacCharts = {};
let hvacInitialized = false;
let hvacSortKey = 'hvac';
let hvacDistSlice = null; // { type: 'tnt', bucketIdx: 0 }
let hvacDistSortKey = 'hvac';
let hvacDistSortAsc = true;
let hvacSortAsc = true;

// Store-level avg zone temp lookup (built from TERM_DETAIL)
var _hvacStoreAvgTemp = null;
function ensureHvacTempLookup() {
    if (_hvacStoreAvgTemp !== null) return;
    _hvacStoreAvgTemp = {};
    if (typeof TERM_DETAIL === 'undefined' || !TERM_DETAIL.length) return;
    var byStore = {};
    TERM_DETAIL.forEach(function(u) {
        if (u.zt != null && u.zt > -100 && u.zt < 200) {
            if (!byStore[u.sn]) byStore[u.sn] = [];
            byStore[u.sn].push(u.zt);
        }
    });
    Object.keys(byStore).forEach(function(sn) {
        var ts = byStore[sn];
        _hvacStoreAvgTemp[sn] = ts.reduce(function(a,b){return a+b;},0) / ts.length;
    });
}

function _tempBucket(t) {
    if (t == null) return '';
    if (t <= 60) return 'cold';
    if (t <= 68) return 'cool';
    if (t <= 73) return 'target';
    if (t <= 78) return 'warm';
    return 'hot';
}

function populateHvacFilter(id, values) {
    const sel = document.getElementById(id);
    if (!sel) return;
    const cur = sel.value;
    const firstLabel = sel.options.length > 0 ? sel.options[0].text : 'All';
    const normalized = values.map(v => (v && v.indexOf('Unassigned') === 0) ? 'Unassigned' : v);
    const opts = [...new Set(normalized)].filter(Boolean).sort();
    sel.innerHTML = '<option value="">' + firstLabel + '</option>' +
        opts.map(v => `<option value="${v}" ${v === cur ? 'selected' : ''}>${v}</option>`).join('');
    if (cur && !opts.includes(cur)) sel.value = '';
}

function getHvacFiltered() {
    ensureHvacTempLookup();
    const ops = document.getElementById('hvOps')?.value || '';
    const sr = document.getElementById('hvSr')?.value || '';
    const dir = document.getElementById('hvDir')?.value || '';
    const rm = document.getElementById('hvRm')?.value || '';
    const fsm = document.getElementById('hvFsm')?.value || '';
    const tempRange = document.getElementById('hvTemp')?.value || '';
    const banners = getActiveBanners();
    return STORES.filter(s => {
        if (!banners.has(s.bn) || s.hvac == null) return false;
        if (ops && s.ops !== ops) return false;
        if (!_matchField(s.sr, sr) || !_matchField(s.dir, dir)) return false;
        if (!_matchField(s.rm, rm) || !_matchField(s.fsm, fsm)) return false;
        if (tempRange) {
            var avgT = _hvacStoreAvgTemp[s.sn];
            if (avgT == null || _tempBucket(avgT) !== tempRange) return false;
        }
        return true;
    });
}

function applyHvacFilters() {
    const data = getHvacFiltered();
    populateHvacFilter('hvOps', data.map(s => s.ops));
    populateHvacFilter('hvDir', data.map(s => s.dir));
    populateHvacFilter('hvRm', data.map(s => s.rm));
    populateHvacFilter('hvFsm', data.map(s => s.fsm));
    renderHvacTab();
}

function clearHvacFilters() {
    ['hvOps','hvSr','hvDir','hvRm','hvFsm','hvTemp'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    nameSearchClear('hv');
    closeHvacStoreUnits();
    applyHvacFilters();
}

// Register HVAC name search with shared utility
registerNameSearch('hv', {
    orgIds: [
        { key: 'sr', filterId: 'hvSr', label: 'Sr. Director' },
        { key: 'dir', filterId: 'hvDir', label: 'FM Director' },
        { key: 'rm', filterId: 'hvRm', label: 'Regional Manager' },
        { key: 'fsm', filterId: 'hvFsm', label: 'FS Manager' },
    ],
    applyFn: 'applyHvacFilters',
    storeFilter: function(s) { return s.hvac != null; }
});

function initHvacFilters() {
    const banners = getActiveBanners();
    const all = STORES.filter(s => banners.has(s.bn) && s.hvac != null);
    populateHvacFilter('hvOps', all.map(s => s.ops));
    populateHvacFilter('hvSr', all.map(s => s.sr));
    populateHvacFilter('hvDir', all.map(s => s.dir));
    populateHvacFilter('hvRm', all.map(s => s.rm));
    populateHvacFilter('hvFsm', all.map(s => s.fsm));
}

function sortHvacTable(key) {
    if (hvacSortKey === key) hvacSortAsc = !hvacSortAsc;
    else { hvacSortKey = key; hvacSortAsc = true; }
    renderHvacTable(getHvacFiltered());
}

// ── KPI Cards ──
function renderHvacKPIs(data) {
    ensureHvacTempLookup();
    const hvacs = data.map(s => s.hvac).filter(v => v != null);
    const dps = data.filter(s => s.dp != null).map(s => s.dp);
    const adps = data.filter(s => s.adp != null).map(s => s.adp);
    const hwoTotal = data.reduce((a, s) => a + (s.hwo || 0), 0);
    const alerts = data.reduce((a, s) => a + (s.ha72 || 0), 0);
    const dpPass = dps.filter(v => v <= 52).length;
    const dpPct = dps.length ? Math.round(100 * dpPass / dps.length) : 0;
    const below80 = hvacs.filter(v => v < 80).length;

    // Avg zone temp from terminal units
    const storeTemps = data.map(s => _hvacStoreAvgTemp[s.sn]).filter(t => t != null);
    const avgZoneTemp = storeTemps.length ? (storeTemps.reduce((a,b)=>a+b,0)/storeTemps.length) : null;

    // Update header KPIs
    document.getElementById('hvacStoreCount').textContent = data.length;
    document.getElementById('hvacAvgTnt').textContent = avg(hvacs).toFixed(1) + '%';
    document.getElementById('hvacAvgDp').textContent = avg(dps).toFixed(1) + '°F';
    document.getElementById('hvacAvgZoneTemp').textContent = avgZoneTemp != null ? avgZoneTemp.toFixed(1) + '°F' : '--';

    const tempColor = avgZoneTemp == null ? 'blue' : (avgZoneTemp >= 69 && avgZoneTemp <= 73) ? 'green' : (avgZoneTemp >= 60 && avgZoneTemp <= 78) ? 'yellow' : 'red';
    const cards = [
        { label: 'Avg HVAC TnT', value: avg(hvacs).toFixed(1) + '%', color: avg(hvacs) >= 90 ? 'green' : avg(hvacs) >= 80 ? 'yellow' : 'red' },
        { label: 'Avg Zone Temp', value: avgZoneTemp != null ? avgZoneTemp.toFixed(1) + '°F' : '--', sub: storeTemps.length + ' stores', color: tempColor },
        { label: 'Avg Dewpoint', value: avg(dps).toFixed(1) + '°F', color: avg(dps) <= 52 ? 'green' : 'red' },
        { label: 'Avg AHU DP', value: avg(adps).toFixed(1) + '°F', color: avg(adps) <= 52 ? 'green' : 'red' },
        { label: 'DP ≤52°F', value: dpPct + '%', sub: dpPass + '/' + dps.length, color: dpPct >= 80 ? 'green' : 'red' },
        { label: 'HVAC WOs', value: hwoTotal.toLocaleString(), color: 'blue' },
        { label: '72hr Alerts', value: alerts.toLocaleString(), color: alerts > 0 ? 'red' : 'green' },
    ];

    const colorMap = { green: 'bg-green-50 border-green-300 text-green-800', red: 'bg-red-50 border-red-300 text-red-800', yellow: 'bg-yellow-50 border-yellow-300 text-yellow-800', blue: 'bg-blue-50 border-blue-300 text-blue-800' };
    document.getElementById('hvacKpiCards').innerHTML = cards.map(c =>
        `<div class="kpi-card rounded-lg border-2 p-4 ${colorMap[c.color]}">
            <p class="text-xs font-medium opacity-70">${c.label}</p>
            <p class="text-2xl font-bold mt-1">${c.value}</p>
            ${c.sub ? '<p class="text-xs mt-1 opacity-60">' + c.sub + ' stores</p>' : ''}
        </div>`
    ).join('');
}

// ── Charts ──
function makeOrUpdate(id, cfg) {
    if (hvacCharts[id]) hvacCharts[id].destroy();
    hvacCharts[id] = new Chart(document.getElementById(id), cfg);
}

function renderHvacTntDist(data) {
    const bucketDefs = [
        { label: '≥95', min: 95, max: 999, color: '#2a8703' },
        { label: '90-94', min: 90, max: 94.999, color: '#86bc25' },
        { label: '80-89', min: 80, max: 89.999, color: '#fbbf24' },
        { label: '70-79', min: 70, max: 79.999, color: '#ff8200' },
        { label: '<70', min: -999, max: 69.999, color: '#ea1100' },
    ];
    const counts = bucketDefs.map(() => 0);
    data.forEach(s => {
        const v = s.hvac;
        for (let i = 0; i < bucketDefs.length; i++) {
            if (v >= bucketDefs[i].min && v <= bucketDefs[i].max) { counts[i]++; break; }
        }
    });
    // Store bucketDefs globally for click handler
    window._hvacTntBuckets = bucketDefs;
    window._hvacTntData = data;
    makeOrUpdate('hvacTntDist', {
        type: 'bar',
        data: { labels: bucketDefs.map(b => b.label), datasets: [{
            data: counts,
            backgroundColor: bucketDefs.map(b => b.color)
        }]},
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, datalabels: { display: true, anchor: 'end', align: 'top', font: { weight: 'bold' } } },
            scales: { y: { beginAtZero: true } },
            onClick: function(evt) {
                var pts = this.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
                if (pts.length) hvacDistClick(pts[0].index, 'tnt');
            }
        }
    });
}

function renderHvacDpDist(data) {
    const dps = data.filter(s => s.dp != null);
    const buckets = { '≤45': 0, '46-48': 0, '49-50': 0, '51-52': 0, '53-55': 0, '>55': 0 };
    dps.forEach(s => {
        const v = s.dp;
        if (v <= 45) buckets['≤45']++;
        else if (v <= 48) buckets['46-48']++;
        else if (v <= 50) buckets['49-50']++;
        else if (v <= 52) buckets['51-52']++;
        else if (v <= 55) buckets['53-55']++;
        else buckets['>55']++;
    });
    makeOrUpdate('hvacDpDist', {
        type: 'bar',
        data: { labels: Object.keys(buckets), datasets: [{
            data: Object.values(buckets),
            backgroundColor: ['#2a8703','#86bc25','#86bc25','#fbbf24','#ff8200','#ea1100']
        }]},
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: true, anchor: 'end', align: 'top', font: { weight: 'bold' } } }, scales: { y: { beginAtZero: true } } }
    });
}

function renderHvacSrChart(data) {
    const groups = {};
    data.forEach(s => {
        if (!s.sr) return;
        if (!groups[s.sr]) groups[s.sr] = [];
        groups[s.sr].push(s.hvac);
    });
    const sorted = Object.entries(groups).map(([k, v]) => ({ name: k, avg: avg(v) })).sort((a, b) => b.avg - a.avg);
    makeOrUpdate('hvacSrChart', {
        type: 'bar',
        data: {
            labels: sorted.map(s => s.name.split(',')[0]),
            datasets: [{ data: sorted.map(s => Math.round(s.avg * 10) / 10),
                backgroundColor: sorted.map(s => s.avg >= 90 ? '#2a8703' : s.avg >= 80 ? '#fbbf24' : '#ea1100') }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: true, anchor: 'end', align: 'right', formatter: v => v + '%', font: { size: 10 } } }, scales: { x: { min: 0, max: 100 } } }
    });
}

function renderHvacAlertChart(data) {
    const groups = {};
    data.filter(s => s.ha72 > 0).forEach(s => {
        const key = s.rm || s.dir || 'Unknown';
        groups[key] = (groups[key] || 0) + s.ha72;
    });
    const sorted = Object.entries(groups).sort((a, b) => b[1] - a[1]).slice(0, 10);
    if (sorted.length === 0) {
        const el = document.getElementById('hvacAlertChart');
        if (el) el.parentElement.innerHTML = '<p class="text-center text-gray-400 py-16">No active 72hr alerts ✅</p>';
        return;
    }
    // Store data globally for click handler
    window._hvacAlertGroups = sorted;
    window._hvacAlertData = data;
    makeOrUpdate('hvacAlertChart', {
        type: 'bar',
        data: {
            labels: sorted.map(s => s[0].split(',')[0]),
            datasets: [{ data: sorted.map(s => s[1]), backgroundColor: '#ea1100' }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: true, anchor: 'end', align: 'right', font: { weight: 'bold' } } }, scales: { x: { beginAtZero: true } },
            onClick: function(evt) {
                var pts = this.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
                if (pts.length) hvacAlertClick(pts[0].index);
            }
        }
    });
}

function renderHvacWoChart(data) {
    const totalHvac = data.reduce((a, s) => a + (s.hwo || 0), 0);
    const totalRef = data.reduce((a, s) => a + (s.rwo || 0), 0);
    makeOrUpdate('hvacWoChart', {
        type: 'doughnut',
        data: {
            labels: ['HVAC WOs', 'Refrigeration WOs'],
            datasets: [{ data: [totalHvac, totalRef], backgroundColor: ['#0ea5e9', '#fbbf24'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, datalabels: { display: true, formatter: v => v.toLocaleString(), font: { weight: 'bold', size: 14 } } } }
    });
}

function renderHvacScatter(data) {
    const points = data.filter(s => s.dp != null && s.adp != null).map(s => ({ x: s.dp, y: s.adp, sn: s.sn }));
    makeOrUpdate('hvacScatter', {
        type: 'scatter',
        data: {
            datasets: [{
                data: points,
                backgroundColor: points.map(p => p.x <= 52 && p.y <= 52 ? '#2a870380' : '#ea110080'),
                pointRadius: 3
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, datalabels: { display: false },
                tooltip: { callbacks: { label: ctx => `Store ${ctx.raw.sn}: DP=${ctx.raw.x}°F, AHU=${ctx.raw.y}°F` } } },
            scales: {
                x: { title: { display: true, text: 'Store Dewpoint (°F)' } },
                y: { title: { display: true, text: 'AHU Dewpoint (°F)' } }
            }
        }
    });
}

// ── Table ──
function renderHvacTable(data) {
    ensureHvacTempLookup();
    // Augment data with avg zone temp for sorting
    data.forEach(function(s) { s.avgzt = _hvacStoreAvgTemp[s.sn] || null; });
    const sorted = [...data].sort((a, b) => {
        const av = a[hvacSortKey] ?? 999, bv = b[hvacSortKey] ?? 999;
        return hvacSortAsc ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
    });
    const show = sorted.slice(0, 200);
    const tbody = document.getElementById('hvacTableBody');
    if (!tbody) return;

    function tntColor(v) {
        if (v == null) return 'text-gray-400';
        if (v >= 95) return 'bg-green-100 text-green-800';
        if (v >= 90) return 'bg-green-50 text-green-700';
        if (v >= 80) return 'bg-yellow-100 text-yellow-800';
        return 'bg-red-100 text-red-800 font-bold';
    }
    function dpColor(v) {
        if (v == null) return 'text-gray-400';
        if (v <= 48) return 'bg-green-100 text-green-800';
        if (v <= 52) return 'bg-yellow-100 text-yellow-800';
        return 'bg-red-100 text-red-800 font-bold';
    }

    function tempColor(v) {
        if (v == null) return 'text-gray-400';
        if (v >= 69 && v <= 73) return 'bg-green-100 text-green-800';
        if (v >= 60 && v <= 78) return 'bg-yellow-100 text-yellow-800';
        return 'bg-red-100 text-red-800 font-bold';
    }

    tbody.innerHTML = show.map(s => {
        var zt = s.avgzt;
        var ztDisplay = zt != null ? zt.toFixed(1) + '°F' : '-';
        return `<tr class="table-row hover:bg-cyan-50 cursor-pointer" onclick="toggleHvacDetail('${s.sn}', this)">
            <td class="px-3 py-2 font-semibold">${s.sn}</td>
            <td class="px-3 py-2 text-xs">${(s.nm || '').slice(0, 25)}</td>
            <td class="px-3 py-2 text-xs">${s.city || ''}, ${s.state || ''}</td>
            <td class="px-3 py-2 text-xs">${(s.rm || '-').split(',')[0]}</td>
            <td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${tntColor(s.hvac)}">${s.hvac != null ? s.hvac.toFixed(1) + '%' : '-'}</span></td>
            <td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${dpColor(s.dp)}">${s.dp != null ? s.dp + '°F' : '-'}</span></td>
            <td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${dpColor(s.adp)}">${s.adp != null ? s.adp.toFixed(1) + '°F' : '-'}</span></td>
            <td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${tempColor(zt)}">${ztDisplay}</span></td>
            <td class="px-3 py-2 text-center">${s.hwo || 0}</td>
            <td class="px-3 py-2 text-center">${s.rwo || 0}</td>
            <td class="px-3 py-2 text-center">${s.ha72 ? '<span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-800 font-bold">' + s.ha72 + '</span>' : '-'}</td>
            <td class="px-3 py-2 text-right text-xs">${s.loss ? '$' + Math.round(s.loss).toLocaleString() : '-'}</td>
        </tr>`;
    }).join('');

    document.getElementById('hvacTableShowing').textContent =
        `Showing ${show.length} of ${data.length} stores (sorted by ${hvacSortKey} ${hvacSortAsc ? '↑' : '↓'})`;
}

// ── Store Detail Expand ──
function toggleHvacDetail(sn, rowEl) {
    const existing = document.getElementById('hvac-detail-' + sn);
    if (existing) { existing.remove(); return; }
    document.querySelectorAll('[id^="hvac-detail-"]').forEach(el => el.remove());

    const storeWos = WOS.filter(w => w.sn === sn);
    const termUnits = TERM_UNITS[sn] || [];
    const colspan = 12;

    let html = '<td colspan="' + colspan + '" class="px-4 py-3 bg-blue-50 border-l-4 border-[#0ea5e9]">';

    // ---- Terminal HVAC Units (Mod Labels) ----
    html += '<div class="text-sm font-semibold text-gray-800 mb-2">';
    html += '\u{1F3F7}\uFE0F Store #' + sn + ' — Terminal HVAC Mod Labels';
    html += '</div>';

    if (termUnits.length === 0) {
        html += '<p class="text-sm text-green-600 mb-3">\u2705 No terminal HVAC units at this store.</p>';
    } else {
        html += '<table class="w-full text-xs border border-red-200 rounded mb-3">';
        html += '<thead class="bg-red-50"><tr>';
        html += '<th class="px-2 py-1 text-left font-medium text-red-700">Mod Label</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-red-700">Unit</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-red-700">Type</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-red-700">Failure</th>';
        html += '<th class="px-2 py-1 text-center font-medium text-red-700">% Terminal</th>';
        html += '<th class="px-2 py-1 text-center font-medium text-red-700">Comm Loss</th>';
        html += '<th class="px-2 py-1 text-center font-medium text-red-700">Sensor Err</th>';
        html += '</tr></thead><tbody>';

        termUnits.forEach(u => {
            const failCls = u.ft ? 'bg-red-100 text-red-800' : 'text-gray-500';
            const commCls = u.cl_loss ? 'bg-orange-100 text-orange-800 font-bold' : 'text-gray-400';
            const sensCls = u.se ? 'bg-yellow-100 text-yellow-800 font-bold' : 'text-gray-400';
            html += '<tr class="border-t border-red-100 hover:bg-red-50">';
            html += '<td class="px-2 py-1 font-semibold text-red-700">' + (u.cl || '-') + '</td>';
            html += '<td class="px-2 py-1 font-mono">' + (u.un || '-') + '</td>';
            html += '<td class="px-2 py-1">' + (u.lt || '-') + '</td>';
            html += '<td class="px-2 py-1"><span class="px-1.5 py-0.5 rounded text-xs ' + failCls + '">' + (u.ft || 'none') + '</span></td>';
            html += '<td class="px-2 py-1 text-center">' + (u.pct != null ? u.pct + '%' : '-') + '</td>';
            html += '<td class="px-2 py-1 text-center"><span class="px-1.5 py-0.5 rounded text-xs ' + commCls + '">' + (u.cl_loss ? 'YES' : 'no') + '</span></td>';
            html += '<td class="px-2 py-1 text-center"><span class="px-1.5 py-0.5 rounded text-xs ' + sensCls + '">' + (u.se ? 'YES' : 'no') + '</span></td>';
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '<p class="text-xs text-red-600 mb-3">\u26A0 ' + termUnits.length + ' terminal unit(s) \u2014 Source: Tableau Terminal HVAC Units</p>';
    }

    // ---- Work Orders ----
    html += '<div class="text-sm font-semibold text-gray-800 mb-2 mt-1">';
    html += '\u{1F6E0}\uFE0F Work Orders';
    html += '</div>';

    if (storeWos.length === 0) {
        html += '<p class="text-sm text-gray-500 italic">No Win-the-Winter work orders found for this store.</p>';
    } else {
        html += '<table class="w-full text-xs border border-gray-200 rounded">';
        html += '<thead class="bg-gray-100"><tr>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">WO Label</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">Phase</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">Tracking #</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">WO #</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">Status</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">Problem</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">Category</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">Provider</th>';
        html += '<th class="px-2 py-1 text-right font-medium text-gray-600">NTE</th>';
        html += '<th class="px-2 py-1 text-left font-medium text-gray-600">Created</th>';
        html += '</tr></thead><tbody>';

        storeWos.forEach(w => {
            const statusCls = w.st === 'COMPLETED' || w.st === 'INVOICED'
                ? 'bg-green-100 text-green-800'
                : w.st === 'IN PROGRESS'
                ? 'bg-blue-100 text-blue-800'
                : 'bg-yellow-100 text-yellow-800';
            html += '<tr class="border-t border-gray-100 hover:bg-blue-100">';
            html += '<td class="px-2 py-1 font-semibold text-[#0ea5e9]">' + (w.lbl || '-') + '</td>';
            html += '<td class="px-2 py-1">' + (w.ph || '-') + '</td>';
            html += '<td class="px-2 py-1 font-mono">' + (w.t || '-') + '</td>';
            html += '<td class="px-2 py-1 font-mono">' + (w.w || '-') + '</td>';
            html += '<td class="px-2 py-1"><span class="px-1.5 py-0.5 rounded ' + statusCls + '">' + (w.st || '-') + '</span></td>';
            html += '<td class="px-2 py-1">' + (w.prob || '-') + '</td>';
            html += '<td class="px-2 py-1">' + (w.cat || '-') + '</td>';
            html += '<td class="px-2 py-1">' + ((w.prov || '').slice(0, 30) || '-') + '</td>';
            html += '<td class="px-2 py-1 text-right">' + (w.nte ? '$' + w.nte.toLocaleString() : '-') + '</td>';
            html += '<td class="px-2 py-1">' + (w.cd || '-') + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table>';
        html += '<p class="text-xs text-gray-500 mt-2">' + storeWos.length + ' work order(s)</p>';
    }
    // View all units button
    html += '<div class="mt-3"><button onclick="showHvacStoreUnits(\'' + sn + '\')" class="px-4 py-2 bg-[#0ea5e9] text-white text-sm font-semibold rounded-lg hover:bg-blue-700 transition">\u{1F50D} View All HVAC Units (RTU/AHU/Unit Heater)</button></div>';
    html += '</td>';

    const detailRow = document.createElement('tr');
    detailRow.id = 'hvac-detail-' + sn;
    detailRow.innerHTML = html;
    rowEl.after(detailRow);
}

// Terminal HVAC + detail table logic moved to hvac_units_js.html

// ── Main Render ──
function renderHvacTab() {
    if (!hvacInitialized) {
        initHvacFilters();
        hvacInitialized = true;
    }
    const data = getHvacFiltered();

    // Header KPIs
    document.getElementById('hvacStoreCount').textContent = data.length.toLocaleString();
    document.getElementById('hvacAvgTnt').textContent = avg(data.map(s => s.hvac)).toFixed(1) + '%';
    const dps = data.filter(s => s.dp != null).map(s => s.dp);
    document.getElementById('hvacAvgDp').textContent = dps.length ? avg(dps).toFixed(1) + '°F' : '--';

    renderHvacKPIs(data);
    renderHvacTntDist(data);
    renderHvacDpDist(data);
    renderHvacSrChart(data);
    renderHvacAlertChart(data);
    renderHvacWoChart(data);
    renderHvacScatter(data);
    renderHvacTable(data);
    // Build filtered store set for terminal sections
    var _hvacFilteredStoreSet = new Set(data.map(s => s.sn));
    window._hvacFilteredStoreSet = _hvacFilteredStoreSet;
    renderTerminalHvac(_hvacFilteredStoreSet);
}
// Distribution drill-down + store unit detail moved to hvac_units_js.html
</script>

<script>
// ── 72hr Alert Region click-to-drill ──
var hvacAlertSlice = null;
var hvacAlertSortKey = 'ha72';
var hvacAlertSortAsc = false;

function hvacAlertClick(barIdx) {
    var groups = window._hvacAlertGroups || [];
    if (!groups[barIdx]) return;
    hvacAlertSlice = groups[barIdx][0]; // full region/manager key
    hvacAlertSortKey = 'ha72';
    hvacAlertSortAsc = false;
    renderHvacAlertStores();
}

function clearHvacAlertSlice() {
    hvacAlertSlice = null;
    document.getElementById('hvacAlertStorePanel').classList.add('hidden');
}

function sortHvacAlertStores(key) {
    if (hvacAlertSortKey === key) hvacAlertSortAsc = !hvacAlertSortAsc;
    else { hvacAlertSortKey = key; hvacAlertSortAsc = key === 'nm' || key === 'sn'; }
    renderHvacAlertStores();
}

function renderHvacAlertStores() {
    var panel = document.getElementById('hvacAlertStorePanel');
    if (!panel || !hvacAlertSlice) { if (panel) panel.classList.add('hidden'); return; }

    var data = window._hvacAlertData || [];
    var regionKey = hvacAlertSlice;

    // Filter stores that belong to this region/manager AND have alerts
    var stores = data.filter(function(s) {
        var key = s.rm || s.dir || 'Unknown';
        return key === regionKey && s.ha72 > 0;
    });

    var totalAlerts = stores.reduce(function(a, s) { return a + (s.ha72 || 0); }, 0);
    document.getElementById('hvacAlertTitle').textContent =
        regionKey.split(',')[0] + ' \u2014 ' + totalAlerts + ' Alert' + (totalAlerts !== 1 ? 's' : '') + ' across ' + stores.length + ' Store' + (stores.length !== 1 ? 's' : '');

    // Search filter
    var search = (document.getElementById('hvacAlertSearch').value || '').toLowerCase();
    if (search) {
        stores = stores.filter(function(s) {
            return s.sn.toLowerCase().includes(search) ||
                (s.nm || '').toLowerCase().includes(search) ||
                (s.rm || '').toLowerCase().includes(search);
        });
    }

    document.getElementById('hvacAlertCount').textContent =
        stores.length + ' store' + (stores.length !== 1 ? 's' : '');

    // Sort
    var sk = hvacAlertSortKey, asc = hvacAlertSortAsc;
    stores.sort(function(a, b) {
        var av = a[sk], bv = b[sk];
        if (av == null) av = -9999; if (bv == null) bv = -9999;
        if (typeof av === 'string') return asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return asc ? av - bv : bv - av;
    });

    // Render rows
    document.getElementById('hvacAlertBody').innerHTML = stores.map(function(s, i) {
        var rowCls = i % 2 ? 'bg-gray-50' : '';
        var tntCls = s.hvac == null ? 'text-gray-400' : s.hvac >= 95 ? 'text-[#2a8703] font-bold' : s.hvac >= 90 ? 'text-[#86bc25]' : s.hvac >= 80 ? 'text-[#fbbf24]' : 'text-[#ea1100] font-bold';
        return '<tr class="' + rowCls + ' hover:bg-red-50 cursor-pointer transition" onclick="showHvacStoreUnits(\'' + s.sn + '\')">' +
            '<td class="px-3 py-2 text-sm font-mono font-bold text-[#0ea5e9]">' + s.sn + '</td>' +
            '<td class="px-3 py-2 text-sm">' + (s.nm || '--') + '</td>' +
            '<td class="px-3 py-2 text-sm text-gray-500">' + (s.city || '') + (s.state ? ', ' + s.state : '') + '</td>' +
            '<td class="px-3 py-2 text-sm">' + (s.rm || '--') + '</td>' +
            '<td class="px-3 py-2 text-sm text-gray-600">' + (s.rgn || '--') + '</td>' +
            '<td class="px-3 py-2 text-right ' + tntCls + '">' + (s.hvac != null ? s.hvac.toFixed(1) + '%' : '--') + '</td>' +
            '<td class="px-3 py-2 text-right ' + (s.dp != null && s.dp <= 52 ? 'text-[#2a8703]' : 'text-[#ea1100]') + '">' + (s.dp != null ? s.dp.toFixed(1) + '\u00b0F' : '--') + '</td>' +
            '<td class="px-3 py-2 text-right"><span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800 font-bold">' + (s.ha72 || 0) + '</span></td>' +
            '<td class="px-3 py-2 text-right">' + (s.hwo || 0) + '</td>' +
        '</tr>';
    }).join('');

    panel.classList.remove('hidden');
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ── Distribution click-to-drill ──
function hvacDistClick(bucketIdx, type) {
    hvacDistSlice = { type: type, bucketIdx: bucketIdx };
    hvacDistSortKey = type === 'tnt' ? 'hvac' : 'dp';
    hvacDistSortAsc = true;
    renderHvacDistStores();
}

function clearHvacDistSlice() {
    hvacDistSlice = null;
    document.getElementById('hvacDistStorePanel').classList.add('hidden');
}

function sortHvacDistStores(key) {
    if (hvacDistSortKey === key) hvacDistSortAsc = !hvacDistSortAsc;
    else { hvacDistSortKey = key; hvacDistSortAsc = key === 'nm' || key === 'sn'; }
    renderHvacDistStores();
}

function renderHvacDistStores() {
    var panel = document.getElementById('hvacDistStorePanel');
    if (!panel || !hvacDistSlice) { if (panel) panel.classList.add('hidden'); return; }

    var buckets = window._hvacTntBuckets || [];
    var data = window._hvacTntData || [];
    var b = buckets[hvacDistSlice.bucketIdx];
    if (!b) return;

    var stores = data.filter(function(s) {
        return s.hvac >= b.min && s.hvac <= b.max;
    });

    document.getElementById('hvacDistTitle').textContent =
        'HVAC TnT ' + b.label + '% \u2014 ' + stores.length + ' Stores';

    var search = (document.getElementById('hvacDistSearch').value || '').toLowerCase();
    if (search) {
        stores = stores.filter(function(s) {
            return s.sn.toLowerCase().includes(search) ||
                (s.nm || '').toLowerCase().includes(search) ||
                (s.rm || '').toLowerCase().includes(search) ||
                (s.rgn || '').toLowerCase().includes(search) ||
                (s.sub || '').toLowerCase().includes(search);
        });
    }

    document.getElementById('hvacDistCount').textContent =
        stores.length + ' store' + (stores.length !== 1 ? 's' : '');

    var sk = hvacDistSortKey;
    var asc = hvacDistSortAsc;
    stores.sort(function(a, b) {
        var av = a[sk], bv = b[sk];
        if (av == null) av = -9999; if (bv == null) bv = -9999;
        if (typeof av === 'string') return asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return asc ? av - bv : bv - av;
    });

    document.getElementById('hvacDistBody').innerHTML = stores.map(function(s, i) {
        var rowCls = i % 2 ? 'bg-gray-50' : '';
        return '<tr class="' + rowCls + ' hover:bg-blue-50 cursor-pointer transition" onclick="showHvacStoreUnits(\'' + s.sn + '\')">' +
            '<td class="px-3 py-2 text-sm font-mono font-bold text-[#0ea5e9]">' + s.sn + '</td>' +
            '<td class="px-3 py-2 text-sm">' + (s.nm || '--') + '</td>' +
       '<td class="px-3 py-2 text-sm text-gray-500">' + (s.city || '') + (s.state ? ', ' + s.state : '') + '</td>' +
            '<td class="px-3 py-2 text-sm">' + (s.rm || '--') + '</td>' +
            '<td class="px-3 py-2 text-sm text-gray-600">' + (s.rgn || '--') + '</td>' +
            '<td class="px-3 py-2 text-sm text-gray-600">' + (s.sub || '--') + '</td>' +
            '<td class="px-3 py-2 text-right font-semibold ' + tntColor(s.hvac) + '">' + (s.hvac != null ? fmt(s.hvac) + '%' : '--') + '</td>' +
            '<td class="px-3 py-2 text-right ' + (s.dp != null && s.dp <= 52 ? 'text-[#2a8703]' : 'text-[#ea1100]') + '">' + (s.dp != null ? fmt(s.dp) + '\u00b0F' : '--') + '</td>' +
            '<td class="px-3 py-2 text-right">' + (s.ha72 || 0) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (s.hwo || 0) + '</td>' +
        '</tr>';
    }).join('');

    panel.classList.remove('hidden');
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ── Store HVAC Unit Detail Panel ──
var _hvacUnitStore = null;
var _hvacUnitSortKey = 'un';
var _hvacUnitSortAsc = true;

function showHvacStoreUnits(sn) {
    _hvacUnitStore = String(sn);
    _hvacUnitSortKey = 'un';
    _hvacUnitSortAsc = true;
    document.getElementById('hvacUnitTypeFilter').value = '';
    document.getElementById('hvacUnitStoreNum').textContent = sn;
    renderHvacStoreUnits();
    var panel = document.getElementById('hvacStoreUnitPanel');
    panel.classList.remove('hidden');
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function closeHvacStoreUnits() {
    _hvacUnitStore = null;
    document.getElementById('hvacStoreUnitPanel').classList.add('hidden');
}

function sortHvacStoreUnits(key) {
    if (_hvacUnitSortKey === key) _hvacUnitSortAsc = !_hvacUnitSortAsc;
    else { _hvacUnitSortKey = key; _hvacUnitSortAsc = true; }
    renderHvacStoreUnits();
}

function _unitTypeLabel(ut) {
    if (!ut) return 'Other';
    var l = ut.toLowerCase();
    if (l.indexOf('rooftop') >= 0) return 'RTU';
    if (l.indexOf('air handler') >= 0) return 'AHU';
    if (l.indexOf('unit heater') >= 0) return 'Unit Heater';
    if (l === 'vav') return 'VAV';
    if (l === 'zone') return 'Zone';
    if (l.indexOf('fan') >= 0) return 'Fan Box';
    return ut;
}

function _unitTypeBadgeColor(label) {
    switch(label) {
        case 'RTU': return 'bg-blue-100 text-blue-800 border-blue-300';
        case 'AHU': return 'bg-purple-100 text-purple-800 border-purple-300';
        case 'Unit Heater': return 'bg-orange-100 text-orange-800 border-orange-300';
        case 'VAV': return 'bg-teal-100 text-teal-800 border-teal-300';
        default: return 'bg-gray-100 text-gray-800 border-gray-300';
    }
}

function renderHvacStoreUnits() {
    if (!_hvacUnitStore || typeof TERM_DETAIL === 'undefined') return;
    var typeFilter = document.getElementById('hvacUnitTypeFilter').value;
    var units = TERM_DETAIL.filter(function(u) {
        if (u.sn !== _hvacUnitStore) return false;
        if (typeFilter && u.ut !== typeFilter) return false;
        return true;
    });
    var allUnits = TERM_DETAIL.filter(function(u) { return u.sn === _hvacUnitStore; });

    // Type badges
    var typeCounts = {};
    allUnits.forEach(function(u) {
        var label = _unitTypeLabel(u.ut);
        typeCounts[label] = (typeCounts[label] || 0) + 1;
    });
    document.getElementById('hvacUnitBadges').innerHTML = Object.keys(typeCounts).map(function(label) {
        var cls = _unitTypeBadgeColor(label);
        return '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold border ' + cls + '">' +
            label + ': ' + typeCounts[label] + '</span>';
    }).join('');

    // Avg temp bar
    var validTemps = allUnits.filter(function(u) { return u.zt != null && u.zt > -100 && u.zt < 200; }).map(function(u) { return u.zt; });
    var avgT = validTemps.length ? (validTemps.reduce(function(a,b){return a+b;},0) / validTemps.length) : null;
    var tempHtml = '';
    if (avgT != null) {
        var tColor = (avgT >= 69 && avgT <= 73) ? '#2a8703' : (avgT >= 60 && avgT <= 78) ? '#fbbf24' : '#ea1100';
        var tLabel = avgT <= 60 ? 'Cold' : avgT <= 68 ? 'Cool' : avgT <= 73 ? 'Target' : avgT <= 78 ? 'Warm' : 'Hot';
        tempHtml = '<div class="flex items-center gap-3">' +
            '<span class="text-sm font-semibold text-gray-700">Avg Zone Temp:</span>' +
            '<span class="text-lg font-bold" style="color:' + tColor + '">' + avgT.toFixed(1) + '\u00b0F</span>' +
            '<span class="text-xs px-2 py-0.5 rounded-full font-medium" style="background:' + tColor + '20;color:' + tColor + '">' + tLabel + '</span>' +
            '<span class="text-xs text-gray-500">(' + validTemps.length + ' units with temp data)</span></div>';
    }
    document.getElementById('hvacUnitTempBar').innerHTML = tempHtml;

    // Summary
    document.getElementById('hvacUnitSummary').textContent = units.length + ' of ' + allUnits.length + ' units';

    // Sort
    var sk = _hvacUnitSortKey, asc = _hvacUnitSortAsc;
    units.sort(function(a, b) {
        var av = a[sk], bv = b[sk];
        if (av == null) av = -9999; if (bv == null) bv = -9999;
        if (typeof av === 'string') return asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return asc ? av - bv : bv - av;
    });

    // Render
    var tbody = document.getElementById('hvacStoreUnitBody');
    tbody.innerHTML = units.map(function(u, i) {
        var zt = (u.zt != null && u.zt > -100 && u.zt < 200) ? u.zt.toFixed(1) + '\u00b0F' : '--';
        var zd = (u.zd != null && u.zd > 0) ? u.zd.toFixed(1) + '\u00b0F' : '--';
        var tntV = u.tnt != null ? u.tnt.toFixed(1) + '%' : '--';
        var tntCls = u.tnt == null ? 'text-gray-400' : u.tnt >= 95 ? 'text-[#2a8703] font-bold' : u.tnt >= 90 ? 'text-[#86bc25]' : u.tnt >= 80 ? 'text-[#fbbf24]' : 'text-[#ea1100] font-bold';
        var alertBadge = u.al > 0 ? '<span class="px-2 py-0.5 rounded-full text-xs bg-red-100 text-red-800 font-bold">' + u.al + '</span>' : '<span class="text-gray-400">0</span>';
        var flag = function(v) { return v ? '<span class="text-[#ea1100] font-bold">\u26A0</span>' : '<span class="text-gray-300">\u2014</span>'; };
        var rowCls = i % 2 ? 'bg-gray-50' : '';
        var utLabel = _unitTypeLabel(u.ut);
        var utCls = _unitTypeBadgeColor(utLabel);
        return '<tr class="' + rowCls + ' hover:bg-cyan-50">' +
            '<td class="px-3 py-2 font-mono font-semibold text-[#0ea5e9]">' + (u.un || '--') + '</td>' +
            '<td class="px-3 py-2"><span class="px-2 py-0.5 rounded text-xs font-medium border ' + utCls + '">' + utLabel + '</span></td>' +
            '<td class="px-3 py-2 text-right">' + zt + '</td>' +
            '<td class="px-3 py-2 text-right">' + zd + '</td>' +
            '<td class="px-3 py-2 text-right ' + tntCls + '">' + tntV + '</td>' +
            '<td class="px-3 py-2 text-center">' + alertBadge + '</td>' +
            '<td class="px-3 py-2 text-center">' + flag(u.hdp) + '</td>' +
            '<td class="px-3 py-2 text-center">' + flag(u.ht) + '</td>' +
            '<td class="px-3 py-2 text-center">' + flag(u.lt) + '</td>' +
            '<td class="px-3 py-2 text-center">' + flag(u.lo) + '</td>' +
            '<td class="px-3 py-2 text-center">' + flag(u.hf) + '</td>' +
            '<td class="px-3 py-2 text-gray-600">' + (u.rsn || '--') + '</td>' +
        '</tr>';
    }).join('');
    document.getElementById('hvacUnitCount').textContent = units.length + ' units shown';
}

// ── Terminal HVAC Charts (filtered by top-level store set) ──
function renderTerminalHvac(filteredStoreSet) {
    if (!TERM_DETAIL || !TERM_DETAIL.length) return;

    var allFiltered = filteredStoreSet
        ? TERM_DETAIL.filter(u => filteredStoreSet.has(u.sn))
        : TERM_DETAIL;

    // KPIs from filtered terminal units
    var totalUnits = allFiltered.length;
    var totalAlerts = allFiltered.reduce((a, u) => a + (u.al || 0), 0);
    var withAlerts = allFiltered.filter(u => u.al > 0).length;

    document.getElementById('termTotalUnits').textContent = totalUnits.toLocaleString();
    document.getElementById('termTotalOccur').textContent = totalAlerts.toLocaleString();
    document.getElementById('termGt3Units').textContent = withAlerts.toLocaleString();

    // By Reason (doughnut)
    var byReason = {};
    allFiltered.forEach(u => {
        var r = u.rsn || 'Unknown';
        byReason[r] = (byReason[r] || 0) + 1;
    });
    var reasonColors = { 'ZONE TEMP': '#ea1100', 'COMM LOSS': '#ff8200', 'DEWPOINT': '#0ea5e9' };
    makeOrUpdate('termReasonChart', {
        type: 'doughnut',
        data: {
            labels: Object.keys(byReason),
            datasets: [{ data: Object.values(byReason), backgroundColor: Object.keys(byReason).map(r => reasonColors[r] || '#9ca3af') }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, datalabels: { display: true, formatter: v => v.toLocaleString(), font: { weight: 'bold', size: 14 }, color: '#fff' } } }
    });

    // Stacked bar: reason x alert severity
    var alertBuckets = { '0 alerts': {}, '1-10 alerts': {}, '10+ alerts': {} };
    allFiltered.forEach(u => {
        var r = u.rsn || 'Unknown';
        var bucket = u.al === 0 ? '0 alerts' : u.al <= 10 ? '1-10 alerts' : '10+ alerts';
        alertBuckets[bucket][r] = (alertBuckets[bucket][r] || 0) + 1;
    });
    var bucketOrder = ['0 alerts', '1-10 alerts', '10+ alerts'];
    var reasons = [...new Set(allFiltered.map(u => u.rsn || 'Unknown'))].sort();
    makeOrUpdate('termStackedChart', {
        type: 'bar',
        data: {
            labels: bucketOrder,
            datasets: reasons.map(r => ({
                label: r,
                data: bucketOrder.map(b => (alertBuckets[b] && alertBuckets[b][r]) || 0),
                backgroundColor: reasonColors[r] || '#9ca3af'
            }))
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }, plugins: { legend: { position: 'top' }, datalabels: { display: true, color: '#fff', font: { weight: 'bold', size: 11 }, formatter: v => v > 0 ? v.toLocaleString() : '' } } }
    });

    // Alert severity bar chart
    var severityCounts = bucketOrder.map(b => {
        return Object.values(alertBuckets[b] || {}).reduce((a, v) => a + v, 0);
    });
    makeOrUpdate('termDaysChart', {
        type: 'bar',
        data: {
            labels: bucketOrder,
            datasets: [{ data: severityCounts, backgroundColor: ['#86bc25', '#fbbf24', '#ea1100'] }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: true, anchor: 'end', align: 'right', font: { weight: 'bold' } } }, scales: { x: { beginAtZero: true } } }
    });

    // Pre-aggregated summary table (TERMINAL_HVAC)
    var data = typeof TERMINAL_HVAC !== 'undefined' ? TERMINAL_HVAC : [];
    var tbody = document.getElementById('termTableBody');
    if (tbody && data.length) {
        var sorted = [...data].sort((a, b) => b.units - a.units);
        tbody.innerHTML = sorted.map(d => {
            var cls = d.days === '>3 Days' ? 'bg-red-50' : '';
            return '<tr class="' + cls + ' hover:bg-gray-50">' +
                '<td class="px-4 py-2 text-sm">' + d.days + '</td>' +
                '<td class="px-4 py-2 text-sm font-medium">' + d.reason + '</td>' +
                '<td class="px-4 py-2 text-sm text-right">' + d.count.toLocaleString() + '</td>' +
                '<td class="px-4 py-2 text-sm text-right font-semibold">' + d.units.toLocaleString() + '</td>' +
            '</tr>';
        }).join('');
    }

    renderTermDetailTable();
}

function renderTermDetailTable() {
    var reason = document.getElementById('termReasonFilter') ? document.getElementById('termReasonFilter').value : '';
    var alarmsOnly = document.getElementById('termAlarmsOnly') ? document.getElementById('termAlarmsOnly').checked : false;
    var search = (document.getElementById('termSearch') ? document.getElementById('termSearch').value : '').trim();
    var storeSet = window._hvacFilteredStoreSet;

    var filtered = TERM_DETAIL;
    if (storeSet && storeSet.size > 0) {
        filtered = filtered.filter(function(u) { return storeSet.has(u.sn); });
    }
    if (reason) filtered = filtered.filter(function(u) { return u.rsn === reason; });
    if (alarmsOnly) filtered = filtered.filter(function(u) { return u.al > 0; });
    if (search) filtered = filtered.filter(function(u) { return u.sn.includes(search); });

    filtered = filtered.slice().sort(function(a, b) { return b.al - a.al; });
    var show = filtered.slice(0, 300);

    var reasonCls = { 'ZONE TEMP': 'bg-red-100 text-red-800', 'COMM LOSS': 'bg-orange-100 text-orange-800', 'DEWPOINT': 'bg-blue-100 text-blue-800' };

    var tbody = document.getElementById('termDetailBody');
    if (!tbody) return;
    tbody.innerHTML = show.map(function(u) {
        var alCls = u.al > 100 ? 'bg-red-200 text-red-900 font-bold' : u.al > 10 ? 'bg-red-100 text-red-800' : u.al > 0 ? 'bg-yellow-100 text-yellow-800' : 'text-gray-400';
        var tntCls = u.tnt != null && u.tnt < 50 ? 'text-red-700 font-bold' : u.tnt != null && u.tnt < 80 ? 'text-yellow-700' : '';
        return '<tr class="hover:bg-red-50">' +
            '<td class="px-2 py-1 font-semibold">' + u.sn + '</td>' +
            '<td class="px-2 py-1 text-[#0ea5e9] font-medium">' + (u.cl || '-') + '</td>' +
            '<td class="px-2 py-1 font-mono">' + u.un + '</td>' +
            '<td class="px-2 py-1"><span class="px-1.5 py-0.5 rounded text-xs ' + (reasonCls[u.rsn] || '') + '">' + u.rsn + '</span></td>' +
            '<td class="px-2 py-1 text-center"><span class="px-1.5 py-0.5 rounded text-xs ' + alCls + '">' + u.al + '</span></td>' +
            '<td class="px-2 py-1 text-center ' + tntCls + '">' + (u.tnt != null ? u.tnt + '%' : '-') + '</td>' +
            '<td class="px-2 py-1 text-center">' + (u.zt != null ? u.zt + '\u00b0F' : '-') + '</td>' +
            '<td class="px-2 py-1 text-center">' + (u.zd != null ? u.zd + '\u00b0F' : '-') + '</td>' +
        '</tr>';
    }).join('');

    var totalCount = storeSet ? TERM_DETAIL.filter(function(u) { return storeSet.has(u.sn); }).length : TERM_DETAIL.length;
    document.getElementById('termDetailCount').textContent =
        'Showing ' + show.length + ' of ' + filtered.length + ' units' +
        (filtered.length !== totalCount ? ' (filtered from ' + totalCount + ' in scope)' : '') +
        (totalCount !== TERM_DETAIL.length ? ' \u2014 ' + TERM_DETAIL.length + ' total across all stores' : '');
}
</script>

<script>
// ── NPS Tab Logic ──
let npsCharts = {};
let npsInitialized = false;
let npsTableSortKey = 'market_nps';
let npsTableSortAsc = true;
let npsMarketSlice = null;
let npsMarketSortKey = 'market_nps';
let npsMarketSortAsc = true;
let npsDistDrillSlice = null; // { type: 'nps'|'part', label, filterFn }
let npsDistDrillSortKey = 'market_nps';
let npsDistDrillSortAsc = true;
let npsFilteredOps = []; // filtered NPS_OPS data
let npsSrFilter = null; // active Sr Director name (uppercase) or null

// Lazy lookups — built on first renderNpsTab when STORES is loaded
var NPS_MKT_OPS = null;
var NPS_MKT_SR = null;
var NPS_MKT_BANNERS = null; // market → Set of banner strings
var NPS_MKT_SR_NAME = null;  // market → sr director name
var NPS_MKT_DIR = null;      // market → fm director name
var NPS_MKT_RM = null;       // market → regional manager name
var NPS_MKT_FSM = null;      // market → fs manager name

function ensureNpsLookups() {
    if (NPS_MKT_OPS !== null) return;
    NPS_MKT_OPS = {};
    NPS_MKT_SR = {};
    NPS_MKT_BANNERS = {};
    NPS_MKT_SR_NAME = {};
    NPS_MKT_DIR = {};
    NPS_MKT_RM = {};
    NPS_MKT_FSM = {};
    STORES.forEach(function(s) {
        if (s.mkt && s.ops) NPS_MKT_OPS[s.mkt] = s.ops;
        if (s.mkt && s.sr) {
            NPS_MKT_SR[s.mkt] = s.sr.toUpperCase();
            NPS_MKT_SR_NAME[s.mkt] = s.sr;
        }
        if (s.mkt && s.dir) NPS_MKT_DIR[s.mkt] = s.dir;
        if (s.mkt && s.rm) NPS_MKT_RM[s.mkt] = s.rm;
        if (s.mkt && s.fsm) NPS_MKT_FSM[s.mkt] = s.fsm;
        if (s.mkt && s.bn) {
            if (!NPS_MKT_BANNERS[s.mkt]) NPS_MKT_BANNERS[s.mkt] = new Set();
            NPS_MKT_BANNERS[s.mkt].add(s.bn);
        }
    });
}

function npsColor(score) {
    if (score == null) return 'text-gray-400';
    if (score >= 90) return 'text-[#2a8703]';
    if (score >= 80) return 'text-[#86bc25]';
    if (score >= 70) return 'text-[#fbbf24]';
    return 'text-[#ea1100]';
}

function npsBgColor(score) {
    if (score == null) return '#9ca3af';
    if (score >= 90) return '#2a8703';
    if (score >= 80) return '#86bc25';
    if (score >= 70) return '#fbbf24';
    if (score >= 60) return '#ff8200';
    return '#ea1100';
}

function npsFormat(v) {
    return v != null ? Math.round(v) : '--';
}

// ── Filter Logic ──
function populateNpsFilters() {
    var filtered = npsFilteredOps;
    // Org hierarchy filters based on market → store lookups
    var srVals = [...new Set(filtered.map(d => NPS_MKT_SR_NAME[d.market]).filter(Boolean))].sort();
    var dirVals = [...new Set(filtered.map(d => NPS_MKT_DIR[d.market]).filter(Boolean))].sort();
    var rmVals = [...new Set(filtered.map(d => NPS_MKT_RM[d.market]).filter(Boolean))].sort();
    var fsmVals = [...new Set(filtered.map(d => NPS_MKT_FSM[d.market]).filter(Boolean))].sort();
    var mktVals = [...new Set(filtered.map(d => d.market).filter(Boolean))].sort(function(a,b){return parseInt(a)-parseInt(b);});
    var opsRegions = [...new Set(filtered.map(d => NPS_MKT_OPS[d.market]).filter(Boolean))].sort();
    var regionals = [...new Set(filtered.map(d => d.regional).filter(Boolean))].sort();
    var managers = [...new Set(filtered.map(d => d.manager).filter(Boolean))].sort();

    _npsPopFilter('npsFilterSr', srVals, 'All Sr. Directors');
    _npsPopFilter('npsFilterDir', dirVals, 'All Directors');
    _npsPopFilter('npsFilterRm', rmVals, 'All Regional Mgrs');
    _npsPopFilter('npsFilterFsm', fsmVals, 'All FS Managers');
    _npsPopFilter('npsFilterMkt', mktVals, 'All Markets');
    _npsPopFilter('npsFilterOps', opsRegions, 'All Ops Regions');
    _npsPopFilter('npsFilterRegional', regionals, 'All Regionals');
    _npsPopFilter('npsFilterManager', managers, 'All Managers');
}

function _npsPopFilter(id, values, defaultLabel) {
    var sel = document.getElementById(id);
    if (!sel) return;
    var cur = sel.value;
    sel.innerHTML = '<option value="">' + defaultLabel + '</option>' +
        values.map(v => '<option value="' + v + '"' + (v === cur ? ' selected' : '') + '>' + v + '</option>').join('');
    if (cur && !values.includes(cur)) sel.value = '';
}

function getFilteredNpsOps() {
    var bannerMode = typeof activeBanner !== 'undefined' ? activeBanner : 'all';
    var banners = (bannerMode !== 'all' && typeof getActiveBanners === 'function') ? getActiveBanners() : null;
    var opsReg = document.getElementById('npsFilterOps').value;
    var regional = document.getElementById('npsFilterRegional').value;
    var manager = document.getElementById('npsFilterManager').value;
    var score = document.getElementById('npsFilterScore').value;
    var part = document.getElementById('npsFilterPart').value;
    // Org hierarchy filters
    var srVal = document.getElementById('npsFilterSr') ? document.getElementById('npsFilterSr').value : '';
    var dirVal = document.getElementById('npsFilterDir') ? document.getElementById('npsFilterDir').value : '';
    var rmVal = document.getElementById('npsFilterRm') ? document.getElementById('npsFilterRm').value : '';
    var fsmVal = document.getElementById('npsFilterFsm') ? document.getElementById('npsFilterFsm').value : '';
    var mktVal = document.getElementById('npsFilterMkt') ? document.getElementById('npsFilterMkt').value : '';
    return NPS_OPS.filter(function(d) {
        // Banner filter
        if (banners && NPS_MKT_BANNERS) {
            var mktBanners = NPS_MKT_BANNERS[d.market];
            if (!mktBanners) return false;
            var hasMatch = false;
            mktBanners.forEach(function(b) { if (banners.has(b)) hasMatch = true; });
            if (!hasMatch) return false;
        }
        // Org hierarchy filters via market → store lookups
        if (srVal && NPS_MKT_SR_NAME[d.market] !== srVal) return false;
        if (dirVal && NPS_MKT_DIR[d.market] !== dirVal) return false;
        if (rmVal && NPS_MKT_RM[d.market] !== rmVal) return false;
        if (fsmVal && NPS_MKT_FSM[d.market] !== fsmVal) return false;
        if (mktVal && d.market !== mktVal) return false;
        if (npsSrFilter && NPS_MKT_SR[d.market] !== npsSrFilter) return false;
        if (opsReg && NPS_MKT_OPS[d.market] !== opsReg) return false;
        if (regional && d.regional !== regional) return false;
        if (manager && d.manager !== manager) return false;
        if (score) {
            var s = parseInt(score);
            var nps = d.market_nps;
            if (nps == null) return false;
            if (s === 90 && nps < 90) return false;
            if (s === 80 && (nps < 80 || nps >= 90)) return false;
            if (s === 70 && (nps < 70 || nps >= 80)) return false;
            if (s === 60 && (nps < 60 || nps >= 70)) return false;
            if (s === 0 && nps >= 60) return false;
        }
        if (part) {
            var p = parseInt(part);
            var rr = d.response_rate;
            if (rr == null) return false;
            if (p === 50 && rr < 50) return false;
            if (p === 30 && (rr < 30 || rr >= 50)) return false;
            if (p === 20 && (rr < 20 || rr >= 30)) return false;
            if (p === 0 && rr >= 20) return false;
        }
        return true;
    });
}

function applyNpsFilters() {
    npsFilteredOps = getFilteredNpsOps();
    clearNpsDistDrill();
    clearNpsMarketSlice();
    renderNpsMissingMarkets();
    renderNpsHeader();
    renderNpsSrCards();
    renderNpsRegionalChart();
    renderNpsRegionBucketChart();
    renderNpsDistChart();
    renderNpsParticipationChart();
    renderNpsTable();
    renderNpsInsights();
}

function clearNpsFilters() {
    npsSrFilter = null;
    document.getElementById('npsFilterSr').value = '';
    document.getElementById('npsFilterDir').value = '';
    document.getElementById('npsFilterRm').value = '';
    document.getElementById('npsFilterFsm').value = '';
    document.getElementById('npsFilterMkt').value = '';
    document.getElementById('npsFilterOps').value = '';
    document.getElementById('npsFilterRegional').value = '';
    document.getElementById('npsFilterManager').value = '';
    document.getElementById('npsFilterScore').value = '';
    document.getElementById('npsFilterPart').value = '';
    nameSearchClear('nps');
    applyNpsFilters();
}

registerNameSearch('nps', {
    orgIds: [
        { key: 'sr', filterId: 'npsFilterSr', label: 'Sr. Director' },
        { key: 'dir', filterId: 'npsFilterDir', label: 'FM Director' },
        { key: 'rm', filterId: 'npsFilterRm', label: 'Regional Manager' },
        { key: 'fsm', filterId: 'npsFilterFsm', label: 'FS Manager' },
    ],
    applyFn: 'applyNpsFilters'
});

// ── Header KPIs ──
function renderNpsMissingMarkets() {
    var alert = document.getElementById('npsMissingMarketsAlert');
    if (!alert) return;
    // Only show when an org filter is active and results are sparse
    var srVal = (document.getElementById('npsFilterSr') || {}).value || '';
    var dirVal = (document.getElementById('npsFilterDir') || {}).value || '';
    var rmVal = (document.getElementById('npsFilterRm') || {}).value || '';
    var fsmVal = (document.getElementById('npsFilterFsm') || {}).value || '';
    if (!srVal && !dirVal && !rmVal && !fsmVal) { alert.classList.add('hidden'); return; }

    // Find all store markets that match the org filter
    var npsMarketSet = new Set(NPS_OPS.map(function(d) { return d.market; }));
    var filteredStores = STORES.filter(function(s) {
        if (srVal && s.sr !== srVal) return false;
        if (dirVal && s.dir !== dirVal) return false;
        if (rmVal && s.rm !== rmVal) return false;
        if (fsmVal && s.fsm !== fsmVal) return false;
        return true;
    });
    var missingStores = filteredStores.filter(function(s) { return s.mkt && !npsMarketSet.has(s.mkt); });
    var missingMarkets = [...new Set(missingStores.map(function(s) { return s.mkt; }))].sort(function(a,b){return parseInt(a)-parseInt(b);});

    if (missingMarkets.length === 0) { alert.classList.add('hidden'); return; }

    // Build filter label
    var filterName = fsmVal || rmVal || dirVal || srVal;
    var filterRole = fsmVal ? 'FS Manager' : rmVal ? 'Regional Manager' : dirVal ? 'FM Director' : 'Sr. Director';

    // Summarize
    var coveredStores = filteredStores.length - missingStores.length;
    document.getElementById('npsMissingSummary').innerHTML =
        '<strong>' + missingMarkets.length + ' market' + (missingMarkets.length > 1 ? 's' : '') + '</strong>' +
        ' (' + missingMarkets.join(', ') + ') under ' + filterRole + ' <strong>' + filterName + '</strong>' +
        ' have no NPS survey data in the Tableau source.' +
        ' <span class="text-amber-600">' + missingStores.length + ' store' + (missingStores.length > 1 ? 's' : '') + ' affected</span>' +
        (coveredStores > 0 ? ' &middot; ' + coveredStores + ' store' + (coveredStores > 1 ? 's' : '') + ' have NPS coverage.' : '.');

    // Detail: group missing stores by market
    var byMkt = {};
    missingStores.forEach(function(s) {
        if (!byMkt[s.mkt]) byMkt[s.mkt] = [];
        byMkt[s.mkt].push(s);
    });
    var detailHtml = missingMarkets.map(function(mkt) {
        var stores = byMkt[mkt] || [];
        var storeList = stores.slice(0, 20).map(function(s) {
            return '#' + s.sn + ' ' + (s.nm || '');
        }).join(', ');
        if (stores.length > 20) storeList += '... +' + (stores.length - 20) + ' more';
        return '<div class="mb-1"><strong>Market ' + mkt + '</strong> (' + stores.length + ' stores): ' + storeList + '</div>';
    }).join('');
    document.getElementById('npsMissingDetail').innerHTML = detailHtml;
    alert.classList.remove('hidden');
}

function renderNpsHeader() {
    var ops = npsFilteredOps;

    // Overall NPS = weighted avg from filtered ops
    var totalVol = 0, totalWeighted = 0;
    ops.forEach(function(d) {
        if (d.market_nps != null && d.volume) {
            totalWeighted += d.market_nps * d.volume;
            totalVol += d.volume;
        }
    });
    var overall = totalVol > 0 ? Math.round(totalWeighted / totalVol) : '--';
    document.getElementById('npsOverallScore').textContent = overall;

    // Total responses
    document.getElementById('npsTotalResponses').textContent =
        totalVol.toLocaleString();

    // Total stores
    var totalStores = ops.reduce(function(a, d) { return a + (d.stores || 0); }, 0);
    document.getElementById('npsTotalStores').textContent =
        Math.round(totalStores).toLocaleString();

    // Avg participation
    var parts = ops.filter(function(d) { return d.response_rate != null; });
    var avgPart = parts.length
        ? Math.round(parts.reduce(function(a, d) { return a + d.response_rate; }, 0) / parts.length)
        : '--';
    document.getElementById('npsAvgParticipation').textContent = avgPart + '%';
}

// ── Sr Director Cards ──
function toggleNpsSrFilter(name) {
    npsSrFilter = (npsSrFilter === name) ? null : name;
    applyNpsFilters();
}

function renderNpsSrCards() {
    var fs = NPS_FS.slice().sort(function(a, b) { return (b.nps || 0) - (a.nps || 0); });
    var container = document.getElementById('npsSrCards');
    container.innerHTML = fs.map(function(d) {
        var color = npsBgColor(d.nps);
        var partPct = d.participation != null ? Math.round(d.participation) + '%' : '--';
        var isActive = npsSrFilter === d.name;
        var ring = isActive ? 'ring-2 ring-[#0ea5e9] ring-offset-2 scale-105' : 'hover:scale-[1.02]';
        var escapedName = d.name.replace(/'/g, "\\'");
        return '<div class="bg-white rounded-lg shadow p-4 border-l-4 cursor-pointer transition-all ' + ring + '" ' +
            'style="border-left-color:' + color + '" ' +
            'onclick="toggleNpsSrFilter(\'' + escapedName + '\')" ' +
            'title="Click to filter by ' + d.name + '">' +
            '<p class="text-xs ' + (isActive ? 'text-[#0ea5e9] font-bold' : 'text-gray-500') + ' truncate">' +
            (isActive ? '\u2714 ' : '') + d.name + '</p>' +
            '<p class="text-2xl font-bold mt-1" style="color:' + color + '">' + npsFormat(d.nps) + '</p>' +
            '<div class="flex justify-between text-xs text-gray-500 mt-2">' +
            '<span>' + (d.volume || 0) + ' responses</span>' +
            '<span>' + partPct + ' part.</span>' +
            '</div>' +
            '<p class="text-xs text-gray-400 mt-1">' + Math.round(d.stores || 0).toLocaleString() + ' stores</p>' +
            '</div>';
    }).join('');
}

// ── Regional Chart ──
function renderNpsRegionalChart() {
    // Group filtered ops by regional
    var byRegional = {};
    npsFilteredOps.forEach(function(d) {
        var key = d.regional || 'Unknown';
        if (!byRegional[key]) byRegional[key] = { nps: d.region_nps, part: d.region_participation, markets: [] };
        byRegional[key].markets.push(d);
    });

    var entries = Object.keys(byRegional).map(function(k) {
        return { name: k, nps: byRegional[k].nps, part: byRegional[k].part, count: byRegional[k].markets.length };
    }).sort(function(a, b) { return (a.nps || 0) - (b.nps || 0); });

    var labels = entries.map(function(e) { return e.name; });
    var scores = entries.map(function(e) { return e.nps; });
    var colors = scores.map(function(s) { return npsBgColor(s); });

    window._npsRegionalEntries = entries;

    var cfg = {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ data: scores, backgroundColor: colors }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: { display: true, anchor: 'end', align: 'right', font: { weight: 'bold', size: 10 } }
            },
            scales: { x: { beginAtZero: true, max: 100, title: { display: true, text: 'NPS Score' } } },
            onClick: function(evt) {
                var pts = this.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
                if (pts.length) {
                    var entry = window._npsRegionalEntries[pts[0].index];
                    npsMarketSlice = entry.name;
                    renderNpsMarketList();
                }
            }
        }
    };
    npsChartUpdate('npsRegionalChart', cfg);
}

// ── Region Bucket Chart ──
function renderNpsRegionBucketChart() {
    // Compute region-level NPS from filtered ops (weighted by volume)
    var byRegion = {};
    npsFilteredOps.forEach(function(d) {
        var key = d.regional || 'Unknown';
        if (!byRegion[key]) byRegion[key] = { weighted: 0, vol: 0 };
        if (d.market_nps != null && d.volume) {
            byRegion[key].weighted += d.market_nps * d.volume;
            byRegion[key].vol += d.volume;
        }
    });
    var bucketOrder = ['90-100', '80-90', '70-80', '60-70', '<60'];
    var bucketColors = ['#2a8703', '#86bc25', '#fbbf24', '#ff8200', '#ea1100'];
    var counts = bucketOrder.map(function() { return 0; });
    Object.values(byRegion).forEach(function(r) {
        if (r.vol === 0) return;
        var nps = r.weighted / r.vol;
        if (nps >= 90) counts[0]++;
        else if (nps >= 80) counts[1]++;
        else if (nps >= 70) counts[2]++;
        else if (nps >= 60) counts[3]++;
        else counts[4]++;
    });

    var cfg = {
        type: 'doughnut',
        data: {
            labels: bucketOrder,
            datasets: [{ data: counts, backgroundColor: bucketColors }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' },
                datalabels: {
                    display: true,
                    color: '#fff',
                    font: { weight: 'bold', size: 14 },
                    formatter: function(v) { return v > 0 ? v + ' regions' : ''; }
                }
            }
        }
    };
    npsChartUpdate('npsRegionBucketChart', cfg);
}

// ── NPS Distribution Chart ──
function renderNpsDistChart() {
    var bucketDefs = [
        { label: '\u226590', min: 90, max: 999 },
        { label: '80-89', min: 80, max: 89.999 },
        { label: '70-79', min: 70, max: 79.999 },
        { label: '60-69', min: 60, max: 69.999 },
        { label: '<60', min: -999, max: 59.999 },
    ];
    var bucketColors = ['#2a8703', '#86bc25', '#fbbf24', '#ff8200', '#ea1100'];
    var counts = bucketDefs.map(function() { return 0; });
    npsFilteredOps.forEach(function(d) {
        var v = d.market_nps;
        if (v == null) return;
        for (var i = 0; i < bucketDefs.length; i++) {
            if (v >= bucketDefs[i].min && v <= bucketDefs[i].max) { counts[i]++; break; }
        }
    });
    window._npsDistBuckets = bucketDefs;
    var cfg = {
        type: 'bar',
        data: {
            labels: bucketDefs.map(function(b) { return b.label; }),
            datasets: [{ data: counts, backgroundColor: bucketColors }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: { display: true, anchor: 'end', align: 'top', font: { weight: 'bold' } }
            },
            scales: { y: { beginAtZero: true, title: { display: true, text: '# Markets' } } },
            onClick: function(evt) {
                var pts = this.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
                if (pts.length) {
                    var b = bucketDefs[pts[0].index];
                    npsDistDrillSlice = {
                        type: 'nps', label: 'NPS ' + b.label + ' — Markets',
                        filterFn: function(d) { return d.market_nps != null && d.market_nps >= b.min && d.market_nps <= b.max; }
                    };
                    npsDistDrillSortKey = 'market_nps'; npsDistDrillSortAsc = true;
                    renderNpsDistDrill();
                }
            }
        }
    };
    npsChartUpdate('npsDistChart', cfg);
}

// ── Participation Chart ──
function renderNpsParticipationChart() {
    var bucketDefs = [
        { label: '\u226550%', min: 50, max: 999 },
        { label: '30-49%', min: 30, max: 49.999 },
        { label: '20-29%', min: 20, max: 29.999 },
        { label: '<20%', min: -999, max: 19.999 },
    ];
    var bucketColors = ['#2a8703', '#86bc25', '#fbbf24', '#ea1100'];
    var counts = bucketDefs.map(function() { return 0; });
    npsFilteredOps.forEach(function(d) {
        var v = d.response_rate;
        if (v == null) return;
        for (var i = 0; i < bucketDefs.length; i++) {
            if (v >= bucketDefs[i].min && v <= bucketDefs[i].max) { counts[i]++; break; }
        }
    });
    window._npsPartBuckets = bucketDefs;
    var cfg = {
        type: 'bar',
        data: {
            labels: bucketDefs.map(function(b) { return b.label; }),
            datasets: [{ data: counts, backgroundColor: bucketColors }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                datalabels: { display: true, anchor: 'end', align: 'top', font: { weight: 'bold' } }
            },
            scales: { y: { beginAtZero: true, title: { display: true, text: '# Markets' } } },
            onClick: function(evt) {
                var pts = this.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
                if (pts.length) {
                    var b = bucketDefs[pts[0].index];
                    npsDistDrillSlice = {
                        type: 'part', label: 'Participation ' + b.label + ' — Markets',
                        filterFn: function(d) { return d.response_rate != null && d.response_rate >= b.min && d.response_rate <= b.max; }
                    };
                    npsDistDrillSortKey = 'response_rate'; npsDistDrillSortAsc = true;
                    renderNpsDistDrill();
                }
            }
        }
    };
    npsChartUpdate('npsParticipationChart', cfg);
}

// ── Chart helper ──
function npsChartUpdate(id, cfg) {
    if (npsCharts[id]) {
        npsCharts[id].destroy();
    }
    npsCharts[id] = new Chart(document.getElementById(id), cfg);
}

// ── Market drill-down ──
function clearNpsMarketSlice() {
    npsMarketSlice = null;
    document.getElementById('npsMarketPanel').classList.add('hidden');
}

function sortNpsMarkets(key) {
    if (npsMarketSortKey === key) npsMarketSortAsc = !npsMarketSortAsc;
    else { npsMarketSortKey = key; npsMarketSortAsc = key === 'market' || key === 'manager'; }
    renderNpsMarketList();
}

function renderNpsMarketList() {
    var panel = document.getElementById('npsMarketPanel');
    if (!panel || !npsMarketSlice) { if (panel) panel.classList.add('hidden'); return; }

    var markets = npsFilteredOps.filter(function(d) { return d.regional === npsMarketSlice; });
    document.getElementById('npsMarketPanelTitle').textContent = npsMarketSlice;

    var search = (document.getElementById('npsMarketSearch').value || '').toLowerCase();
    if (search) {
        markets = markets.filter(function(d) {
            return d.market.toLowerCase().includes(search) ||
                d.manager.toLowerCase().includes(search);
        });
    }

    document.getElementById('npsMarketCount').textContent =
        markets.length + ' market' + (markets.length !== 1 ? 's' : '');

    var sk = npsMarketSortKey, asc = npsMarketSortAsc;
    markets.sort(function(a, b) {
        var av = a[sk], bv = b[sk];
        if (av == null) av = -9999; if (bv == null) bv = -9999;
        if (typeof av === 'string') return asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return asc ? av - bv : bv - av;
    });

    document.getElementById('npsMarketBody').innerHTML = markets.map(function(d, i) {
        var rowCls = i % 2 ? 'bg-gray-50' : '';
        return '<tr class="' + rowCls + ' hover:bg-green-50 transition">' +
            '<td class="px-3 py-2 text-sm font-mono font-bold text-[#0ea5e9]">' + d.market + '</td>' +
            '<td class="px-3 py-2 text-sm">' + (d.manager || '--') + '</td>' +
            '<td class="px-3 py-2 text-right font-semibold ' + npsColor(d.market_nps) + '">' + npsFormat(d.market_nps) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.volume || 0) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.stores || 0) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.response_rate != null ? Math.round(d.response_rate) + '%' : '--') + '</td>' +
            '</tr>';
    }).join('');

    panel.classList.remove('hidden');
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ── Full table ──
function sortNpsTable(key) {
    if (npsTableSortKey === key) npsTableSortAsc = !npsTableSortAsc;
    else { npsTableSortKey = key; npsTableSortAsc = key === 'market' || key === 'manager' || key === 'regional'; }
    renderNpsTable();
}

function renderNpsTable() {
    var search = (document.getElementById('npsTableSearch').value || '').toLowerCase();
    var data = npsFilteredOps.slice();
    if (search) {
        data = data.filter(function(d) {
            return d.market.toLowerCase().includes(search) ||
                d.manager.toLowerCase().includes(search) ||
                d.regional.toLowerCase().includes(search);
        });
    }

    var sk = npsTableSortKey, asc = npsTableSortAsc;
    data.sort(function(a, b) {
        var av = a[sk], bv = b[sk];
        if (av == null) av = -9999; if (bv == null) bv = -9999;
        if (typeof av === 'string') return asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return asc ? av - bv : bv - av;
    });

    document.getElementById('npsTableBody').innerHTML = data.map(function(d, i) {
        var rowCls = i % 2 ? 'bg-gray-50' : '';
        return '<tr class="' + rowCls + ' hover:bg-green-50 cursor-pointer transition" ' +
            'onclick="npsMarketSlice=\'' + d.regional.replace(/'/g, "\\'") + '\';renderNpsMarketList()">' +
            '<td class="px-3 py-2 text-sm font-mono font-bold">' + d.market + '</td>' +
            '<td class="px-3 py-2 text-sm">' + (d.manager || '--') + '</td>' +
            '<td class="px-3 py-2 text-sm text-gray-600">' + (d.regional || '--') + '</td>' +
            '<td class="px-3 py-2 text-right ' + npsColor(d.region_nps) + '">' + npsFormat(d.region_nps) + '</td>' +
            '<td class="px-3 py-2 text-right font-semibold ' + npsColor(d.market_nps) + '">' + npsFormat(d.market_nps) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.volume || 0) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.stores || 0) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.region_participation != null ? Math.round(d.region_participation) + '%' : '--') + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.response_rate != null ? Math.round(d.response_rate) + '%' : '--') + '</td>' +
            '</tr>';
    }).join('');

    document.getElementById('npsTableShowing').textContent =
        'Showing ' + data.length + ' of ' + npsFilteredOps.length + ' markets';
}

// ── Insights ──
function renderNpsInsights() {
    var ops = npsFilteredOps;
    // Best/worst markets
    var scored = ops.filter(function(d) { return d.market_nps != null; });
    scored.sort(function(a, b) { return (a.market_nps || 0) - (b.market_nps || 0); });

    var worst = scored.slice(0, 5);
    var best = scored.slice(-5).reverse();

    // Low participation
    var lowPart = ops.filter(function(d) { return d.response_rate != null && d.response_rate < 20; });

    var html = '';
    html += '<p><strong>\u2B50 Top 5 Markets:</strong> ';
    html += best.map(function(d) { return 'Mkt ' + d.market + ' (' + npsFormat(d.market_nps) + ')'; }).join(', ');
    html += '</p>';
    html += '<p><strong>\u26A0\uFE0F Bottom 5 Markets:</strong> ';
    html += worst.map(function(d) { return 'Mkt ' + d.market + ' (' + npsFormat(d.market_nps) + ')'; }).join(', ');
    html += '</p>';
    if (lowPart.length > 0) {
        html += '<p><strong>\u{1F4C9} Low Participation (&lt;20%):</strong> ' +
            lowPart.length + ' markets have very low survey response rates, which may skew NPS results. ' +
            'Focus on improving participation in these areas for more reliable data.</p>';
    }

    // Region analysis
    var regionBuckets = {};
    NPS_REGION.forEach(function(d) {
        if (!regionBuckets[d.bucket]) regionBuckets[d.bucket] = 0;
        regionBuckets[d.bucket]++;
    });
    html += '<p><strong>\u{1F30D} Region Distribution:</strong> ';
    html += Object.keys(regionBuckets).sort().reverse().map(function(b) {
        return regionBuckets[b] + ' regions in ' + b + ' range';
    }).join(', ') + '.</p>';

    // Overall assessment
    var totalVol = 0, totalWeighted = 0;
    ops.forEach(function(d) {
        if (d.market_nps != null && d.volume) { totalWeighted += d.market_nps * d.volume; totalVol += d.volume; }
    });
    var overall = totalVol > 0 ? Math.round(totalWeighted / totalVol) : null;
    if (overall != null) {
        html += '<p><strong>\u{1F4CA} Executive Summary:</strong> Overall weighted NPS is <strong>' + overall + '</strong>. ';
        if (overall >= 90) html += 'Excellent — stores report very high satisfaction with Facilities Services.';
        else if (overall >= 80) html += 'Good — most stores are satisfied but there are improvement opportunities.';
        else if (overall >= 70) html += 'Moderate — notable dissatisfaction in some areas requiring attention.';
        else html += 'Needs improvement — consider root cause analysis on low-scoring regions.';
        html += '</p>';
    }

    document.getElementById('npsInsights').innerHTML = html;
}

// ── Distribution Drill-down Panel ──
function clearNpsDistDrill() {
    npsDistDrillSlice = null;
    var panel = document.getElementById('npsDistDrillPanel');
    if (panel) panel.classList.add('hidden');
}

function sortNpsDistDrill(key) {
    if (npsDistDrillSortKey === key) npsDistDrillSortAsc = !npsDistDrillSortAsc;
    else { npsDistDrillSortKey = key; npsDistDrillSortAsc = key === 'market' || key === 'manager' || key === 'regional'; }
    renderNpsDistDrill();
}

function renderNpsDistDrill() {
    var panel = document.getElementById('npsDistDrillPanel');
    if (!panel || !npsDistDrillSlice) { if (panel) panel.classList.add('hidden'); return; }

    var data = npsFilteredOps.filter(npsDistDrillSlice.filterFn);
    document.getElementById('npsDistDrillTitle').textContent = npsDistDrillSlice.label;

    var search = (document.getElementById('npsDistDrillSearch').value || '').toLowerCase();
    if (search) {
        data = data.filter(function(d) {
            return d.market.toLowerCase().includes(search) ||
                d.manager.toLowerCase().includes(search) ||
                d.regional.toLowerCase().includes(search);
        });
    }

    document.getElementById('npsDistDrillCount').textContent =
        data.length + ' market' + (data.length !== 1 ? 's' : '');

    var sk = npsDistDrillSortKey, asc = npsDistDrillSortAsc;
    data.sort(function(a, b) {
        var av = a[sk], bv = b[sk];
        if (av == null) av = -9999; if (bv == null) bv = -9999;
        if (typeof av === 'string') return asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return asc ? av - bv : bv - av;
    });

    document.getElementById('npsDistDrillBody').innerHTML = data.map(function(d, i) {
        var rowCls = i % 2 ? 'bg-gray-50' : '';
        return '<tr class="' + rowCls + ' hover:bg-green-50 cursor-pointer transition" ' +
            'onclick="npsMarketSlice=\'' + d.regional.replace(/'/g, "\\'") + '\';renderNpsMarketList()">' +
            '<td class="px-3 py-2 text-sm font-mono font-bold text-[#0ea5e9]">' + d.market + '</td>' +
            '<td class="px-3 py-2 text-sm">' + (d.manager || '--') + '</td>' +
            '<td class="px-3 py-2 text-sm text-gray-600">' + (d.regional || '--') + '</td>' +
            '<td class="px-3 py-2 text-right font-semibold ' + npsColor(d.market_nps) + '">' + npsFormat(d.market_nps) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.volume || 0) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.stores || 0) + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.response_rate != null ? Math.round(d.response_rate) + '%' : '--') + '</td>' +
            '<td class="px-3 py-2 text-right">' + (d.region_participation != null ? Math.round(d.region_participation) + '%' : '--') + '</td>' +
            '</tr>';
    }).join('');

    panel.classList.remove('hidden');
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// ── Main entry ──
function renderNpsTab() {
    if (typeof NPS_FS === 'undefined' || typeof NPS_OPS === 'undefined') return;
    ensureNpsLookups();
    npsFilteredOps = getFilteredNpsOps();
    populateNpsFilters();
    renderNpsHeader();
    renderNpsSrCards();
    renderNpsRegionalChart();
    renderNpsRegionBucketChart();
    renderNpsDistChart();
    renderNpsParticipationChart();
    renderNpsTable();
    renderNpsInsights();
    npsInitialized = true;
}
</script>

<script>
// ── Goals Tab Logic ──
var goalsCharts = {};
var goalsInitialized = false;

// Goals config — injected from report_config.json at build time
var GOALS_CONFIG = {"fy24": {"total_loss": 808, "markdown": 496}, "fy25": {"total_loss": 640, "markdown": 361}, "fy26": {"total_loss_ytd": 555, "total_loss_proj": 620, "markdown_ytd": 313, "markdown_proj": 350, "sup_per_store": 157}, "fy27": {"total_loss": 585, "markdown": 330, "sup_per_store": 149}, "health": {"rack_weight": 0.4, "tnt_weight": 0.3, "dp_weight": 0.3, "tnt_tolerance": 52, "tnt_buffer": 5, "target_score": 90.0}, "composite_rank": {"tnt_weight": 0.25, "hvac_weight": 0.15, "dewpoint_weight": 0.15, "rack_weight": 0.15, "pm_weight": 0.1, "loss_weight": 0.1, "wtw_weight": 0.1, "dewpoint_target": 52, "loss_normalization": 500000}};
var GOALS = {
    fy24: GOALS_CONFIG.fy24,
    fy25: GOALS_CONFIG.fy25,
    fy26: GOALS_CONFIG.fy26,
    fy27: GOALS_CONFIG.fy27,
    health: GOALS_CONFIG.health
};

// Inline Chart.js plugin to show data labels on bars
var goalsLabelPlugin = {
    id: 'goalsLabels',
    afterDatasetsDraw: function(chart) {
        var ctx = chart.ctx;
        chart.data.datasets.forEach(function(ds, dsi) {
            var meta = chart.getDatasetMeta(dsi);
            meta.data.forEach(function(bar, i) {
                var val = ds.data[i];
                if (val == null || val === 0) return;
                ctx.save();
                ctx.font = 'bold 12px sans-serif';
                ctx.fillStyle = '#374151';
                ctx.textAlign = 'center';
                var label = ds._labelFormat ? ds._labelFormat(val) : val;
                ctx.fillText(label, bar.x, bar.y - 6);
                ctx.restore();
            });
        });
    }
};

function goalsChartUpdate(id, cfg) {
    if (goalsCharts[id]) goalsCharts[id].destroy();
    goalsCharts[id] = new Chart(document.getElementById(id), cfg);
}

function goalsColor(actual, target, lower) {
    if (actual == null) return '#9ca3af';
    if (lower) return actual <= target ? '#2a8703' : actual <= target * 1.05 ? '#fbbf24' : '#ea1100';
    return actual >= target ? '#2a8703' : actual >= target * 0.95 ? '#fbbf24' : '#ea1100';
}

function goalsStatusBadge(actual, target, lower) {
    if (actual == null) return '<span class="text-xs text-gray-400">—</span>';
    var on;
    if (lower) on = actual <= target;
    else on = actual >= target;
    if (on) return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">\u2705 On Track</span>';
    var close;
    if (lower) close = actual <= target * 1.05;
    else close = actual >= target * 0.95;
    if (close) return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">\u26A0\uFE0F Close</span>';
    return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">\u274C Behind</span>';
}

// ── Filtering ──
function getGoalsFilteredStores() {
    var ops = document.getElementById('gOps').value;
    var sr = document.getElementById('gSr').value;
    var dir = document.getElementById('gDir').value;
    var rm = document.getElementById('gRm').value;
    var fsm = document.getElementById('gFsm').value;
    var mkt = document.getElementById('gMkt').value;
    return STORES.filter(function(s) {
        if (!s.bn) return false;
        if (ops && s.ops !== ops) return false;
        if (!_matchField(s.sr, sr)) return false;
        if (!_matchField(s.dir, dir)) return false;
        if (!_matchField(s.rm, rm)) return false;
        if (!_matchField(s.fsm, fsm)) return false;
        if (mkt && s.mkt !== mkt) return false;
        return true;
    });
}

function populateGoalsFilter(id, values) {
    var sel = document.getElementById(id);
    var cur = sel.value;
    var opts = [];
    var seen = {};
    values.forEach(function(v) {
        var nv = (v && v.indexOf('Unassigned') === 0) ? 'Unassigned' : v;
        if (nv && !seen[nv]) { seen[nv] = true; opts.push(nv); }
    });
    opts.sort();
    var firstLabel = sel.options.length > 0 ? sel.options[0].text : 'All';
    sel.innerHTML = '<option value="">' + firstLabel + '</option>' +
        opts.map(function(v) { return '<option value="' + v + '"' + (v === cur ? ' selected' : '') + '>' + v + '</option>'; }).join('');
    if (cur && !opts.includes(cur)) sel.value = '';
}

function cascadeGoalsFilters() {
    var f = getGoalsFilteredStores();
    populateGoalsFilter('gOps', f.map(function(s) { return s.ops; }));
    populateGoalsFilter('gSr', f.map(function(s) { return s.sr; }));
    populateGoalsFilter('gDir', f.map(function(s) { return s.dir; }));
    populateGoalsFilter('gRm', f.map(function(s) { return s.rm; }));
    populateGoalsFilter('gFsm', f.map(function(s) { return s.fsm; }));
    populateGoalsFilter('gMkt', f.map(function(s) { return s.mkt; }));
    // Filter label
    var parts = [];
    var ops = document.getElementById('gOps').value;
    var sr = document.getElementById('gSr').value;
    var dir = document.getElementById('gDir').value;
    var rm = document.getElementById('gRm').value;
    var fsm = document.getElementById('gFsm').value;
    var mkt = document.getElementById('gMkt').value;
    if (ops) parts.push('Ops ' + ops);
    if (sr) parts.push(sr);
    if (dir) parts.push(dir);
    if (rm) parts.push(rm);
    if (fsm) parts.push(fsm);
    if (mkt) parts.push('Mkt ' + mkt);
    document.getElementById('goalsFilterLabel').textContent =
        parts.length ? 'Showing: ' + parts.join(' \u203A ') + ' (' + f.length + ' stores)' : '';
}

function applyGoalsFilters() {
    cascadeGoalsFilters();
    var live = getGoalsLive();
    renderGoalsHeader(live);
    renderGoalsHealth(live);
    renderGoalsLossChart(live);
    renderGoalsMarkdownChart();
    renderGoalsSupChart(live);
    renderGoalsYoyChart();
    renderGoalsSummary(live);
    renderGoalsHealthDist(live);
    renderGoalsInsights(live);
}

function clearGoalsFilters() {
    ['gOps','gSr','gDir','gRm','gFsm','gMkt'].forEach(function(id) {
        document.getElementById(id).value = '';
    });
    nameSearchClear('g');
    applyGoalsFilters();
}

registerNameSearch('g', {
    orgIds: [
        { key: 'sr', filterId: 'gSr', label: 'Sr. Director' },
        { key: 'dir', filterId: 'gDir', label: 'FM Director' },
        { key: 'rm', filterId: 'gRm', label: 'Regional Manager' },
        { key: 'fsm', filterId: 'gFsm', label: 'FS Manager' },
    ],
    applyFn: 'applyGoalsFilters'
});

// ── Compute live FY26 metrics from STORES ──
function getGoalsLive() {
    var stores = getGoalsFilteredStores();
    var losses = [], tnts = [], hvacs = [], dps = [], racks = [];
    stores.forEach(function(s) {
        if (s.loss != null) losses.push(+s.loss);
        if (s.tnt != null) tnts.push(+s.tnt);
        if (s.hvac != null) hvacs.push(+s.hvac);
        if (s.dp != null) dps.push(+s.dp);
        if (s.rack != null) racks.push(+s.rack);
    });
    var sum = function(arr) { return arr.reduce(function(a, b) { return a + b; }, 0); };
    var avg = function(arr) { return arr.length ? sum(arr) / arr.length : null; };

    var totalLoss = losses.length ? sum(losses) / 1e6 : null;
    var avgTnt = avg(tnts);
    var avgHvac = avg(hvacs);
    var avgDp = avg(dps);
    var avgRack = avg(racks);
    var supPerStore = losses.length ? sum(losses) / losses.length / 1e3 : null;

    // Health score: dp_tnt = % of stores with dewpoint <= 52
    var dpInTarget = dps.filter(function(d) { return d <= GOALS.health.tnt_tolerance; }).length;
    var dpTntPct = dps.length ? (dpInTarget / dps.length) * 100 : null;

    return {
        totalLoss: totalLoss, avgTnt: avgTnt, avgHvac: avgHvac,
        avgDp: avgDp, avgRack: avgRack, supPerStore: supPerStore,
        dpTntPct: dpTntPct, storeCount: losses.length
    };
}

// ── Header KPIs ──
function renderGoalsHeader(live) {
    document.getElementById('goalsCurrLoss').textContent =
        live.totalLoss != null ? '$' + live.totalLoss.toFixed(0) + 'M' : '--';
    document.getElementById('goalsCurrTnt').textContent =
        live.avgTnt != null ? live.avgTnt.toFixed(1) + '%' : '--';
    document.getElementById('goalsCurrDp').textContent =
        live.avgDp != null ? live.avgDp.toFixed(1) + '\u00B0' : '--';
    document.getElementById('goalsCurrHvac').textContent =
        live.avgHvac != null ? live.avgHvac.toFixed(1) + '%' : '--';
}

// ── Health Scoring Bars ──
function renderGoalsHealth(live) {
    // Rack Health
    var rackPct = live.avgRack != null ? live.avgRack.toFixed(1) : '--';
    document.getElementById('goalsRackPct').textContent = rackPct + '%';
    var rackBar = document.getElementById('goalsRackBar');
    rackBar.style.width = (live.avgRack || 0) + '%';
    rackBar.style.backgroundColor = goalsColor(live.avgRack, 85, false);

    // TnT
    var tntPct = live.avgTnt != null ? live.avgTnt.toFixed(1) : '--';
    document.getElementById('goalsTntPct').textContent = tntPct + '%';
    var tntBar = document.getElementById('goalsTntBar');
    tntBar.style.width = (live.avgTnt || 0) + '%';
    tntBar.style.backgroundColor = goalsColor(live.avgTnt, GOALS.health.target_score, false);

    // Dewpoint TnT
    var dpPct = live.dpTntPct != null ? live.dpTntPct.toFixed(1) : '--';
    document.getElementById('goalsDpPct').textContent = dpPct + '%';
    var dpBar = document.getElementById('goalsDpBar');
    dpBar.style.width = (live.dpTntPct || 0) + '%';
    dpBar.style.backgroundColor = goalsColor(live.dpTntPct, GOALS.health.target_score, false);

    // Composite
    var composite = null;
    if (live.avgRack != null && live.avgTnt != null && live.dpTntPct != null) {
        composite = (live.avgRack * GOALS.health.rack_weight) + (live.avgTnt * GOALS.health.tnt_weight) + (live.dpTntPct * GOALS.health.dp_weight);
    }
    var compEl = document.getElementById('goalsComposite');
    compEl.textContent = composite != null ? composite.toFixed(1) : '--';
    compEl.style.color = goalsColor(composite, GOALS.health.target_score, false);
}

// ── Product Loss Chart ──
function renderGoalsLossChart(live) {
    var labels = ['FY24', 'FY25', 'FY26 YTD', 'FY26 Proj*', 'FY27 Goal'];
    var actuals = [GOALS.fy24.total_loss, GOALS.fy25.total_loss, live.totalLoss ? Math.round(live.totalLoss) : GOALS.fy26.total_loss_ytd, GOALS.fy26.total_loss_proj, null];
    var goals = [null, null, null, null, GOALS.fy27.total_loss];
    goalsChartUpdate('goalsLossChart', {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Actual/Projected', data: actuals, backgroundColor: ['#6b7280','#6b7280','#0ea5e9','#93c5fd','transparent'], borderRadius: 4, _labelFormat: function(v) { return '$' + v + 'M'; } },
                { label: 'FY27 Goal', data: goals, backgroundColor: ['transparent','transparent','transparent','transparent','#2a8703'], borderRadius: 4, _labelFormat: function(v) { return '$' + v + 'M'; } }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' },
                goalsLabels: {}
            },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Total Loss ($M)' } } }
        },
        plugins: [goalsLabelPlugin]
    });
}

// ── Markdown Chart ──
function renderGoalsMarkdownChart() {
    var labels = ['FY24', 'FY25', 'FY26 YTD', 'FY26 Proj*', 'FY27 Goal'];
    var actuals = [GOALS.fy24.markdown, GOALS.fy25.markdown, GOALS.fy26.markdown_ytd, GOALS.fy26.markdown_proj, null];
    var goals = [null, null, null, null, GOALS.fy27.markdown];
    goalsChartUpdate('goalsMarkdownChart', {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Actual/Projected', data: actuals, backgroundColor: ['#6b7280','#6b7280','#0ea5e9','#93c5fd','transparent'], borderRadius: 4, _labelFormat: function(v) { return '$' + v + 'M'; } },
                { label: 'FY27 Goal', data: goals, backgroundColor: ['transparent','transparent','transparent','transparent','#2a8703'], borderRadius: 4, _labelFormat: function(v) { return '$' + v + 'M'; } }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' },
                goalsLabels: {}
            },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Markdown ($M)' } } }
        },
        plugins: [goalsLabelPlugin]
    });
}

// ── SUP Chart ──
function renderGoalsSupChart(live) {
    var fy24Sup = GOALS.fy24.total_loss * 1000 / 4600; // approx stores
    var fy25Sup = GOALS.fy25.total_loss * 1000 / 4600;
    var currSup = live.supPerStore || GOALS.fy26.sup_per_store;
    goalsChartUpdate('goalsSupChart', {
        type: 'bar',
        data: {
            labels: ['FY24', 'FY25', 'FY26 Current', 'FY26 Target', 'FY27 Goal'],
            datasets: [{
                label: 'Loss Per Store ($k)',
                data: [Math.round(fy24Sup), Math.round(fy25Sup), Math.round(currSup), GOALS.fy26.sup_per_store, GOALS.fy27.sup_per_store],
                backgroundColor: ['#6b7280', '#6b7280', '#0ea5e9', '#93c5fd', '#2a8703'],
                borderRadius: 4,
                _labelFormat: function(v) { return '$' + v + 'k'; }
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, goalsLabels: {} },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'Loss Per Store ($k)' } } }
        },
        plugins: [goalsLabelPlugin]
    });
}

// ── YoY Improvement Chart ──
function renderGoalsYoyChart() {
    var G = GOALS;
    var fy24to25 = ((G.fy24.total_loss - G.fy25.total_loss) / G.fy24.total_loss * 100);
    var fy25to26 = ((G.fy25.total_loss - G.fy26.total_loss_proj) / G.fy25.total_loss * 100);
    var fy26to27 = ((G.fy26.total_loss_proj - G.fy27.total_loss) / G.fy26.total_loss_proj * 100);
    goalsChartUpdate('goalsYoyChart', {
        type: 'bar',
        data: {
            labels: ['FY24\u2192FY25', 'FY25\u2192FY26*', 'FY26\u2192FY27 Goal'],
            datasets: [{
                label: '% Reduction in Total Loss',
                data: [Math.round(fy24to25 * 10) / 10, Math.round(fy25to26 * 10) / 10, Math.round(fy26to27 * 10) / 10],
                backgroundColor: ['#2a8703', '#86bc25', '#0ea5e9'],
                borderRadius: 4,
                _labelFormat: function(v) { return v.toFixed(1) + '%'; }
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, goalsLabels: {} },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'YoY Reduction (%)' } } }
        },
        plugins: [goalsLabelPlugin]
    });
}

// ── Summary Table ──
function renderGoalsSummary(live) {
    var G = GOALS;
    var fy24SupK = Math.round(G.fy24.total_loss * 1000 / 4600);
    var fy25SupK = Math.round(G.fy25.total_loss * 1000 / 4600);
    var lossGap = G.fy26.total_loss_proj - G.fy27.total_loss;
    var mdGap = G.fy26.markdown_proj - G.fy27.markdown;
    var supGap = G.fy26.sup_per_store - G.fy27.sup_per_store;
    var rows = [
        { metric: 'Total Product Loss',
          fy24: '$' + G.fy24.total_loss + 'M', fy25: '$' + G.fy25.total_loss + 'M',
          fy26ytd: '$' + (live.totalLoss ? Math.round(live.totalLoss) : G.fy26.total_loss_ytd) + 'M',
          fy26proj: '$' + G.fy26.total_loss_proj + 'M*', fy27: '$' + G.fy27.total_loss + 'M',
          gap: '$' + lossGap + 'M \u2193', status: goalsStatusBadge(G.fy26.total_loss_proj, G.fy27.total_loss, true) },
        { metric: 'Markdown Loss',
          fy24: '$' + G.fy24.markdown + 'M', fy25: '$' + G.fy25.markdown + 'M',
          fy26ytd: '$' + G.fy26.markdown_ytd + 'M', fy26proj: '$' + G.fy26.markdown_proj + 'M*', fy27: '$' + G.fy27.markdown + 'M',
          gap: '$' + mdGap + 'M \u2193', status: goalsStatusBadge(G.fy26.markdown_proj, G.fy27.markdown, true) },
        { metric: 'SUP (Loss/Store)',
          fy24: '$' + fy24SupK + 'k', fy25: '$' + fy25SupK + 'k',
          fy26ytd: '$' + (live.supPerStore ? Math.round(live.supPerStore) : G.fy26.sup_per_store) + 'k',
          fy26proj: '$' + G.fy26.sup_per_store + 'k', fy27: '$' + G.fy27.sup_per_store + 'k',
          gap: '$' + supGap + 'k \u2193', status: goalsStatusBadge(G.fy26.sup_per_store, G.fy27.sup_per_store, true) },
        { metric: 'Ref Time in Target', fy24: '--', fy25: '--',
          fy26ytd: live.avgTnt ? live.avgTnt.toFixed(1) + '%' : '--',
          fy26proj: '--', fy27: '\u2265' + G.health.target_score + '%',
          gap: live.avgTnt ? (G.health.target_score - live.avgTnt).toFixed(1) + 'pp' : '--',
          status: goalsStatusBadge(live.avgTnt, G.health.target_score, false) },
        { metric: 'HVAC TnT (AHU)', fy24: '--', fy25: '--',
          fy26ytd: live.avgHvac ? live.avgHvac.toFixed(1) + '%' : '--',
          fy26proj: '--', fy27: '\u2265' + G.health.target_score + '%',
          gap: live.avgHvac ? (live.avgHvac >= G.health.target_score ? '\u2705' : (G.health.target_score - live.avgHvac).toFixed(1) + 'pp') : '--',
          status: goalsStatusBadge(live.avgHvac, G.health.target_score, false) },
        { metric: 'Avg Dewpoint', fy24: '--', fy25: '--',
          fy26ytd: live.avgDp ? live.avgDp.toFixed(1) + '\u00B0' : '--',
          fy26proj: '--', fy27: '\u2264' + G.health.tnt_tolerance + '\u00B0',
          gap: live.avgDp ? (live.avgDp - G.health.tnt_tolerance).toFixed(1) + '\u00B0' : '--',
          status: goalsStatusBadge(live.avgDp, G.health.tnt_tolerance, true) },
        { metric: 'Composite Health', fy24: '--', fy25: '--',
          fy26ytd: document.getElementById('goalsComposite').textContent,
          fy26proj: '--', fy27: '\u2265' + G.health.target_score,
          gap: '--',
          status: goalsStatusBadge(parseFloat(document.getElementById('goalsComposite').textContent) || null, G.health.target_score, false) }
    ];

    document.getElementById('goalsSummaryBody').innerHTML = rows.map(function(r, i) {
        var cls = i % 2 ? 'bg-gray-50' : '';
        return '<tr class="' + cls + '">' +
            '<td class="px-4 py-3 text-sm font-semibold text-gray-800">' + r.metric + '</td>' +
            '<td class="px-4 py-3 text-right text-sm text-gray-600">' + r.fy24 + '</td>' +
            '<td class="px-4 py-3 text-right text-sm text-gray-600">' + r.fy25 + '</td>' +
            '<td class="px-4 py-3 text-right text-sm font-semibold text-[#0ea5e9]">' + r.fy26ytd + '</td>' +
            '<td class="px-4 py-3 text-right text-sm text-gray-500 italic">' + r.fy26proj + '</td>' +
            '<td class="px-4 py-3 text-right text-sm font-bold text-[#0ea5e9]">' + r.fy27 + '</td>' +
            '<td class="px-4 py-3 text-right text-sm text-gray-600">' + r.gap + '</td>' +
            '<td class="px-4 py-3 text-center">' + r.status + '</td>' +
            '</tr>';
    }).join('');
}

// ── Health Score Distribution ──
function renderGoalsHealthDist(live) {
    var buckets = { '\u226595': 0, '90-94': 0, '85-89': 0, '80-84': 0, '<80': 0 };
    getGoalsFilteredStores().forEach(function(s) {
        if (s.tnt == null && s.hvac == null) return;
        var rack = s.rack != null ? +s.rack : 85;
        var tnt = s.tnt != null ? +s.tnt : 85;
        var dpTnt = (s.dp != null && +s.dp <= GOALS.health.tnt_tolerance) ? 100 : (s.dp != null ? 0 : 85);
        var score = rack * GOALS.health.rack_weight + tnt * GOALS.health.tnt_weight + dpTnt * GOALS.health.dp_weight;
        if (score >= 95) buckets['\u226595']++;
        else if (score >= 90) buckets['90-94']++;
        else if (score >= 85) buckets['85-89']++;
        else if (score >= 80) buckets['80-84']++;
        else buckets['<80']++;
    });
    goalsChartUpdate('goalsHealthDistChart', {
        type: 'bar',
        data: {
            labels: Object.keys(buckets),
            datasets: [{
                data: Object.values(buckets),
                backgroundColor: ['#2a8703', '#86bc25', '#fbbf24', '#ff8200', '#ea1100'],
                borderRadius: 4
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, goalsLabels: {} },
            scales: { y: { beginAtZero: true, title: { display: true, text: '# Stores' } } }
        },
        plugins: [goalsLabelPlugin]
    });
}

// ── Insights ──
function renderGoalsInsights(live) {
    var G = GOALS;
    var html = '';
    var lossReduction24to25 = ((G.fy24.total_loss - G.fy25.total_loss) / G.fy24.total_loss * 100).toFixed(1);
    var lossReduction25to26 = ((G.fy25.total_loss - G.fy26.total_loss_proj) / G.fy25.total_loss * 100).toFixed(1);
    var neededReduction = ((G.fy26.total_loss_proj - G.fy27.total_loss) / G.fy26.total_loss_proj * 100).toFixed(1);
    var lossGapM = G.fy26.total_loss_proj - G.fy27.total_loss;
    html += '<p><strong>\u{1F4C9} Loss Trajectory:</strong> Total loss dropped ' + lossReduction24to25 +
        '% from FY24\u2192FY25 and is projected to drop ' + lossReduction25to26 +
        '% from FY25\u2192FY26. To hit the FY27 goal of $' + G.fy27.total_loss + 'M, a further <strong>' +
        neededReduction + '% reduction</strong> ($' + lossGapM + 'M) is needed.</p>';

    var mdReduction = ((G.fy24.markdown - G.fy25.markdown) / G.fy24.markdown * 100).toFixed(0);
    var mdGap = G.fy26.markdown_proj - G.fy27.markdown;
    html += '<p><strong>\u{1F4CB} Markdown:</strong> Markdown fell from $' + G.fy24.markdown + 'M (FY24) to $' + G.fy25.markdown + 'M (FY25) \u2014 a ' + mdReduction + '% reduction. ' +
        'FY26 is projected at $' + G.fy26.markdown_proj + 'M. The FY27 target of $' + G.fy27.markdown + 'M requires an additional $' + mdGap + 'M reduction.</p>';

    if (live.supPerStore != null) {
        var supStatus = live.supPerStore <= G.fy27.sup_per_store ? 'on track' : live.supPerStore <= G.fy26.sup_per_store ? 'within FY26 range' : 'above target';
        html += '<p><strong>\u{1F3EA} SUP (Loss/Store):</strong> Current YTD avg is <strong>$' +
            Math.round(live.supPerStore) + 'k</strong> per store (' + supStatus +
            '). FY27 goal is $' + G.fy27.sup_per_store + 'k (down from FY26 target of $' + G.fy26.sup_per_store + 'k).</p>';
    }

    // Health score
    var composite = document.getElementById('goalsComposite').textContent;
    if (composite !== '--') {
        var c = parseFloat(composite);
        var tgt = G.health.target_score;
        if (c >= tgt) {
            html += '<p><strong>\u2705 Health Score:</strong> Composite score of <strong>' + composite +
                '</strong> meets the FY27 target of ' + tgt + '. Continue maintaining current performance.</p>';
        } else {
            var gap = (tgt - c).toFixed(1);
            html += '<p><strong>\u26A0\uFE0F Health Score:</strong> Composite score of <strong>' + composite +
                '</strong> is <strong>' + gap + ' points below</strong> the FY27 target of ' + tgt + '. Focus on ' +
                (live.avgTnt < tgt ? 'improving Ref TnT' : '') +
                (live.avgTnt < tgt && live.dpTntPct < tgt ? ' and ' : '') +
                (live.dpTntPct < tgt ? 'dewpoint compliance' : '') + '.</p>';
        }
    }

    if (live.avgTnt != null) {
        var tgt = G.health.target_score;
        html += '<p><strong>\u{1F321}\uFE0F Ref TnT:</strong> Currently at <strong>' + live.avgTnt.toFixed(1) +
            '%</strong>. ' + (live.avgTnt >= tgt ? 'Meeting the \u2265' + tgt + '% target. \u2705' :
            'Need to improve by ' + (tgt - live.avgTnt).toFixed(1) + 'pp to reach \u2265' + tgt + '%.') + '</p>';
    }

    if (live.avgDp != null) {
        var tol = G.health.tnt_tolerance;
        html += '<p><strong>\u{1F4A7} Dewpoint:</strong> Fleet average is <strong>' + live.avgDp.toFixed(1) +
            '\u00B0</strong>. ' + (live.avgDp <= tol ? 'Within the ' + tol + '\u00B0 tolerance. \u2705' :
            'Above the ' + tol + '\u00B0 target by ' + (live.avgDp - tol).toFixed(1) + '\u00B0 \u2014 AHU optimization needed.') + '</p>';
    }

    document.getElementById('goalsInsights').innerHTML = html;
}

// ── Main entry ──
function renderGoalsTab() {
    if (!goalsInitialized) {
        cascadeGoalsFilters();
    }
    var live = getGoalsLive();
    renderGoalsHeader(live);
    renderGoalsHealth(live);
    renderGoalsLossChart(live);
    renderGoalsMarkdownChart();
    renderGoalsSupChart(live);
    renderGoalsYoyChart();
    renderGoalsSummary(live);
    renderGoalsHealthDist(live);
    renderGoalsInsights(live);
    goalsInitialized = true;
}
</script>

<script>
// ═══════════ Active Projects Tab JS ═══════════
var ACTIVE_PROJECTS = []; // loaded from data/active_projects.json
var PROJECTS = ACTIVE_PROJECTS;
var pjFiltered = PROJECTS;
var pjSort = { key: 'sn', asc: true };
var pjPage = 0;
var PJ_PAGE_SIZE = 50;

// ── Helpers ──
function _pjFmt$(v) {
    if (v == null) return '—';
    var n = Number(v);
    if (isNaN(n)) return '—';
    if (Math.abs(n) >= 1e6) return '$' + (n / 1e6).toFixed(1) + 'M';
    if (Math.abs(n) >= 1e3) return '$' + (n / 1e3).toFixed(0) + 'K';
    return '$' + n.toFixed(0);
}

function _pjStatusColor(s) {
    switch (s) {
        case 'Under Construction': return { bg: '#0ea5e9', text: 'white' };
        case 'Starting Soon':      return { bg: '#fbbf24', text: '#1a1a1a' };
        case 'Recently Started':   return { bg: '#2a8703', text: 'white' };
        case 'Active':             return { bg: '#76c043', text: 'white' };
        case 'Closing Soon':       return { bg: '#f57c00', text: 'white' };
        default:                   return { bg: '#9e9e9e', text: 'white' };
    }
}

function _pjBadge(s) {
    var c = _pjStatusColor(s);
    return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" style="background:' + c.bg + ';color:' + c.text + '">' + s + '</span>';
}

// ── Populate filter dropdowns ──
function _pjPopulate(id, values) {
    var sel = document.getElementById(id);
    if (!sel) return;
    var cur = sel.value;
    var firstLabel = sel.options.length > 0 ? sel.options[0].text : 'All';
    var opts = [...new Set(values)].filter(Boolean).sort();
    sel.innerHTML = '<option value="">' + firstLabel + '</option>' +
        opts.map(function(v) { return '<option value="' + v + '"' + (v === cur ? ' selected' : '') + '>' + v + '</option>'; }).join('');
    if (cur && !opts.includes(cur)) sel.value = '';
}

// Build store-to-banner and store-to-org lookups for filtering
var _pjStoreBanner = {};
var _pjStoreSr = {};
var _pjStoreDir = {};
var _pjStoreRm = {};
var _pjStoreFsm = {};
function _pjBuildBannerMap() {
    if (typeof STORES !== 'undefined' && STORES.length && !_pjStoreBanner._built) {
        STORES.forEach(function(s) {
            _pjStoreBanner[s.sn] = s.bn;
            if (s.sr) _pjStoreSr[s.sn] = s.sr;
            if (s.dir) _pjStoreDir[s.sn] = s.dir;
            if (s.rm) _pjStoreRm[s.sn] = s.rm;
            if (s.fsm) _pjStoreFsm[s.sn] = s.fsm;
        });
        _pjStoreBanner._built = true;
    }
}

// Sync paired filter dropdowns (global ↔ inline table)
var _pjLastChanged = {};
function _pjSyncFilter(globalId, inlineId) {
    var g = document.getElementById(globalId);
    var i = document.getElementById(inlineId);
    if (!g || !i) return;
    // Detect which one changed based on focus
    if (document.activeElement === i) {
        g.value = i.value;
        _pjLastChanged[globalId] = 'inline';
    } else if (document.activeElement === g || _pjLastChanged[globalId] !== 'inline') {
        i.value = g.value;
    }
    _pjLastChanged[globalId] = '';
}

// ── Filter ──
function applyProjectFilters() {
    _pjBuildBannerMap();
    // Only filter by banner when a specific banner is selected (not 'all')
    var bannerMode = typeof activeBanner !== 'undefined' ? activeBanner : 'all';
    var banners = (bannerMode !== 'all' && typeof getActiveBanners === 'function') ? getActiveBanners() : null;
    // Sync inline table filters ↔ global filters (whichever changed last wins)
    _pjSyncFilter('pjStatus', 'pjTableStatus');
    _pjSyncFilter('pjType', 'pjTableType');
    var status = document.getElementById('pjStatus').value;
    var type = document.getElementById('pjType').value;
    var state = document.getElementById('pjState').value;
    var fy = document.getElementById('pjFy').value;
    var cat = document.getElementById('pjTableCat') ? document.getElementById('pjTableCat').value : '';
    var search = (document.getElementById('pjSearch').value || document.getElementById('pjTableSearch').value || '').toLowerCase().trim();
    // Org hierarchy filters
    var srVal = document.getElementById('pjSr') ? document.getElementById('pjSr').value : '';
    var dirVal = document.getElementById('pjDir') ? document.getElementById('pjDir').value : '';
    var rmVal = document.getElementById('pjRm') ? document.getElementById('pjRm').value : '';
    var fsmVal = document.getElementById('pjFsm') ? document.getElementById('pjFsm').value : '';

    pjFiltered = PROJECTS.filter(function(p) {
        // Banner filter
        if (banners && _pjStoreBanner[p.sn] && !banners.has(_pjStoreBanner[p.sn])) return false;
        // Org hierarchy filters via store lookups
        if (srVal && _pjStoreSr[p.sn] !== srVal) return false;
        if (dirVal && _pjStoreDir[p.sn] !== dirVal) return false;
        if (rmVal && _pjStoreRm[p.sn] !== rmVal) return false;
        if (fsmVal && _pjStoreFsm[p.sn] !== fsmVal) return false;
        if (status && p.as !== status) return false;
        if (type && p.pt !== type) return false;
        if (cat && p.pc !== cat) return false;
        if (state && p.st !== state) return false;
        if (fy && String(p.fy) !== fy) return false;
        if (search && (p.sn + ' ' + (p.nm || '')).toLowerCase().indexOf(search) === -1) return false;
        return true;
    });

    // Cascade filters
    _pjPopulate('pjSr', pjFiltered.map(function(p) { return _pjStoreSr[p.sn] || ''; }));
    _pjPopulate('pjDir', pjFiltered.map(function(p) { return _pjStoreDir[p.sn] || ''; }));
    _pjPopulate('pjRm', pjFiltered.map(function(p) { return _pjStoreRm[p.sn] || ''; }));
    _pjPopulate('pjFsm', pjFiltered.map(function(p) { return _pjStoreFsm[p.sn] || ''; }));
    _pjPopulate('pjStatus', pjFiltered.map(function(p) { return p.as; }));
    _pjPopulate('pjType', pjFiltered.map(function(p) { return p.pt; }));
    _pjPopulate('pjState', pjFiltered.map(function(p) { return p.st; }));
    _pjPopulate('pjFy', pjFiltered.map(function(p) { return String(p.fy || ''); }));
    // Inline table filters (mirror global)
    _pjPopulate('pjTableType', pjFiltered.map(function(p) { return p.pt; }));
    _pjPopulate('pjTableStatus', pjFiltered.map(function(p) { return p.as; }));
    _pjPopulate('pjTableCat', pjFiltered.map(function(p) { return p.pc || ''; }));

    var label = pjFiltered.length === PROJECTS.length
        ? PROJECTS.length + ' projects'
        : pjFiltered.length + ' of ' + PROJECTS.length + ' projects';
    document.getElementById('pjFilterLabel').textContent = label;

    pjPage = 0;
    renderProjectsContent();
}

function clearProjectFilters() {
    document.getElementById('pjSr').value = '';
    document.getElementById('pjDir').value = '';
    document.getElementById('pjRm').value = '';
    document.getElementById('pjFsm').value = '';
    document.getElementById('pjStatus').value = '';
    document.getElementById('pjType').value = '';
    document.getElementById('pjState').value = '';
    document.getElementById('pjFy').value = '';
    document.getElementById('pjSearch').value = '';
    // Clear inline table filters
    if (document.getElementById('pjTableType')) document.getElementById('pjTableType').value = '';
    if (document.getElementById('pjTableStatus')) document.getElementById('pjTableStatus').value = '';
    if (document.getElementById('pjTableCat')) document.getElementById('pjTableCat').value = '';
    if (document.getElementById('pjTableSearch')) document.getElementById('pjTableSearch').value = '';
    nameSearchClear('pj');
    applyProjectFilters();
}

registerNameSearch('pj', {
    orgIds: [
        { key: 'sr', filterId: 'pjSr', label: 'Sr. Director' },
        { key: 'dir', filterId: 'pjDir', label: 'FM Director' },
        { key: 'rm', filterId: 'pjRm', label: 'Regional Manager' },
        { key: 'fsm', filterId: 'pjFsm', label: 'FS Manager' },
    ],
    applyFn: 'applyProjectFilters'
});

// ── KPI Cards ──
function renderProjectKpis() {
    var d = pjFiltered;
    var statusCounts = {};
    d.forEach(function(p) { statusCounts[p.as] = (statusCounts[p.as] || 0) + 1; });
    var totalBudget = d.reduce(function(a, p) { return a + (Number(p.wbud) || 0); }, 0);
    var totalActuals = d.reduce(function(a, p) { return a + (Number(p.act) || 0); }, 0);
    var uniqueStores = new Set(d.map(function(p) { return p.sn; })).size;

    var cards = [
        { label: 'Total Projects', value: d.length, color: '#0ea5e9' },
        { label: 'Unique Stores', value: uniqueStores, color: '#004c91' },
        { label: 'Under Construction', value: statusCounts['Under Construction'] || 0, color: '#0ea5e9' },
        { label: 'Starting Soon', value: statusCounts['Starting Soon'] || 0, color: '#fbbf24', textColor: '#1a1a1a' },
        { label: 'Working Budget', value: _pjFmt$(totalBudget), color: '#2a8703' },
        { label: 'Actuals', value: _pjFmt$(totalActuals), color: '#f57c00' },
    ];

    document.getElementById('pjKpis').innerHTML = cards.map(function(c) {
        return '<div class="bg-white rounded-lg shadow p-4 border-l-4" style="border-color:' + c.color + '">' +
            '<p class="text-xs text-gray-500">' + c.label + '</p>' +
            '<p class="text-2xl font-bold mt-1" style="color:' + (c.textColor || c.color) + '">' + c.value + '</p></div>';
    }).join('');
}

// ── Charts ──
function renderProjectCharts() {
    // Status donut
    var statusCounts = {};
    var statusOrder = ['Under Construction', 'Starting Soon', 'Recently Started', 'Active', 'Closing Soon'];
    pjFiltered.forEach(function(p) { statusCounts[p.as] = (statusCounts[p.as] || 0) + 1; });
    var sLabels = statusOrder.filter(function(s) { return statusCounts[s]; });
    var sData = sLabels.map(function(s) { return statusCounts[s]; });
    var sColors = sLabels.map(function(s) { return _pjStatusColor(s).bg; });

    _pjChart('pjStatusChart', {
        type: 'doughnut',
        data: { labels: sLabels, datasets: [{ data: sData, backgroundColor: sColors, borderWidth: 2 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { size: 11 } } } } }
    });

    // Type bar
    var typeCounts = {};
    pjFiltered.forEach(function(p) { typeCounts[p.pt] = (typeCounts[p.pt] || 0) + 1; });
    var typeEntries = Object.entries(typeCounts).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 12);
    _pjChart('pjTypeChart', {
        type: 'bar',
        data: { labels: typeEntries.map(function(e) { return e[0]; }),
            datasets: [{ data: typeEntries.map(function(e) { return e[1]; }), backgroundColor: '#0ea5e9', borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true, grid: { display: false } } } }
    });

    // State bar (top 15)
    var stateCounts = {};
    pjFiltered.forEach(function(p) { if (p.st) stateCounts[p.st] = (stateCounts[p.st] || 0) + 1; });
    var stateEntries = Object.entries(stateCounts).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 15);
    _pjChart('pjStateChart', {
        type: 'bar',
        data: { labels: stateEntries.map(function(e) { return e[0]; }),
            datasets: [{ data: stateEntries.map(function(e) { return e[1]; }), backgroundColor: '#004c91', borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { color: '#f0f0f0' } }, x: { grid: { display: false } } } }
    });

    // Duration distribution
    var buckets = [{ l: '< 30d', max: 30 }, { l: '30–60d', max: 60 }, { l: '60–90d', max: 90 },
        { l: '90–180d', max: 180 }, { l: '180–365d', max: 365 }, { l: '365d+', max: 999999 }];
    var durCounts = buckets.map(function() { return 0; });
    pjFiltered.forEach(function(p) {
        var d = p.dur;
        if (d == null || d < 0) return;
        for (var i = 0; i < buckets.length; i++) {
            if (d < buckets[i].max || i === buckets.length - 1) { durCounts[i]++; break; }
        }
    });
    _pjChart('pjDurationChart', {
        type: 'bar',
        data: { labels: buckets.map(function(b) { return b.l; }),
            datasets: [{ data: durCounts, backgroundColor: ['#2a8703', '#76c043', '#fbbf24', '#f57c00', '#ea1100', '#b71c1c'], borderRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, grid: { color: '#f0f0f0' } }, x: { grid: { display: false } } } }
    });
}

var _pjCharts = {};
function _pjChart(id, cfg) {
    if (_pjCharts[id]) _pjCharts[id].destroy();
    _pjCharts[id] = new Chart(document.getElementById(id), cfg);
}

// ── Budget Cards ──
function renderProjectBudget() {
    var d = pjFiltered;
    var totalBudget = d.reduce(function(a, p) { return a + (Number(p.wbud) || 0); }, 0);
    var totalActuals = d.reduce(function(a, p) { return a + (Number(p.act) || 0); }, 0);
    var sapBudget = d.reduce(function(a, p) { return a + (Number(p.bud) || 0); }, 0);
    var pct = totalBudget > 0 ? (totalActuals / totalBudget * 100) : 0;
    var barColor = pct > 100 ? '#ea1100' : pct > 80 ? '#f57c00' : '#2a8703';

    document.getElementById('pjBudgetCards').innerHTML =
        '<div class="text-center p-4 bg-gray-50 rounded-lg">' +
            '<p class="text-xs text-gray-500">SAP Budget</p>' +
            '<p class="text-xl font-bold text-gray-800">' + _pjFmt$(sapBudget) + '</p></div>' +
        '<div class="text-center p-4 bg-gray-50 rounded-lg">' +
            '<p class="text-xs text-gray-500">Working Budget</p>' +
            '<p class="text-xl font-bold text-[#0ea5e9]">' + _pjFmt$(totalBudget) + '</p></div>' +
        '<div class="p-4 bg-gray-50 rounded-lg">' +
            '<p class="text-xs text-gray-500">Actuals vs Working Budget</p>' +
            '<p class="text-xl font-bold" style="color:' + barColor + '">' + _pjFmt$(totalActuals) + ' <span class="text-sm font-normal">(' + pct.toFixed(1) + '%)</span></p>' +
            '<div class="mt-2 w-full bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full" style="width:' + Math.min(pct, 100) + '%;background:' + barColor + '"></div></div></div>';
}

// ── Table ──
function sortProjects(key) {
    if (pjSort.key === key) pjSort.asc = !pjSort.asc;
    else { pjSort.key = key; pjSort.asc = true; }
    renderProjectTable();
}

function renderProjectTable() {
    var data = pjFiltered.slice();
    var k = pjSort.key;
    data.sort(function(a, b) {
        var va = a[k], vb = b[k];
        if (va == null) va = '';
        if (vb == null) vb = '';
        var cmp = typeof va === 'number' ? va - vb : String(va).localeCompare(String(vb));
        return pjSort.asc ? cmp : -cmp;
    });

    var start = pjPage * PJ_PAGE_SIZE;
    var pageData = data.slice(start, start + PJ_PAGE_SIZE);
    var totalPages = Math.ceil(data.length / PJ_PAGE_SIZE);

    document.getElementById('pjTableCount').textContent = data.length + ' projects';
    document.getElementById('pjTableBody').innerHTML = pageData.map(function(p, i) {
        return '<tr class="hover:bg-blue-50 transition">' +
            '<td class="px-3 py-2 font-mono font-bold text-[#0ea5e9]">' + p.sn + '</td>' +
            '<td class="px-3 py-2">' + (p.pt || '') + '</td>' +
            '<td class="px-3 py-2">' + _pjBadge(p.as) + '</td>' +
            '<td class="px-3 py-2 text-gray-600">' + (p.city || '') + (p.st ? ', ' + p.st : '') + '</td>' +
            '<td class="px-3 py-2">' + (p.cst || '—') + '</td>' +
            '<td class="px-3 py-2">' + (p.cco || '—') + '</td>' +
            '<td class="px-3 py-2">' + (p.cer || '—') + '</td>' +
            '<td class="px-3 py-2">' + (p.pos || '—') + '</td>' +
            '<td class="px-3 py-2 text-right">' + (p.dur != null ? p.dur + 'd' : '—') + '</td>' +
            '<td class="px-3 py-2 text-right">' + _pjFmt$(p.wbud) + '</td>' +
            '<td class="px-3 py-2 text-gray-600 truncate max-w-[160px]" title="' + (p.gc || '') + '">' + (p.gc || '—') + '</td>' +
            '<td class="px-3 py-2 text-gray-500">' + (p.pmo || p.ph || '—') + '</td>' +
            '</tr>';
    }).join('');

    // Pagination
    document.getElementById('pjTablePagination').innerHTML = totalPages > 1
        ? '<button onclick="pjPage=Math.max(0,pjPage-1);renderProjectTable()" class="px-3 py-1 border rounded hover:bg-gray-50"' + (pjPage === 0 ? ' disabled' : '') + '>&laquo; Prev</button>' +
          '<span>Page ' + (pjPage + 1) + ' of ' + totalPages + '</span>' +
          '<button onclick="pjPage=Math.min(' + (totalPages - 1) + ',pjPage+1);renderProjectTable()" class="px-3 py-1 border rounded hover:bg-gray-50"' + (pjPage >= totalPages - 1 ? ' disabled' : '') + '>Next &raquo;</button>'
        : '<span>' + data.length + ' projects</span>';
}

// ── Render all ──
function renderProjectsContent() {
    renderProjectKpis();
    renderProjectCharts();
    renderProjectBudget();
    renderProjectTable();
}

function renderProjectsTab() {
    // In split mode, ACTIVE_PROJECTS is populated by async fetch + dict decode
    PROJECTS = (typeof ACTIVE_PROJECTS !== 'undefined' && ACTIVE_PROJECTS.length) ? ACTIVE_PROJECTS : PROJECTS;
    if (!PROJECTS || !PROJECTS.length) { return; }
    // Apply filters (including banner slicer) — this populates pjFiltered and renders everything
    applyProjectFilters();
}
</script>

<!-- KPI Centralized JS -->
<script>
var _kpiCharts = {};
var _kpiCurrentSub = 'overview';
var _kpiFiltered = {};
var _kpiOrg = { srToDirs: {}, dirToRgns: {}, dirToSr: {}, rgnToDir: {} };

// ── Sub-tab switching ──────────────────────────────────────────────────────
function switchKpiSub(sub) {
    var subs = ['overview', 'safety', 'service', 'productivity', 'finance'];
    subs.forEach(function(s) {
        var el = document.getElementById('kpiSubContent-' + s);
        var tab = document.getElementById('kpiSub-' + s);
        if (el) el.classList.toggle('hidden', s !== sub);
        if (tab) {
            tab.className = s === sub
                ? 'border-b-2 border-[#0ea5e9] text-[#0ea5e9] py-3 px-1 text-sm font-medium'
                : 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-3 px-1 text-sm font-medium';
        }
    });
    _kpiCurrentSub = sub;
    renderKpiCurrentSub();
}

// ── Org hierarchy builder ─────────────────────────────────────────────────
function buildKpiOrgHierarchy() {
    _kpiOrg = { srToDirs: {}, dirToRgns: {}, dirToSr: {}, rgnToDir: {} };
    // Count occurrences to determine canonical mapping (majority wins)
    var dirSrCounts = {}; // dir -> { sr: count }
    var rgnDirCounts = {}; // rgn -> { dir: count }
    var sources = [
        KPI_DATA.safety_trir || [],
        KPI_DATA.productivity_tat || [],
        KPI_DATA.service_nps || [],
    ];
    sources.forEach(function(rows) {
        rows.forEach(function(r) {
            var sr = r.sr || '', dir = r.dir || '', rgn = r.rgn || r.sub || '';
            if (sr && dir) {
                if (!dirSrCounts[dir]) dirSrCounts[dir] = {};
                dirSrCounts[dir][sr] = (dirSrCounts[dir][sr] || 0) + 1;
            }
            if (dir && rgn) {
                if (!rgnDirCounts[rgn]) rgnDirCounts[rgn] = {};
                rgnDirCounts[rgn][dir] = (rgnDirCounts[rgn][dir] || 0) + 1;
            }
        });
    });
    // Canonical mapping: pick the Sr with the most rows for each Director
    Object.keys(dirSrCounts).forEach(function(dir) {
        var best = '', bestN = 0;
        Object.keys(dirSrCounts[dir]).forEach(function(sr) {
            if (dirSrCounts[dir][sr] > bestN) { best = sr; bestN = dirSrCounts[dir][sr]; }
        });
        _kpiOrg.dirToSr[dir] = best;
        if (!_kpiOrg.srToDirs[best]) _kpiOrg.srToDirs[best] = new Set();
        _kpiOrg.srToDirs[best].add(dir);
    });
    Object.keys(rgnDirCounts).forEach(function(rgn) {
        var best = '', bestN = 0;
        Object.keys(rgnDirCounts[rgn]).forEach(function(dir) {
            if (rgnDirCounts[rgn][dir] > bestN) { best = dir; bestN = rgnDirCounts[rgn][dir]; }
        });
        _kpiOrg.rgnToDir[rgn] = best;
        if (!_kpiOrg.dirToRgns[best]) _kpiOrg.dirToRgns[best] = new Set();
        _kpiOrg.dirToRgns[best].add(rgn);
    });
}

// ── Cascading Filters (slicer behavior) ───────────────────────────────
function initKpiFilters() {
    if (typeof KPI_DATA === 'undefined' || !KPI_DATA) return;
    buildKpiOrgHierarchy();
    refreshKpiDropdowns();
}

function refreshKpiDropdowns() {
    var f = getKpiFilterValues();

    // Determine valid Sr Directors
    var allSrs = Object.keys(_kpiOrg.srToDirs).sort();

    // Determine valid Directors based on Sr Director selection
    var validDirs;
    if (f.sr && _kpiOrg.srToDirs[f.sr]) {
        validDirs = Array.from(_kpiOrg.srToDirs[f.sr]).sort();
    } else {
        validDirs = Object.keys(_kpiOrg.dirToSr).sort();
    }

    // Determine valid Regions based on Director selection
    var validRgns;
    if (f.dir && _kpiOrg.dirToRgns[f.dir]) {
        validRgns = Array.from(_kpiOrg.dirToRgns[f.dir]).sort();
    } else if (f.sr && _kpiOrg.srToDirs[f.sr]) {
        // All regions under this Sr Director's directors
        var rgnSet = new Set();
        _kpiOrg.srToDirs[f.sr].forEach(function(d) {
            if (_kpiOrg.dirToRgns[d]) _kpiOrg.dirToRgns[d].forEach(function(r) { rgnSet.add(r); });
        });
        validRgns = Array.from(rgnSet).sort();
    } else {
        validRgns = Object.keys(_kpiOrg.rgnToDir).sort();
    }

    fillKpiSelect('kpiFilterSr', allSrs, 'All Sr. Directors');
    fillKpiSelect('kpiFilterDir', validDirs, 'All Directors');
    fillKpiSelect('kpiFilterRgn', validRgns, 'All Regions');
}

function fillKpiSelect(id, values, placeholder) {
    var sel = document.getElementById(id);
    if (!sel) return;
    var cur = sel.value;
    sel.innerHTML = '<option value="">' + placeholder + '</option>';
    values.forEach(function(v) {
        if (v) sel.innerHTML += '<option value="' + v + '"' + (v === cur ? ' selected' : '') + '>' + v + '</option>';
    });
    // If current value is no longer in the list, reset
    if (cur && !values.includes(cur)) sel.value = '';
}

function clearKpiFilters() {
    ['kpiFilterSr', 'kpiFilterDir', 'kpiFilterRgn', 'kpiFilterFy', 'kpiFilterQtr'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.value = (id === 'kpiFilterFy') ? '2026' : '';
    });
    refreshKpiDropdowns();
    syncSubTabGroupBy();
    applyKpiFilters();
}

function syncSubTabGroupBy() {
    var f = getKpiFilterValues();
    // Determine the right drill-down level based on header filters
    // If region selected → already at lowest, group by rgn
    // If director selected → drill to rgn
    // If sr selected → drill to dir
    // If nothing → group by sr (top level)
    var orgLevel;
    if (f.rgn) {
        orgLevel = 'rgn';
    } else if (f.dir) {
        orgLevel = 'rgn';
    } else if (f.sr) {
        orgLevel = 'dir';
    } else {
        orgLevel = 'sr';
    }

    // Sync safety, service, productivity group-by selects
    var safetyEl = document.getElementById('kpiSafetyGroupBy');
    if (safetyEl) safetyEl.value = orgLevel;

    // Service uses 'sub' instead of 'rgn'
    var serviceEl = document.getElementById('kpiServiceGroupBy');
    if (serviceEl) serviceEl.value = orgLevel === 'rgn' ? 'sub' : orgLevel;

    // Productivity uses 'rm' instead of 'rgn'
    var prodEl = document.getElementById('kpiProdGroupBy');
    if (prodEl) prodEl.value = orgLevel === 'rgn' ? 'rm' : orgLevel;

    // Finance: sync by year if FY filter is set, otherwise by gc
    var finEl = document.getElementById('kpiFinGroupBy');
    if (finEl) {
        if (f.fy) finEl.value = 'type';
        // Don't override if user manually changed it
    }
}

function getKpiFilterValues() {
    return {
        sr: (document.getElementById('kpiFilterSr') || {}).value || '',
        dir: (document.getElementById('kpiFilterDir') || {}).value || '',
        rgn: (document.getElementById('kpiFilterRgn') || {}).value || '',
        fy: (document.getElementById('kpiFilterFy') || {}).value || '',
        qtr: (document.getElementById('kpiFilterQtr') || {}).value || '',
    };
}

function onKpiFilterChange(source) {
    var f = getKpiFilterValues();

    // Cascade: Director → auto-set Sr Director
    if (source === 'dir' && f.dir && _kpiOrg.dirToSr[f.dir]) {
        var srEl = document.getElementById('kpiFilterSr');
        if (srEl) srEl.value = _kpiOrg.dirToSr[f.dir];
    }

    // Cascade: Region → auto-set Director → auto-set Sr Director
    if (source === 'rgn' && f.rgn && _kpiOrg.rgnToDir[f.rgn]) {
        var dirEl = document.getElementById('kpiFilterDir');
        var parentDir = _kpiOrg.rgnToDir[f.rgn];
        if (dirEl) dirEl.value = parentDir;
        if (_kpiOrg.dirToSr[parentDir]) {
            var srEl2 = document.getElementById('kpiFilterSr');
            if (srEl2) srEl2.value = _kpiOrg.dirToSr[parentDir];
        }
    }

    // Cascade: Sr Director changed → reset Director & Region if not valid
    if (source === 'sr') {
        var f2 = getKpiFilterValues();
        if (f2.sr && f2.dir && _kpiOrg.dirToSr[f2.dir] !== f2.sr) {
            document.getElementById('kpiFilterDir').value = '';
        }
        if (f2.sr && f2.rgn) {
            // Check if region belongs to any director under this Sr
            var validRgns = new Set();
            if (_kpiOrg.srToDirs[f2.sr]) {
                _kpiOrg.srToDirs[f2.sr].forEach(function(d) {
                    if (_kpiOrg.dirToRgns[d]) _kpiOrg.dirToRgns[d].forEach(function(r) { validRgns.add(r); });
                });
            }
            if (!validRgns.has(f2.rgn)) document.getElementById('kpiFilterRgn').value = '';
        }
    }

    refreshKpiDropdowns();
    syncSubTabGroupBy();
    applyKpiFilters();
}

function onKpiSubGroupByChange(subTab) {
    // Bidirectional: sub-tab group-by changed → update header filters
    var groupByIds = {
        safety: 'kpiSafetyGroupBy',
        service: 'kpiServiceGroupBy',
        productivity: 'kpiProdGroupBy',
        finance: 'kpiFinGroupBy',
    };
    var el = document.getElementById(groupByIds[subTab]);
    if (!el) return;
    var val = el.value;

    // Normalize sub-tab specific field names to org level
    if (val === 'sub') val = 'rgn';
    if (val === 'rm') val = 'rgn';

    // When user picks "By Sr. Director" → clear Director & Region filters
    if (val === 'sr') {
        var dirEl = document.getElementById('kpiFilterDir');
        var rgnEl = document.getElementById('kpiFilterRgn');
        if (dirEl) dirEl.value = '';
        if (rgnEl) rgnEl.value = '';
    }
    // When user picks "By Director" → clear Region filter
    if (val === 'dir') {
        var rgnEl2 = document.getElementById('kpiFilterRgn');
        if (rgnEl2) rgnEl2.value = '';
    }

    // Sync ALL sub-tab group-bys to the same level
    var safetyEl = document.getElementById('kpiSafetyGroupBy');
    var serviceEl = document.getElementById('kpiServiceGroupBy');
    var prodEl = document.getElementById('kpiProdGroupBy');
    if (safetyEl) safetyEl.value = val;
    if (serviceEl) serviceEl.value = val === 'rgn' ? 'sub' : val;
    if (prodEl) prodEl.value = val === 'rgn' ? 'rm' : val;

    refreshKpiDropdowns();
    applyKpiFilters();
}

function applyKpiFilters() {
    if (typeof KPI_DATA === 'undefined' || !KPI_DATA) return;
    var f = getKpiFilterValues();
    var label = [];
    if (f.sr) label.push(f.sr);
    if (f.dir) label.push(f.dir);
    if (f.rgn) label.push('Rgn ' + f.rgn);
    if (f.fy) label.push('FY' + f.fy);
    if (f.qtr) label.push('Q' + f.qtr);
    var el = document.getElementById('kpiFilterLabel');
    if (el) el.textContent = label.length ? 'Showing: ' + label.join(' \u203A ') : '';

    // Build a universal name filter using CANONICAL org hierarchy
    function matchOrg(r) {
        var dir = r.dir || '';
        var rgn = r.rgn || r.sub || '';
        // Use canonical Sr Director from hierarchy, not raw r.sr
        var canonicalSr = dir ? (_kpiOrg.dirToSr[dir] || r.sr || '') : (r.sr || '');
        if (f.sr && canonicalSr !== f.sr) return false;
        if (f.dir && dir !== f.dir) return false;
        if (f.rgn && rgn && rgn !== f.rgn) return false;
        return true;
    }

    // Filter safety
    _kpiFiltered.safety = (KPI_DATA.safety_trir || []).filter(function(r) {
        if (!matchOrg(r)) return false;
        if (f.fy && String(r.yr) !== f.fy) return false;
        return true;
    });
    // Filter NPS
    _kpiFiltered.nps = (KPI_DATA.service_nps || []).filter(function(r) {
        if (!matchOrg(r)) return false;
        if (f.fy && String(r.yr) !== f.fy) return false;
        if (f.qtr && String(r.qtr) !== f.qtr) return false;
        return true;
    });
    // TAT no longer filtered here - computed from STORES in renderer
    _kpiFiltered.tat = [];
    // Filter finance
    _kpiFiltered.finance = (KPI_DATA.finance_projects || []).filter(function(r) {
        if (f.fy && String(r.yr) !== f.fy) return false;
        return true;
    });
    _kpiFiltered.gc = (KPI_DATA.finance_gc || []).filter(function(r) {
        if (f.fy && String(r.yr) !== f.fy) return false;
        if (f.qtr && r.qtr && !r.qtr.includes('Q' + f.qtr)) return false;
        return true;
    });
    _kpiFiltered.monthly = KPI_DATA.safety_monthly || [];

    updateKpiHeader();
    renderKpiCurrentSub();
}

// ── Header KPIs ────────────────────────────────────────────────────────────
function updateKpiHeader() {
    var safety = _kpiFiltered.safety || [];
    var totalHrs = 0, totalInc = 0;
    safety.forEach(function(r) { totalHrs += parseFloat(r.hrs)||0; totalInc += parseInt(r.inc)||0; });
    var trir = totalHrs > 0 ? ((totalInc * 200000) / totalHrs).toFixed(1) : '--';
    setText('kpiOverallTrir', trir);

    var nps = _kpiFiltered.nps || [];
    var npsSum = 0, npsCount = 0;
    nps.forEach(function(r) {
        if (r.avg_score != null) { npsSum += parseFloat(r.avg_score) * parseInt(r.responses); npsCount += parseInt(r.responses); }
    });
    setText('kpiOverallNps', npsCount > 0 ? (npsSum / npsCount).toFixed(1) : '--');

    // TAT - now computed from STORES (unified with TnT tab)
    var filteredStores = (typeof getKpiFilteredStores === 'function') ? getKpiFilteredStores() : [];
    var tatSum = 0, tatN = 0;
    filteredStores.forEach(function(s) {
        if (s.tnt != null) { tatSum += s.tnt; tatN++; }
    });
    setText('kpiOverallTat', tatN > 0 ? (tatSum / tatN).toFixed(1) + '%' : '--');

    var fin = _kpiFiltered.finance || [];
    var totalSpend = 0;
    fin.forEach(function(r) { totalSpend += parseFloat(r.spend) || 0; });
    setText('kpiOverallSpend', totalSpend > 0 ? '$' + formatM(totalSpend) : '--');
}

function setText(id, val) { var el = document.getElementById(id); if (el) el.textContent = val; }
function formatM(v) {
    if (v >= 1e9) return (v/1e9).toFixed(1) + 'B';
    if (v >= 1e6) return (v/1e6).toFixed(1) + 'M';
    if (v >= 1e3) return (v/1e3).toFixed(0) + 'K';
    return v.toFixed(0);
}

// ── Render current sub-tab ─────────────────────────────────────────────────
function renderKpiCurrentSub() {
    if (_kpiCurrentSub === 'overview') renderKpiOverview();
    else if (_kpiCurrentSub === 'safety') renderKpiSafety();
    else if (_kpiCurrentSub === 'service') renderKpiService();
    else if (_kpiCurrentSub === 'productivity') renderKpiProductivity();
    else if (_kpiCurrentSub === 'finance') renderKpiFinance();
}

function renderKpiTab() {
    initKpiFilters();
    applyKpiFilters();
}
</script>

<!-- KPI Centralized Renderers -->
<script>
// ── Overview (Centralized KPIs) ────────────────────────────────────────────
function renderKpiOverview() {
    renderKpiOverviewCards();
    renderKpiTrirTrend();
    renderKpiTopLists();
}

function renderKpiOverviewCards() {
    var safety = _kpiFiltered.safety || [];
    var nps = _kpiFiltered.nps || [];
    var fin = _kpiFiltered.finance || [];

    var totalHrs = 0, totalInc = 0;
    safety.forEach(function(r) { totalHrs += parseFloat(r.hrs)||0; totalInc += parseInt(r.inc)||0; });
    var trir = totalHrs > 0 ? ((totalInc * 200000) / totalHrs).toFixed(1) : 'N/A';

    var npsS = 0, npsC = 0;
    nps.forEach(function(r) { if (r.avg_score != null) { npsS += parseFloat(r.avg_score)*parseInt(r.responses); npsC += parseInt(r.responses); } });
    var npsVal = npsC > 0 ? (npsS/npsC).toFixed(1) : 'N/A';

    // TiT from STORES (unified source)
    var filteredStores = getKpiFilteredStores();
    var tatS = 0, tatN = 0;
    filteredStores.forEach(function(s) { if (s.tnt != null) { tatS += s.tnt; tatN++; } });
    var tatVal = tatN > 0 ? (tatS/tatN).toFixed(1) + '%' : 'N/A';

    var totalSpend = 0;
    fin.forEach(function(r) { totalSpend += parseFloat(r.spend)||0; });

    var cards = [
        { label: 'TRIR (Safety)', value: trir, desc: totalInc + ' incidents / ' + formatM(totalHrs) + ' hrs', color: 'red', icon: '\ud83d\udee1\ufe0f' },
        { label: 'NPS (Service)', value: npsVal, desc: npsC.toLocaleString() + ' responses', color: 'green', icon: '\ud83e\udd1d' },
        { label: 'Time-in-Target', value: tatVal, desc: tatN.toLocaleString() + ' stores', color: 'blue', icon: '\u26a1' },
        { label: 'Total Spend', value: '$' + formatM(totalSpend), desc: fin.length + ' projects', color: 'indigo', icon: '\ud83d\udcb0' },
    ];
    var el = document.getElementById('kpiOverviewCards');
    if (!el) return;
    el.innerHTML = cards.map(function(c) {
        return '<div class="bg-white rounded-lg shadow p-5 kpi-card border-l-4 border-' + c.color + '-500">'
            + '<p class="text-xs text-gray-500 uppercase tracking-wide">' + c.icon + ' ' + c.label + '</p>'
            + '<p class="text-2xl font-bold text-gray-800 mt-1">' + c.value + '</p>'
            + '<p class="text-xs text-gray-400 mt-1">' + c.desc + '</p></div>';
    }).join('');
}

function renderKpiTrirTrend() {
    var monthly = _kpiFiltered.monthly || [];
    if (!monthly.length) return;
    var sorted = monthly.slice().sort(function(a,b) {
        return (parseInt(a.yr)*100 + parseInt(a.mo)) - (parseInt(b.yr)*100 + parseInt(b.mo));
    });
    var labels = sorted.map(function(r) {
        var months = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return months[parseInt(r.mo)] + ' ' + r.yr;
    });
    var data = sorted.map(function(r) { return parseFloat(r.trir); });

    if (_kpiCharts.trirTrend) _kpiCharts.trirTrend.destroy();
    var ctx = document.getElementById('kpiTrirTrendChart');
    if (!ctx) return;
    _kpiCharts.trirTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'TRIR',
                data: data,
                borderColor: '#ea1100',
                backgroundColor: 'rgba(234,17,0,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false },
                datalabels: { display: true, align: 'top', font: { size: 10 }, color: '#ea1100',
                    formatter: function(v) { return v.toFixed(1); } }
            },
            scales: { y: { beginAtZero: true, title: { display: true, text: 'TRIR' } } }
        }
    });
}

function renderKpiTopLists() {
    // Top 5 Safety (lowest TRIR)
    var safetyAgg = aggregateBy(_kpiFiltered.safety || [], 'sr', function(rows) {
        var hrs = 0, inc = 0;
        rows.forEach(function(r) { hrs += parseFloat(r.hrs)||0; inc += parseInt(r.inc)||0; });
        return { hrs: hrs, inc: inc, trir: hrs > 0 ? ((inc*200000)/hrs) : 999 };
    });
    safetyAgg.sort(function(a,b) { return a.val.trir - b.val.trir; });
    var topSafety = safetyAgg.slice(0, 5);
    setInner('kpiTopSafety', topSafety.length ? rankTable(topSafety, function(r) {
        return '<td class="px-3 py-2 text-right">' + formatM(r.val.hrs) + '</td>'
            + '<td class="px-3 py-2 text-right">' + r.val.inc + '</td>'
            + '<td class="px-3 py-2 text-right font-bold">' + r.val.trir.toFixed(1) + '</td>';
    }, ['Hours','Incidents','TRIR']) : '<p class="text-gray-400 text-sm">No data</p>');

    // Top 5 Service (highest NPS)
    var serviceAgg = aggregateBy(_kpiFiltered.nps || [], 'sr', function(rows) {
        var s = 0, n = 0;
        rows.forEach(function(r) { s += parseFloat(r.avg_score)*parseInt(r.responses); n += parseInt(r.responses); });
        return { avg: n > 0 ? s/n : 0, responses: n };
    });
    serviceAgg.sort(function(a,b) { return b.val.avg - a.val.avg; });
    var topService = serviceAgg.slice(0, 5);
    setInner('kpiTopService', topService.length ? rankTable(topService, function(r) {
        return '<td class="px-3 py-2 text-right">' + r.val.responses + '</td>'
            + '<td class="px-3 py-2 text-right font-bold">' + r.val.avg.toFixed(1) + '</td>';
    }, ['Responses','Avg NPS']) : '<p class="text-gray-400 text-sm">No data</p>');

    // Top 5 Productivity (highest TiT — from STORES)
    var filteredStores = getKpiFilteredStores();
    var prodAgg = aggregateBy(filteredStores, 'sr', function(rows) {
        var s = 0, n = 0;
        rows.forEach(function(r) { if (r.tnt != null) { s += r.tnt; n++; } });
        return { avgTat: n > 0 ? s / n : 0, stores: n };
    });
    prodAgg.sort(function(a,b) { return b.val.avgTat - a.val.avgTat; });
    var topProd = prodAgg.slice(0, 5);
    setInner('kpiTopProductivity', topProd.length ? rankTable(topProd, function(r) {
        return '<td class="px-3 py-2 text-right">' + r.val.stores + '</td>'
            + '<td class="px-3 py-2 text-right font-bold">' + r.val.avgTat.toFixed(1) + '%</td>';
    }, ['Stores','Avg TiT']) : '<p class="text-gray-400 text-sm">No data</p>');

    // Top 5 Finance (best spend efficiency)
    var finAgg = aggregateBy(_kpiFiltered.finance || [], 'gc', function(rows) {
        var budget = 0, spend = 0;
        rows.forEach(function(r) { budget += parseFloat(r.budget)||0; spend += parseFloat(r.spend)||0; });
        return { budget: budget, spend: spend, pct: budget > 0 ? (spend/budget*100) : 0, projects: rows.length };
    });
    finAgg = finAgg.filter(function(r) { return r.val.budget > 0; });
    finAgg.sort(function(a,b) { return a.val.pct - b.val.pct; });
    var topFin = finAgg.slice(0, 5);
    setInner('kpiTopFinance', topFin.length ? rankTable(topFin, function(r) {
        return '<td class="px-3 py-2 text-right">' + r.val.projects + '</td>'
            + '<td class="px-3 py-2 text-right font-bold">' + r.val.pct.toFixed(0) + '%</td>';
    }, ['Projects','Spend %']) : '<p class="text-gray-400 text-sm">No data</p>');
}

// ── Safety Ranked ──────────────────────────────────────────────────────
function renderKpiSafety() {
    var groupBy = (document.getElementById('kpiSafetyGroupBy') || {}).value || 'sr';
    var agg = aggregateBy(_kpiFiltered.safety || [], groupBy, function(rows) {
        var hrs = 0, inc = 0;
        rows.forEach(function(r) { hrs += parseFloat(r.hrs)||0; inc += parseInt(r.inc)||0; });
        return { hrs: hrs, inc: inc, trir: hrs > 0 ? ((inc*200000)/hrs) : 0 };
    });
    agg.sort(function(a,b) { return a.val.trir - b.val.trir; });
    var searchFiltered = filterBySearch(agg, 'kpiSafetySearch');

    // Bar chart
    if (_kpiCharts.safetyBar) _kpiCharts.safetyBar.destroy();
    var ctx = document.getElementById('kpiSafetyBarChart');
    if (ctx) {
        var top20 = searchFiltered.slice(0, 20);
        _kpiCharts.safetyBar = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top20.map(function(r) { return truncName(r.key); }),
                datasets: [{
                    label: 'TRIR',
                    data: top20.map(function(r) { return +r.val.trir.toFixed(2); }),
                    backgroundColor: top20.map(function(r) { return r.val.trir <= 3 ? '#2a8703' : r.val.trir <= 5 ? '#fbbf24' : '#ea1100'; }),
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: { legend: { display: false },
                    datalabels: { display: true, anchor: 'end', align: 'right', font: { size: 10 } }
                },
                scales: { x: { beginAtZero: true, title: { display: true, text: 'TRIR' } } }
            }
        });
    }

    // Table
    var tbody = document.getElementById('kpiSafetyTbody');
    if (tbody) {
        tbody.innerHTML = searchFiltered.map(function(r, i) {
            var trirColor = r.val.trir <= 3 ? 'text-green-600' : r.val.trir <= 5 ? 'text-yellow-600' : 'text-red-600';
            return '<tr class="table-row border-b">'
                + '<td class="px-3 py-2 text-gray-500">' + (i+1) + '</td>'
                + '<td class="px-3 py-2 font-medium">' + r.key + '</td>'
                + '<td class="px-3 py-2 text-right">' + Math.round(r.val.hrs).toLocaleString() + '</td>'
                + '<td class="px-3 py-2 text-right">' + r.val.inc + '</td>'
                + '<td class="px-3 py-2 text-right font-bold ' + trirColor + '">' + r.val.trir.toFixed(1) + '</td></tr>';
        }).join('');
    }
}

// ── Service Ranked ─────────────────────────────────────────────────────
function renderKpiService() {
    var groupBy = (document.getElementById('kpiServiceGroupBy') || {}).value || 'sr';
    var agg = aggregateBy(_kpiFiltered.nps || [], groupBy, function(rows) {
        var s = 0, n = 0;
        rows.forEach(function(r) { s += parseFloat(r.avg_score)*parseInt(r.responses); n += parseInt(r.responses); });
        return { avg: n > 0 ? s/n : 0, responses: n };
    });
    agg.sort(function(a,b) { return b.val.avg - a.val.avg; });
    var searchFiltered = filterBySearch(agg, 'kpiServiceSearch');

    if (_kpiCharts.serviceBar) _kpiCharts.serviceBar.destroy();
    var ctx = document.getElementById('kpiServiceBarChart');
    if (ctx) {
        var top20 = searchFiltered.slice(0, 20);
        _kpiCharts.serviceBar = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top20.map(function(r) { return truncName(r.key); }),
                datasets: [{
                    label: 'Avg NPS',
                    data: top20.map(function(r) { return +r.val.avg.toFixed(2); }),
                    backgroundColor: '#0ea5e9',
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: { legend: { display: false },
                    datalabels: { display: true, anchor: 'end', align: 'right', font: { size: 10 } }
                },
                scales: { x: { beginAtZero: true, max: 10, title: { display: true, text: 'Avg NPS Score' } } }
            }
        });
    }

    var tbody = document.getElementById('kpiServiceTbody');
    if (tbody) {
        tbody.innerHTML = searchFiltered.map(function(r, i) {
            return '<tr class="table-row border-b">'
                + '<td class="px-3 py-2 text-gray-500">' + (i+1) + '</td>'
                + '<td class="px-3 py-2 font-medium">' + r.key + '</td>'
                + '<td class="px-3 py-2 text-right">' + r.val.responses.toLocaleString() + '</td>'
                + '<td class="px-3 py-2 text-right font-bold text-[#0ea5e9]">' + r.val.avg.toFixed(1) + '</td></tr>';
        }).join('');
    }
}

// ── Productivity Ranked (unified with TnT — uses STORES data) ──────────
function getKpiFilteredStores() {
    // Filter STORES using the same KPI header filters for consistency
    if (typeof STORES === 'undefined' || !STORES.length) return [];
    var f = getKpiFilterValues();
    return STORES.filter(function(s) {
        if (s.tnt == null) return false;
        // Use canonical org hierarchy for Sr Director filtering
        var canonicalSr = s.dir ? (_kpiOrg.dirToSr[s.dir] || s.sr || '') : (s.sr || '');
        if (f.sr && canonicalSr !== f.sr) return false;
        if (f.dir && s.dir !== f.dir) return false;
        if (f.rgn && (s.rgn || s.sub || '') !== f.rgn) return false;
        return true;
    });
}

function renderKpiProductivity() {
    var groupBy = (document.getElementById('kpiProdGroupBy') || {}).value || 'sr';
    var filteredStores = getKpiFilteredStores();

    var agg = aggregateBy(filteredStores, groupBy, function(rows) {
        var tntS = 0, tntN = 0, t7s = 0, t7n = 0, t30s = 0, t30n = 0;
        rows.forEach(function(s) {
            if (s.tnt != null) { tntS += s.tnt; tntN++; }
            if (s.tnt7 != null) { t7s += s.tnt7; t7n++; }
            if (s.tnt30 != null) { t30s += s.tnt30; t30n++; }
        });
        return {
            tntAvg: tntN > 0 ? tntS / tntN : 0,
            tnt7Avg: t7n > 0 ? t7s / t7n : 0,
            tnt30Avg: t30n > 0 ? t30s / t30n : 0,
            stores: tntN
        };
    });
    agg.sort(function(a, b) { return b.val.tntAvg - a.val.tntAvg; });
    var searchFiltered = filterBySearch(agg, 'kpiProdSearch');

    if (_kpiCharts.prodBar) _kpiCharts.prodBar.destroy();
    var ctx = document.getElementById('kpiProdBarChart');
    if (ctx) {
        var top20 = searchFiltered.slice(0, 20);
        _kpiCharts.prodBar = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top20.map(function(r) { return truncName(r.key); }),
                datasets: [
                    { label: 'Current TiT %', data: top20.map(function(r) { return +r.val.tntAvg.toFixed(1); }), backgroundColor: '#0ea5e9' },
                    { label: '7-Day TiT %', data: top20.map(function(r) { return +r.val.tnt7Avg.toFixed(1); }), backgroundColor: '#60a5fa' },
                    { label: '30-Day TiT %', data: top20.map(function(r) { return +r.val.tnt30Avg.toFixed(1); }), backgroundColor: '#93c5fd' },
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: { legend: { position: 'top' }, datalabels: { display: false } },
                scales: { x: { beginAtZero: true, max: 100, title: { display: true, text: 'Time-in-Target %' } } }
            }
        });
    }

    var tbody = document.getElementById('kpiProdTbody');
    if (tbody) {
        tbody.innerHTML = searchFiltered.map(function(r, i) {
            var color = r.val.tntAvg >= 85 ? 'text-green-600' : r.val.tntAvg >= 70 ? 'text-yellow-600' : 'text-red-600';
            return '<tr class="table-row border-b">'
                + '<td class="px-3 py-2 text-gray-500">' + (i+1) + '</td>'
                + '<td class="px-3 py-2 font-medium">' + r.key + '</td>'
                + '<td class="px-3 py-2 text-right">' + r.val.stores + '</td>'
                + '<td class="px-3 py-2 text-right">' + r.val.tnt7Avg.toFixed(1) + '%</td>'
                + '<td class="px-3 py-2 text-right">' + r.val.tnt30Avg.toFixed(1) + '%</td>'
                + '<td class="px-3 py-2 text-right font-bold ' + color + '">' + r.val.tntAvg.toFixed(1) + '%</td></tr>';
        }).join('');
    }
}

// ── Finance Ranked ──────────────────────────────────────────────────────
function renderKpiFinance() {
    var groupBy = (document.getElementById('kpiFinGroupBy') || {}).value || 'gc';
    var agg = aggregateBy(_kpiFiltered.finance || [], groupBy, function(rows) {
        var budget = 0, spend = 0;
        rows.forEach(function(r) { budget += parseFloat(r.budget)||0; spend += parseFloat(r.spend)||0; });
        return { budget: budget, spend: spend, pct: budget > 0 ? (spend/budget*100) : 0, projects: rows.length };
    });
    agg = agg.filter(function(r) { return r.val.budget > 0 || r.val.spend > 0; });
    agg.sort(function(a,b) { return b.val.spend - a.val.spend; });
    var searchFiltered = filterBySearch(agg, 'kpiFinSearch');

    // Bar chart - top 15 by spend
    if (_kpiCharts.finBar) _kpiCharts.finBar.destroy();
    var ctx = document.getElementById('kpiFinanceBarChart');
    if (ctx) {
        var top15 = searchFiltered.slice(0, 15);
        _kpiCharts.finBar = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: top15.map(function(r) { return truncName(r.key); }),
                datasets: [
                    { label: 'Budget', data: top15.map(function(r) { return r.val.budget; }), backgroundColor: '#60a5fa' },
                    { label: 'Spend', data: top15.map(function(r) { return r.val.spend; }), backgroundColor: '#0ea5e9' },
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: { legend: { position: 'top' }, datalabels: { display: false } },
                scales: { x: { beginAtZero: true, ticks: { callback: function(v) { return '$' + formatM(v); } } } }
            }
        });
    }

    // Finance table
    var tbody = document.getElementById('kpiFinanceTbody');
    if (tbody) {
        tbody.innerHTML = searchFiltered.slice(0, 50).map(function(r, i) {
            var color = r.val.pct <= 100 ? 'text-green-600' : r.val.pct <= 110 ? 'text-yellow-600' : 'text-red-600';
            return '<tr class="table-row border-b">'
                + '<td class="px-3 py-2 text-gray-500">' + (i+1) + '</td>'
                + '<td class="px-3 py-2 font-medium">' + r.key + '</td>'
                + '<td class="px-3 py-2 text-right">' + r.val.projects + '</td>'
                + '<td class="px-3 py-2 text-right">$' + formatM(r.val.budget) + '</td>'
                + '<td class="px-3 py-2 text-right">$' + formatM(r.val.spend) + '</td>'
                + '<td class="px-3 py-2 text-right font-bold ' + color + '">' + r.val.pct.toFixed(0) + '%</td></tr>';
        }).join('');
    }

    // GC Scorecard
    var gc = _kpiFiltered.gc || [];
    var gcAgg = {};
    gc.forEach(function(r) {
        if (!r.gc) return;
        if (!gcAgg[r.gc]) gcAgg[r.gc] = { spend: 0, awarded: 0, changes: 0, projects: 0, days: [], grade: r.isn_grade };
        gcAgg[r.gc].spend += parseFloat(r.spend)||0;
        gcAgg[r.gc].awarded += parseFloat(r.awarded)||0;
        gcAgg[r.gc].changes += parseFloat(r.changes)||0;
        gcAgg[r.gc].projects += parseInt(r.projects)||0;
        if (r.avg_days) gcAgg[r.gc].days.push(parseFloat(r.avg_days));
        if (r.isn_grade && r.isn_grade !== 'null') gcAgg[r.gc].grade = r.isn_grade;
    });
    var gcList = Object.keys(gcAgg).map(function(k) {
        var v = gcAgg[k];
        var avgDays = v.days.length ? v.days.reduce(function(a,b){return a+b;},0)/v.days.length : 0;
        return { gc: k, spend: v.spend, awarded: v.awarded, pct: v.awarded > 0 ? (v.spend/v.awarded*100) : 0,
                 projects: v.projects, avgDays: avgDays, grade: v.grade };
    });
    // Apply GC search
    var gcSearch = getKpiSearch('kpiGcSearch');
    if (gcSearch) gcList = gcList.filter(function(r) { return r.gc.toLowerCase().indexOf(gcSearch) !== -1; });
    gcList.sort(function(a,b) { return b.spend - a.spend; });

    var gcTbody = document.getElementById('kpiGcTbody');
    if (gcTbody) {
        gcTbody.innerHTML = gcList.slice(0, 30).map(function(r, i) {
            var gradeColor = r.grade === 'A' ? 'bg-green-100 text-green-700'
                : r.grade === 'B' ? 'bg-blue-100 text-blue-700'
                : r.grade === 'C' ? 'bg-yellow-100 text-yellow-700'
                : 'bg-gray-100 text-gray-600';
            return '<tr class="table-row border-b">'
                + '<td class="px-3 py-2 text-gray-500">' + (i+1) + '</td>'
                + '<td class="px-3 py-2 font-medium">' + r.gc + '</td>'
                + '<td class="px-3 py-2 text-right">' + r.projects + '</td>'
                + '<td class="px-3 py-2 text-right">$' + formatM(r.spend) + '</td>'
                + '<td class="px-3 py-2 text-right">$' + formatM(r.awarded) + '</td>'
                + '<td class="px-3 py-2 text-right">' + r.pct.toFixed(0) + '%</td>'
                + '<td class="px-3 py-2 text-right">' + Math.round(r.avgDays) + '</td>'
                + '<td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs font-medium ' + gradeColor + '">' + (r.grade || 'N/A') + '</span></td></tr>';
        }).join('');
    }
}

// ── Utilities ───────────────────────────────────────────────────────────
function aggregateBy(rows, key, reducer) {
    var groups = {};
    rows.forEach(function(r) {
        var k = r[key] || 'Unknown';
        if (!groups[k]) groups[k] = [];
        groups[k].push(r);
    });
    return Object.keys(groups).map(function(k) {
        return { key: k, val: reducer(groups[k]) };
    });
}

function truncName(s) { return s && s.length > 20 ? s.substring(0, 18) + '...' : s; }

function getKpiSearch(id) {
    var el = document.getElementById(id);
    return el ? el.value.trim().toLowerCase() : '';
}

function filterBySearch(agg, searchId) {
    var q = getKpiSearch(searchId);
    if (!q) return agg;
    return agg.filter(function(r) { return r.key.toLowerCase().indexOf(q) !== -1; });
}

function setInner(id, html) { var el = document.getElementById(id); if (el) el.innerHTML = html; }

function rankTable(items, cellFn, headers) {
    var ths = '<th class="px-3 py-2 text-left font-medium text-gray-600 text-sm">Rank</th>'
        + '<th class="px-3 py-2 text-left font-medium text-gray-600 text-sm">Name</th>'
        + headers.map(function(h) { return '<th class="px-3 py-2 text-right font-medium text-gray-600 text-sm">' + h + '</th>'; }).join('');
    var rows = items.map(function(r, i) {
        return '<tr class="table-row border-b"><td class="px-3 py-2 text-gray-500">' + (i+1) + '</td>'
            + '<td class="px-3 py-2 font-medium text-sm">' + r.key + '</td>' + cellFn(r) + '</tr>';
    }).join('');
    return '<table class="min-w-full text-sm"><thead class="bg-gray-50"><tr>' + ths + '</tr></thead><tbody>' + rows + '</tbody></table>';
}
</script>

<script>
// ── Win the Winter Tab JS ──
var wtwFiltered = WTW_DATA;
var wtwSub = 'overview';
var wtwStoreSumSort = { key: 'store', asc: true };
var wtwIpSort = { key: 'store', asc: true };
var wtwOverviewChart = null;
var wtwReadyChartObj = null;
var wtwStoreSlicerSn = null; // Store slicer: when set, filters all WtW views to one store

function wtwToggleStoreSlicer(sn) {
    wtwStoreSlicerSn = (wtwStoreSlicerSn === sn) ? null : sn;
    // Show/hide slicer badge
    var badge = document.getElementById('wtwSlicerBadge');
    if (badge) {
        if (wtwStoreSlicerSn) {
            badge.textContent = 'Filtered: Store ' + wtwStoreSlicerSn + ' \u2715';
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }
    wtwRenderAll();
}

// Returns wtwFiltered optionally narrowed by store slicer
function wtwGetFiltered() {
    if (!wtwStoreSlicerSn) return wtwFiltered;
    return wtwFiltered.filter(w => w.sn === wtwStoreSlicerSn);
}

// Lazy store->ops lookup for WtW cross-referencing (built after STORES loads)
var WTW_STORE_OPS = null;
var WTW_STORE_BN = null;
var WTW_STORE_DIR = null;
var WTW_STORE_RM = null;
var WTW_STORE_FSM = null;
var WTW_STORE_PM = null;
var WTW_STORE_TNT30 = null;
var WTW_STORE_LEAK = null;
function ensureWtwStoreOps() {
    if (WTW_STORE_OPS !== null) return;
    WTW_STORE_OPS = {};
    WTW_STORE_BN = {};
    WTW_STORE_DIR = {};
    WTW_STORE_RM = {};
    WTW_STORE_FSM = {};
    WTW_STORE_PM = {};
    WTW_STORE_TNT30 = {};
    STORES.forEach(function(s) {
        if (s.ops) WTW_STORE_OPS[s.sn] = s.ops;
        if (s.bn) WTW_STORE_BN[s.sn] = s.bn;
        if (s.dir) WTW_STORE_DIR[s.sn] = s.dir;
        if (s.rm) WTW_STORE_RM[s.sn] = s.rm;
        if (s.fsm) WTW_STORE_FSM[s.sn] = s.fsm;
        if (s.pm != null) WTW_STORE_PM[s.sn] = s.pm;
        if (s.tnt30 != null) WTW_STORE_TNT30[s.sn] = s.tnt30;
    });
    // Build store-level leak rate from LEAK_SUMMARY
    WTW_STORE_LEAK = {};
    if (typeof LEAK_SUMMARY !== 'undefined') {
        LEAK_SUMMARY.forEach(function(r) {
            var sn = String(r.sn);
            if (!WTW_STORE_LEAK[sn]) {
                WTW_STORE_LEAK[sn] = { storeRate: r.store_rate || 0, assets: 0, totalLR: 0 };
            }
            WTW_STORE_LEAK[sn].assets++;
            WTW_STORE_LEAK[sn].totalLR += (r.leak_rate || 0);
        });
    }
}

// ── Cascading Filters ──
function wtwPopulate(id, values) {
    const sel = document.getElementById(id);
    const cur = sel.value;
    const firstOpt = sel.options[0].text;
    const opts = [...new Set(values)].filter(Boolean).sort();
    sel.innerHTML = '<option value="">' + firstOpt + '</option>' +
        opts.map(v => '<option value="' + v + '"' + (v === cur ? ' selected' : '') + '>' + v + '</option>').join('');
}

function wtwApplyFilter() {
    // Clear store slicer when filter changes — prevent stale slicer pointing to
    // a store that's no longer in the filtered set
    wtwStoreSlicerSn = null;
    var badge = document.getElementById('wtwSlicerBadge');
    if (badge) badge.classList.add('hidden');

    const opsReg = document.getElementById('wtwOps').value;
    const bu = document.getElementById('wtwBu').value;
    const fmd = document.getElementById('wtwFmd').value;
    const fmr = document.getElementById('wtwFmr').value;
    const fsm = document.getElementById('wtwFsm').value;
    const phase = document.getElementById('wtwPhase').value;

    // Cascade dropdowns
    const srToBu = WTW_ORG.srToBu;
    const buToSr = {};
    Object.entries(srToBu).forEach(([sr, b]) => { buToSr[b] = sr; });

    let directors = bu ? (WTW_ORG.srToFm[buToSr[bu]] || []) : Object.values(WTW_ORG.srToFm).flat();
    wtwPopulate('wtwFmd', directors);

    let regionals;
    if (fmd) {
        regionals = WTW_ORG.fmToReg[fmd] || [];
    } else if (bu) {
        regionals = (WTW_ORG.srToFm[buToSr[bu]] || []).flatMap(d => WTW_ORG.fmToReg[d] || []);
    } else {
        regionals = Object.values(WTW_ORG.fmToReg).flat();
    }
    wtwPopulate('wtwFmr', regionals);

    let fsMgrs;
    const curFmr = document.getElementById('wtwFmr').value;
    if (curFmr) {
        fsMgrs = WTW_ORG.regToFs[curFmr] || [];
    } else if (fmd) {
        fsMgrs = (WTW_ORG.fmToReg[fmd] || []).flatMap(r => WTW_ORG.regToFs[r] || []);
    } else {
        fsMgrs = Object.values(WTW_ORG.regToFs).flat();
    }
    wtwPopulate('wtwFsm', fsMgrs);

    // Filter data
    const selBu = document.getElementById('wtwBu').value;
    const selFmd = document.getElementById('wtwFmd').value;
    const selFmr = document.getElementById('wtwFmr').value;
    const selFsm = document.getElementById('wtwFsm').value;
    const selPhase = document.getElementById('wtwPhase').value;
    const selOps = document.getElementById('wtwOps').value;

    wtwFiltered = WTW_DATA.filter(d => {
        const bn = WTW_STORE_BN[d.sn];
        const bannerOk = !bn || getActiveBanners().has(bn);
        return bannerOk &&
            (!selOps || WTW_STORE_OPS[d.sn] === selOps) &&
            (!selBu || srToBu[d.spm] === selBu) &&
            (!selFmd || d.epm === selFmd) &&
            (!selFmr || d.sr === selFmr) &&
            (!selFsm || WTW_STORE_FSM[d.sn] === selFsm) &&
            (!selPhase || d.ph === selPhase);
    });

    wtwRenderAll();
}

function wtwReset() {
    ['wtwOps','wtwBu','wtwFmd','wtwFmr','wtwFsm','wtwPhase'].forEach(id => document.getElementById(id).value = '');
    var storeSearch = document.getElementById('wtwStoreSearch');
    if (storeSearch) storeSearch.value = '';
    nameSearchClear('wtw');
    wtwStoreSlicerSn = null;
    var badge = document.getElementById('wtwSlicerBadge');
    if (badge) badge.classList.add('hidden');
    wtwApplyFilter();
}

registerNameSearch('wtw', {
    orgIds: [
        { key: 'dir', filterId: 'wtwFmd', label: 'FM Director' },
        { key: 'rm', filterId: 'wtwFmr', label: 'Regional Manager' },
        { key: 'fsm', filterId: 'wtwFsm', label: 'FS Manager' },
    ],
    applyFn: 'wtwApplyFilter'
});

function wtwShowSub(name) {
    wtwSub = name;
    ['overview','inprogress','ready'].forEach(s => {
        document.getElementById('wtw' + s.charAt(0).toUpperCase() + s.slice(1)).classList.toggle('hidden', s !== name);
        const btn = document.getElementById('wtwSub' + s.charAt(0).toUpperCase() + s.slice(1));
        if (s === name) {
            btn.className = 'px-4 py-1.5 text-xs font-semibold rounded-md bg-gradient-to-r from-[#0ea5e9] to-[#0ea5e9] text-white';
        } else {
            btn.className = 'px-4 py-1.5 text-xs font-semibold rounded-md border border-gray-200 text-gray-600 hover:border-[#0ea5e9] hover:text-[#0ea5e9]';
        }
    });
}

// ── Render All ──
function wtwRenderAll() {
    const d = wtwGetFiltered();
    const total = d.length;
    const done = d.filter(w => w.st === 'COMPLETED').length;
    const ip = d.filter(w => w.st === 'IN PROGRESS').length;
    const op = d.filter(w => w.st === 'OPEN').length;

    document.getElementById('wtwKpiTotal').textContent = total.toLocaleString();
    document.getElementById('wtwKpiDone').textContent = done.toLocaleString();
    document.getElementById('wtwKpiDonePct').textContent = total ? (100*done/total).toFixed(1) + '% of total' : '0%';
    document.getElementById('wtwKpiIp').textContent = ip.toLocaleString();
    document.getElementById('wtwKpiIpPct').textContent = total ? (100*ip/total).toFixed(1) + '% remaining' : '0%';
    document.getElementById('wtwKpiOpen').textContent = op.toLocaleString();
    document.getElementById('wtwKpiOpenPct').textContent = total ? (100*op/total).toFixed(1) + '% pending' : '0%';
    document.getElementById('wtwIpCount').textContent = ip;

    // Ready count
    const readyWos = d.filter(w => w.st === 'IN PROGRESS' && (WTW_STORE_PM[w.sn] ?? 0) >= 90);
    document.getElementById('wtwReadyCount').textContent = readyWos.length;

    wtwRenderBuTable();
    wtwRenderOverviewChart();
    wtwRenderPmImprovement();
    wtwRenderStoreSummary();
    wtwRenderIpTable();
    wtwRenderReadyTab();
}

// ── BU Progress Table (slices by active filters) ──
function wtwRenderBuTable() {
    const srToBu = WTW_ORG.srToBu;
    const buOrder = ['East', 'North', 'West', 'Southeast', 'Southwest'];

    // Determine which Sr Directors to show based on filtered data
    const gf = wtwGetFiltered();
    const activeSrs = new Set(gf.map(w => w.spm).filter(Boolean));
    const srOrder = Object.entries(srToBu)
        .filter(([sr]) => activeSrs.has(sr))
        .sort((a, b) => buOrder.indexOf(a[1]) - buOrder.indexOf(b[1]));

    const tbody = document.getElementById('wtwBuBody');
    if (srOrder.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-3 py-6 text-center text-gray-400">No matching Sr Directors</td></tr>';
        return;
    }
    tbody.innerHTML = srOrder.map(([sr, bu]) => {
        const rows = gf.filter(w => w.spm === sr);
        const tot = rows.length;
        const comp = rows.filter(w => w.st === 'COMPLETED').length;
        const ip = rows.filter(w => w.st === 'IN PROGRESS').length;
        const op = rows.filter(w => w.st === 'OPEN').length;
        const pct = tot ? (100 * comp / tot).toFixed(1) : 0;
        return `<tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-3 py-3 font-semibold text-[#0ea5e9]">${bu} BU</td>
            <td class="px-3 py-3">${sr}</td>
            <td class="px-3 py-3 text-center font-semibold">${tot}</td>
            <td class="px-3 py-3 text-center font-semibold text-[#2a8703]">${comp}</td>
            <td class="px-3 py-3 text-center font-semibold text-[#fbbf24]">${ip}</td>
            <td class="px-3 py-3 text-center font-semibold text-[#ea1100]">${op}</td>
            <td class="px-3 py-3 text-center">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div style="width:${pct}%" class="h-full bg-gradient-to-r from-[#2a8703] to-[#4caf50] rounded-full"></div>
                    </div>
                    <span class="font-semibold text-[#2a8703] text-xs">${pct}%</span>
                </div>
            </td>
        </tr>`;
    }).join('');
}

// ── Overview Stacked Bar Chart ──
function wtwRenderOverviewChart() {
    const phases = ['PH1', 'PH2', 'PH3'];
    const phaseLabels = ['Phase 1', 'Phase 2', 'Phase 3'];
    const statuses = ['Completed', 'In Progress', 'Open'];
    const statusMap = { 'Completed': 'COMPLETED', 'In Progress': 'IN PROGRESS', 'Open': 'OPEN' };
    const colors = { 'Completed': '#76c043', 'In Progress': '#fbbf24', 'Open': '#e57373' };

    const datasets = statuses.map(st => ({
        label: st,
        data: phases.map(ph => wtwGetFiltered().filter(w => w.ph === ph && w.st === statusMap[st]).length),
        backgroundColor: colors[st],
    }));

    if (wtwOverviewChart) wtwOverviewChart.destroy();
    wtwOverviewChart = new Chart(document.getElementById('wtwOverviewChart'), {
        type: 'bar',
        data: { labels: phaseLabels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                datalabels: { display: true, font: { weight: 'bold', size: 11 }, color: '#333' }
            },
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
        }
    });
}

// ── Completion Metrics ──
function wtwRenderPmImprovement() {
    const completed = wtwGetFiltered().filter(w => w.st === 'COMPLETED');
    const withHrs = completed.filter(w => w.hrs != null && w.hrs > 0);
    const avgHrs = withHrs.length ? (withHrs.reduce((a, w) => a + w.hrs, 0) / withHrs.length) : 0;
    const avgDays = (avgHrs / 24).toFixed(1);
    const total = wtwGetFiltered().length;
    const compPct = total ? (100 * completed.length / total).toFixed(1) : '0.0';

    document.getElementById('wtwAvgImp').textContent = avgDays + ' days';
    document.getElementById('wtwAvgImp').style.color = '#0ea5e9';
    document.getElementById('wtwImpCount').textContent = completed.length;
    document.getElementById('wtwMissingScores').textContent = compPct + '%';
}

// ── Store Summary ──
function wtwRenderStoreSummary() {
    const statusFilter = document.getElementById('wtwStoreSumStatus')?.value || '';
    const storeSearch = (document.getElementById('wtwStoreSearch')?.value || '').trim();

    // Group by store: aggregate WOs into store-level summary
    const storeMap = {};
    wtwFiltered.forEach(w => {
        if (!storeMap[w.sn]) storeMap[w.sn] = { sn: w.sn, wos: [] };
        storeMap[w.sn].wos.push(w);
    });

    let stores = Object.values(storeMap).map(s => {
        const latestSt = s.wos.some(w => w.st === 'IN PROGRESS') ? 'IN PROGRESS' :
                         s.wos.some(w => w.st === 'OPEN') ? 'OPEN' : 'COMPLETED';
        const phases = [...new Set(s.wos.map(w => w.ph))].sort().join(', ');
        const hours = s.wos.reduce((a, w) => a + (parseInt(w.hrs) || 0), 0);
        // Get PM score from STORES (crystal store data), not from WO flag
        const recentPm = WTW_STORE_PM[s.sn] ?? null;
        // Improvement = current PM score minus 30-day-ago TnT score
        const tnt30 = WTW_STORE_TNT30[s.sn];
        const improvement = (recentPm != null && tnt30 != null) ? +(recentPm - tnt30).toFixed(1) : null;
        // Leak rates from LEAK_SUMMARY
        const lk = WTW_STORE_LEAK[s.sn];
        const storeRate = lk ? lk.storeRate : null;
        const avgAssetLR = (lk && lk.assets > 0) ? lk.totalLR / lk.assets : null;
        return { sn: s.sn, status: latestSt, phase: phases, hours, recentPm, improvement, storeRate, avgAssetLR, leakAssets: lk ? lk.assets : 0 };
    });

    if (statusFilter) stores = stores.filter(s => s.status === statusFilter);
    if (storeSearch) stores = stores.filter(s => s.sn.includes(storeSearch));

    // Show count
    var countEl = document.getElementById('wtwStoreSumCount');
    if (countEl) countEl.textContent = stores.length + ' store' + (stores.length !== 1 ? 's' : '');

    // Sort
    const sk = wtwStoreSumSort.key;
    stores.sort((a, b) => {
        let av = sk === 'store' ? a.sn : sk === 'status' ? a.status : sk === 'phase' ? a.phase :
                 sk === 'hours' ? a.hours : sk === 'recent_pm' ? (a.recentPm ?? -1) :
                 sk === 'store_rate' ? (a.storeRate ?? -1) : sk === 'asset_lr' ? (a.avgAssetLR ?? -1) :
                 (a.improvement ?? -999);
        let bv = sk === 'store' ? b.sn : sk === 'status' ? b.status : sk === 'phase' ? b.phase :
                 sk === 'hours' ? b.hours : sk === 'recent_pm' ? (b.recentPm ?? -1) :
                 sk === 'store_rate' ? (b.storeRate ?? -1) : sk === 'asset_lr' ? (b.avgAssetLR ?? -1) :
                 (b.improvement ?? -999);
        return wtwStoreSumSort.asc ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
    });

    const tbody = document.getElementById('wtwStoreSumBody');
    tbody.innerHTML = stores.slice(0, 300).map(s => {
        const stCls = s.status === 'COMPLETED' ? 'bg-green-50' : s.status === 'IN PROGRESS' ? 'bg-yellow-50' : 'bg-blue-50';
        const impColor = s.improvement != null ? (s.improvement > 0 ? 'text-[#2a8703] font-bold' : s.improvement < 0 ? 'text-[#ea1100] font-bold' : '') : 'text-gray-400';
        const impText = s.improvement != null ? (s.improvement > 0 ? '+' : '') + s.improvement.toFixed(1) : '-';
        const srColor = s.storeRate != null ? (s.storeRate > 0.25 ? 'text-[#ea1100] font-bold' : s.storeRate > 0.10 ? 'text-orange-600' : 'text-[#2a8703]') : 'text-gray-400';
        const alrColor = s.avgAssetLR != null ? (s.avgAssetLR > 1 ? 'text-[#ea1100] font-bold' : s.avgAssetLR > 0.5 ? 'text-orange-600' : 'text-[#2a8703]') : 'text-gray-400';
        const isActive = wtwStoreSlicerSn === s.sn;
        const rowCls = isActive ? 'ring-2 ring-[#0ea5e9] bg-blue-100' : stCls;
        return `<tr class="${rowCls} border-b border-gray-100 hover:brightness-95 cursor-pointer" onclick="wtwToggleStoreSlicer('${s.sn}')" title="Click to filter by store ${s.sn}">
            <td class="px-2 py-2 text-center font-semibold">${s.sn}</td>
            <td class="px-2 py-2 text-center">${s.status}</td>
            <td class="px-2 py-2 text-center">${s.phase}</td>
            <td class="px-2 py-2 text-center">${s.hours}</td>
            <td class="px-2 py-2 text-center">${s.recentPm != null ? s.recentPm.toFixed(1) : '-'}</td>
            <td class="px-2 py-2 text-center ${impColor}">${impText}</td>
            <td class="px-2 py-2 text-center ${srColor}">${s.storeRate != null ? (s.storeRate * 100).toFixed(1) + '%' : '-'}</td>
            <td class="px-2 py-2 text-center ${alrColor}">${s.avgAssetLR != null ? s.avgAssetLR.toFixed(3) : '-'}</td>
        </tr>`;
    }).join('');
}

function wtwSortStoreSummary(key) {
    if (wtwStoreSumSort.key === key) wtwStoreSumSort.asc = !wtwStoreSumSort.asc;
    else { wtwStoreSumSort.key = key; wtwStoreSumSort.asc = true; }
    wtwRenderStoreSummary();
}

// ── In-Progress Table ──
function wtwRenderIpTable() {
    let data = wtwGetFiltered().filter(w => w.st === 'IN PROGRESS');
    const sk = wtwIpSort.key;
    data.sort((a, b) => {
        let av = sk === 'phase' ? a.ph : sk === 'store' ? a.sn : sk === 'wo_num' ? a.w :
                 sk === 'extended' ? a.ext : sk === 'hours' ? (parseInt(a.hrs)||0) :
                 sk === 'scheduled' ? a.sch : (WTW_STORE_PM[a.sn] ?? -1);
        let bv = sk === 'phase' ? b.ph : sk === 'store' ? b.sn : sk === 'wo_num' ? b.w :
                 sk === 'extended' ? b.ext : sk === 'hours' ? (parseInt(b.hrs)||0) :
                 sk === 'scheduled' ? b.sch : (WTW_STORE_PM[b.sn] ?? -1);
        return wtwIpSort.asc ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
    });

    const phCls = { 'PH1': 'bg-blue-50', 'PH2': 'bg-yellow-50', 'PH3': 'bg-green-50' };
    document.getElementById('wtwIpBody').innerHTML = data.slice(0, 500).map(w => {
        const pm = WTW_STORE_PM[w.sn] ?? NaN;
        const pmCls = !isNaN(pm) ? (pm >= 90 ? 'text-[#2a8703] font-bold' : pm < 70 ? 'text-[#ea1100] font-bold' : '') : 'text-gray-400';
        return `<tr class="${phCls[w.ph] || ''} border-b border-gray-100 hover:brightness-95">
            <td class="px-2 py-2 text-center">${w.ph}</td>
            <td class="px-2 py-2 text-center font-semibold">${w.sn}</td>
            <td class="px-2 py-2 text-center font-mono">${w.w}</td>
            <td class="px-2 py-2 text-center">${w.ext || w.st}</td>
            <td class="px-2 py-2 text-center">${w.hrs || 0}</td>
            <td class="px-2 py-2 text-center">${w.sch || '-'}</td>
            <td class="px-2 py-2 text-center ${pmCls}">${!isNaN(pm) ? pm.toFixed(1) : '-'}</td>
        </tr>`;
    }).join('');
}

function wtwSortIp(key) {
    if (wtwIpSort.key === key) wtwIpSort.asc = !wtwIpSort.asc;
    else { wtwIpSort.key = key; wtwIpSort.asc = true; }
    wtwRenderIpTable();
}

// ── Ready Tab ──
function wtwRenderReadyTab() {
    const gf = wtwGetFiltered();
    const ip = gf.filter(w => w.st === 'IN PROGRESS');
    const ready = ip.filter(w => (WTW_STORE_PM[w.sn] ?? 0) >= 90);
    const total = gf.length;
    const done = gf.filter(w => w.st === 'COMPLETED').length;
    const projected = done + ready.length;

    document.getElementById('wtwReadyBig').textContent = ready.length.toLocaleString();
    document.getElementById('wtwProjCompleted').textContent = projected.toLocaleString();
    document.getElementById('wtwProjPct').textContent = total ? (100 * projected / total).toFixed(1) + '%' : '0%';

    // Chart: Ready count by FM Director
    const byDir = {};
    ready.forEach(w => { byDir[w.fmd] = (byDir[w.fmd] || 0) + 1; });
    const sorted = Object.entries(byDir).sort((a, b) => b[1] - a[1]);

    if (wtwReadyChartObj) wtwReadyChartObj.destroy();
    if (sorted.length > 0) {
        wtwReadyChartObj = new Chart(document.getElementById('wtwReadyChart'), {
            type: 'bar',
            data: {
                labels: sorted.map(s => s[0]),
                datasets: [{ data: sorted.map(s => s[1]), backgroundColor: '#76c043' }]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, datalabels: { display: true, anchor: 'end', align: 'end', font: { weight: 'bold', size: 11 } } },
                scales: { x: { beginAtZero: true } }
            }
        });
    }

    // Ready details table
    document.getElementById('wtwReadyBody').innerHTML = ready.map(w => {
        const pm = WTW_STORE_PM[w.sn] ?? NaN;
        return `<tr class="border-b border-gray-100 hover:bg-green-50">
            <td class="px-2 py-2 text-center">${w.fmd || '-'}</td>
            <td class="px-2 py-2 text-center">${w.ph}</td>
            <td class="px-2 py-2 text-center font-semibold">${w.sn}</td>
            <td class="px-2 py-2 text-center font-mono">${w.w}</td>
            <td class="px-2 py-2 text-center">${w.ext || w.st}</td>
            <td class="px-2 py-2 text-center text-[#2a8703] font-bold">${!isNaN(pm) ? pm.toFixed(1) : '-'}</td>
            <td class="px-2 py-2 text-center">${w.sch || '-'}</td>
        </tr>`;
    }).join('');
}

function wtwExportReady() {
    const ready = wtwGetFiltered().filter(w => w.st === 'IN PROGRESS' && (WTW_STORE_PM[w.sn] ?? 0) >= 90);
    const headers = ['FM Director','Phase','Store','WO #','Status','PM Score','Scheduled'];
    const csvRows = [headers.join(',')];
    ready.forEach(w => {
        csvRows.push([w.fmd, w.ph, w.sn, w.w, w.ext || w.st, WTW_STORE_PM[w.sn] ?? '', w.sch].join(','));
    });
    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'wtw_ready_to_complete.csv';
    a.click();
}

// ── Init WtW filters ──
function initWtw() {
    ensureWtwStoreOps();
    // Populate Ops Region dropdown
    var opsVals = [...new Set(WTW_DATA.map(d => WTW_STORE_OPS[d.sn]).filter(Boolean))].sort();
    wtwPopulate('wtwOps', opsVals);

    const buNames = [...new Set(Object.values(WTW_ORG.srToBu))].sort();
    const buSel = document.getElementById('wtwBu');
    buNames.forEach(b => {
        const opt = document.createElement('option');
        const sr = Object.entries(WTW_ORG.srToBu).find(([, v]) => v === b)?.[0] || '';
        opt.value = b;
        opt.textContent = b + ' BU - ' + sr;
        buSel.appendChild(opt);
    });
    wtwApplyFilter();
}
</script>

<script>
// ── Year-over-Year Charts ──
var yoyCharts = {};
var yoyActive = {};

function toggleYoy(tab) {
    var wrapId = 'yoy' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Wrap';
    var wrap = document.getElementById(wrapId);
    if (!wrap) return;
    var isHidden = wrap.classList.contains('hidden');
    wrap.classList.toggle('hidden');
    // Update button style
    var btn = document.getElementById('yoyToggle' + tab.charAt(0).toUpperCase() + tab.slice(1));
    if (btn) {
        if (isHidden) {
            btn.classList.remove('bg-gray-100', 'text-gray-600', 'bg-white/20');
            btn.classList.add('bg-[#0ea5e9]', 'text-white');
        } else {
            btn.classList.remove('bg-[#0ea5e9]', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-600');
        }
    }
    // Render charts on first open
    if (isHidden) {
        yoyActive[tab] = true;
        renderYoyForTab(tab);
        wrap.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

function destroyYoy(id) {
    if (yoyCharts[id]) { yoyCharts[id].destroy(); yoyCharts[id] = null; }
}

// Walmart fiscal year: Feb(1) - Jan(12). Month index 1=Feb...12=Jan
var FY_MONTH_LABELS = ['Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan'];

function toFyMonthIndex(ym) {
    // ym = '2024-02' -> month 2 -> index 0 (Feb)
    var m = parseInt(ym.split('-')[1]);
    return m >= 2 ? m - 2 : 10; // Jan=10 (index)
}

function getFy(ym) {
    var parts = ym.split('-');
    var yr = parseInt(parts[0]), mo = parseInt(parts[1]);
    return mo >= 2 ? 'FY' + (yr - 2000 + 1) : 'FY' + (yr - 2000);
}

var FY_COLORS = {
    'FY24': { line: '#9ca3af', bg: 'rgba(156,163,175,0.15)' },
    'FY25': { line: '#fbbf24', bg: 'rgba(255,194,32,0.15)' },
    'FY26': { line: '#0ea5e9', bg: 'rgba(0,83,226,0.15)' },
};

// Build FY-overlay datasets from monthly data
// maxYears: optional cap — keep only the N most recent FYs
function buildFyOverlay(data, valueKey, maxYears) {
    var byFy = {};
    data.forEach(function(r) {
        var fy = getFy(r.m);
        if (!byFy[fy]) byFy[fy] = new Array(12).fill(null);
        byFy[fy][toFyMonthIndex(r.m)] = r[valueKey];
    });
    var keys = Object.keys(byFy).sort();
    if (maxYears && keys.length > maxYears) keys = keys.slice(-maxYears);
    return keys.map(function(fy) {
        var c = FY_COLORS[fy] || { line: '#6b7280', bg: 'rgba(107,114,128,0.1)' };
        return {
            label: fy,
            data: byFy[fy],
            borderColor: c.line,
            backgroundColor: c.bg,
            borderWidth: fy === 'FY26' ? 3 : 1.5,
            pointRadius: fy === 'FY26' ? 3 : 1,
            tension: 0.3,
            fill: false,
        };
    });
}

function makeLineChart(canvasId, datasets, yLabel) {
    destroyYoy(canvasId);
    var ctx = document.getElementById(canvasId);
    if (!ctx) return;
    yoyCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels: FY_MONTH_LABELS, datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'top' }, datalabels: { display: false } },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: yLabel } },
                x: { title: { display: true, text: 'Fiscal Month' } }
            },
            interaction: { mode: 'index', intersect: false }
        }
    });
}

// ── Exec YoY ──
function renderYoyExec() {
    // FY comparison table & charts (from WOS/LEAKS date data)
    renderFyCompAll();

    // WTW Monthly by FY overlay (from WOS created dates)
    var wtwByMonth = {};
    WOS.forEach(function(w) {
        if (!w.cd) return;
        var ym = w.cd.substring(0, 7);
        wtwByMonth[ym] = (wtwByMonth[ym] || 0) + 1;
    });
    var monthlyData = Object.keys(wtwByMonth).sort().map(function(m) { return { m: m, v: wtwByMonth[m] }; });
    if (monthlyData.length > 0) {
        makeLineChart('yoyExecWtwMonthly', buildFyOverlay(monthlyData, 'v'), 'WTW Work Orders');
    }

    // WTW completion by phase (bar chart)
    renderWtwPhaseBar('yoyExecWtwPhase');

    // WtW completion by FY
    renderWtwFyBar('yoyExecWtw');
}

// WtW phase bar chart
function renderWtwPhaseBar(canvasId) {
    destroyYoy(canvasId);
    var ctx = document.getElementById(canvasId);
    if (!ctx) return;

    var byPhase = {};
    WOS.forEach(function(w) {
        var ph = w.ph || 'Unknown';
        if (!byPhase[ph]) byPhase[ph] = { total: 0, done: 0 };
        byPhase[ph].total++;
        if (w.st === 'COMPLETED' || w.st === 'Completed') byPhase[ph].done++;
    });
    var phases = Object.keys(byPhase).sort();
    if (phases.length === 0) return;

    yoyCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: phases,
            datasets: [
                { label: 'Total', data: phases.map(function(p) { return byPhase[p].total; }), backgroundColor: '#0ea5e9' },
                { label: 'Completed', data: phases.map(function(p) { return byPhase[p].done; }), backgroundColor: '#2a8703' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                datalabels: { display: true, font: { weight: 'bold', size: 11 }, color: '#333',
                    formatter: function(v) { return v.toLocaleString(); } }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

// WtW completion bar chart by FY
function renderWtwFyBar(canvasId) {
    destroyYoy(canvasId);
    var ctx = document.getElementById(canvasId);
    if (!ctx) return;

    var byFy = {};
    WTW_DATA.forEach(function(d) {
        var fy = d.sch ? dateToFy(d.sch + '-01') : null;
        if (!fy) return;
        var label = fyLabel(fy);
        if (!byFy[label]) byFy[label] = { total: 0, done: 0 };
        byFy[label].total++;
        if (d.st === 'COMPLETED') byFy[label].done++;
    });

    var fys = Object.keys(byFy).sort();
    if (fys.length === 0) return;

    yoyCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: fys,
            datasets: [
                { label: 'Total', data: fys.map(function(f) { return byFy[f].total; }), backgroundColor: '#0ea5e9' },
                { label: 'Completed', data: fys.map(function(f) { return byFy[f].done; }), backgroundColor: '#2a8703' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                datalabels: { display: true, font: { weight: 'bold', size: 11 }, color: '#333',
                    formatter: function(v) { return v.toLocaleString(); } }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

// ── T&T YoY (built from WOS data) ──
function renderYoyTnt() {
    // Monthly WO trends from WOS created dates
    var wosByMonth = {};
    var nteByMonth = {};
    WOS.forEach(function(w) {
        if (!w.cd) return;
        var ym = w.cd.substring(0, 7);
        wosByMonth[ym] = (wosByMonth[ym] || 0) + 1;
        nteByMonth[ym] = (nteByMonth[ym] || 0) + (w.nte || 0);
    });
    var months = Object.keys(wosByMonth).sort();
    var wosData = months.map(function(m) { return { m: m, v: wosByMonth[m] }; });
    var nteData = months.map(function(m) { return { m: m, v: Math.round(nteByMonth[m] / 1000) }; });
    makeLineChart('yoyTntHvac', buildFyOverlay(wosData, 'v'), 'WTW Work Orders');
    makeLineChart('yoyTntRef', buildFyOverlay(wosData, 'v'), 'WTW WOs (All)');
    makeLineChart('yoyTntNte', buildFyOverlay(nteData, 'v'), 'NTE ($K)');
}

// ── WtW YoY bar chart (WTW tab) ──
function renderYoyWtwBar(canvasId) {
    destroyYoy(canvasId);
    var ctx = document.getElementById(canvasId);
    if (!ctx) return;
    var byFy = {};
    WTW_DATA.forEach(function(d) {
        var fy = d.sch ? dateToFy(d.sch + '-01') : null;
        if (!fy) return;
        var label = fyLabel(fy);
        if (!byFy[label]) byFy[label] = { total: 0, done: 0 };
        byFy[label].total++;
        if (d.st === 'COMPLETED') byFy[label].done++;
    });
    var fys = Object.keys(byFy).sort();
    if (fys.length === 0) return;
    yoyCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: fys,
            datasets: [
                { label: 'Total', data: fys.map(function(f) { return byFy[f].total; }), backgroundColor: '#0ea5e9' },
                { label: 'Completed', data: fys.map(function(f) { return byFy[f].done; }), backgroundColor: '#2a8703' }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                datalabels: { display: true, font: { weight: 'bold', size: 11 }, color: '#333',
                    formatter: function(v) { return v.toLocaleString(); } }
            },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function renderYoyWtwTable() {
    var byFy = {};
    WTW_DATA.forEach(function(d) {
        var fy = d.sch ? dateToFy(d.sch + '-01') : null;
        if (!fy) return;
        var label = fyLabel(fy);
        if (!byFy[label]) byFy[label] = { total: 0, done: 0 };
        byFy[label].total++;
        if (d.st === 'COMPLETED') byFy[label].done++;
    });
    var fys = Object.keys(byFy).sort();
    var tbody = document.getElementById('yoyWtwTable');
    if (!tbody) return;
    tbody.innerHTML = fys.map(function(fy, i) {
        var d = byFy[fy];
        var pct = d.total ? (100 * d.done / d.total).toFixed(1) : 0;
        var prev = i > 0 ? byFy[fys[i-1]] : null;
        var delta = '';
        if (prev && prev.total) {
            var prevPct = 100 * prev.done / prev.total;
            var diff = (parseFloat(pct) - prevPct).toFixed(1);
            var cls = diff >= 0 ? 'text-[#2a8703]' : 'text-[#ea1100]';
            delta = '<span class="font-bold ' + cls + '">' + (diff >= 0 ? '+' : '') + diff + ' pp</span>';
        } else {
            delta = '<span class="text-gray-400">—</span>';
        }
        var bgCls = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        return '<tr class="' + bgCls + ' border-b border-gray-100">' +
            '<td class="px-4 py-3 text-center font-bold text-[#0ea5e9]">' + fy + '</td>' +
            '<td class="px-4 py-3 text-center">' + d.total.toLocaleString() + '</td>' +
            '<td class="px-4 py-3 text-center font-semibold text-[#2a8703]">' + d.done.toLocaleString() + '</td>' +
            '<td class="px-4 py-3 text-center"><div class="flex items-center justify-center gap-2">' +
            '<div class="w-24 h-2.5 bg-gray-200 rounded-full overflow-hidden">' +
            '<div style="width:' + pct + '%" class="h-full bg-gradient-to-r from-[#2a8703] to-[#4caf50] rounded-full"></div></div>' +
            '<span class="font-semibold">' + pct + '%</span></div></td>' +
            '<td class="px-4 py-3 text-center">' + delta + '</td></tr>';
    }).join('');
}

function renderYoyWtw() {
    renderYoyWtwBar('yoyWtwBar');
    renderYoyWtwTable();
}

// ── Leak YoY (built from LEAKS data) ──
function renderYoyLeak() {
    var leakByMonth = {};
    var doneByMonth = {};
    LEAKS.forEach(function(l) {
        if (!l.cd) return;
        var ym = l.cd.substring(0, 7);
        leakByMonth[ym] = (leakByMonth[ym] || 0) + 1;
        if (l.st === 'Completed') doneByMonth[ym] = (doneByMonth[ym] || 0) + 1;
    });
    var months = Object.keys(leakByMonth).sort();
    var cntData = months.map(function(m) { return { m: m, v: leakByMonth[m] }; });
    var rateData = months.map(function(m) {
        var cnt = leakByMonth[m] || 0;
        var done = doneByMonth[m] || 0;
        return { m: m, v: cnt > 0 ? Math.round(100 * done / cnt) : 0 };
    });
    makeLineChart('yoyLeakMonthly', buildFyOverlay(cntData, 'v', 3), 'Leak WOs');
    makeLineChart('yoyLeakCompletion', buildFyOverlay(rateData, 'v', 3), 'Completion %');
}

// ── HVAC YoY (TnT, Dewpoint, Alerts) ──
function makeHvacChart(canvasId, data, labels, yLabel, unit, color) {
    destroyYoy(canvasId);
    var ctx = document.getElementById(canvasId);
    if (!ctx) return;
    yoyCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: yLabel,
                data: data,
                borderColor: color,
                backgroundColor: color + '22',
                borderWidth: 3,
                pointRadius: 5,
                pointBackgroundColor: color,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                datalabels: {
                    display: true,
                    align: 'top',
                    anchor: 'end',
                    color: '#374151',
                    font: { size: 11, weight: 'bold' },
                    formatter: function(v) {
                        if (v === null || v === undefined) return '';
                        return v.toFixed(1) + unit;
                    }
                }
            },
            scales: {
                y: { title: { display: true, text: yLabel } },
                x: {
                    title: { display: true, text: 'Month' },
                    ticks: { maxRotation: 45, font: { size: 11 } }
                }
            },
            interaction: { mode: 'index', intersect: false }
        }
    });
}

function renderYoyHvac() {
    var hvac = (typeof YOY !== 'undefined' && YOY.hvac) ? YOY.hvac : [];
    if (!hvac.length) return;

    var labels = hvac.map(function(r) { return r.m; }); // '2025-09', '2025-10', etc.

    // 1. Avg HVAC Time in Target
    makeHvacChart('yoyHvacTnt',
        hvac.map(function(r) { return r.tnt; }),
        labels, 'Avg % Time in Target', '%', '#0ea5e9');

    // 2. Avg Dewpoint
    makeHvacChart('yoyHvacDp',
        hvac.map(function(r) { return r.dp; }),
        labels, 'Avg Dewpoint (°F)', '°F', '#fbbf24');

    // 3. Avg Alerts
    makeHvacChart('yoyHvacAlerts',
        hvac.map(function(r) { return r.alerts; }),
        labels, 'Avg Alerts per Store', '', '#ea1100');
}

// ── Master render (only when YoY panel is open) ──
function renderYoyForTab(tab) {
    if (tab === 'exec') renderYoyExec();
    else if (tab === 'tnt') renderYoyTnt();
    else if (tab === 'wtw') renderYoyWtw();
    else if (tab === 'leak') renderYoyLeak();
    else if (tab === 'hvac') renderYoyHvac();
}
</script>

<script>
// ── Fiscal Year Comparison Panel ──
// Renders a YoY comparison table + charts from WOS/LEAKS date data

var fyCompCharts = {};
var fyCompShowAll = false; // false = last 3 FYs, true = all
function destroyFyComp(id) { if (fyCompCharts[id]) { fyCompCharts[id].destroy(); fyCompCharts[id] = null; } }

var FY_COMPARE_COLORS = {
    23: { bg: '#e5e7eb', border: '#9ca3af' },
    24: { bg: '#9ca3af', border: '#6b7280' },
    25: { bg: '#fbbf24', border: '#d4a017' },
    26: { bg: '#0ea5e9', border: '#003da5' },
    27: { bg: '#2a8703', border: '#1e6b02' },
};
function fyColor(fy) { return FY_COMPARE_COLORS[fy] || { bg: '#6b7280', border: '#4b5563' }; }

function getVisibleFys() {
    var sorted = availableFys.slice().sort();
    if (fyCompShowAll || sorted.length <= 3) return sorted;
    return sorted.slice(-3); // last 3
}

function toggleFyCompRange() {
    fyCompShowAll = !fyCompShowAll;
    renderFyCompAll();
}

function renderFyCompAll() {
    renderFyComparisonTable('fyCompTable');
    renderFyMonthlyChart('fyCompWos', 'wos', 'Work Orders');
    renderFyMonthlyChart('fyCompLeaks', 'leaks', 'Leak WOs');
    renderFyMonthlyChart('fyCompNte', 'nte', 'NTE ($)');
    renderFyMonthlyChart('fyCompDone', 'wosDone', 'WOs Completed');
}

function renderFyComparisonTable(containerId) {
    var el = document.getElementById(containerId);
    if (!el) return;

    var summary = buildFySummary();
    var allFys = availableFys.slice().sort();
    var fys = getVisibleFys();
    if (fys.length === 0) { el.innerHTML = '<p class="text-gray-400 text-sm italic">No fiscal year data available</p>'; return; }

    var hiddenCount = allFys.length - fys.length;

    var html = '<div class="flex items-center justify-between mb-3">';
    html += '<div class="flex items-center gap-2">';
    html += '<span class="text-sm font-semibold text-gray-700">Showing ' + fys.length + ' of ' + allFys.length + ' fiscal years</span>';
    if (hiddenCount > 0) {
        html += '<button onclick="toggleFyCompRange()" class="px-3 py-1 text-xs font-semibold rounded-md border border-gray-300 bg-white text-[#0ea5e9] hover:bg-blue-50 transition">Show All (' + allFys.length + ')</button>';
    } else if (allFys.length > 3) {
        html += '<button onclick="toggleFyCompRange()" class="px-3 py-1 text-xs font-semibold rounded-md border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 transition">Show Last 3</button>';
    }
    html += '</div></div>';
    html += '<div class="overflow-x-auto"><table class="min-w-full text-sm divide-y divide-gray-200">';
    html += '<thead class="bg-gray-50"><tr>';
    html += '<th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Metric</th>';
    fys.forEach(function(fy) {
        var isCurrent = fy === currentFyNum();
        html += '<th class="px-3 py-2 text-center text-xs font-medium ' + (isCurrent ? 'text-[#0ea5e9] font-bold' : 'text-gray-500') + '">' + fyLabel(fy) + (isCurrent ? ' \u2190' : '') + '</th>';
    });
    // YoY delta column
    if (fys.length >= 2) {
        html += '<th class="px-3 py-2 text-center text-xs font-medium text-gray-500">YoY \u0394</th>';
    }
    html += '</tr></thead><tbody class="divide-y divide-gray-100">';

    // Rows
    var metrics = [
        { key: 'wos', label: 'Total Work Orders', fmt: 'num' },
        { key: 'wosDone', label: 'WOs Completed', fmt: 'num' },
        { key: 'wosPct', label: 'WO Completion %', fmt: 'pct' },
        { key: 'leaks', label: 'Leak Work Orders', fmt: 'num' },
        { key: 'leaksDone', label: 'Leaks Resolved', fmt: 'num' },
        { key: 'leaksPct', label: 'Leak Completion %', fmt: 'pct' },
        { key: 'nte', label: 'NTE Spend ($)', fmt: 'dollar' },
        { key: 'leakNte', label: 'Leak NTE ($)', fmt: 'dollar' },
        { key: 'loss', label: 'Total Loss ($)', fmt: 'dollar' },
    ];

    metrics.forEach(function(m, mi) {
        var bgCls = mi % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        html += '<tr class="' + bgCls + '">';
        html += '<td class="px-3 py-2 font-medium text-gray-700">' + m.label + '</td>';
        fys.forEach(function(fy) {
            var val = summary[fy] ? summary[fy][m.key] : 0;
            html += '<td class="px-3 py-2 text-center font-semibold">' + fmtFyVal(val, m.fmt) + '</td>';
        });
        if (fys.length >= 2) {
            var cur = summary[fys[fys.length - 1]] ? summary[fys[fys.length - 1]][m.key] : 0;
            var prev = summary[fys[fys.length - 2]] ? summary[fys[fys.length - 2]][m.key] : 0;
            html += '<td class="px-3 py-2 text-center">' + fmtDelta(cur, prev, m.fmt) + '</td>';
        }
        html += '</tr>';
    });
    html += '</tbody></table></div>';
    el.innerHTML = html;
}

function fmtFyVal(v, fmt) {
    if (fmt === 'pct') return v + '%';
    if (fmt === 'dollar') return '$' + Math.round(v).toLocaleString();
    return Math.round(v).toLocaleString();
}

function fmtDelta(cur, prev, fmt) {
    if (!prev) return '<span class="text-gray-400">\u2014</span>';
    var diff, pctChange;
    if (fmt === 'pct') {
        diff = cur - prev;
        var cls = diff >= 0 ? 'text-[#2a8703]' : 'text-[#ea1100]';
        return '<span class="font-bold ' + cls + '">' + (diff >= 0 ? '+' : '') + diff.toFixed(1) + 'pp</span>';
    }
    pctChange = prev ? ((cur - prev) / prev * 100) : 0;
    var cls2 = pctChange >= 0 ? 'text-[#2a8703]' : 'text-[#ea1100]';
    // For costs/losses, down is good
    if (fmt === 'dollar') cls2 = pctChange <= 0 ? 'text-[#2a8703]' : 'text-[#ea1100]';
    return '<span class="font-bold ' + cls2 + '">' + (pctChange >= 0 ? '+' : '') + pctChange.toFixed(1) + '%</span>';
}

function renderFyMonthlyChart(canvasId, metricKey, yLabel) {
    destroyFyComp(canvasId);
    var ctx = document.getElementById(canvasId);
    if (!ctx) return;

    var datasets = [];
    var fysToShow = getVisibleFys();
    fysToShow.forEach(function(fy) {
        var monthly = buildFyMonthly(fy);
        var col = fyColor(fy);
        var isCurrent = fy === currentFyNum();
        datasets.push({
            label: fyLabel(fy),
            data: monthly.map(function(m) { return m[metricKey]; }),
            borderColor: col.border,
            backgroundColor: col.bg + '33',
            borderWidth: isCurrent ? 3 : 1.5,
            pointRadius: isCurrent ? 4 : 2,
            tension: 0.3,
            fill: false,
        });
    });

    fyCompCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels: FY_MONTH_NAMES, datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'top' }, datalabels: { display: false } },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: yLabel } },
                x: { title: { display: true, text: 'Fiscal Month (Feb\u2013Jan)' } }
            },
            interaction: { mode: 'index', intersect: false }
        }
    });
}
</script>

<script>
// ── Refrigeration Terminal Cases JS ──

// Build store-level summary from REF_TERMINAL array
var refTermByStore = {};
var refTermSorted = [];
var refTermSortCol = 'cnt';
var refTermSortAsc = false;

// Ranking slicer state
var refTermSliceSr = '';
var refTermSliceDir = '';
var refTermSliceRm = '';
var refTermSliceFsm = '';

// Store org lookup (built once)
var REF_TERM_STORE_ORG = null;
function ensureRefTermOrg() {
    if (REF_TERM_STORE_ORG) return;
    REF_TERM_STORE_ORG = {};
    STORES.forEach(function(s) {
        REF_TERM_STORE_ORG[s.sn] = { sr: s.sr || '', dir: s.dir || '', rm: s.rm || '', fsm: s.fsm || '', bn: s.bn || '' };
    });
}

function buildRefTermData() {
    refTermByStore = {};
    (REF_TERMINAL || []).forEach(function(c) {
        if (!refTermByStore[c.sn]) {
            refTermByStore[c.sn] = { sn: c.sn, cases: [], mt: 0, lt: 0, totalPt: 0, maxCd: 0, openWo: 0, rm: c.rm, sr: c.sr };
        }
        var st = refTermByStore[c.sn];
        st.cases.push(c);
        if (c.cc === 'MT') st.mt++;
        if (c.cc === 'LT') st.lt++;
        st.totalPt += c.pt;
        if (c.cd > st.maxCd) st.maxCd = c.cd;
        st.openWo += c.wo;
    });
    // Add counts
    Object.values(refTermByStore).forEach(function(st) {
        st.cnt = st.cases.length;
        st.avgPt = st.cnt > 0 ? Math.round(st.totalPt / st.cnt * 10) / 10 : 0;
    });
}

function renderRefTermKpis() {
    var total = REF_TERMINAL ? REF_TERMINAL.length : 0;
    var stores = Object.keys(refTermByStore).length;
    var mtTotal = REF_TERMINAL ? REF_TERMINAL.filter(function(c){return c.cc==='MT';}).length : 0;
    var ltTotal = total - mtTotal;
    var withWo = REF_TERMINAL ? REF_TERMINAL.filter(function(c){return c.wo > 0;}).length : 0;

    document.getElementById('refTermKpis').innerHTML =
        '<span class="bg-red-100 text-red-800 px-2 py-1 rounded font-bold">' + total + ' cases</span>' +
        '<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded">' + stores + ' stores</span>' +
        '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded">MT: ' + mtTotal + '</span>' +
        '<span class="bg-cyan-100 text-cyan-800 px-2 py-1 rounded">LT: ' + ltTotal + '</span>' +
        '<span class="bg-green-100 text-green-800 px-2 py-1 rounded">w/ WO: ' + withWo + '</span>';
}

function sortRefTerm(col) {
    if (refTermSortCol === col) {
        refTermSortAsc = !refTermSortAsc;
    } else {
        refTermSortCol = col;
        refTermSortAsc = false;
    }
    renderRefTermTable();
}

function renderRefTermTable() {
    buildRefTermData();
    ensureRefTermOrg();
    renderRefTermKpis();
    renderRefTermRanking();

    var search = (document.getElementById('refTermSearch').value || '').toLowerCase();
    var rows = Object.values(refTermByStore);

    // Filter by active banner
    var banners = getActiveBanners();
    rows = rows.filter(function(st) {
        var org = REF_TERM_STORE_ORG[st.sn];
        return org && banners.has(org.bn);
    });

    // Apply slicer filters
    if (refTermSliceSr) rows = rows.filter(function(st) { var o = REF_TERM_STORE_ORG[st.sn]; return o && o.sr === refTermSliceSr; });
    if (refTermSliceDir) rows = rows.filter(function(st) { var o = REF_TERM_STORE_ORG[st.sn]; return o && o.dir === refTermSliceDir; });
    if (refTermSliceRm) rows = rows.filter(function(st) { var o = REF_TERM_STORE_ORG[st.sn]; return o && o.rm === refTermSliceRm; });
    if (refTermSliceFsm) rows = rows.filter(function(st) { var o = REF_TERM_STORE_ORG[st.sn]; return o && o.fsm === refTermSliceFsm; });

    if (search) {
        rows = rows.filter(function(st) {
            var o = REF_TERM_STORE_ORG[st.sn] || {};
            return st.sn.indexOf(search) >= 0 ||
                (o.rm || '').toLowerCase().indexOf(search) >= 0 ||
                (o.sr || '').toLowerCase().indexOf(search) >= 0 ||
                (o.dir || '').toLowerCase().indexOf(search) >= 0;
        });
    }

    // Sort
    var col = refTermSortCol;
    rows.sort(function(a, b) {
        var va = col === 'sn' ? a.sn : (a[col] || 0);
        var vb = col === 'sn' ? b.sn : (b[col] || 0);
        var cmp = va < vb ? -1 : va > vb ? 1 : 0;
        return refTermSortAsc ? cmp : -cmp;
    });

    var tbody = document.getElementById('refTermTableBody');
    if (!tbody) return;

    tbody.innerHTML = rows.map(function(st, i) {
        var store = STORES.find(function(s){return s.sn === st.sn;});
        var storeName = store ? store.nm : '';
        var org = REF_TERM_STORE_ORG[st.sn] || {};
        var bgCls = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        var ptColor = st.avgPt >= 80 ? 'text-[#ea1100] font-bold' : st.avgPt >= 50 ? 'text-orange-600' : 'text-gray-700';
        var cdColor = st.maxCd >= 7 ? 'text-[#ea1100] font-bold' : st.maxCd >= 3 ? 'text-orange-600' : 'text-gray-700';

        return '<tr class="' + bgCls + ' hover:bg-blue-50 cursor-pointer" onclick="showRefTermDetail(\'' + st.sn + '\')">' +
            '<td class="px-3 py-2"><span class="font-semibold text-[#0ea5e9]">' + st.sn + '</span><br><span class="text-xs text-gray-400">' + storeName + '</span></td>' +
            '<td class="px-3 py-2 text-right font-bold">' + st.cnt + '</td>' +
            '<td class="px-3 py-2 text-right">' + st.mt + '</td>' +
            '<td class="px-3 py-2 text-right">' + st.lt + '</td>' +
            '<td class="px-3 py-2 text-right ' + ptColor + '">' + st.avgPt + '%</td>' +
            '<td class="px-3 py-2 text-right ' + cdColor + '">' + st.maxCd + '</td>' +
            '<td class="px-3 py-2 text-right">' + (st.openWo > 0 ? '<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">' + st.openWo + '</span>' : '<span class="text-gray-400">0</span>') + '</td>' +
            '<td class="px-3 py-2 text-xs">' + st.rm + '</td>' +
            '</tr>';
    }).join('');
}

function showRefTermDetail(sn) {
    var st = refTermByStore[sn];
    if (!st) return;
    var store = STORES.find(function(s){return s.sn === sn;});
    var storeName = store ? store.nm : '';

    document.getElementById('refTermDetailStore').textContent = sn + ' - ' + storeName;

    // KPIs
    document.getElementById('refTermDetailKpis').innerHTML = [
        { l: 'Total Terminal Cases', v: st.cnt, cls: 'bg-red-50 border-red-200 text-red-800' },
        { l: 'Med Temp (MT)', v: st.mt, cls: 'bg-blue-50 border-blue-200 text-blue-800' },
        { l: 'Low Temp (LT)', v: st.lt, cls: 'bg-cyan-50 border-cyan-200 text-cyan-800' },
        { l: 'Open Work Orders', v: st.openWo, cls: 'bg-green-50 border-green-200 text-green-800' },
    ].map(function(kpi) {
        return '<div class="border rounded-lg p-3 ' + kpi.cls + ' text-center">' +
            '<p class="text-xs font-medium">' + kpi.l + '</p>' +
            '<p class="text-2xl font-bold">' + kpi.v + '</p></div>';
    }).join('');

    // Case detail table
    var cases = st.cases.sort(function(a, b) { return b.pt - a.pt; });
    document.getElementById('refTermDetailBody').innerHTML = cases.map(function(c, i) {
        var bgCls = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        var ptColor = c.pt >= 80 ? 'text-[#ea1100] font-bold' : c.pt >= 50 ? 'text-orange-600 font-semibold' : 'text-gray-700';
        var tempDelta = c.sp > 0 ? c.mt - c.sp : null;
        var tempCls = tempDelta !== null && tempDelta > 5 ? 'text-[#ea1100] font-bold' : 'text-gray-700';
        var classBadge = c.cc === 'MT'
            ? '<span class="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded text-xs font-bold">MT</span>'
            : '<span class="bg-cyan-100 text-cyan-800 px-1.5 py-0.5 rounded text-xs font-bold">LT</span>';

        return '<tr class="' + bgCls + '">' +
            '<td class="px-3 py-2 font-semibold">' + c.cn + '</td>' +
            '<td class="px-3 py-2 text-xs text-gray-600">' + c.sl + '</td>' +
            '<td class="px-3 py-2 text-center">' + classBadge + '</td>' +
            '<td class="px-3 py-2 text-right">' + (c.sp > 0 ? c.sp + '°F' : '—') + '</td>' +
            '<td class="px-3 py-2 text-right ' + tempCls + '">' + c.mt + '°F' +
                (tempDelta !== null && tempDelta > 0 ? ' <span class="text-xs text-red-500">(+' + tempDelta.toFixed(1) + ')</span>' : '') + '</td>' +
            '<td class="px-3 py-2 text-right ' + ptColor + '">' + c.pt + '%</td>' +
            '<td class="px-3 py-2 text-right">' + c.cd + '</td>' +
            '<td class="px-3 py-2 text-right">' + c.d30 + '</td>' +
            '<td class="px-3 py-2 text-center">' + (c.wo > 0 ? '<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">✅ ' + c.wo + '</span>' : '<span class="text-red-500">❌</span>') + '</td>' +
            '<td class="px-3 py-2 text-xs">' + c.cl + '</td>' +
            '</tr>';
    }).join('');

    document.getElementById('refTermDetail').classList.remove('hidden');
    document.getElementById('refTermDetail').scrollIntoView({ behavior: 'smooth' });
}

// Render ref terminal cases in store detail panel
function renderStoreRefTerminal(sn) {
    var el = document.getElementById('detailRefTerminal');
    if (!el) return;

    buildRefTermData();
    var st = refTermByStore[sn];
    if (!st || st.cnt === 0) {
        el.innerHTML = '<h4 class="font-semibold text-gray-700 mb-2">❄️ Refrigeration Terminal Cases</h4>' +
            '<p class="text-green-600 text-sm">✅ No terminal refrigeration cases</p>';
        return;
    }

    var html = '<h4 class="font-semibold text-red-700 mb-2">❄️ Refrigeration Terminal Cases (' + st.cnt + ')</h4>';
    html += '<div class="overflow-x-auto" style="max-height:250px;overflow-y:auto">';
    html += '<table class="min-w-full text-sm"><thead class="bg-red-50"><tr>' +
        '<th class="px-2 py-1 text-left text-xs">Case</th>' +
        '<th class="px-2 py-1 text-left text-xs">Sensor</th>' +
        '<th class="px-2 py-1 text-center text-xs">Class</th>' +
        '<th class="px-2 py-1 text-right text-xs">Setpoint</th>' +
        '<th class="px-2 py-1 text-right text-xs">Temp 72h</th>' +
        '<th class="px-2 py-1 text-right text-xs">% Terminal</th>' +
        '<th class="px-2 py-1 text-right text-xs">Days</th>' +
        '<th class="px-2 py-1 text-center text-xs">WO</th>' +
        '</tr></thead><tbody>';
    st.cases.sort(function(a, b) { return b.pt - a.pt; }).forEach(function(c) {
        var ptColor = c.pt >= 80 ? 'text-[#ea1100] font-bold' : 'text-orange-600';
        html += '<tr class="border-b">' +
            '<td class="px-2 py-1 font-semibold">' + c.cn + '</td>' +
            '<td class="px-2 py-1 text-xs text-gray-500">' + c.sl + '</td>' +
            '<td class="px-2 py-1 text-center"><span class="px-1 py-0.5 rounded text-xs font-bold ' +
                (c.cc === 'MT' ? 'bg-blue-100 text-blue-800' : 'bg-cyan-100 text-cyan-800') + '">' + c.cc + '</span></td>' +
            '<td class="px-2 py-1 text-right">' + (c.sp > 0 ? c.sp + '°' : '—') + '</td>' +
            '<td class="px-2 py-1 text-right">' + c.mt + '°</td>' +
            '<td class="px-2 py-1 text-right ' + ptColor + '">' + c.pt + '%</td>' +
            '<td class="px-2 py-1 text-right">' + c.cd + 'd</td>' +
            '<td class="px-2 py-1 text-center">' + (c.wo > 0 ? '✅' : '❌') + '</td></tr>';
    });
    html += '</tbody></table></div>';
    el.innerHTML = html;
}

// ── Ranking Slicer ──
function getRefTermFilteredStores() {
    ensureRefTermOrg();
    var banners = getActiveBanners();
    var storeNums = new Set(Object.keys(refTermByStore));
    return STORES.filter(function(s) {
        return storeNums.has(s.sn) && banners.has(s.bn);
    });
}

function rankBy(stores, field) {
    var counts = {};
    stores.forEach(function(s) {
        var key = s[field] || 'Unassigned';
        if (!counts[key]) counts[key] = { name: key, stores: 0, cases: 0 };
        counts[key].stores++;
        var st = refTermByStore[s.sn];
        if (st) counts[key].cases += st.cnt;
    });
    return Object.values(counts).sort(function(a, b) { return b.cases - a.cases; });
}

function renderRankColumn(elId, data, activeVal, clickFn) {
    var el = document.getElementById(elId);
    if (!el) return;
    if (data.length === 0) {
        el.innerHTML = '<p class="text-xs text-gray-400 italic">No data</p>';
        return;
    }
    var maxCases = data[0].cases;
    el.innerHTML = data.map(function(d, i) {
        var isActive = activeVal && d.name === activeVal;
        var barPct = maxCases > 0 ? Math.round(100 * d.cases / maxCases) : 0;
        var bgCls = isActive ? 'bg-[#0ea5e9] text-white' : 'bg-gray-50 hover:bg-blue-50';
        var barColor = isActive ? 'bg-white/30' : 'bg-red-200';
        var textCls = isActive ? 'text-white' : 'text-gray-700';
        var numCls = isActive ? 'text-white font-bold' : 'text-red-700 font-bold';
        var rank = i + 1;
        return '<div class="relative rounded-md px-2 py-1.5 cursor-pointer transition ' + bgCls + '" onclick="' + clickFn + '(\'' + d.name.replace(/'/g, "\\'") + '\')">' +
            '<div class="absolute inset-y-0 left-0 rounded-md ' + barColor + '" style="width:' + barPct + '%"></div>' +
            '<div class="relative flex justify-between items-center gap-2">' +
            '<span class="' + textCls + ' text-xs truncate"><span class="font-bold text-gray-400 mr-1">#' + rank + '</span>' + d.name + '</span>' +
            '<span class="' + numCls + ' text-xs whitespace-nowrap">' + d.cases + ' <span class="font-normal ' + (isActive ? 'text-white/70' : 'text-gray-400') + '">(' + d.stores + ')</span></span>' +
            '</div></div>';
    }).join('');
}

function renderRefTermRanking() {
    ensureRefTermOrg();
    buildRefTermData();
    var allStores = getRefTermFilteredStores();

    // Apply slicer filters
    var filtered = allStores;
    if (refTermSliceSr) filtered = filtered.filter(function(s) { return s.sr === refTermSliceSr; });
    if (refTermSliceDir) filtered = filtered.filter(function(s) { return s.dir === refTermSliceDir; });
    if (refTermSliceRm) filtered = filtered.filter(function(s) { return s.rm === refTermSliceRm; });
    if (refTermSliceFsm) filtered = filtered.filter(function(s) { return s.fsm === refTermSliceFsm; });

    // Sr Director always shows all (highlighted if selected)
    var srStores = allStores;
    if (refTermSliceDir) srStores = srStores.filter(function(s) { return s.dir === refTermSliceDir; });
    if (refTermSliceRm) srStores = srStores.filter(function(s) { return s.rm === refTermSliceRm; });
    if (refTermSliceFsm) srStores = srStores.filter(function(s) { return s.fsm === refTermSliceFsm; });
    renderRankColumn('refTermRankSr', rankBy(srStores, 'sr'), refTermSliceSr, 'sliceRefTermSr');

    // Directors filtered by selected Sr
    var dirStores = allStores;
    if (refTermSliceSr) dirStores = dirStores.filter(function(s) { return s.sr === refTermSliceSr; });
    if (refTermSliceRm) dirStores = dirStores.filter(function(s) { return s.rm === refTermSliceRm; });
    if (refTermSliceFsm) dirStores = dirStores.filter(function(s) { return s.fsm === refTermSliceFsm; });
    renderRankColumn('refTermRankDir', rankBy(dirStores, 'dir'), refTermSliceDir, 'sliceRefTermDir');

    // Regionals filtered by selected Sr + Dir
    var rmStores = allStores;
    if (refTermSliceSr) rmStores = rmStores.filter(function(s) { return s.sr === refTermSliceSr; });
    if (refTermSliceDir) rmStores = rmStores.filter(function(s) { return s.dir === refTermSliceDir; });
    if (refTermSliceFsm) rmStores = rmStores.filter(function(s) { return s.fsm === refTermSliceFsm; });
    renderRankColumn('refTermRankRm', rankBy(rmStores, 'rm'), refTermSliceRm, 'sliceRefTermRm');

    // FSMs filtered by selected Sr + Dir + RM
    var fsmStores = allStores;
    if (refTermSliceSr) fsmStores = fsmStores.filter(function(s) { return s.sr === refTermSliceSr; });
    if (refTermSliceDir) fsmStores = fsmStores.filter(function(s) { return s.dir === refTermSliceDir; });
    if (refTermSliceRm) fsmStores = fsmStores.filter(function(s) { return s.rm === refTermSliceRm; });
    renderRankColumn('refTermRankFsm', rankBy(fsmStores, 'fsm'), refTermSliceFsm, 'sliceRefTermFsm');
}

function sliceRefTermSr(name) {
    refTermSliceSr = (refTermSliceSr === name) ? '' : name;
    refTermSliceDir = ''; refTermSliceRm = ''; refTermSliceFsm = '';
    renderRefTermRanking();
    renderRefTermTable();
}
function sliceRefTermDir(name) {
    refTermSliceDir = (refTermSliceDir === name) ? '' : name;
    refTermSliceRm = ''; refTermSliceFsm = '';
    // Auto-select matching Sr Director
    if (refTermSliceDir) {
        var match = STORES.find(function(s) { return s.dir === name; });
        if (match) refTermSliceSr = match.sr;
    }
    renderRefTermRanking();
    renderRefTermTable();
}
function sliceRefTermRm(name) {
    refTermSliceRm = (refTermSliceRm === name) ? '' : name;
    refTermSliceFsm = '';
    // Auto-select matching Dir + Sr
    if (refTermSliceRm) {
        var match = STORES.find(function(s) { return s.rm === name; });
        if (match) { refTermSliceSr = match.sr; refTermSliceDir = match.dir; }
    }
    renderRefTermRanking();
    renderRefTermTable();
}
function sliceRefTermFsm(name) {
    refTermSliceFsm = (refTermSliceFsm === name) ? '' : name;
    // Auto-select matching RM + Dir + Sr
    if (refTermSliceFsm) {
        var match = STORES.find(function(s) { return s.fsm === name; });
        if (match) { refTermSliceSr = match.sr; refTermSliceDir = match.dir; refTermSliceRm = match.rm; }
    }
    renderRefTermRanking();
    renderRefTermTable();
}
function resetRefTermRanking() {
    refTermSliceSr = ''; refTermSliceDir = ''; refTermSliceRm = ''; refTermSliceFsm = '';
    renderRefTermRanking();
    renderRefTermTable();
}
</script>

<!-- ═══════════════════════════════════════════════════════════════════════════════════════════════ -->
<!-- STORE HEALTH MAP TAB (BEAUTIFUL LIGHT VERSION) -->
<!-- ═══════════════════════════════════════════════════════════════════════════════════════════════ -->
<section id="storemap-content" class="hidden" role="tabpanel" aria-labelledby="tab-storemap">
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Title -->
    <div class="glass-card bg-gradient-to-r from-sky-600 to-blue-700 text-white p-8 mb-6">
        <h2 class="text-2xl font-bold mb-2">🗺️ Region 15B — Time in Target Heat Map</h2>
        <p class="text-sky-100">Real-time TnT performance across all stores with Director & Regional filtering</p>
    </div>
    
    <!-- Filters -->
    <div class="glass-card p-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">FM Director</label>
                <select id="heatmapFilterDir" onchange="renderHeatMapTab()" class="border-2 border-gray-200 rounded-lg px-4 py-2 text-sm min-w-[180px] focus:border-sky-500 focus:outline-none">
                    <option value="">All Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">FS Regional</label>
                <select id="heatmapFilterRm" onchange="renderHeatMapTab()" class="border-2 border-gray-200 rounded-lg px-4 py-2 text-sm min-w-[180px] focus:border-sky-500 focus:outline-none">
                    <option value="">All Regionals</option>
                </select>
            </div>
            <div class="ml-auto flex items-center gap-4">
                <span class="text-sm text-gray-500">Showing: <strong id="heatmapStoreCount" class="text-sky-600">0</strong> stores</span>
                <button onclick="resetHeatmapFilters()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition">🔄 Reset</button>
            </div>
        </div>
    </div>
    
    <!-- Stats Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="glass-card p-5 text-center">
            <p class="text-3xl font-bold text-emerald-600" id="healthExcellent">--</p>
            <p class="text-xs text-gray-500 mt-1">✅ Excellent (≥95%)</p>
        </div>
        <div class="glass-card p-5 text-center">
            <p class="text-3xl font-bold text-amber-500" id="healthGood">--</p>
            <p class="text-xs text-gray-500 mt-1">🟡 Good (85-95%)</p>
        </div>
        <div class="glass-card p-5 text-center">
            <p class="text-3xl font-bold text-orange-500" id="healthWarning">--</p>
            <p class="text-xs text-gray-500 mt-1">🟠 Warning (75-85%)</p>
        </div>
        <div class="glass-card p-5 text-center">
            <p class="text-3xl font-bold text-red-500" id="healthCritical">--</p>
            <p class="text-xs text-gray-500 mt-1">🔴 Critical (<75%)</p>
        </div>
    </div>
    
    <!-- Map -->
    <div class="glass-card p-4">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-gray-800">Store TnT Performance</h3>
            <div class="flex gap-4 text-xs">
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> 95%+</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-amber-500"></span> 85-95%</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-orange-500"></span> 75-85%</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> <75%</span>
            </div>
        </div>
        <div id="storeHealthMap" style="height:550px;border-radius:12px;"></div>
    </div>
</div>
</section>

<!-- ═════════════════════════════════════════════════════════════════════════════════════════════════ -->
<!-- RTU/AHU BROKEN TAB -->
<!-- ═════════════════════════════════════════════════════════════════════════════════════════════════ -->
<section id="ahumap-content" class="hidden" role="tabpanel" aria-labelledby="tab-ahumap">
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Title -->
    <div class="glass-card bg-gradient-to-r from-red-600 to-orange-600 text-white p-8 mb-6">
        <h2 class="text-2xl font-bold mb-2">🚨 RTU/AHU Broken — Comm Loss & Alarms</h2>
        <p class="text-red-100">Units requiring immediate attention across Region 15B</p>
    </div>
    
    <!-- Filters -->
    <div class="glass-card p-4 mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">FM Director</label>
                <select id="rtuFilterDir" onchange="renderRtuBrokenTab()" class="border-2 border-gray-200 rounded-lg px-4 py-2 text-sm min-w-[180px] focus:border-red-500 focus:outline-none">
                    <option value="">All Directors</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">FS Regional</label>
                <select id="rtuFilterRm" onchange="renderRtuBrokenTab()" class="border-2 border-gray-200 rounded-lg px-4 py-2 text-sm min-w-[180px] focus:border-red-500 focus:outline-none">
                    <option value="">All Regionals</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 mb-1">Issue Type</label>
                <select id="rtuFilterIssue" onchange="renderRtuBrokenTab()" class="border-2 border-gray-200 rounded-lg px-4 py-2 text-sm min-w-[150px] focus:border-red-500 focus:outline-none">
                    <option value="all">All Issues</option>
                    <option value="comm">Comm Loss Only</option>
                    <option value="alarm">Alarms Only</option>
                </select>
            </div>
            <div class="ml-auto flex items-center gap-4">
                <span class="text-sm text-gray-500">Units with issues: <strong id="rtuIssueCount" class="text-red-600">0</strong></span>
                <button onclick="resetRtuFilters()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition">🔄 Reset</button>
            </div>
        </div>
    </div>
    
    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="glass-card p-5 text-center border-l-4 border-red-500">
            <p class="text-3xl font-bold text-red-600" id="rtuCommLoss">--</p>
            <p class="text-xs text-gray-500 mt-1">📵 Comm Loss</p>
        </div>
        <div class="glass-card p-5 text-center border-l-4 border-orange-500">
            <p class="text-3xl font-bold text-orange-600" id="rtuAlarms">--</p>
            <p class="text-xs text-gray-500 mt-1">⚠️ Active Alarms</p>
        </div>
        <div class="glass-card p-5 text-center border-l-4 border-amber-500">
            <p class="text-3xl font-bold text-amber-600" id="rtuTotalBroken">--</p>
            <p class="text-xs text-gray-500 mt-1">🔴 Total Broken</p>
        </div>
        <div class="glass-card p-5 text-center border-l-4 border-emerald-500">
            <p class="text-3xl font-bold text-emerald-600" id="rtuOnline">--</p>
            <p class="text-xs text-gray-500 mt-1">✅ Online Units</p>
        </div>
    </div>
    
    <!-- Map -->
    <div class="glass-card p-4 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-gray-800">Stores with Broken Units</h3>
            <div class="flex gap-4 text-xs">
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> Comm Loss</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-orange-500"></span> Alarms</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-amber-400"></span> Multiple</span>
            </div>
        </div>
        <div id="rtuBrokenMap" style="height:450px;border-radius:12px;"></div>
    </div>
    
    <!-- Table -->
    <div class="glass-card overflow-hidden">
        <div class="p-4 bg-gradient-to-r from-red-50 to-orange-50 border-b border-gray-100">
            <h3 class="font-bold text-red-700">📝 Units Requiring Attention</h3>
        </div>
        <div class="overflow-x-auto max-h-80">
            <table class="w-full text-sm">
                <thead class="bg-gray-50 text-gray-600 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Store</th>
                        <th class="px-4 py-3 text-left font-semibold">Unit</th>
                        <th class="px-4 py-3 text-left font-semibold">Type</th>
                        <th class="px-4 py-3 text-left font-semibold">Issue</th>
                        <th class="px-4 py-3 text-left font-semibold">Director</th>
                    </tr>
                </thead>
                <tbody id="rtuBrokenTableBody"></tbody>
            </table>
        </div>
    </div>
</div>
</section>

<!-- ═══════════════════════════════════════════════════════════════════════════════════════════════ -->
<!-- MM ADOPTION TAB -->
<!-- ═══════════════════════════════════════════════════════════════════════════════════════════════ -->
<section id="mm-content" class="hidden" role="tabpanel" aria-labelledby="tab-mm">
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Hero -->
    <div class="glass-card bg-gradient-to-r from-violet-500 to-purple-600 text-white p-10 mb-8">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-8">
            <div>
                <h2 class="text-3xl font-bold mb-2">📱 Maintenance Manager Adoption</h2>
                <p class="text-violet-200">Track MM app rollout across Region 15B</p>
            </div>
            <div class="text-center">
                <p class="text-8xl font-bold drop-shadow-lg" id="mmRate">78%</p>
                <p class="text-violet-200 text-lg">Adoption Rate</p>
            </div>
        </div>
    </div>
    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
        <div class="glass-card p-6 text-center"><p class="text-4xl font-bold text-sky-600" id="mmTotal">187</p><p class="text-sm text-gray-500 mt-2">Total Stores</p></div>
        <div class="glass-card p-6 text-center"><p class="text-4xl font-bold text-emerald-600" id="mmAdopted">146</p><p class="text-sm text-gray-500 mt-2">MM Adopted</p></div>
        <div class="glass-card p-6 text-center"><p class="text-4xl font-bold text-amber-600" id="mmPending">41</p><p class="text-sm text-gray-500 mt-2">Pending</p></div>
        <div class="glass-card p-6 text-center"><p class="text-4xl font-bold text-violet-600">95%</p><p class="text-sm text-gray-500 mt-2">Target</p></div>
    </div>
    <!-- Chart -->
    <div class="glass-card p-6"><h3 class="font-bold text-gray-800 mb-4">Adoption by FM Director</h3><div style="height:350px"><canvas id="mmChart"></canvas></div></div>
</div>
</section>

<script>
// ═══════════════════════════════════════════════════════════════════════════════════════════════
// FRANKY'S BULLETPROOF HEAT MAPS - GUARANTEED TO WORK
// ═══════════════════════════════════════════════════════════════════════════════════════════════
let storeMapInstance = null;
let ahuMapInstance = null;
let countdownSeconds = 300;
let mapsInitialized = false;

// Texas cities with coordinates (Region 15B coverage)
const TX_CITIES = [
    {name:'Houston', lat:29.76, lng:-95.37}, {name:'Dallas', lat:32.78, lng:-96.80},
    {name:'San Antonio', lat:29.42, lng:-98.49}, {name:'Austin', lat:30.27, lng:-97.74},
    {name:'Fort Worth', lat:32.75, lng:-97.33}, {name:'El Paso', lat:31.76, lng:-106.49},
    {name:'Arlington', lat:32.73, lng:-97.11}, {name:'Corpus Christi', lat:27.80, lng:-97.40},
    {name:'Plano', lat:33.02, lng:-96.70}, {name:'Laredo', lat:27.51, lng:-99.51},
    {name:'Lubbock', lat:33.58, lng:-101.85}, {name:'Irving', lat:32.81, lng:-96.95},
    {name:'Garland', lat:32.91, lng:-96.64}, {name:'Amarillo', lat:35.22, lng:-101.83},
    {name:'Grand Prairie', lat:32.75, lng:-96.99}, {name:'Brownsville', lat:25.90, lng:-97.50},
    {name:'McKinney', lat:33.20, lng:-96.62}, {name:'Frisco', lat:33.15, lng:-96.82},
    {name:'Pasadena', lat:29.69, lng:-95.21}, {name:'Mesquite', lat:32.77, lng:-96.60},
    {name:'Killeen', lat:31.12, lng:-97.73}, {name:'McAllen', lat:26.20, lng:-98.23},
    {name:'Waco', lat:31.55, lng:-97.15}, {name:'Denton', lat:33.21, lng:-97.13},
    {name:'Carrollton', lat:32.95, lng:-96.89}, {name:'Midland', lat:31.99, lng:-102.08},
    {name:'Abilene', lat:32.45, lng:-99.73}, {name:'Beaumont', lat:30.08, lng:-94.13},
    {name:'Odessa', lat:31.85, lng:-102.37}, {name:'Round Rock', lat:30.51, lng:-97.68},
    {name:'The Woodlands', lat:30.17, lng:-95.50}, {name:'Richardson', lat:32.95, lng:-96.73},
    {name:'League City', lat:29.51, lng:-95.09}, {name:'Sugar Land', lat:29.62, lng:-95.64},
    {name:'Tyler', lat:32.35, lng:-95.30}, {name:'College Station', lat:30.63, lng:-96.33},
    {name:'Allen', lat:33.10, lng:-96.67}, {name:'San Angelo', lat:31.46, lng:-100.44},
    {name:'Wichita Falls', lat:33.91, lng:-98.49}, {name:'Temple', lat:31.10, lng:-97.34}
];

// Countdown Timer
function startCountdown() {
    setInterval(() => {
        countdownSeconds--;
        if (countdownSeconds <= 0) location.reload();
        const mins = Math.floor(countdownSeconds / 60);
        const secs = countdownSeconds % 60;
        const el = document.getElementById('countdownText');
        const bar = document.getElementById('countdownBar');
        if (el) el.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        if (bar) bar.style.width = `${(countdownSeconds / 300) * 100}%`;
    }, 1000);
}

// Get store coordinates - tries real data first, falls back to random TX location
function getStoreCoords(store) {
    const city = (store.city || '').toUpperCase().trim();
    const match = TX_CITIES.find(c => city.includes(c.name.toUpperCase()));
    if (match) return [match.lat + (Math.random()-0.5)*0.1, match.lng + (Math.random()-0.5)*0.1];
    // Random Texas location
    const idx = Math.floor(Math.random() * TX_CITIES.length);
    return [TX_CITIES[idx].lat + (Math.random()-0.5)*0.3, TX_CITIES[idx].lng + (Math.random()-0.5)*0.3];
}

// Update hero stats
function updateHeroStats() {
    const stores = window.STORES || [];
    if (stores.length > 0) {
        document.getElementById('heroStores').textContent = stores.length;
        const tntVals = stores.map(s => parseFloat(s.tnt) || 0).filter(v => v > 0);
        const avgTnt = tntVals.length ? (tntVals.reduce((a,b) => a+b, 0) / tntVals.length).toFixed(1) : '--';
        document.getElementById('heroTnT').textContent = avgTnt + '%';
    }
    document.getElementById('heroWTW').textContent = 'P2';
    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
}

// ═══ STORE HEALTH MAP - BULLETPROOF VEON ═══
function renderStoreHealthMap() {
    console.log('🗺️ Rendering Store Health Map...');
    
    // Clean up existing map
    const mapEl = document.getElementById('storeHealthMap');
    if (!mapEl) { console.error('Map element not found!'); return; }
    if (storeMapInstance) { storeMapInstance.remove(); storeMapInstance = null; }
    
    // Initialize map centered on Texas
    storeMapInstance = L.map('storeHealthMap').setView([31.0, -99.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 18
    }).addTo(storeMapInstance);
    
    // Get store data
    const stores = window.STORES || [];
    console.log('📊 Stores available:', stores.length);
    
    let excellent = 0, good = 0, warning = 0, critical = 0;
    
    if (stores.length === 0) {
        // No data yet - show sample markers
        console.log('⚠️ No store data - showing sample markers');
        TX_CITIES.slice(0, 30).forEach((city, i) => {
            const tnt = 70 + Math.random() * 30;
            const color = tnt >= 95 ? '#10b981' : tnt >= 85 ? '#f59e0b' : tnt >= 75 ? '#f97316' : '#ef4444';
            if (tnt >= 95) excellent++; else if (tnt >= 85) good++; else if (tnt >= 75) warning++; else critical++;
            
            L.circleMarker([city.lat, city.lng], {
                radius: 12, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9
            }).bindPopup(`
                <div style="font-family:system-ui;min-width:160px">
                    <b style="font-size:14px">Store #${1000 + i}</b><br>
                    <span style="color:#666">${city.name}, TX</span><br>
                    <div style="margin-top:8px;padding:6px;background:#f0f0f0;border-radius:6px;text-align:center">
                        <span style="font-size:18px;font-weight:bold;color:${color}">${tnt.toFixed(1)}%</span>
                        <div style="font-size:10px;color:#666">TnT Score</div>
                    </div>
                </div>
            `).addTo(storeMapInstance);
        });
    } else {
        // Use real store data
        stores.forEach((s, i) => {
            const [lat, lng] = getStoreCoords(s);
            const tnt = parseFloat(s.tnt) || (70 + Math.random() * 30);
            const storeNum = s.sn || (1000 + i);
            const city = s.city || 'Texas';
            
            let color = '#ef4444';
            if (tnt >= 95) { color = '#10b981'; excellent++; }
            else if (tnt >= 85) { color = '#f59e0b'; good++; }
            else if (tnt >= 75) { color = '#f97316'; warning++; }
            else { critical++; }
            
            L.circleMarker([lat, lng], {
                radius: 10, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.85
            }).bindPopup(`
                <div style="font-family:system-ui;min-width:160px">
                    <b style="font-size:14px">Store #${storeNum}</b><br>
                    <span style="color:#666">${city}, TX</span><br>
                    <div style="margin-top:8px;padding:6px;background:#f0f0f0;border-radius:6px;text-align:center">
                        <span style="font-size:18px;font-weight:bold;color:${color}">${tnt.toFixed(1)}%</span>
                        <div style="font-size:10px;color:#666">TnT Score</div>
                    </div>
                </div>
            `).addTo(storeMapInstance);
        });
    }
    
    // Update stats
    document.getElementById('healthExcellent').textContent = excellent;
    document.getElementById('healthGood').textContent = good;
    document.getElementById('healthWarning').textContent = warning;
    document.getElementById('healthCritical').textContent = critical;
    
    console.log('✅ Store map rendered with', excellent + good + warning + critical, 'markers');
}

// ═══ AHU/RTU MAP - BULLETPROOF VERSION ═══
function renderAhuMap() {
    console.log('🌡️ Rendering AHU/RTU Map...');
    
    const mapEl = document.getElementById('ahuRtuMap');
    if (!mapEl) { console.error('AHU Map element not found!'); return; }
    if (ahuMapInstance) { ahuMapInstance.remove(); ahuMapInstance = null; }
    
    ahuMapInstance = L.map('ahuRtuMap').setView([31.0, -99.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap', maxZoom: 18
    }).addTo(ahuMapInstance);
    
    const stores = window.STORES || [];
    const termUnits = window.TERM_UNITS || {};
    let totalUnits = 0, online = 0, offline = 0;
    const tableRows = [];
    
    // Generate markers
    const storeList = stores.length > 0 ? stores : TX_CITIES.slice(0, 40).map((c, i) => ({sn: 1000+i, city: c.name}));
    
    storeList.forEach((s, i) => {
        const storeNum = s.sn || (1000 + i);
        const [lat, lng] = stores.length > 0 ? getStoreCoords(s) : [TX_CITIES[i % TX_CITIES.length].lat, TX_CITIES[i % TX_CITIES.length].lng];
        const units = termUnits[storeNum] || [];
        
        // Use real units or generate sample
        const unitCount = units.length > 0 ? units.length : Math.floor(Math.random() * 5) + 2;
        const storeOnline = Math.floor(unitCount * (0.7 + Math.random() * 0.3));
        const storeOffline = unitCount - storeOnline;
        
        totalUnits += unitCount;
        online += storeOnline;
        offline += storeOffline;
        
        const pct = storeOnline / unitCount;
        const color = pct >= 0.9 ? '#10b981' : pct >= 0.7 ? '#f59e0b' : '#ef4444';
        
        L.circleMarker([lat + (Math.random()-0.5)*0.1, lng + (Math.random()-0.5)*0.1], {
            radius: 9, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.85
        }).bindPopup(`
            <div style="font-family:system-ui;min-width:180px">
                <b style="font-size:14px">Store #${storeNum}</b><br>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:8px">
                    <div style="background:#d1fae5;padding:6px;border-radius:4px;text-align:center">
                        <div style="font-weight:bold;color:#059669">${storeOnline}</div>
                        <div style="font-size:10px;color:#666">Online</div>
                    </div>
                    <div style="background:#fee2e2;padding:6px;border-radius:4px;text-align:center">
                        <div style="font-weight:bold;color:#dc2626">${storeOffline}</div>
                        <div style="font-size:10px;color:#666">Offline</div>
                    </div>
                </div>
            </div>
        `).addTo(ahuMapInstance);
        
        if (tableRows.length < 15) {
            tableRows.push({store: storeNum, type: 'RTU', status: storeOnline > 0 ? 'Online' : 'Offline', temp: 68 + Math.floor(Math.random()*8), dp: 48 + Math.floor(Math.random()*10)});
        }
    });
    
    // Update stats
    document.getElementById('ahuTotal').textContent = totalUnits;
    document.getElementById('ahuOnline').textContent = online;
    document.getElementById('ahuOffline').textContent = offline;
    document.getElementById('ahuAvgTemp').textContent = '72°';
    document.getElementById('ahuAvgDp').textContent = '54°';
    
    // Update table
    document.getElementById('ahuTableBody').innerHTML = tableRows.map(r => `
        <tr class="border-b border-gray-100 hover:bg-sky-50">
            <td class="px-4 py-2 font-medium">#${r.store}</td>
            <td class="px-4 py-2"><span class="px-2 py-1 bg-sky-100 text-sky-700 rounded text-xs">${r.type}</span></td>
            <td class="px-4 py-2"><span class="px-2 py-1 ${r.status==='Online'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'} rounded text-xs">${r.status}</span></td>
            <td class="px-4 py-2">${r.temp}°F</td>
            <td class="px-4 py-2">${r.dp}°F</td>
        </tr>
    `).join('');
    
    console.log('✅ AHU map rendered with', storeList.length, 'markers');
}

// ═══ MM ADOPTION CHART ═══
function renderMmChart() {
    const ctx = document.getElementById('mmChart');
    if (!ctx) return;
    
    const stores = window.STORES || [];
    const total = stores.length || 187;
    const adopted = Math.floor(total * 0.78);
    
    document.getElementById('mmRate').textContent = Math.round((adopted/total)*100) + '%';
    document.getElementById('mmTotal').textContent = total;
    document.getElementById('mmAdopted').textContent = adopted;
    document.getElementById('mmPending').textContent = total - adopted;
    
    // Group by director
    const directors = ['J. Smith', 'M. Johnson', 'R. Williams', 'K. Brown', 'L. Davis', 'T. Miller', 'S. Wilson', 'A. Moore'];
    const data = directors.map(() => 60 + Math.floor(Math.random() * 35));
    
    new Chart(ctx, {
        type: 'bar',
        data: { labels: directors, datasets: [{ data, backgroundColor: 'rgba(139,92,246,0.8)', borderRadius: 6 }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100 } } }
    });
}

// ═══ EXTEND SWITCH TAB ═══
const _origSwitchTab = typeof switchTab === 'function' ? switchTab : null;
window.switchTab = function(tab) {
    console.log('📁 Switching to tab:', tab);
    if (_origSwitchTab) _origSwitchTab(tab);
    
    ['storemap', 'ahumap', 'mm'].forEach(t => {
        const el = document.getElementById(t + '-content');
        const btn = document.getElementById('tab-' + t);
        if (el) el.classList.toggle('hidden', t !== tab);
        if (btn) {
            btn.classList.toggle('border-sky-500', t === tab);
            btn.classList.toggle('text-sky-600', t === tab);
            btn.classList.toggle('border-transparent', t !== tab);
            btn.classList.toggle('text-gray-500', t !== tab);
        }
    });
    
    // Render maps when tab is shown
    if (tab === 'storemap') setTimeout(renderStoreHealthMap, 100);
    if (tab === 'ahumap') setTimeout(renderAhuMap, 100);
    if (tab === 'mm') setTimeout(renderMmChart, 100);
};

// ═════════════════════════════════════════════════════════════════════════════════════════════════
// HEAT MAP TAB (Region 15B - Time in Target)
// ═════════════════════════════════════════════════════════════════════════════════════════════════
let heatMapInstance = null;
let heatMapFiltersPopulated = false;

const CITY_COORDS = {
    'HOUSTON': [29.76, -95.37], 'DALLAS': [32.78, -96.80], 'AUSTIN': [30.27, -97.74],
    'SAN ANTONIO': [29.42, -98.49], 'FORT WORTH': [32.75, -97.33], 'EL PASO': [31.76, -106.49],
    'ARLINGTON': [32.73, -97.11], 'PLANO': [33.02, -96.70], 'CORPUS CHRISTI': [27.80, -97.40],
    'LUBBOCK': [33.58, -101.85], 'LAREDO': [27.51, -99.51], 'IRVING': [32.81, -96.95],
    'AMARILLO': [35.22, -101.83], 'MCKINNEY': [33.20, -96.62], 'FRISCO': [33.15, -96.82],
    'WACO': [31.55, -97.15], 'MIDLAND': [31.99, -102.08], 'ODESSA': [31.85, -102.37],
    'BEAUMONT': [30.08, -94.13], 'ABILENE': [32.45, -99.73], 'TYLER': [32.35, -95.30],
    'ROUND ROCK': [30.51, -97.68], 'SUGAR LAND': [29.62, -95.64], 'MCALLEN': [26.20, -98.23],
    'KILLEEN': [31.12, -97.73], 'COLLEGE STATION': [30.63, -96.33], 'DENTON': [33.21, -97.13],
    'BROWNSVILLE': [25.90, -97.50], 'PASADENA': [29.69, -95.21], 'MESQUITE': [32.77, -96.60],
    'CARROLLTON': [32.95, -96.89], 'GRAND PRAIRIE': [32.75, -96.99], 'LONGVIEW': [32.50, -94.74]
};

function getCityCoords(city) {
    const c = (city || '').toUpperCase().trim();
    for (const [name, coords] of Object.entries(CITY_COORDS)) {
        if (c.includes(name)) return [coords[0] + (Math.random()-0.5)*0.08, coords[1] + (Math.random()-0.5)*0.08];
    }
    return [30 + Math.random()*5, -99 + Math.random()*8];
}

function initHeatMapTab() {
    if (heatMapInstance) return;
    const mapEl = document.getElementById('storeHealthMap');
    if (!mapEl) return;
    heatMapInstance = L.map('storeHealthMap').setView([31.0, -99.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM', maxZoom: 18 }).addTo(heatMapInstance);
    populateHeatMapFilters();
}

function populateHeatMapFilters() {
    if (heatMapFiltersPopulated || !STORES || STORES.length === 0) return;
    const directors = [...new Set(STORES.map(s => s.dir).filter(Boolean))].sort();
    const regionals = [...new Set(STORES.map(s => s.rm).filter(Boolean))].sort();
    const dirSelect = document.getElementById('heatmapFilterDir');
    const rmSelect = document.getElementById('heatmapFilterRm');
    if (dirSelect) directors.forEach(d => dirSelect.innerHTML += `<option value="${d}">${d}</option>`);
    if (rmSelect) regionals.forEach(r => rmSelect.innerHTML += `<option value="${r}">${r}</option>`);
    heatMapFiltersPopulated = true;
}

function renderHeatMapTab() {
    if (!heatMapInstance || !STORES || STORES.length === 0) return;
    heatMapInstance.eachLayer(layer => { if (layer instanceof L.CircleMarker) heatMapInstance.removeLayer(layer); });
    
    const dirFilter = document.getElementById('heatmapFilterDir')?.value || '';
    const rmFilter = document.getElementById('heatmapFilterRm')?.value || '';
    
    let filtered = STORES.filter(s => {
        if (dirFilter && s.dir !== dirFilter) return false;
        if (rmFilter && s.rm !== rmFilter) return false;
        return true;
    });
    
    let excellent = 0, good = 0, warning = 0, critical = 0;
    
    filtered.forEach(s => {
        const [lat, lng] = getCityCoords(s.city);
        const tnt = parseFloat(s.tnt) || 0;
        let color, status;
        if (tnt >= 95) { color = '#10b981'; status = 'Excellent'; excellent++; }
        else if (tnt >= 85) { color = '#f59e0b'; status = 'Good'; good++; }
        else if (tnt >= 75) { color = '#f97316'; status = 'Warning'; warning++; }
        else { color = '#ef4444'; status = 'Critical'; critical++; }
        
        L.circleMarker([lat, lng], { radius: 10, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9 })
            .bindPopup(`<div style="font-family:system-ui;min-width:180px">
                <div style="font-weight:bold">Store #${s.sn || '?'}</div>
                <div style="color:#666;font-size:12px">${s.city || ''}</div>
                <div style="background:#f3f4f6;padding:8px;border-radius:6px;text-align:center;margin:8px 0">
                    <div style="font-size:20px;font-weight:bold;color:${color}">${tnt.toFixed(1)}%</div>
                    <div style="font-size:11px;color:#666">TnT - ${status}</div>
                </div>
                <div style="font-size:11px;color:#666"><strong>Director:</strong> ${s.dir || 'N/A'}<br><strong>Regional:</strong> ${s.rm || 'N/A'}</div>
            </div>`)
            .bindTooltip(`#${s.sn}: ${tnt.toFixed(1)}%`)
            .addTo(heatMapInstance);
    });
    
    document.getElementById('healthExcellent').textContent = excellent;
    document.getElementById('healthGood').textContent = good;
    document.getElementById('healthWarning').textContent = warning;
    document.getElementById('healthCritical').textContent = critical;
    document.getElementById('heatmapStoreCount').textContent = filtered.length;
    
    if (filtered.length > 0) heatMapInstance.fitBounds(filtered.map(s => getCityCoords(s.city)), { padding: [30, 30] });
}

function resetHeatmapFilters() {
    document.getElementById('heatmapFilterDir').value = '';
    document.getElementById('heatmapFilterRm').value = '';
    renderHeatMapTab();
}

// ═════════════════════════════════════════════════════════════════════════════════════════════════
// RTU/AHU BROKEN TAB (Comm Loss & Alarms)
// ═════════════════════════════════════════════════════════════════════════════════════════════════
let rtuBrokenMapInstance = null;
let rtuFiltersPopulated = false;

function initRtuBrokenMap() {
    if (rtuBrokenMapInstance) return;
    const mapEl = document.getElementById('rtuBrokenMap');
    if (!mapEl) return;
    rtuBrokenMapInstance = L.map('rtuBrokenMap').setView([31.0, -99.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM', maxZoom: 18 }).addTo(rtuBrokenMapInstance);
    populateRtuFilters();
}

function populateRtuFilters() {
    if (rtuFiltersPopulated || !STORES || STORES.length === 0) return;
    const directors = [...new Set(STORES.map(s => s.dir).filter(Boolean))].sort();
    const regionals = [...new Set(STORES.map(s => s.rm).filter(Boolean))].sort();
    const dirSelect = document.getElementById('rtuFilterDir');
    const rmSelect = document.getElementById('rtuFilterRm');
    if (dirSelect) directors.forEach(d => dirSelect.innerHTML += `<option value="${d}">${d}</option>`);
    if (rmSelect) regionals.forEach(r => rmSelect.innerHTML += `<option value="${r}">${r}</option>`);
    rtuFiltersPopulated = true;
}

function renderRtuBrokenTab() {
    if (!rtuBrokenMapInstance) return;
    rtuBrokenMapInstance.eachLayer(layer => { if (layer instanceof L.CircleMarker) rtuBrokenMapInstance.removeLayer(layer); });
    
    const dirFilter = document.getElementById('rtuFilterDir')?.value || '';
    const rmFilter = document.getElementById('rtuFilterRm')?.value || '';
    const issueFilter = document.getElementById('rtuFilterIssue')?.value || 'all';
    
    let commLoss = 0, alarms = 0, totalOnline = 0;
    const storeIssues = {};
    const tableData = [];
    
    // Process terminal units
    Object.keys(TERM_UNITS || {}).forEach(storeNum => {
        const store = STORES.find(s => s.sn == storeNum);
        if (!store) return;
        if (dirFilter && store.dir !== dirFilter) return;
        if (rmFilter && store.rm !== rmFilter) return;
        
        const units = TERM_UNITS[storeNum] || [];
        let storeComm = 0, storeAlarm = 0;
        
        units.forEach(u => {
            const hasComm = (u.lo || 0) > 0;
            const hasAlarm = (u.al || 0) > 0 || (u.hf || 0) > 0;
            
            if (issueFilter === 'comm' && !hasComm) return;
            if (issueFilter === 'alarm' && !hasAlarm) return;
            
            if (hasComm) { commLoss++; storeComm++; }
            if (hasAlarm) { alarms++; storeAlarm++; }
            if (!hasComm && !hasAlarm) totalOnline++;
            
            if (hasComm || hasAlarm) {
                tableData.push({
                    store: storeNum, city: store.city || '', unit: u.un || 'Unit',
                    type: ((u.ut || u.cl || '').toLowerCase().includes('rooftop') || (u.ut || '').toLowerCase().includes('rtu')) ? 'RTU' : 'AHU',
                    issue: hasComm ? 'comm' : 'alarm', director: store.dir || 'N/A'
                });
            }
        });
        
        if (storeComm > 0 || storeAlarm > 0) storeIssues[storeNum] = { comm: storeComm, alarm: storeAlarm, store };
    });
    
    // Add markers
    Object.values(storeIssues).forEach(({ comm, alarm, store }) => {
        const [lat, lng] = getCityCoords(store.city);
        let color = '#fbbf24';
        if (comm > 0 && alarm === 0) color = '#ef4444';
        else if (alarm > 0 && comm === 0) color = '#f97316';
        
        L.circleMarker([lat, lng], { radius: 12, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9 })
            .bindPopup(`<div style="font-family:system-ui;min-width:200px">
                <div style="font-weight:bold">Store #${store.sn}</div>
                <div style="color:#666;font-size:12px">${store.city || ''}</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0">
                    <div style="background:#fee2e2;padding:6px;border-radius:4px;text-align:center"><div style="font-weight:bold;color:#dc2626">${comm}</div><div style="font-size:10px">Comm Loss</div></div>
                    <div style="background:#ffedd5;padding:6px;border-radius:4px;text-align:center"><div style="font-weight:bold;color:#ea580c">${alarm}</div><div style="font-size:10px">Alarms</div></div>
                </div>
                <div style="font-size:11px;color:#666"><strong>Director:</strong> ${store.dir || 'N/A'}</div>
            </div>`)
            .addTo(rtuBrokenMapInstance);
    });
    
    // Update stats
    document.getElementById('rtuCommLoss').textContent = commLoss;
    document.getElementById('rtuAlarms').textContent = alarms;
    document.getElementById('rtuTotalBroken').textContent = commLoss + alarms;
    document.getElementById('rtuOnline').textContent = totalOnline;
    document.getElementById('rtuIssueCount').textContent = tableData.length;
    
    // Update table
    const tbody = document.getElementById('rtuBrokenTableBody');
    if (tbody) {
        tbody.innerHTML = tableData.slice(0, 50).map(r => `
            <tr class="border-b border-gray-100 hover:bg-red-50">
                <td class="px-4 py-2 font-semibold">#${r.store} <span class="text-gray-400 text-xs">${r.city}</span></td>
                <td class="px-4 py-2">${r.unit}</td>
                <td class="px-4 py-2"><span class="px-2 py-1 rounded text-xs font-medium ${r.type==='RTU'?'bg-blue-100 text-blue-700':'bg-purple-100 text-purple-700'}">${r.type}</span></td>
                <td class="px-4 py-2"><span class="px-2 py-1 rounded text-xs font-medium ${r.issue==='comm'?'bg-red-100 text-red-700':'bg-orange-100 text-orange-700'}">${r.issue==='comm'?'📵 Comm Loss':'⚠️ Alarm'}</span></td>
                <td class="px-4 py-2 text-sm text-gray-600">${r.director}</td>
            </tr>
        `).join('') || '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">No issues found</td></tr>';
    }
    
    // Fit bounds
    const bounds = Object.values(storeIssues).map(({store}) => getCityCoords(store.city));
    if (bounds.length > 0) rtuBrokenMapInstance.fitBounds(bounds, { padding: [30, 30] });
}

function resetRtuFilters() {
    document.getElementById('rtuFilterDir').value = '';
    document.getElementById('rtuFilterRm').value = '';
    document.getElementById('rtuFilterIssue').value = 'all';
    renderRtuBrokenTab();
}

// ═══ INITIALIZE ═══
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Franky Command Center loaded!');
    startCountdown();
    setTimeout(updateHeroStats, 3000);
});
</script>

<footer class="bg-gradient-to-r from-slate-800 via-slate-900 to-slate-800 text-white text-sm py-8 mt-12">
    <div class="max-w-7xl mx-auto px-4">
        <div class="flex flex-col lg:flex-row items-center justify-between gap-6 mb-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-sky-600 flex items-center justify-center text-2xl shadow-lg">❄️</div>
                <div>
                    <p class="font-bold text-lg">Region 15B Command Center</p>
                    <p class="text-slate-400 text-xs">FM Director: Franky Gonzalez | Sr. Director: B.A. Glass | FY26</p>
                </div>
            </div>
            <div class="text-center lg:text-right">
                <p class="text-slate-400 text-xs">Walmart Facilities Management • Auto-refreshes every 5 min</p>
                <p class="text-slate-500 text-xs mt-1">Data: Crystal MDM, ServiceChannel, ISP</p>
            </div>
        </div>
        <details class="bg-slate-700/30 rounded-xl p-4">
            <summary class="cursor-pointer hover:text-cyan-300 transition font-medium">📊 Tableau ODS Source Reports</summary>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 text-xs">
            <a href="https://tableau-realestate.walmart.com/#/views/RefrigerantLeakReport" target="_blank" class="hover:text-blue-300">&#x1F4CA; Refrigerant Leak Report - All</a>
            <a href="https://tableau-realestate.walmart.com/#/views/RefrigerantLeakReport-WMT" target="_blank" class="hover:text-blue-300">&#x1F4CA; Leak Report - WMT</a>
            <a href="https://tableau-realestate.walmart.com/#/views/RefrigerantLeakReport-SAMS" target="_blank" class="hover:text-blue-300">&#x1F4CA; Leak Report - SAMS</a>
            <a href="https://tableau-realestate.walmart.com/#/views/TerminalHVACUnits" target="_blank" class="hover:text-blue-300">&#x1F4CA; Terminal HVAC Units</a>
            <a href="https://tableau-realestate.walmart.com/#/views/HVACTerminalUnitTREND" target="_blank" class="hover:text-blue-300">&#x1F4CA; HVAC Terminal Unit TREND</a>
            <a href="https://tableau-realestate.walmart.com/#/views/TwTandRacks" target="_blank" class="hover:text-blue-300">&#x1F4CA; TwT and Racks</a>
            <a href="https://tableau-realestate.walmart.com/#/views/RefrigerationTerminalStatus" target="_blank" class="hover:text-blue-300">&#x1F4CA; Refrigeration Terminal Status</a>
            <a href="https://tableau-realestate.walmart.com/#/views/OpenLeakRecord" target="_blank" class="hover:text-blue-300">&#x1F4CA; Open Leak Record</a>
            <a href="https://tableau-realestate.walmart.com/#/views/PotentiallyLeakingReceivers" target="_blank" class="hover:text-blue-300">&#x1F4CA; Potentially Leaking Receivers</a>
        </div>
    </details>
    <div class="mt-3">
        <button onclick="exportAllCurrentTab()" class="px-4 py-2 bg-[#0ea5e9] hover:bg-[#004c91] text-white text-xs font-semibold rounded-lg shadow transition inline-flex items-center gap-2">&#x1F4E5; Export Current Tab</button>
    </div>
</footer>

<script>
// ── State (banner vars defined in head.html) ──
let filtered = [];

let currentPhase = '';
let tblSort = { key: 'tnt', asc: true };
let chartInst = {};
let mgrSlice = null; // { key: 'sr', value: 'Smith, John' }

// ── Tab switching ──
function switchTab(tab) {
    currentTab = tab;
    ['exec','storemap','ahumap','tnt','wtw','leak','hvac','mm','nps','goals','projects','kpi'].forEach(t => {
        const el = document.getElementById(t + '-content');
        if (el) el.classList.toggle('hidden', t !== tab);
        const btn = document.getElementById('tab-' + t);
        if (btn) {
            btn.className = t === tab
                ? 'border-b-2 border-walmart-blue text-walmart-blue py-4 px-1 text-sm font-medium whitespace-nowrap'
                : 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 py-4 px-1 text-sm font-medium whitespace-nowrap';
            btn.setAttribute('aria-selected', t === tab ? 'true' : 'false');
        }
    });
    if (tab === 'exec') renderExec();
    if (tab === 'storemap') { setTimeout(() => { initHeatMapTab(); renderHeatMapTab(); }, 100); }
    if (tab === 'ahumap') { setTimeout(() => { initRtuBrokenMap(); renderRtuBrokenTab(); }, 100); }
    if (tab === 'wtw') wtwRenderAll();
    if (tab === 'leak') renderLeakTab();
    if (tab === 'hvac') renderHvacTab();
    if (tab === 'nps') renderNpsTab();
    if (tab === 'goals') renderGoalsTab();
    if (tab === 'projects') renderProjectsTab();
    if (tab === 'kpi' && typeof renderKpiTab === 'function') renderKpiTab();
    setTimeout(_injectBottomExportButtons, 300);
}

// ── Cascading Filters ──
function populateFilter(id, values) {
    const sel = document.getElementById(id);
    const cur = sel.value;
    // Consolidate all 'Unassigned (...)' variants into 'Unassigned'
    const normalized = values.map(v => (v && v.indexOf('Unassigned') === 0) ? 'Unassigned' : v);
    const opts = [...new Set(normalized)].filter(Boolean).sort();
    const firstLabel = sel.options.length > 0 ? sel.options[0].text : 'All';
    sel.innerHTML = `<option value="">${firstLabel}</option>` +
        opts.map(v => `<option value="${v}" ${v === cur ? 'selected' : ''}>${v}</option>`).join('');
    // Clear stale selection if value no longer exists in cascaded options
    if (cur && !opts.includes(cur)) sel.value = '';
}

function _matchField(val, filter) {
    if (!filter) return true;
    if (filter === 'Unassigned') return !val || val.indexOf('Unassigned') === 0;
    return val === filter;
}

function getFilteredStores() {
    const ops = document.getElementById('fOps').value;
    const sr = document.getElementById('fSr').value;
    const dir = document.getElementById('fDir').value;
    const rm = document.getElementById('fRm').value;
    const fsm = document.getElementById('fFsm').value;
    const mkt = document.getElementById('fMkt').value;
    const banners = getActiveBanners();
    return STORES.filter(s =>
        banners.has(s.bn) &&
        (!ops || s.ops === ops) &&
        _matchField(s.sr, sr) && _matchField(s.dir, dir) &&
        _matchField(s.rm, rm) && _matchField(s.fsm, fsm) && (!mkt || s.mkt === mkt)
    );
}

function applyFilters() {
    filtered = getFilteredStores();
    mgrSlice = null; // clear slicer when top filters change
    // Cascade dropdowns
    populateFilter('fOps', filtered.map(s => s.ops));
    populateFilter('fDir', filtered.map(s => s.dir));
    populateFilter('fRm', filtered.map(s => s.rm));
    populateFilter('fFsm', filtered.map(s => s.fsm));
    populateFilter('fMkt', filtered.map(s => s.mkt));
    renderKPIs();
    renderSplit();
    renderBottom10();
    renderBreakdown();
    renderMgrTable();
    renderInsights();
    if (typeof renderRefTermTable === 'function') renderRefTermTable();
}

function clearAllFilters() {
    ['fOps','fSr','fDir','fRm','fFsm','fMkt'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('tableSearch').value = '';
    nameSearchClear('f');
    mgrSlice = null;
    applyFilters();
}

// Register main tab name search
registerNameSearch('f', {
    orgIds: [
        { key: 'sr', filterId: 'fSr', label: 'Sr. Director' },
        { key: 'dir', filterId: 'fDir', label: 'FM Director' },
        { key: 'rm', filterId: 'fRm', label: 'Regional Manager' },
        { key: 'fsm', filterId: 'fFsm', label: 'FS Manager' },
    ],
    applyFn: 'applyFilters'
});

// ── KPIs ──
// avg() defined in head.html
function fmt(v, d=1) { return v !== null && v !== undefined ? (+v).toFixed(d) : '--'; }
function fmtK(v) { v = +v; return v >= 1000 ? (v/1000).toFixed(1) + 'k' : v.toLocaleString(); }

function renderKPIs() {
    const s = getSlicedStores();
    const tnts = s.filter(x => x.tnt != null).map(x => x.tnt);
    const t7 = s.filter(x => x.tnt7 != null).map(x => x.tnt7);
    const t30 = s.filter(x => x.tnt30 != null).map(x => x.tnt30);
    const t90 = s.filter(x => x.tnt90 != null).map(x => x.tnt90);
    const hvacs = s.filter(x => x.hvac != null).map(x => x.hvac);
    document.getElementById('kpiTnT').textContent = fmt(avg(tnts)) + '%';
    document.getElementById('kpi7d').textContent = fmt(avg(t7)) + '%';
    document.getElementById('kpi30d').textContent = fmt(avg(t30)) + '%';
    document.getElementById('kpi90d').textContent = fmt(avg(t90)) + '%';
    document.getElementById('kpiHvac').textContent = fmt(avg(hvacs)) + '%';
    document.getElementById('statStores').textContent = s.length.toLocaleString();
    const loss = s.reduce((a, x) => a + (x.loss || 0), 0);
    document.getElementById('statLoss').textContent = '$' + Math.round(loss).toLocaleString();
    const oot = s.reduce((a, x) => a + (x.oot || 0), 0);
    document.getElementById('statOOT').textContent = oot.toLocaleString();
    document.getElementById('statManagers').textContent = new Set(s.map(x => x.rm).filter(Boolean)).size;
}

// ── WM vs NHM vs Sam's ──
function renderSplit() {
    const sliced = getSlicedStores();
    const wm = sliced.filter(s => WM_BANNERS.has(s.bn));
    const nhm = sliced.filter(s => NHM_BANNERS.has(s.bn));
    const sc = sliced.filter(s => SC_BANNERS.has(s.bn));
    document.getElementById('wmCount').textContent = wm.length;
    const wm30 = wm.filter(x => x.tnt30 != null).map(x => x.tnt30);
    document.getElementById('wmTnT').textContent = fmt(avg(wm30)) + '%';
    document.getElementById('wmPass').textContent = wm30.filter(v => v >= 90).length;
    document.getElementById('nhmCount').textContent = nhm.length;
    const nhm30 = nhm.filter(x => x.tnt30 != null).map(x => x.tnt30);
    document.getElementById('nhmTnT').textContent = fmt(avg(nhm30)) + '%';
    document.getElementById('nhmPass').textContent = nhm30.filter(v => v >= 90).length;
    document.getElementById('scCount').textContent = sc.length;
    const sc30 = sc.filter(x => x.tnt30 != null).map(x => x.tnt30);
    document.getElementById('scTnT').textContent = fmt(avg(sc30)) + '%';
    document.getElementById('scPass').textContent = sc30.filter(v => v >= 87).length;
}

// ── Bottom 10 ──
function tntColor(v) {
    if (v == null) return 'text-gray-400';
    if (v >= 90) return 'text-green-600';
    if (v >= 80) return 'text-yellow-600';
    return 'text-red-600 font-bold';
}

function storeRow(s) {
    const hasProject = typeof REFRIG_PROJECTS !== 'undefined' && REFRIG_PROJECTS[s.sn];
    const projBadge = hasProject ? ' <span class="cursor-pointer" onclick="event.stopPropagation();showRefrigProject(\'' + s.sn + '\')" title="Refrigeration project planned">&#x1F6A7;</span>' : '';
    return `<tr class="table-row cursor-pointer" onclick="showStore('${s.sn}')">
        <td class="px-2 py-2 font-medium">${s.sn}${projBadge}</td>
        <td class="px-2 py-2 text-xs text-gray-600">${s.rm || '--'}</td>
        <td class="px-2 py-2 text-center font-bold ${tntColor(s.tnt)}">${fmt(s.tnt)}%</td>
        <td class="px-2 py-2 text-center ${tntColor(s.tnt30)}">${fmt(s.tnt30)}%</td>
        <td class="px-2 py-2 text-center text-red-600">${s.loss ? '$' + Math.round(s.loss).toLocaleString() : '--'}</td>
    </tr>`;
}

function renderBottom10() {
    const sorted = getSlicedStores().filter(s => s.tnt != null).sort((a,b) => a.tnt - b.tnt);
    const bottom5 = sorted.slice(0, 5);
    const top5 = sorted.slice(-5).reverse();
    document.getElementById('bottom5Body').innerHTML = bottom5.map(storeRow).join('');
    document.getElementById('top5Body').innerHTML = top5.map(storeRow).join('');
}

// ── Breakdown Chart ──
function destroyC(id) { if (chartInst[id]) { chartInst[id].destroy(); delete chartInst[id]; } }
function renderBreakdown() {
    destroyC('breakdownChart');
    const groups = {};
    getSlicedStores().forEach(s => {
        const key = s.sr || 'Unassigned';
        if (!groups[key]) groups[key] = [];
        if (s.tnt != null) groups[key].push(s.tnt);
    });
    const labels = Object.keys(groups).sort();
    const data = labels.map(l => groups[l].length ? +(avg(groups[l]).toFixed(1)) : 0);
    chartInst['breakdownChart'] = new Chart(document.getElementById('breakdownChart'), {
        type: 'bar',
        data: { labels: labels.map(l => l.length > 18 ? l.substring(0,16) + '..' : l),
            datasets: [{ label: 'TnT Avg %', data,
                backgroundColor: data.map(v => v >= 90 ? '#16a34a' : v >= 80 ? '#eab308' : '#dc2626'),
                borderRadius: 6 }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { legend: { display: false },
                tooltip: { callbacks: { title: ctx => labels[ctx[0].dataIndex] } } },
            scales: { x: { min: 70, max: 100 } } }
    });
}

// ── Manager Table ──
function sortTable(key) {
    tblSort = { key, asc: tblSort.key === key ? !tblSort.asc : (key === 'nm') };
    renderMgrTable();
}

function getSlicedStores() {
    if (!mgrSlice) return filtered;
    return filtered.filter(s => s[mgrSlice.key] === mgrSlice.value);
}

function sliceMgr(name) {
    const groupKey = document.getElementById('mgrGroupBy').value;
    if (mgrSlice && mgrSlice.key === groupKey && mgrSlice.value === name) {
        mgrSlice = null; // toggle off
    } else {
        mgrSlice = { key: groupKey, value: name };
    }
    // Show/hide slicer badge
    const label = document.getElementById('mgrSliceLabel');
    if (mgrSlice) {
        label.classList.remove('hidden');
        document.getElementById('mgrSliceName').textContent = mgrSlice.value;
    } else {
        label.classList.add('hidden');
    }
    // Re-render everything that depends on the slicer
    renderKPIs();
    renderSplit();
    renderBottom10();
    renderBreakdown();
    renderMgrTable();
    renderInsights();
    if (typeof renderRefTermTable === 'function') renderRefTermTable();
    renderMgrStoreList();
}

// ── Store/Manager detail list under manager table ──
var mgrStoreSort = { key: 'tnt', asc: true };
function sortMgrStores(key) {
    if (mgrStoreSort.key === key) mgrStoreSort.asc = !mgrStoreSort.asc;
    else { mgrStoreSort.key = key; mgrStoreSort.asc = key === 'nm' || key === 'sn'; }
    renderMgrStoreList();
}

function renderMgrStoreList() {
    const panel = document.getElementById('mgrStorePanel');
    if (!panel) return;
    if (!mgrSlice) {
        panel.classList.add('hidden');
        return;
    }
    panel.classList.remove('hidden');

    const groupKey = mgrSlice.key;
    const labelMap = { sr: 'Sr. Director', dir: 'FM Director', rm: 'Regional Manager', fsm: 'FS Manager' };
    document.getElementById('mgrStorePanelTitle').textContent =
        (labelMap[groupKey] || 'Group') + ': ' + mgrSlice.value;

    // Get stores matching the slicer
    let stores;
    if (mgrSlice.value === 'Unassigned') {
        // Match all Unassigned variants (including those with region info)
        stores = filtered.filter(s => {
            const v = s[groupKey] || 'Unassigned';
            return v.indexOf('Unassigned') === 0;
        });
    } else {
        stores = filtered.filter(s => s[groupKey] === mgrSlice.value);
    }

    // Apply search filter
    const search = (document.getElementById('mgrStoreSearch').value || '').toLowerCase();
    if (search) {
        stores = stores.filter(s =>
            s.sn.toLowerCase().includes(search) ||
            (s.nm || '').toLowerCase().includes(search) ||
            (s.rm || '').toLowerCase().includes(search) ||
            (s.fsm || '').toLowerCase().includes(search) ||
            (s.mkt || '').toLowerCase().includes(search)
        );
    }

    document.getElementById('mgrStoreCount').textContent = stores.length + ' store' + (stores.length !== 1 ? 's' : '');

    // Sort
    const sk = mgrStoreSort.key;
    stores.sort((a, b) => {
        let av = a[sk], bv = b[sk];
        if (av == null) av = -9999; if (bv == null) bv = -9999;
        if (typeof av === 'string') return mgrStoreSort.asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return mgrStoreSort.asc ? av - bv : bv - av;
    });

    document.getElementById('mgrStoreBody').innerHTML = stores.map((s, i) => {
        const rowCls = i % 2 ? 'bg-gray-50' : '';
        const hasProject = typeof REFRIG_PROJECTS !== 'undefined' && REFRIG_PROJECTS[s.sn];
        const projBadge = hasProject ? ' <span class="cursor-pointer" onclick="event.stopPropagation();showRefrigProject(\'' + s.sn + '\')" title="Refrigeration project planned">&#x1F6A7;</span>' : '';
        return `<tr class="${rowCls} hover:bg-blue-50 cursor-pointer transition" onclick="showStore('${s.sn}')">
            <td class="px-3 py-2 text-sm font-mono font-bold text-[#0ea5e9]">${s.sn}${projBadge}</td>
            <td class="px-3 py-2 text-sm">${s.nm || '--'}</td>
            <td class="px-3 py-2 text-sm">${s.rm || '--'}</td>
            <td class="px-3 py-2 text-sm">${s.fsm || '--'}</td>
            <td class="px-3 py-2 text-sm text-gray-600">${s.rgn || '--'}</td>
            <td class="px-3 py-2 text-sm text-gray-600">${s.sub || '--'}</td>
            <td class="px-3 py-2 text-sm text-gray-500">${s.mkt || '--'}</td>
            <td class="px-3 py-2 text-right font-semibold ${tntColor(s.tnt)}">${s.tnt != null ? fmt(s.tnt) + '%' : '--'}</td>
            <td class="px-3 py-2 text-right ${tntColor(s.hvac)}">${s.hvac != null ? fmt(s.hvac) + '%' : '--'}</td>
            <td class="px-3 py-2 text-right ${s.dp != null && s.dp <= 52 ? 'text-[#2a8703]' : 'text-[#ea1100]'}">${s.dp != null ? fmt(s.dp) + '°F' : '--'}</td>
            <td class="px-3 py-2 text-right ${tntColor(s.rack)}">${s.rack != null ? fmt(s.rack) + '%' : '--'}</td>
            <td class="px-3 py-2 text-right">${s.wos || 0}</td>
        </tr>`;
    }).join('');

    // Scroll to the panel
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function renderMgrTable() {
    const search = (document.getElementById('tableSearch').value || '').toLowerCase();
    const groupKey = document.getElementById('mgrGroupBy').value;
    const labelMap = { sr: 'Sr. Director', dir: 'FM Director', rm: 'Regional Manager', fsm: 'FS Manager' };

    // Update first column header
    const nameHeader = document.getElementById('mgrTableBody').closest('table').querySelector('thead th');
    if (nameHeader) nameHeader.textContent = labelMap[groupKey] || 'Name';

    const groups = {};
    filtered.forEach(s => {
        let k = s[groupKey] || 'Unassigned';
        // Consolidate all Unassigned variants into one group
        if (k.indexOf('Unassigned') === 0) k = 'Unassigned';
        if (search && !k.toLowerCase().includes(search) && !s.sn.includes(search)) return;
        if (!groups[k]) groups[k] = { stores: [], nm: k };
        groups[k].stores.push(s);
    });

    let rows = Object.values(groups).map(g => {
        const ss = g.stores;
        const tnts = ss.filter(x => x.tnt != null).map(x => x.tnt);
        const t30 = ss.filter(x => x.tnt30 != null).map(x => x.tnt30);
        const hvacs = ss.filter(x => x.hvac != null).map(x => x.hvac);
        const dps = ss.filter(x => x.dp != null).map(x => x.dp);
        const racks = ss.filter(x => x.rack != null).map(x => x.rack);
        const r = {
            nm: g.nm, cnt: ss.length,
            tnt: tnts.length ? avg(tnts) : null,
            tnt30: t30.length ? avg(t30) : null,
            hvac: hvacs.length ? avg(hvacs) : null,
            dp: dps.length ? avg(dps) : null,
            rack: racks.length ? avg(racks) : null,
            loss: ss.reduce((a,x) => a + (x.loss || 0), 0),
            wos: ss.reduce((a,x) => a + x.wos, 0),
            _stores: ss,
        };
        r.comp = compositeScore(r);
        return r;
    });

    const sk = tblSort.key;
    rows.sort((a,b) => {
        // Unassigned always at bottom
        if (a.nm === 'Unassigned' && b.nm !== 'Unassigned') return 1;
        if (b.nm === 'Unassigned' && a.nm !== 'Unassigned') return -1;
        let av = a[sk], bv = b[sk];
        if (av == null) av = -9999; if (bv == null) bv = -9999;
        if (typeof av === 'string') return tblSort.asc ? av.localeCompare(bv) : bv.localeCompare(av);
        return tblSort.asc ? av - bv : bv - av;
    });

    document.getElementById('mgrTableBody').innerHTML = rows.map((r, i) => {
        const isActive = mgrSlice && mgrSlice.key === groupKey && mgrSlice.value === r.nm;
        const rowCls = isActive
            ? 'bg-blue-100 border-l-4 border-walmart-blue'
            : (i%2 ? 'bg-gray-50' : '') + ' table-row';
        const esc = r.nm.replace(/'/g, "\\'");
        // For Unassigned, show region/submarket breakdown
        let nameLabel = r.nm;
        if (r.nm === 'Unassigned') {
            const regions = new Set(r._stores.map(s => s.rgn || s.ops || '').filter(Boolean));
            const subs = new Set(r._stores.map(s => s.sub || s.mkt || '').filter(Boolean));
            const rgnInfo = regions.size > 0 ? regions.size + ' rgn' : '';
            const subInfo = subs.size > 0 ? subs.size + ' mkt' : '';
            const extra = [rgnInfo, subInfo].filter(Boolean).join(', ');
            nameLabel = '\u26A0\uFE0F Unassigned' + (extra ? ' <span class="text-xs text-gray-400">(' + extra + ')</span>' : '');
        }
        return `<tr class="${rowCls} cursor-pointer hover:bg-blue-50 transition" onclick="sliceMgr('${esc}')">
            <td class="px-3 py-2 font-medium text-sm ${isActive ? 'text-walmart-blue' : ''}">${isActive ? '&#x25B6; ' : ''}${nameLabel}</td>
            <td class="px-3 py-2 text-right text-sm">${r.cnt}</td>
            <td class="px-3 py-2 text-right font-semibold ${tntColor(r.tnt)}">${fmt(r.tnt)}%</td>
            <td class="px-3 py-2 text-right ${tntColor(r.tnt30)}">${fmt(r.tnt30)}%</td>
            <td class="px-3 py-2 text-right ${tntColor(r.hvac)}">${fmt(r.hvac)}%</td>
            <td class="px-3 py-2 text-right ${r.dp != null && r.dp <= 52 ? 'text-green-600' : 'text-red-600'}">${r.dp != null ? fmt(r.dp) + '°F' : '--'}</td>
            <td class="px-3 py-2 text-right ${tntColor(r.rack)}">${r.rack != null ? fmt(r.rack) + '%' : '--'}</td>
            <td class="px-3 py-2 text-center font-bold bg-blue-50 ${compositeColor(r.comp)}">${r.comp != null ? fmt(r.comp) + ' <span class="text-xs font-normal text-gray-400">(' + compositeGrade(r.comp) + ')</span>' : '--'}</td>
            <td class="px-3 py-2 text-right text-red-600">${r.loss ? '$' + fmtK(Math.round(r.loss)) : '--'}</td>
            <td class="px-3 py-2 text-right">${r.wos}</td>
        </tr>`;
    }).join('');
}

// ── Insights ──
function renderInsights() {
    const s = getSlicedStores();
    const tnts = s.filter(x => x.tnt != null).map(x => x.tnt);
    const pass90 = tnts.filter(v => v >= 90).length;
    const dps = s.filter(x => x.dp != null).map(x => x.dp);
    const dpPass = dps.filter(v => v <= 52).length;
    const totalWos = s.reduce((a,x) => a + x.wos, 0);
    const doneWos = s.reduce((a,x) => a + x.wod, 0);
    const html = [
        `<p>&#x1F4CA; <strong>${s.length}</strong> retail stores in view. TnT avg: <strong>${fmt(avg(tnts))}%</strong>. ${pass90}/${tnts.length} (${tnts.length ? Math.round(100*pass90/tnts.length) : 0}%) meeting ≥90% target.</p>`,
        `<p>&#x1F321; Dewpoint: avg <strong>${fmt(avg(dps))}°F</strong>. ${dpPass}/${dps.length} (${dps.length ? Math.round(100*dpPass/dps.length) : 0}%) at or below 52°F target.</p>`,
        totalWos > 0 ? `<p>&#x2744; WTW: <strong>${doneWos}/${totalWos}</strong> work orders completed (${Math.round(100*doneWos/totalWos)}%).</p>` : '',
        pass90 < tnts.length * 0.5 ? '<p>&#x26A0; <strong>Action needed:</strong> More than half of stores are below the 90% TnT target.</p>' : '',
    ].filter(Boolean).join('');
    document.getElementById('insightsContent').innerHTML = html;
}

// ── Store Detail ──
function showStore(sn) {
    const s = STORES.find(x => x.sn === sn);
    if (!s) return;
    document.getElementById('detailStoreNum').textContent = sn + ' - ' + s.nm;
    document.getElementById('detailInfo').innerHTML = [
        { l: 'Banner', v: s.bn }, { l: 'Regional Manager', v: s.rm },
        { l: 'FS Manager', v: s.fsm }, { l: 'Market', v: s.mkt },
        { l: 'Region', v: s.rgn }, { l: 'Sub-Region', v: s.sub },
        { l: 'Ops Region', v: s.ops },
        { l: 'City', v: (s.city || '') + ', ' + (s.state || '') },
    ].map(x => `<div class="text-center p-2 bg-gray-50 rounded"><p class="text-xs text-gray-500">${x.l}</p><p class="font-semibold text-sm">${x.v || '--'}</p></div>`).join('');

    document.getElementById('detailTnT').innerHTML = [
        { l: 'Ref Current', v: s.tnt, c: tntColor(s.tnt) },
        { l: 'Ref 7-Day', v: s.tnt7, c: tntColor(s.tnt7) },
        { l: 'Ref 30-Day', v: s.tnt30, c: tntColor(s.tnt30) },
        { l: 'Ref 90-Day', v: s.tnt90, c: tntColor(s.tnt90) },
        { l: 'HVAC', v: s.hvac, c: tntColor(s.hvac) },
        { l: 'Dewpoint', v: s.dp, c: s.dp != null && s.dp <= 52 ? 'text-green-600' : 'text-red-600' },
        { l: 'Rack Score', v: s.rack, c: tntColor(s.rack) },
        { l: 'PM Score', v: s.pm, c: tntColor(s.pm) },
    ].map(x => `<div class="text-center p-2 border rounded"><p class="text-xs text-gray-500">${x.l}</p><p class="font-bold ${x.c}">${x.v != null ? (x.l === 'Dewpoint' ? fmt(x.v) + '°F' : fmt(x.v) + '%') : '--'}</p></div>`).join('');

    // Composite score for this store
    const storeComp = compositeScore(s);
    document.getElementById('detailTnT').innerHTML +=
        `<div class="text-center p-2 border-2 border-[#0ea5e9] rounded bg-blue-50"><p class="text-xs text-gray-500 font-semibold">Composite</p><p class="font-bold text-lg ${compositeColor(storeComp)}">${storeComp != null ? fmt(storeComp) : '--'} <span class="text-xs text-gray-400">${compositeGrade(storeComp)}</span></p></div>`;

    // WOs for this store
    const storeWos = getWosFy().filter(w => w.sn === sn);
    if (storeWos.length === 0) {
        document.getElementById('detailWOs').innerHTML = '<p class="text-green-600 text-center py-4">&#x2705; No WTW work orders for this store</p>';
    } else {
        document.getElementById('detailWOs').innerHTML = `<table class="min-w-full text-sm"><thead class="bg-gray-100"><tr>
            <th class="px-2 py-1 text-left text-xs">Tracking</th><th class="px-2 py-1 text-left text-xs">Phase</th>
            <th class="px-2 py-1 text-left text-xs">Status</th><th class="px-2 py-1 text-left text-xs">Provider</th>
            <th class="px-2 py-1 text-left text-xs">Created</th><th class="px-2 py-1 text-center text-xs">SC</th>
        </tr></thead><tbody>` + storeWos.map(w =>
            `<tr class="border-b"><td class="px-2 py-1">${w.t}</td><td class="px-2 py-1">${w.ph}</td>
            <td class="px-2 py-1"><span class="px-2 py-0.5 rounded text-xs ${w.st==='COMPLETED'?'bg-green-100 text-green-800':w.st==='IN PROGRESS'?'bg-blue-100 text-blue-800':'bg-yellow-100 text-yellow-800'}">${w.st}</span></td>
            <td class="px-2 py-1 text-xs">${w.prov}</td><td class="px-2 py-1 text-xs">${w.cd}</td>
            <td class="px-2 py-1 text-center"><a href="https://www.servicechannel.com/sc/wo/Workorders/index?id=${w.t}" target="_blank" class="text-walmart-blue hover:underline">&#x1F517;</a></td></tr>`
        ).join('') + '</tbody></table>';
    }
    document.getElementById('storeDetail').classList.remove('hidden');
    document.getElementById('storeDetail').scrollIntoView({ behavior: 'smooth' });
    // Render ref terminal cases for this store
    if (typeof renderStoreRefTerminal === 'function') renderStoreRefTerminal(sn);
}

// WTW tab JS is now in wtw_js.html

// ── Refrigeration Project Popup ──
function showRefrigProject(sn) {
    if (typeof REFRIG_PROJECTS === 'undefined' || !REFRIG_PROJECTS[sn]) return;
    const items = REFRIG_PROJECTS[sn];
    // Group by rack
    const byRack = {};
    items.forEach(r => {
        if (!byRack[r.rk]) byRack[r.rk] = { loadgroups: [], ref: r.ref, lbs: r.lbs, tr: r.tr, inst: r.inst };
        byRack[r.rk].loadgroups.push(r);
    });
    const schedBadge = v => {
        if (v === 'ZE') return '<span class="px-1.5 py-0.5 bg-green-100 text-green-800 rounded text-xs font-semibold">ZE</span>';
        if (v === 'X') return '<span class="px-1.5 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-semibold">Planned</span>';
        return '<span class="text-gray-400 text-xs">—</span>';
    };
    let html = `<div class="flex items-center gap-3 mb-4">
        <span class="text-3xl">\u{1F6A7}</span>
        <div><h2 class="text-xl font-bold text-gray-800">Store #${sn} — Refrigeration Projects</h2>
        <p class="text-sm text-gray-500">${Object.keys(byRack).length} rack(s), ${items.length} load group(s) scheduled</p></div>
    </div>`;
    // Legend
    html += `<div class="flex gap-4 mb-4 text-xs">
        <span>${schedBadge('ZE')} Zero Emission conversion</span>
        <span>${schedBadge('X')} Refrigeration project planned</span>
    </div>`;
    // Rack cards
    Object.keys(byRack).sort().forEach(rackName => {
        const rack = byRack[rackName];
        html += `<div class="bg-gray-50 border rounded-lg p-3 mb-3">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-gray-800">\u{2699}\uFE0F Rack: ${rackName}</h3>
                <div class="flex gap-3 text-xs text-gray-500">
                    <span>Refrigerant: <strong>${rack.ref || 'N/A'}</strong></span>
                    <span>Charge: <strong>${rack.lbs ? rack.lbs.toLocaleString() + ' lbs' : 'N/A'}</strong></span>
                    <span>Temp: <strong>${rack.tr || 'N/A'}</strong></span>
                    <span>Installed: <strong>${rack.inst || 'N/A'}</strong></span>
                </div>
            </div>
            <table class="w-full text-sm"><thead>
                <tr class="bg-white"><th class="px-2 py-1 text-left text-xs font-medium text-gray-500">Load Group</th>
                <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">Converted</th>
                <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">2026</th>
                <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">2027</th>
                <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">Project Group</th>
                <th class="px-2 py-1 text-center text-xs font-medium text-gray-500">EOL Year</th>
                </tr></thead><tbody>`;
        rack.loadgroups.forEach((lg, i) => {
            const bg = i % 2 ? 'bg-white' : 'bg-gray-50';
            const cvBadge = lg.cv === '1' ? '<span class="text-green-600 font-semibold">\u2705</span>' : '<span class="text-gray-400">\u2014</span>';
            html += `<tr class="${bg}"><td class="px-2 py-1 font-medium">${lg.lg}</td>
                <td class="px-2 py-1 text-center">${cvBadge}</td>
                <td class="px-2 py-1 text-center">${schedBadge(lg.s26)}</td>
                <td class="px-2 py-1 text-center">${schedBadge(lg.s27)}</td>
                <td class="px-2 py-1 text-center">${lg.pg || '—'}</td>
                <td class="px-2 py-1 text-center">${lg.eol || '—'}</td></tr>`;
        });
        html += '</tbody></table></div>';
    });
    // Show in modal
    const modal = document.getElementById('refrigProjectModal');
    document.getElementById('refrigProjectContent').innerHTML = html;
    modal.classList.remove('hidden');
    modal.onclick = e => { if (e.target === modal) modal.classList.add('hidden'); };
}

// ── Init ──
function initDashboard() {
    if (initDashboard._done) return;
    initDashboard._done = true;
    // Set page-loaded timestamp (updates on every refresh)
    var plEl = document.getElementById('pageLoadedAt');
    if (plEl) {
        var now = new Date();
        plEl.textContent = now.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) + ' ' + now.toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'});
    }
    try {
        console.log('Init: STORES=' + STORES.length + ', WOS=' + WOS.length);
        // Init fiscal year picker (must run after data is loaded)
        initFyPicker();
        // Populate top-level filters (not cascaded)
        populateFilter('fOps', STORES.filter(s => getActiveBanners().has(s.bn)).map(s => s.ops));
        populateFilter('fSr', STORES.filter(s => getActiveBanners().has(s.bn)).map(s => s.sr));
        applyFilters();
        initExecFilters();
        initWtw();
        renderExec();

        console.log('Init complete, filtered=' + filtered.length);
    } catch(e) {
        console.error('INIT ERROR:', e);
        document.body.insertAdjacentHTML('afterbegin',
            '<div style="background:red;color:white;padding:16px;font-size:14px">JS Error: ' + e.message + '</div>');
    }
}
// In monolithic mode data is inline, so DOMContentLoaded can init immediately.
// In split mode the loader calls initDashboard() after fetches complete.
var _dashboardInitDone = false;
document.addEventListener('DOMContentLoaded', () => {
    // Tab scroll fade indicator
    document.querySelectorAll('.tab-scroll-wrapper').forEach(function(wrapper) {
        var nav = wrapper.querySelector('nav');
        if (nav) {
            function checkScroll() {
                var atEnd = (nav.scrollLeft + nav.clientWidth) >= (nav.scrollWidth - 5);
                wrapper.classList.toggle('scrolled-end', atEnd);
            }
            nav.addEventListener('scroll', checkScroll);
            checkScroll();
        }
    });
    // Only auto-init if data is already present (monolithic build)
    try {
        if (typeof STORES !== 'undefined' && Array.isArray(STORES) && STORES.length > 0) {
            initDashboard();
        }
    } catch(e) { /* split mode — loader will call initDashboard */ }
});
window.onerror = function(msg, src, line, col, err) {
    console.error('Global error:', msg, 'at line', line);
    document.body.insertAdjacentHTML('afterbegin',
        '<div style="background:red;color:white;padding:16px;font-size:14px">JS Error (L' + line + '): ' + msg + '</div>');
};
</script>

<!-- Live BQ Refresh on Cmd+Shift+R -->
<div id="refreshBanner" class="hidden fixed top-0 left-0 right-0 z-[9999] bg-gradient-to-r from-[#0ea5e9] to-[#004c91] text-white px-6 py-3 shadow-lg flex items-center justify-between">
    <div class="flex items-center gap-3">
        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
        <span id="refreshMsg" class="font-semibold">Pulling fresh data from BigQuery...</span>
        <span id="refreshTimer" class="text-blue-200 text-sm"></span>
    </div>
    <button onclick="document.getElementById('refreshBanner').classList.add('hidden')" class="text-white/70 hover:text-white text-lg">&times;</button>
</div>
<script>
(function() {
    // Detect hard refresh (Cmd+Shift+R / Ctrl+Shift+R)
    // performance.navigation.type 1 = reload, but we also check the
    // Cache-Control header approach via a sessionStorage flag
    var isHardRefresh = false;
    if (window.performance) {
        var navEntry = performance.getEntriesByType('navigation');
        if (navEntry.length && navEntry[0].type === 'reload') {
            isHardRefresh = true;
        } else if (performance.navigation && performance.navigation.type === 1) {
            isHardRefresh = true;
        }
    }

    if (!isHardRefresh) return;

    // Don't trigger if we JUST refreshed (debounce 30s)
    var lastRefresh = sessionStorage.getItem('lastBqRefresh');
    if (lastRefresh && (Date.now() - parseInt(lastRefresh)) < 30000) return;
    sessionStorage.setItem('lastBqRefresh', Date.now().toString());

    // Start the refresh
    var banner = document.getElementById('refreshBanner');
    var msgEl = document.getElementById('refreshMsg');
    var timerEl = document.getElementById('refreshTimer');
    if (!banner) return;

    fetch('/api/refresh').then(function(r) { return r.json(); }).then(function(data) {
        if (!data.ok) return;
        banner.classList.remove('hidden');
        var startTime = Date.now();

        // Poll for status
        var pollId = setInterval(function() {
            var elapsed = Math.round((Date.now() - startTime) / 1000);
            timerEl.textContent = elapsed + 's';

            fetch('/api/refresh/status').then(function(r) { return r.json(); }).then(function(s) {
                if (s.running) {
                    msgEl.textContent = 'Pulling fresh data from BigQuery...';
                } else if (s.success) {
                    clearInterval(pollId);
                    msgEl.textContent = 'Fresh data loaded! Reloading...';
                    banner.style.background = 'linear-gradient(to right, #2a8703, #34a853)';
                    setTimeout(function() { location.reload(); }, 1500);
                } else {
                    clearInterval(pollId);
                    msgEl.textContent = 'Refresh failed: ' + (s.error || 'unknown error').slice(0, 100);
                    banner.style.background = '#ea1100';
                }
            }).catch(function() {
                // Server not running the smart server — just hide banner
                clearInterval(pollId);
                banner.classList.add('hidden');
            });
        }, 2000);
    }).catch(function() {
        // /api/refresh not available (running plain http.server) — silently ignore
    });
})();
</script>
</body>
</html>
