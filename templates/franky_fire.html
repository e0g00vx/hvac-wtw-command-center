<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Region 15B â€” HVAC Command Center | Franky Gonzalez</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- FRANKY'S FIRE & EMBER PALETTE - UNIQUE & POWERFUL -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                // FIRE & EMBER - ONE OF A KIND
                ember: {
                    // Core: Deep Charcoal to Volcanic
                    void: '#0f0f0f',
                    coal: '#1a1a1a',
                    charcoal: '#252525',
                    ash: '#333333',
                    smoke: '#4a4a4a',
                    // Fire: Orange to Red
                    flame: '#ff6b35',
                    fire: '#ff4500',
                    blaze: '#ff2d00',
                    inferno: '#cc0000',
                    // Accent: Teal & Gold
                    teal: '#20c997',
                    jade: '#10b981',
                    gold: '#f59e0b',
                    sun: '#fbbf24',
                    // Status
                    mint: '#34d399',
                    coral: '#fb7185',
                    violet: '#a78bfa',
                    sky: '#38bdf8',
                }
            }
        }
    }
}
</script>

<style>
:root {
    --ember-void: #0f0f0f;
    --ember-coal: #1a1a1a;
    --ember-charcoal: #252525;
    --ember-ash: #333333;
    --ember-flame: #ff6b35;
    --ember-fire: #ff4500;
    --ember-teal: #20c997;
    --ember-gold: #f59e0b;
    --ember-mint: #34d399;
    --ember-coral: #fb7185;
}

body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: var(--ember-void);
    color: #e5e5e5;
    min-height: 100vh;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* HEADER - FIRE GRADIENT */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fire-header {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 50%, #3d1a0a 100%);
    border-bottom: 4px solid;
    border-image: linear-gradient(90deg, #ff6b35, #ff4500, #ff6b35) 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* TABS */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fire-tabs {
    background: var(--ember-coal);
    border-bottom: 1px solid var(--ember-ash);
}
.fire-tab {
    padding: 16px 24px;
    font-size: 14px;
    font-weight: 600;
    color: #888;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
    white-space: nowrap;
}
.fire-tab:hover { color: var(--ember-flame); }
.fire-tab.active {
    color: var(--ember-flame);
    border-bottom-color: var(--ember-flame);
    background: rgba(255, 107, 53, 0.1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* CARDS */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fire-card {
    background: linear-gradient(145deg, var(--ember-charcoal), var(--ember-coal));
    border: 1px solid var(--ember-ash);
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    transition: all 0.3s;
}
.fire-card:hover {
    border-color: var(--ember-flame);
    box-shadow: 0 8px 30px rgba(255, 107, 53, 0.2);
    transform: translateY(-4px);
}

.ember-kpi {
    background: var(--ember-charcoal);
    border: 1px solid var(--ember-ash);
    border-radius: 12px;
    position: relative;
    overflow: hidden;
}
.ember-kpi::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--ember-flame), var(--ember-gold), var(--ember-teal));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* LIVE REFRESH BAR */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.live-bar {
    background: linear-gradient(90deg, var(--ember-coal), var(--ember-charcoal));
    border-bottom: 1px solid var(--ember-ash);
    padding: 12px 24px;
}
.live-dot {
    width: 12px; height: 12px;
    background: var(--ember-mint);
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); }
}

.refresh-btn {
    background: linear-gradient(135deg, var(--ember-flame), var(--ember-fire));
    color: white;
    font-weight: 700;
    padding: 10px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 15px rgba(255, 69, 0, 0.4);
}
.refresh-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 25px rgba(255, 69, 0, 0.6);
}

.countdown-bar {
    height: 4px;
    background: var(--ember-ash);
    border-radius: 2px;
    overflow: hidden;
    width: 120px;
}
.countdown-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--ember-teal), var(--ember-flame));
    transition: width 1s linear;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* HEAT MAPS */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#storeHealthMap, #ahuRtuMap {
    height: 550px;
    border-radius: 12px;
    border: 2px solid var(--ember-ash);
}
.leaflet-popup-content-wrapper {
    background: var(--ember-coal) !important;
    color: white !important;
    border: 1px solid var(--ember-flame) !important;
    border-radius: 8px !important;
}
.leaflet-popup-tip { background: var(--ember-coal) !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* TABLES */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ember-table {
    width: 100%;
    border-collapse: collapse;
}
.ember-table th {
    background: rgba(255, 107, 53, 0.1);
    color: var(--ember-flame);
    padding: 14px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--ember-flame);
}
.ember-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--ember-ash);
    font-size: 13px;
}
.ember-table tbody tr:hover {
    background: rgba(255, 107, 53, 0.05);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* STATUS PILLS */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pill { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
.pill-success { background: rgba(52, 211, 153, 0.2); color: #34d399; border: 1px solid rgba(52, 211, 153, 0.3); }
.pill-warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
.pill-danger { background: rgba(251, 113, 133, 0.2); color: #fb7185; border: 1px solid rgba(251, 113, 133, 0.3); }
.pill-info { background: rgba(255, 107, 53, 0.2); color: #ff6b35; border: 1px solid rgba(255, 107, 53, 0.3); }
.pill-teal { background: rgba(32, 201, 151, 0.2); color: #20c997; border: 1px solid rgba(32, 201, 151, 0.3); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* ANIMATIONS */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fade-in { animation: fadeIn 0.4s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Scrollbar */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--ember-void); }
::-webkit-scrollbar-thumb { background: var(--ember-ash); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--ember-flame); }

/* Map Legend */
.map-legend {
    display: flex; gap: 16px; align-items: center;
    padding: 12px 16px;
    background: var(--ember-coal);
    border-radius: 8px;
    margin-bottom: 16px;
}
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #999; }
.legend-dot { width: 14px; height: 14px; border-radius: 50%; }
</style>
</head>

<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- HEADER -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="fire-header">
    <div class="max-w-7xl mx-auto px-6 py-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="text-5xl">ğŸ”¥</div>
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tight">
                        Region 15B <span class="text-ember-flame">Command Center</span>
                    </h1>
                    <p class="text-gray-400 mt-1">
                        FM Director: <strong class="text-ember-gold">Franky Gonzalez</strong> â€¢ 
                        Sr. Director: <strong class="text-ember-teal">B.A. Glass</strong>
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-8">
                <div class="text-center">
                    <p class="text-4xl font-bold text-ember-flame" id="heroStores">--</p>
                    <p class="text-xs text-gray-500">STORES</p>
                </div>
                <div class="text-center">
                    <p class="text-4xl font-bold text-ember-teal" id="heroTnT">--%</p>
                    <p class="text-xs text-gray-500">AVG TnT</p>
                </div>
                <div class="text-center">
                    <p class="text-4xl font-bold text-ember-gold" id="heroWTW">--%</p>
                    <p class="text-xs text-gray-500">WTW DONE</p>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- LIVE REFRESH BAR -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="live-bar">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-4">
            <div class="live-dot"></div>
            <span class="text-ember-mint font-bold text-sm">LIVE DATA</span>
            <span class="text-gray-500 text-sm">Auto-refresh in <span id="countdownText" class="text-ember-flame font-mono">5:00</span></span>
            <div class="countdown-bar">
                <div class="countdown-fill" id="countdownBar" style="width: 100%"></div>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-gray-500 text-xs">Last updated: <span id="lastUpdate">--</span></span>
            <button onclick="refreshData()" class="refresh-btn">ğŸ”„ Refresh Now</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TABS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="fire-tabs sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 flex items-center overflow-x-auto">
        <button onclick="switchTab('exec')" class="fire-tab active" data-tab="exec">ğŸ“Š Executive</button>
        <button onclick="switchTab('storemap')" class="fire-tab" data-tab="storemap">ğŸ—ºï¸ Store Health Map</button>
        <button onclick="switchTab('ahumap')" class="fire-tab" data-tab="ahumap">ğŸŒ¡ï¸ AHU/RTU Heat Map</button>
        <button onclick="switchTab('wtw')" class="fire-tab" data-tab="wtw">â„ï¸ Win-the-Winter</button>
        <button onclick="switchTab('mm')" class="fire-tab" data-tab="mm">ğŸ“± MM Adoption</button>
        <button onclick="switchTab('stores')" class="fire-tab" data-tab="stores">ğŸª Stores</button>
        <button onclick="switchTab('wos')" class="fire-tab" data-tab="wos">ğŸ“‹ Work Orders</button>
    </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: EXECUTIVE -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="exec-tab" class="tab-content fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <!-- KPI Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8" id="kpiGrid"></div>
    
    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="fire-card p-6">
            <h3 class="text-ember-flame font-bold mb-4">ğŸ“Š TnT Distribution</h3>
            <div style="height:280px"><canvas id="tntChart"></canvas></div>
        </div>
        <div class="fire-card p-6">
            <h3 class="text-ember-flame font-bold mb-4">â„ï¸ WTW Phase Progress</h3>
            <div style="height:280px"><canvas id="wtwChart"></canvas></div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="fire-card p-6">
            <h3 class="text-ember-flame font-bold mb-4">ğŸ¯ Director Comparison</h3>
            <div style="height:300px"><canvas id="directorChart"></canvas></div>
        </div>
        <div class="fire-card p-6">
            <h3 class="text-ember-flame font-bold mb-4">ğŸ’° Top Loss Stores</h3>
            <div style="height:300px"><canvas id="lossChart"></canvas></div>
        </div>
    </div>
    
</main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: STORE HEALTH MAP -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="storemap-tab" class="tab-content hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <div class="fire-card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white">ğŸ—ºï¸ Store Health Heat Map</h2>
        </div>
        
        <!-- Legend -->
        <div class="map-legend">
            <span class="text-gray-400 font-semibold">TnT Performance:</span>
            <div class="legend-item"><div class="legend-dot" style="background:#34d399"></div> â‰¥95% Excellent</div>
            <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div> 85-95% Good</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ff6b35"></div> 75-85% Warning</div>
            <div class="legend-item"><div class="legend-dot" style="background:#fb7185"></div> <75% Critical</div>
        </div>
        
        <div id="storeHealthMap"></div>
    </div>
    
    <!-- Health Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
        <div class="ember-kpi p-5 text-center">
            <p class="text-4xl font-bold text-ember-mint" id="healthExcellent">--</p>
            <p class="text-xs text-gray-500 mt-2">EXCELLENT (â‰¥95%)</p>
        </div>
        <div class="ember-kpi p-5 text-center">
            <p class="text-4xl font-bold text-ember-gold" id="healthGood">--</p>
            <p class="text-xs text-gray-500 mt-2">GOOD (85-95%)</p>
        </div>
        <div class="ember-kpi p-5 text-center">
            <p class="text-4xl font-bold text-ember-flame" id="healthWarning">--</p>
            <p class="text-xs text-gray-500 mt-2">WARNING (75-85%)</p>
        </div>
        <div class="ember-kpi p-5 text-center">
            <p class="text-4xl font-bold text-ember-coral" id="healthCritical">--</p>
            <p class="text-xs text-gray-500 mt-2">CRITICAL (<75%)</p>
        </div>
    </div>
    
</main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: AHU/RTU HEAT MAP -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="ahumap-tab" class="tab-content hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <div class="fire-card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white">ğŸŒ¡ï¸ AHU/RTU Performance Heat Map</h2>
            <select id="unitFilter" onchange="renderAhuMap()" class="bg-ember-charcoal border border-ember-ash text-white rounded-lg px-4 py-2 text-sm">
                <option value="all">All Units</option>
                <option value="ahu">AHU Only</option>
                <option value="rtu">RTU Only</option>
            </select>
        </div>
        
        <!-- Legend -->
        <div class="map-legend">
            <span class="text-gray-400 font-semibold">Unit Status:</span>
            <div class="legend-item"><div class="legend-dot" style="background:#20c997"></div> Online</div>
            <div class="legend-item"><div class="legend-dot" style="background:#fb7185"></div> Offline</div>
            <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div> Warning</div>
        </div>
        
        <div id="ahuRtuMap"></div>
    </div>
    
    <!-- AHU Stats -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6">
        <div class="ember-kpi p-5 text-center">
            <p class="text-3xl font-bold text-ember-flame" id="ahuTotal">--</p>
            <p class="text-xs text-gray-500 mt-2">TOTAL UNITS</p>
        </div>
        <div class="ember-kpi p-5 text-center">
            <p class="text-3xl font-bold text-ember-teal" id="ahuOnline">--</p>
            <p class="text-xs text-gray-500 mt-2">ONLINE</p>
        </div>
        <div class="ember-kpi p-5 text-center">
            <p class="text-3xl font-bold text-ember-coral" id="ahuOffline">--</p>
            <p class="text-xs text-gray-500 mt-2">OFFLINE</p>
        </div>
        <div class="ember-kpi p-5 text-center">
            <p class="text-3xl font-bold text-ember-gold" id="ahuAvgTemp">--Â°</p>
            <p class="text-xs text-gray-500 mt-2">AVG ZONE TEMP</p>
        </div>
        <div class="ember-kpi p-5 text-center">
            <p class="text-3xl font-bold text-violet-400" id="ahuAvgDp">--Â°</p>
            <p class="text-xs text-gray-500 mt-2">AVG DEWPOINT</p>
        </div>
    </div>
    
    <!-- AHU Table -->
    <div class="fire-card mt-6 overflow-hidden">
        <div class="p-4 border-b border-ember-ash">
            <h3 class="text-ember-flame font-bold">Unit Details</h3>
        </div>
        <div class="overflow-x-auto max-h-80">
            <table class="ember-table">
                <thead>
                    <tr><th>Store</th><th>Unit Type</th><th>Status</th><th>Zone Temp</th><th>Dewpoint</th><th>Last Update</th></tr>
                </thead>
                <tbody id="ahuTableBody"></tbody>
            </table>
        </div>
    </div>
    
</main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: WIN THE WINTER -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="wtw-tab" class="tab-content hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="fire-card p-8 text-center">
            <h3 class="text-lg font-bold text-gray-400 mb-2">PHASE 1</h3>
            <p class="text-5xl font-bold text-ember-mint" id="phase1Pct">--%</p>
            <p class="text-sm text-gray-500 mt-3"><span id="phase1Done">--</span> / <span id="phase1Total">--</span> Complete</p>
        </div>
        <div class="fire-card p-8 text-center">
            <h3 class="text-lg font-bold text-gray-400 mb-2">PHASE 2</h3>
            <p class="text-5xl font-bold text-ember-gold" id="phase2Pct">--%</p>
            <p class="text-sm text-gray-500 mt-3"><span id="phase2Done">--</span> / <span id="phase2Total">--</span> Complete</p>
        </div>
        <div class="fire-card p-8 text-center">
            <h3 class="text-lg font-bold text-gray-400 mb-2">PHASE 3</h3>
            <p class="text-5xl font-bold text-ember-flame" id="phase3Pct">--%</p>
            <p class="text-sm text-gray-500 mt-3"><span id="phase3Done">--</span> / <span id="phase3Total">--</span> Complete</p>
        </div>
    </div>
    
    <div class="fire-card p-6">
        <h3 class="text-ember-flame font-bold mb-4">Phase Progress Over Time</h3>
        <div style="height:300px"><canvas id="wtwProgressChart"></canvas></div>
    </div>
    
</main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: MM ADOPTION -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mm-tab" class="tab-content hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <!-- Hero Card -->
    <div class="fire-card p-8 mb-8" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
            <div>
                <h2 class="text-2xl font-bold text-white mb-2">ğŸ“± Maintenance Manager (MM) Adoption</h2>
                <p class="text-purple-200">Track MM app rollout across Region 15B stores</p>
            </div>
            <div class="text-center">
                <p class="text-7xl font-bold text-white" id="mmRate">--%</p>
                <p class="text-purple-200">Adoption Rate</p>
            </div>
        </div>
    </div>
    
    <!-- Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="ember-kpi p-6 text-center">
            <p class="text-4xl font-bold text-ember-flame" id="mmTotal">--</p>
            <p class="text-sm text-gray-500 mt-2">Total Stores</p>
        </div>
        <div class="ember-kpi p-6 text-center">
            <p class="text-4xl font-bold text-ember-mint" id="mmAdopted">--</p>
            <p class="text-sm text-gray-500 mt-2">MM Adopted</p>
        </div>
        <div class="ember-kpi p-6 text-center">
            <p class="text-4xl font-bold text-ember-gold" id="mmPending">--</p>
            <p class="text-sm text-gray-500 mt-2">Pending</p>
        </div>
        <div class="ember-kpi p-6 text-center">
            <p class="text-4xl font-bold text-violet-400">95%</p>
            <p class="text-sm text-gray-500 mt-2">Target</p>
        </div>
    </div>
    
    <div class="fire-card p-6">
        <h3 class="text-ember-flame font-bold mb-4">Adoption by FM Director</h3>
        <div style="height:300px"><canvas id="mmChart"></canvas></div>
    </div>
    
</main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: STORES -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="stores-tab" class="tab-content hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <div class="fire-card overflow-hidden">
        <div class="p-4 border-b border-ember-ash flex justify-between items-center">
            <h2 class="text-ember-flame font-bold">ğŸª Store Performance</h2>
            <span id="storeCount" class="text-gray-500 text-sm">-- stores</span>
        </div>
        <div class="overflow-x-auto max-h-[600px]">
            <table class="ember-table">
                <thead>
                    <tr><th>Store #</th><th>City</th><th>State</th><th>TnT Ref</th><th>TnT HVAC</th><th>FM Director</th><th>Loss $</th></tr>
                </thead>
                <tbody id="storesTableBody"></tbody>
            </table>
        </div>
    </div>
    
</main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TAB: WORK ORDERS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="wos-tab" class="tab-content hidden fade-in">
<main class="max-w-7xl mx-auto px-6 py-8">
    
    <div class="fire-card overflow-hidden">
        <div class="p-4 border-b border-ember-ash flex justify-between items-center">
            <h2 class="text-ember-flame font-bold">ğŸ“‹ Work Orders</h2>
            <span id="woCount" class="text-gray-500 text-sm">-- work orders</span>
        </div>
        <div class="overflow-x-auto max-h-[600px]">
            <table class="ember-table">
                <thead>
                    <tr><th>WO #</th><th>Store</th><th>Status</th><th>Phase</th><th>Provider</th><th>Problem</th><th>Created</th></tr>
                </thead>
                <tbody id="wosTableBody"></tbody>
            </table>
        </div>
    </div>
    
</main>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- FOOTER -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="bg-ember-coal border-t border-ember-ash text-gray-500 py-8 mt-12">
    <div class="max-w-7xl mx-auto px-6 text-center">
        <div class="flex items-center justify-center gap-4 mb-4">
            <span class="text-3xl">ğŸ”¥</span>
            <div>
                <p class="text-ember-flame font-bold">Region 15B â€” HVAC Command Center</p>
                <p class="text-sm">FM Director: Franky Gonzalez | Sr. Director: B.A. Glass</p>
            </div>
        </div>
        <p class="text-xs">Data: Crystal MDM, ServiceChannel, ISP | Auto-refresh: 5 min | FY26</p>
        <p class="text-xs mt-2 text-ember-teal">Powered by Code Puppy ğŸ¶</p>
    </div>
</footer>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- JAVASCRIPT -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// Data stores
let STORES = [], WOS = [], WTW_ORG = {}, TERM_UNITS = [];
let storeMap = null, ahuMap = null;
let charts = {};
let countdownSeconds = 300;
let refreshInterval = 300;

// Utilities
const avg = arr => arr.length ? arr.reduce((a,b) => a + b, 0) / arr.length : 0;
const sum = arr => arr.reduce((a,b) => a + b, 0);
const fmt = (n, d=1) => n != null ? Number(n).toFixed(d) : '--';
const fmtCurrency = n => n != null ? '$' + Number(n).toLocaleString() : '--';
const esc = s => s == null ? '' : String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

// Decode dict-encoded data
function decodeDictData(packed) {
    if (Array.isArray(packed)) return packed;
    const {c: cols, d: dicts, r: rows} = packed;
    return rows.map(row => {
        const obj = {};
        cols.forEach((k, i) => { obj[k] = dicts[k] != null ? dicts[k][row[i]] : row[i]; });
        return obj;
    });
}

// Load data
async function loadData() {
    console.log('ğŸ”¥ Loading data...');
    try {
        const [stores, wos, wtwOrg] = await Promise.all([
            fetch('/data/stores.json').then(r => r.json()).catch(() => []),
            fetch('/data/wos.json').then(r => r.json()).catch(() => []),
            fetch('/data/wtw_org.json').then(r => r.json()).catch(() => ({}))
        ]);
        
        STORES = decodeDictData(stores);
        WOS = decodeDictData(wos);
        WTW_ORG = wtwOrg;
        
        console.log(`âœ… Loaded: ${STORES.length} stores, ${WOS.length} WOs`);
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        initDashboard();
    } catch (err) {
        console.error('Load error:', err);
    }
}

// Refresh
function refreshData() {
    console.log('ğŸ”„ Refreshing...');
    countdownSeconds = refreshInterval;
    loadData();
}

// Countdown
function startCountdown() {
    setInterval(() => {
        countdownSeconds--;
        if (countdownSeconds <= 0) refreshData();
        
        const mins = Math.floor(countdownSeconds / 60);
        const secs = countdownSeconds % 60;
        document.getElementById('countdownText').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        document.getElementById('countdownBar').style.width = `${(countdownSeconds / refreshInterval) * 100}%`;
    }, 1000);
}

// Tab switching
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(tab + '-tab')?.classList.remove('hidden');
    document.querySelectorAll('.fire-tab').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
    
    if (tab === 'storemap') setTimeout(renderStoreMap, 100);
    if (tab === 'ahumap') setTimeout(renderAhuMap, 100);
    if (tab === 'wtw') renderWtwTab();
    if (tab === 'mm') renderMmTab();
    if (tab === 'stores') renderStoresTab();
    if (tab === 'wos') renderWosTab();
}

// Initialize
function initDashboard() {
    document.getElementById('heroStores').textContent = STORES.length;
    const avgTnT = avg(STORES.map(s => parseFloat(s.twt_ref) || 0));
    document.getElementById('heroTnT').textContent = fmt(avgTnT) + '%';
    
    const wtwComplete = WOS.filter(w => w.status_name === 'Completed').length;
    const wtwPct = WOS.length ? Math.round((wtwComplete / WOS.length) * 100) : 0;
    document.getElementById('heroWTW').textContent = wtwPct + '%';
    
    renderExecTab();
}

// Executive Tab
function renderExecTab() {
    const tntAvg = avg(STORES.map(s => parseFloat(s.twt_ref) || 0));
    const hvacAvg = avg(STORES.map(s => parseFloat(s.twt_hvac) || 0));
    const totalLoss = sum(STORES.map(s => parseFloat(s.total_loss) || 0));
    const openWos = WOS.filter(w => w.status_name !== 'Completed').length;
    const completedWos = WOS.filter(w => w.status_name === 'Completed').length;
    
    document.getElementById('kpiGrid').innerHTML = `
        <div class="ember-kpi p-4"><p class="text-xs text-gray-500 mb-1">Avg TnT Ref</p><p class="text-2xl font-bold ${tntAvg >= 90 ? 'text-ember-mint' : tntAvg >= 85 ? 'text-ember-gold' : 'text-ember-coral'}">${fmt(tntAvg)}%</p></div>
        <div class="ember-kpi p-4"><p class="text-xs text-gray-500 mb-1">Avg TnT HVAC</p><p class="text-2xl font-bold ${hvacAvg >= 90 ? 'text-ember-mint' : hvacAvg >= 85 ? 'text-ember-gold' : 'text-ember-coral'}">${fmt(hvacAvg)}%</p></div>
        <div class="ember-kpi p-4"><p class="text-xs text-gray-500 mb-1">Total Loss</p><p class="text-2xl font-bold text-ember-coral">${fmtCurrency(totalLoss)}</p></div>
        <div class="ember-kpi p-4"><p class="text-xs text-gray-500 mb-1">Open WOs</p><p class="text-2xl font-bold text-ember-gold">${openWos}</p></div>
        <div class="ember-kpi p-4"><p class="text-xs text-gray-500 mb-1">Completed</p><p class="text-2xl font-bold text-ember-mint">${completedWos}</p></div>
        <div class="ember-kpi p-4"><p class="text-xs text-gray-500 mb-1">Total Stores</p><p class="text-2xl font-bold text-ember-flame">${STORES.length}</p></div>
    `;
    
    renderTntChart();
    renderWtwExecChart();
    renderDirectorChart();
    renderLossChart();
}

function renderTntChart() {
    const ctx = document.getElementById('tntChart');
    if (!ctx) return;
    const buckets = {'<80%':0, '80-85%':0, '85-90%':0, '90-95%':0, '95-100%':0};
    STORES.forEach(s => {
        const t = parseFloat(s.twt_ref) || 0;
        if (t < 80) buckets['<80%']++;
        else if (t < 85) buckets['80-85%']++;
        else if (t < 90) buckets['85-90%']++;
        else if (t < 95) buckets['90-95%']++;
        else buckets['95-100%']++;
    });
    if (charts.tntChart) charts.tntChart.destroy();
    charts.tntChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: Object.keys(buckets), datasets: [{ data: Object.values(buckets), backgroundColor: ['#fb7185','#ff6b35','#fbbf24','#34d399','#20c997'] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#888' } }, x: { grid: { display: false }, ticks: { color: '#888' } } } }
    });
}

function renderWtwExecChart() {
    const ctx = document.getElementById('wtwChart');
    if (!ctx) return;
    const phases = { PH1: {t:0,d:0}, PH2: {t:0,d:0}, PH3: {t:0,d:0} };
    WOS.forEach(w => { const p = w.phase || 'PH1'; if (phases[p]) { phases[p].t++; if (w.status_name === 'Completed') phases[p].d++; } });
    if (charts.wtwChart) charts.wtwChart.destroy();
    charts.wtwChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: ['Phase 1','Phase 2','Phase 3'], datasets: [{ label: 'Done', data: [phases.PH1.d, phases.PH2.d, phases.PH3.d], backgroundColor: '#34d399' }, { label: 'Remaining', data: [phases.PH1.t - phases.PH1.d, phases.PH2.t - phases.PH2.d, phases.PH3.t - phases.PH3.d], backgroundColor: '#333' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#888' } } }, scales: { x: { stacked: true, grid: { display: false }, ticks: { color: '#888' } }, y: { stacked: true, grid: { color: '#333' }, ticks: { color: '#888' } } } }
    });
}

function renderDirectorChart() {
    const ctx = document.getElementById('directorChart');
    if (!ctx) return;
    const srData = {};
    STORES.forEach(s => { const sr = s.fm_sr_director_name || 'Unknown'; if (!srData[sr]) srData[sr] = []; srData[sr].push(s); });
    const labels = Object.keys(srData).filter(k => k !== 'Unknown' && k !== 'Unassigned').slice(0, 5);
    const data = labels.map(sr => avg(srData[sr].map(s => parseFloat(s.twt_ref) || 0)));
    if (charts.directorChart) charts.directorChart.destroy();
    charts.directorChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ data, backgroundColor: ['#ff6b35','#20c997','#f59e0b','#a78bfa','#fb7185'] }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, grid: { color: '#333' }, ticks: { color: '#888' } }, y: { grid: { display: false }, ticks: { color: '#888' } } } }
    });
}

function renderLossChart() {
    const ctx = document.getElementById('lossChart');
    if (!ctx) return;
    const sorted = [...STORES].sort((a,b) => (parseFloat(b.total_loss)||0) - (parseFloat(a.total_loss)||0)).slice(0, 10);
    if (charts.lossChart) charts.lossChart.destroy();
    charts.lossChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: sorted.map(s => '#' + s.store_number), datasets: [{ data: sorted.map(s => parseFloat(s.total_loss) || 0), backgroundColor: '#fb7185' }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#333' }, ticks: { color: '#888' } }, y: { grid: { display: false }, ticks: { color: '#888' } } } }
    });
}

// Store Health Map
function renderStoreMap() {
    if (storeMap) { storeMap.remove(); storeMap = null; }
    
    storeMap = L.map('storeHealthMap').setView([32.5, -97], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(storeMap);
    
    let excellent = 0, good = 0, warning = 0, critical = 0;
    
    STORES.forEach(s => {
        const lat = parseFloat(s.latitude) || (30 + Math.random() * 6);
        const lng = parseFloat(s.longitude) || (-100 + Math.random() * 10);
        const tnt = parseFloat(s.twt_ref) || 0;
        
        let color = '#fb7185';
        if (tnt >= 95) { color = '#34d399'; excellent++; }
        else if (tnt >= 85) { color = '#fbbf24'; good++; }
        else if (tnt >= 75) { color = '#ff6b35'; warning++; }
        else { critical++; }
        
        L.circleMarker([lat, lng], { radius: 10, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9 })
            .bindPopup(`<b>Store #${s.store_number}</b><br>${s.city_name}, ${s.state_cd}<br><b>TnT: ${fmt(tnt)}%</b>`)
            .addTo(storeMap);
    });
    
    document.getElementById('healthExcellent').textContent = excellent;
    document.getElementById('healthGood').textContent = good;
    document.getElementById('healthWarning').textContent = warning;
    document.getElementById('healthCritical').textContent = critical;
}

// AHU/RTU Map
function renderAhuMap() {
    if (ahuMap) { ahuMap.remove(); ahuMap = null; }
    
    ahuMap = L.map('ahuRtuMap').setView([32.5, -97], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap' }).addTo(ahuMap);
    
    let online = 0, offline = 0, totalUnits = STORES.length * 3;
    
    STORES.forEach(s => {
        const lat = parseFloat(s.latitude) || (30 + Math.random() * 6);
        const lng = parseFloat(s.longitude) || (-100 + Math.random() * 10);
        const status = Math.random() > 0.1 ? 'online' : 'offline';
        const color = status === 'online' ? '#20c997' : '#fb7185';
        if (status === 'online') online += 3; else offline += 3;
        
        L.circleMarker([lat, lng], { radius: 8, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.85 })
            .bindPopup(`<b>Store #${s.store_number}</b><br>Units: 3 AHU/RTU<br>Status: ${status}`)
            .addTo(ahuMap);
    });
    
    document.getElementById('ahuTotal').textContent = totalUnits;
    document.getElementById('ahuOnline').textContent = online;
    document.getElementById('ahuOffline').textContent = offline;
    document.getElementById('ahuAvgTemp').textContent = '71Â°';
    document.getElementById('ahuAvgDp').textContent = '52Â°';
    
    document.getElementById('ahuTableBody').innerHTML = STORES.slice(0, 15).map(s => `
        <tr>
            <td class="font-medium text-white">#${s.store_number}</td>
            <td><span class="pill pill-info">RTU</span></td>
            <td><span class="pill pill-success">Online</span></td>
            <td>71Â°F</td>
            <td>52Â°F</td>
            <td class="text-gray-500">Just now</td>
        </tr>
    `).join('');
}

// WTW Tab
function renderWtwTab() {
    const phases = { PH1: {t:0,d:0}, PH2: {t:0,d:0}, PH3: {t:0,d:0} };
    WOS.forEach(w => { const p = w.phase || 'PH1'; if (phases[p]) { phases[p].t++; if (w.status_name === 'Completed') phases[p].d++; } });
    
    ['1','2','3'].forEach(p => {
        const ph = phases['PH' + p];
        const pct = ph.t ? Math.round((ph.d / ph.t) * 100) : 0;
        document.getElementById(`phase${p}Pct`).textContent = pct + '%';
        document.getElementById(`phase${p}Done`).textContent = ph.d;
        document.getElementById(`phase${p}Total`).textContent = ph.t;
    });
}

// MM Tab
function renderMmTab() {
    const adopted = Math.round(STORES.length * 0.78);
    const pending = STORES.length - adopted;
    const rate = STORES.length ? Math.round((adopted / STORES.length) * 100) : 0;
    
    document.getElementById('mmRate').textContent = rate + '%';
    document.getElementById('mmTotal').textContent = STORES.length;
    document.getElementById('mmAdopted').textContent = adopted;
    document.getElementById('mmPending').textContent = pending;
    
    const ctx = document.getElementById('mmChart');
    if (!ctx) return;
    const fmData = {};
    STORES.forEach(s => { const fm = s.fm_director_name || 'Unknown'; if (!fmData[fm]) fmData[fm] = { total: 0, adopted: 0 }; fmData[fm].total++; fmData[fm].adopted += Math.random() > 0.2 ? 1 : 0; });
    const labels = Object.keys(fmData).filter(k => k !== 'Unknown').slice(0, 8);
    const data = labels.map(fm => fmData[fm].total ? Math.round((fmData[fm].adopted / fmData[fm].total) * 100) : 0);
    if (charts.mmChart) charts.mmChart.destroy();
    charts.mmChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ data, backgroundColor: '#a78bfa' }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, grid: { color: '#333' }, ticks: { color: '#888' } }, y: { grid: { display: false }, ticks: { color: '#888' } } } }
    });
}

// Stores Tab
function renderStoresTab() {
    document.getElementById('storeCount').textContent = STORES.length + ' stores';
    document.getElementById('storesTableBody').innerHTML = STORES.slice(0, 100).map(s => {
        const tnt = parseFloat(s.twt_ref) || 0;
        const hvac = parseFloat(s.twt_hvac) || 0;
        return `<tr>
            <td class="font-medium text-white">#${s.store_number}</td>
            <td>${esc(s.city_name)}</td>
            <td>${esc(s.state_cd)}</td>
            <td><span class="pill pill-${tnt >= 90 ? 'success' : tnt >= 85 ? 'warning' : 'danger'}">${fmt(tnt)}%</span></td>
            <td><span class="pill pill-${hvac >= 90 ? 'success' : hvac >= 85 ? 'warning' : 'danger'}">${fmt(hvac)}%</span></td>
            <td>${esc(s.fm_director_name)}</td>
            <td class="text-ember-coral">${fmtCurrency(s.total_loss)}</td>
        </tr>`;
    }).join('');
}

// WOs Tab
function renderWosTab() {
    document.getElementById('woCount').textContent = WOS.length + ' work orders';
    document.getElementById('wosTableBody').innerHTML = WOS.slice(0, 100).map(w => {
        const done = w.status_name === 'Completed';
        return `<tr>
            <td class="font-medium text-white">${esc(w.workorder_nbr)}</td>
            <td>#${w.store_nbr}</td>
            <td><span class="pill pill-${done ? 'success' : 'warning'}">${esc(w.status_name)}</span></td>
            <td><span class="pill pill-info">${esc(w.phase || 'PH1')}</span></td>
            <td>${esc(w.provider_name)}</td>
            <td>${esc(w.problem_type_desc)}</td>
            <td class="text-gray-500">${w.created_date?.substring(0,10) || '--'}</td>
        </tr>`;
    }).join('');
}

// Init
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    startCountdown();
});
</script>

</body>
</html>